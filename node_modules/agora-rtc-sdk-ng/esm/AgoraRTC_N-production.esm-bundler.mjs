/**
 * AgoraWebSDK_N-v4.22.0-0-g8569241d-dirty Copyright AgoraInc.
 */

import"webrtc-adapter";import{AgoraRTCEventReport as e,logger as t,report as i,AgoraRTCEvent as n,AgoraRTCEventUploadType as s,apiInvoke as o,isEventCustomReportParams as a}from"@agora-js/report";import{IS_GLOBAL_VERSION as r,MUTABLE_PARAMS as c,MUTABLE_PARAMS_LOCAL_CACHE as d,AgoraRTCError as l,AgoraRTCErrorCode as h,isValidString as u,checkValidString as p,EventEmitter as _,getParameter as E,createDefer as m,isMacOS as S,isFirefox as f,PromiseMutex as C,NETWORK_STATE as T,networkIndicator as R,NETWORK_INDICATOR_EVENTS as I,getRetryWaitTime as g,wait as A,emitAsPromise as v,emitAsInvokerNoResponse as y,Rolling as w,ConnectionDisconnectedReason as b,WebSocketQuitReason as N,getRandomString as O,emitAsInvoker as D,SHA256 as P,uint8ArrayToBase64 as L,base64ToUint8Array as k,jsonClone as M,getBrowserInfo as U,BrowserName as V,BrowserOS as x,withTimeout as F,nextTick as B,isBelowChrome as G,VERSION as j,setParameter as W,getUTF8StringByteLength as H,getMultiUnilbsFormDataByteLength as K,AgoraAPIName as Y,AgoraAPITag as q,retryable as J,DEFAULT_RETRY_CONFIG as X,isPromise as z,P2PTransportType as Q,isRTCIceServerList as Z,isChromeKernel as $,emitAsPromiseNoResponse as ee,getUniqueList as te,VideoCodec as ie,isSafari as ne,isIOS as se,isChromeBelow90 as oe,isBelowIOS14_6 as ae,OVERUSE_DETECTOR_PARAMS as re,isAboveIOS as ce,isBelowIOS as de,isAboveSafari as le,isBelowSafari as he,isMobile as ue,ClientEvents as pe,isWkWebview as _e,runOnce as Ee,generateSessionID as me,md5 as Se,convertStringToFixedLengthUint8Array as fe,checkValidNumber as Ce,removeItemFromList as Te,SDKStore as Re,BUILD as Ie,isClientRoleOptions as ge,concurrent as Ae,isHttpsEnv as ve,supportIsSecureContext as ye,encryptRSA as we,generateIv as be,generateKey as Ne,checkValidBoolean as Oe,checkValidEnum as De,checkValidArray as Pe,isClientRole as Le,isTurnServerConfig as ke,isEncryptionMode as Me,encryptAesGcm as Ue,CRYPTO_HEADER_LENGTH as Ve,decryptAesGcm as xe,isP2PTransport as Fe,isClientConfig as Be,isWebKit as Ge,isSupportedWkWebview as je,isIpadOS as We,isWechatBrowser as He,isQQBrowser as Ke,generateProcessID as Ye}from"@agora-js/shared";export{AudienceLatencyLevelType,BUILD,ConnectionDisconnectedReason,VERSION,getParameter}from"@agora-js/shared";import{LocalAudioTrack as qe,LocalVideoTrack as Je,getCompatibility as Xe,TrackHint as ze,isPlanB as Qe,MixingAudioTrack as Ze,audioTimerLoop as $e,MediaElementNumStatus as et,visibilityWatcher as tt,MediaElementStatus as it,audioElementPlayCenter as nt,MicrophoneAudioTrack as st,RemoteAudioTrack as ot,RemoteVideoTrack as at,TrackInternalEvent as rt,RemoteTrackEvents as ct,TrackEvents as dt,StreamType as lt,DEFAULT_LOCAL_AUDIO_TRACK_STATS as ht,DEFAULT_LOCAL_VIDEO_TRACK_STATS as ut,DEFAULT_REMOTE_AUDIO_TRACK_STATS as pt,DEFAULT_REMOTE_VIDEO_TRACK_STATS as _t,DEFAULT_NETWORK_QUALITY_STATS as Et,CameraVideoTrack as mt,getOriginSenderConfig as St,interceptRemoteVideoFrame as ft,interceptRemoteAudioFrame as Ct,interceptLocalVideoFrame as Tt,interceptLocalAudioFrame as Rt,LocalTrack as It,TrackMediaType as gt,isLowStreamParameter as At,autoPlayGestureEventEmitter as vt,deviceManager as yt,DeviceManagerEvent as wt,audioContextState as bt,AUDIO_CONTEXT_EVENT as Nt,__TRACK_LIST__ as Ot}from"@agora-js/media";export{RemoteStreamFallbackType,RemoteStreamType,__TRACK_LIST__,audioElementPlayCenter,createBufferSourceAudioTrack,createCameraVideoTrack,createCustomAudioTrack,createCustomVideoTrack,createMicrophoneAndCameraTracks,createMicrophoneAudioTrack,createScreenVideoTrack,getElectronScreenSources}from"@agora-js/media";import Dt from"axios";import"formdata-polyfill";const Pt=!0,Lt=!1,kt=!1,Mt=!1,Ut=["CHINA","GLOBAL"],Vt=function(){const e="us".concat("erna","me"),t="pa".concat("sswo","rd"),i=["t","s","t"];i.splice(1,0,"e");const n=i.join(""),s=[];for(let e=0;e<6;e++)s.push("1");const o=s.join(""),a={};return a[e]=n,a[t]=o,Object.assign(a,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=Vt,r||(c.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],c.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],c.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],c.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],c.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],c.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],c.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",c.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",c.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",c.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",c.AREAS=["NORTH_AMERICA","OVERSEA"]);const xt=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],Ft=[];function Bt(e,t){return!!t&&Ft.some((i=>i.uid===e&&i.channelName===t))}function Gt(e,t){this.v=e,this.k=t}function jt(e,t,i,n,s){var o={};return Object.keys(n).forEach((function(e){o[e]=n[e]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=i.slice().reverse().reduce((function(i,n){return n(e,t,i)||i}),o),s&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(s):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(e,t,o),o=null),o}function Wt(e){var t={},i=!1;function n(t,n){return i=!0,n=new Promise((function(i){i(e[t](n))})),{done:!1,value:new Gt(n,1)}}return t["undefined"!=typeof Symbol&&Symbol.iterator||"@@iterator"]=function(){return this},t.next=function(e){return i?(i=!1,e):n("next",e)},"function"==typeof e.throw&&(t.throw=function(e){if(i)throw i=!1,e;return n("throw",e)}),"function"==typeof e.return&&(t.return=function(e){return i?(i=!1,e):n("return",e)}),t}function Ht(e){var t,i,n,s=2;for("undefined"!=typeof Symbol&&(i=Symbol.asyncIterator,n=Symbol.iterator);s--;){if(i&&null!=(t=e[i]))return t.call(e);if(n&&null!=(t=e[n]))return new Kt(t.call(e));i="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function Kt(e){function t(e){if(Object(e)!==e)return Promise.reject(new TypeError(e+" is not an object."));var t=e.done;return Promise.resolve(e.value).then((function(e){return{value:e,done:t}}))}return Kt=function(e){this.s=e,this.n=e.next},Kt.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var i=this.s.return;return void 0===i?Promise.resolve({value:e,done:!0}):t(i.apply(this.s,arguments))},throw:function(e){var i=this.s.return;return void 0===i?Promise.reject(e):t(i.apply(this.s,arguments))}},new Kt(e)}function Yt(e){return new Gt(e,0)}function qt(e,t,i){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function Jt(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Xt(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Jt(Object(i),!0).forEach((function(t){qt(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Jt(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function zt(e){return function(){return new Qt(e.apply(this,arguments))}}function Qt(e){var t,i;function n(t,i){try{var o=e[t](i),a=o.value,r=a instanceof Gt;Promise.resolve(r?a.v:a).then((function(i){if(r){var c="return"===t?"return":"next";if(!a.k||i.done)return n(c,i);i=e[c](i).value}s(o.done?"return":"normal",i)}),(function(e){n("throw",e)}))}catch(e){s("throw",e)}}function s(e,s){switch(e){case"return":t.resolve({value:s,done:!0});break;case"throw":t.reject(s);break;default:t.resolve({value:s,done:!1})}(t=t.next)?n(t.key,t.arg):i=null}this._invoke=function(e,s){return new Promise((function(o,a){var r={key:e,arg:s,resolve:o,reject:a,next:null};i?i=i.next=r:(t=i=r,n(e,s))}))},"function"!=typeof e.return&&(this.return=void 0)}e.__CLIENT_LIST__=Ft,Qt.prototype["function"==typeof Symbol&&Symbol.asyncIterator||"@@asyncIterator"]=function(){return this},Qt.prototype.next=function(e){return this._invoke("next",e)},Qt.prototype.throw=function(e){return this._invoke("throw",e)},Qt.prototype.return=function(e){return this._invoke("return",e)};let Zt=function(e){return e.L1T1="L1T1",e.L1T2="L1T2",e.L1T3="L1T3",e.L1T3_KEY="L1T3_KEY",e.L2T1_KEY="L2T1_KEY",e.L2T2_KEY="L2T2_KEY",e.L2T3_KEY="L2T3_KEY",e.L3T1_KEY="L3T1_KEY",e.L3T2_KEY="L3T2_KEY",e.L3T3_KEY="L3T3_KEY",e}({}),$t=function(e){return e.CERTIFICATE="certificate",e.CODEC="codec",e.CANDIDATE_PAIR="candidate-pair",e.LOCAL_CANDIDATE="local-candidate",e.REMOTE_CANDIDATE="remote-candidate",e.INBOUND="inbound-rtp",e.TRACK="track",e.OUTBOUND="outbound-rtp",e.PC="peer-connection",e.REMOTE_INBOUND="remote-inbound-rtp",e.REMOTE_OUTBOUND="remote-outbound-rtp",e.TRANSPORT="transport",e.CSRC="csrc",e.DATA_CHANNEL="data-channel",e.STREAM="stream",e.SENDER="sender",e.RECEIVER="receiver",e}({}),ei=function(e){return e[e.ACCESS_POINT=101]="ACCESS_POINT",e[e.UNILBS=201]="UNILBS",e[e.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR",e}({}),ti=function(e){return e[e.IIIEGAL_APPID=1]="IIIEGAL_APPID",e[e.IIIEGAL_UID=2]="IIIEGAL_UID",e[e.INTERNAL_ERROR=3]="INTERNAL_ERROR",e}({}),ii=function(e){return e[e.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",e[e.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",e[e.INTERNAL_ERROR=8]="INTERNAL_ERROR",e[e.NO_AUTHORIZED=9]="NO_AUTHORIZED",e[e.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",e[e.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",e[e.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",e[e.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",e[e.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",e[e.USER_OVERLOAD=16]="USER_OVERLOAD",e[e.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",e[e.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND",e}({}),ni=function(e){return e[e.NO_FLAG_SET=100]="NO_FLAG_SET",e[e.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",e[e.INVALID_FALG_SET=102]="INVALID_FALG_SET",e[e.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",e[e.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",e[e.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",e[e.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",e[e.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",e[e.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",e[e.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",e[e.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",e[e.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",e[e.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",e[e.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",e[e.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",e[e.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",e[e.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",e[e.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",e[e.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV",e}({}),si=function(e){return e[e.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",e[e.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",e[e.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",e[e.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",e[e.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",e[e.K_TICKET_INVALID=7]="K_TICKET_INVALID",e[e.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",e[e.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",e[e.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",e[e.K_UID_BANNED=14]="K_UID_BANNED",e[e.K_IP_BANNED=15]="K_IP_BANNED",e[e.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",e[e.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",e[e.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",e[e.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",e[e.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",e[e.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",e[e.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",e[e.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",e[e.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",e[e.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",e[e.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",e[e.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",e[e.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",e[e.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",e[e.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",e[e.ERR_INVALID_UID=117]="ERR_INVALID_UID",e[e.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",e[e.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",e[e.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",e[e.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",e[e.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",e[e.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",e[e.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",e[e.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",e[e.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",e[e.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",e[e.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",e[e.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",e[e.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",e[e.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",e[e.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",e[e.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",e[e.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",e[e.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",e[e.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",e[e.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",e[e.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",e[e.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",e[e.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",e[e.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",e[e.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",e[e.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",e[e.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",e[e.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",e[e.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",e[e.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",e[e.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",e[e.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",e[e.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",e[e.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",e[e.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",e[e.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",e[e.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY",e}({}),oi=function(e){return e.CONNECTING="connecting",e.CONNECTED="connected",e.RECONNECTING="reconnecting",e.CLOSED="closed",e}({}),ai=function(e){return e.WS_CONNECTED="ws_connected",e.WS_RECONNECTING="ws_reconnecting",e.WS_CLOSED="ws_closed",e.WS_RECONNECT_WAITTING_FINISH="ws_reconnect_waitting_finish",e.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",e.ON_BINARY_DATA="on_binary_data",e.REQUEST_RECOVER="request_recover",e.REQUEST_JOIN_INFO="request_join_info",e.REQUEST_REJOIN_INFO="req_rejoin_info",e.IS_P2P_DISCONNECTED="is_p2p_dis",e.DISCONNECT_P2P="dis_p2p",e.ABORT_P2P_EXECUTION="abort_p2p_execution",e.NEED_RENEW_SESSION="need-sid",e.REPORT_JOIN_GATEWAY="report_join_gateway",e.REQUEST_TIMEOUT="request_timeout",e.REQUEST_SUCCESS="request_success",e.JOIN_RESPONSE="join_response",e.PRE_CONNECT_PC="pre_connect_pc",e.P2P_CONNECTION="p2p_connection",e.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",e.P2P_SUBSCRIBE="p2p_subscribe",e.P2P_UNSUBSCRIBE="p2p_unsubscribe",e.P2P_EXCHANGE_SDP="p2p_exchange_sdp",e.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",e.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream",e}({}),ri=function(e){return e.PING="ping",e.PING_BACK="ping_back",e.JOIN="join_v3",e.REJOIN="rejoin_v3",e.LEAVE="leave",e.SET_CLIENT_ROLE="set_client_role",e.PUBLISH="publish",e.PUBLISH_DATASTREAM="publish_datastream",e.UNPUBLISH="unpublish",e.UNPUBLISH_DATASTREAM="unpublish_datastream",e.SUBSCRIBE="subscribe",e.PRE_SUBSCRIBE="pre_subscribe",e.SUBSCRIBE_DATASTREAM="subscribe_datastream",e.SUBSCRIBE_STREAMS="subscribe_streams",e.UNSUBSCRIBE="unsubscribe",e.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",e.UNSUBSCRIBE_STREAMS="unsubscribe_streams",e.SUBSCRIBE_CHANGE="subscribe_change",e.TRAFFIC_STATS="traffic_stats",e.RENEW_TOKEN="renew_token",e.SWITCH_VIDEO_STREAM="switch_video_stream",e.DEFAULT_VIDEO_STREAM="default_video_stream",e.SET_FALLBACK_OPTION="set_fallback_option",e.GATEWAY_INFO="gateway_info",e.CONTROL="control",e.SEND_METADATA="send_metadata",e.DATA_STREAM="data_stream",e.PICK_SVC_LAYER="pick_svc_layer",e.RESTART_ICE="restart_ice",e.CONNECT_PC="connect_pc",e.SET_VIDEO_PROFILE="set_video_profile",e.SET_PARAMETER="set_parameter",e.SET_RTM2_FLAG="set_rtm2_flag",e}({}),ci=function(e){return e.WRTC_STATS="wrtc_stats",e.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",e.DENOISER_STATS="denoiser_stats",e.EXTENSION_USAGE_STATS="extension_usage_stats",e}({}),di=function(e){return e.ON_USER_ONLINE="on_user_online",e.ON_USER_OFFLINE="on_user_offline",e.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",e.ON_PUBLISH_STREAM="on_publish_stream",e.ON_UPLINK_STATS="on_uplink_stats",e.ON_P2P_LOST="on_p2p_lost",e.ON_REMOVE_STREAM="on_remove_stream",e.ON_ADD_AUDIO_STREAM="on_add_audio_stream",e.ON_ADD_VIDEO_STREAM="on_add_video_stream",e.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",e.ON_USER_BANNED="on_user_banned",e.ON_USER_LICENSE_BANNED="on_user_license_banned",e.ON_NOTIFICATION="on_notification",e.ON_CRYPT_ERROR="on_crypt_error",e.MUTE_AUDIO="mute_audio",e.MUTE_VIDEO="mute_video",e.UNMUTE_AUDIO="unmute_audio",e.UNMUTE_VIDEO="unmute_video",e.ON_P2P_OK="on_p2p_ok",e.RECEIVE_METADATA="receive_metadata",e.ON_DATA_STREAM="on_data_stream",e.ON_RTP_CAPABILITY_CHANGE="on_rtp_capability_change",e.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",e.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",e.ENABLE_LOCAL_VIDEO="enable_local_video",e.DISABLE_LOCAL_VIDEO="disable_local_video",e.ENABLE_LOCAL_AUDIO="enable_local_audio",e.DISABLE_LOCAL_AUDIO="disable_local_audio",e.ON_PUBLISHED_USER_LIST="on_published_user_list",e}({}),li=function(e){return e.SEND_ONLY="SEND_ONLY",e.RECEIVE_ONLY="RECEIVE_ONLY",e}({}),hi=function(e){return e.CONNECTED="websocket:connected",e.RECONNECTING="websocket:reconnecting",e.WILL_RECONNECT="websocket:will_reconnect",e.CLOSED="websocket:closed",e.FAILED="websocket:failed",e.ON_MESSAGE="websocket:on_message",e.REQUEST_NEW_URLS="websocket:request_new_urls",e.RECONNECT_WAITTING_FINISH="websocket:reconnect_waitting_finish",e.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire",e}({});class ui extends l{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",arguments.length>2?arguments[2]:void 0),this.name="AgoraRTCException"}print(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"error";return super.print(e,t)}throw(){super.throw(t)}}function pi(e){if("string"!=typeof e||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(e))throw t.error("Invalid Channel Name ".concat(e)),new ui(h.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function _i(e){if(!(i=e,"number"==typeof i&&Math.floor(i)===i&&0<=i&&i<=4294967295||u(e,1,255)))throw new ui(h.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");var i;"string"==typeof e&&t.warn("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}let Ei=function(e){return e.TRANSCODE="mix_streaming",e.RAW="raw_streaming",e}({}),mi=function(e){return e.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager",e}({});function Si(e){if(!e.channelName)throw new ui(h.INVALID_PARAMS,"invalid channelName in info");if("number"!=typeof e.uid)throw new ui(h.INVALID_PARAMS,"invalid uid in info, uid must be a number");return e.token&&p(e.token,"info.token",1,2047),_i(e.uid),pi(e.channelName),!0}let fi=function(e){return e.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",e.NETWORK_CONNECTED="NETWORK_CONNECTED",e.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",e.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",e.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",e.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",e.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",e.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",e.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",e.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE",e}({}),Ci=function(e){return e.RELAY_STATE_IDLE="RELAY_STATE_IDLE",e.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",e.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",e.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE",e}({}),Ti=function(e){return e.RELAY_OK="RELAY_OK",e.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",e.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",e.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED",e}({}),Ri=function(e){return e.High="high",e.Low="low",e.Audio="audio",e.Screen="screen",e.ScreenLow="screen_low",e}({}),Ii=function(e){return e.DISCONNECT="disconnect",e.CONNECTION_STATE_CHANGE="connection-state-change",e.NETWORK_QUALITY="network-quality",e.STREAM_TYPE_CHANGE="stream-type-change",e.IS_P2P_DISCONNECTED="is-p2p-dis",e.DISCONNECT_P2P="dis-p2p",e.REQUEST_NEW_GATEWAY_LIST="req-gate-url",e.NEED_RENEW_SESSION="need-sid",e.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",e.JOIN_RESPONSE="join-response",e.RESET_CONNECTION_EVENTS="reset-connection-events",e.PRE_CONNECT_PC="pre-connect_pc",e}({}),gi=function(e){return e.P2P_DISCONNECTED="P2P_DISCONNECTED",e.A_ROUND_WS_FAILED="A_ROUND_WS_FAILED",e.TIMEOUT="TIMEOUT",e.UNKNOWN_REASON="UNKNOWN_REASON",e}({}),Ai=function(e){return e[e.Nothing=0]="Nothing",e[e.Audio=1]="Audio",e[e.LwoVideo=2]="LwoVideo",e[e.Video=4]="Video",e[e.Data=8]="Data",e[e.DataStream0=256]="DataStream0",e[e.DataStream1=512]="DataStream1",e[e.DataStream2=1024]="DataStream2",e[e.DataStream3=2048]="DataStream3",e[e.DataStream4=4096]="DataStream4",e[e.DataStream5=8192]="DataStream5",e[e.DataStream6=16384]="DataStream6",e[e.DataStream7=32768]="DataStream7",e}({}),vi=function(e){return e.CHINA="CHINA",e.ASIA="ASIA",e.NORTH_AMERICA="NORTH_AMERICA",e.EUROPE="EUROPE",e.JAPAN="JAPAN",e.INDIA="INDIA",e.KOREA="KOREA",e.HKMC="HKMC",e.US="US",e.OCEANIA="OCEANIA",e.SOUTH_AMERICA="SOUTH_AMERICA",e.AFRICA="AFRICA",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="EXTENSIONS",e}({});const yi=[vi.AFRICA,vi.ASIA,vi.CHINA,vi.EUROPE,vi.GLOBAL,vi.INDIA,vi.JAPAN,vi.NORTH_AMERICA,vi.OCEANIA,vi.OVERSEA,vi.SOUTH_AMERICA];let wi=function(e){return e.CHINA="CN",e.ASIA="AS",e.NORTH_AMERICA="NA",e.EUROPE="EU",e.JAPAN="JP",e.INDIA="IN",e.KOREA="KR",e.HKMC="HK",e.US="US",e.OCEANIA="OC",e.SOUTH_AMERICA="SA",e.AFRICA="AF",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="GLOBAL",e}({});const bi={CHINA:{},ASIA:{CODE:wi.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:wi.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:wi.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:wi.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","uap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:wi.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:wi.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:wi.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:wi.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:wi.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:wi.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:wi.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:wi.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:wi.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};r&&(bi.CHINA={CODE:wi.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]});let Ni=function(e){return e.UPDATE_BITRATE_LIMIT="update_bitrate_limit",e}({});class Oi extends _{constructor(e,t){super(),this.onICEConnectionStateChange=void 0,this.onConnectionStateChange=void 0,this.onDTLSTransportStateChange=void 0,this.onDTLSTransportError=void 0,this.onICETransportStateChange=void 0,this.onFirstAudioReceived=void 0,this.onFirstVideoReceived=void 0,this.onFirstAudioDecoded=void 0,this.onFirstVideoDecoded=void 0,this.onFirstVideoDecodedTimeout=void 0,this.onSelectedLocalCandidateChanged=void 0,this.onSelectedRemoteCandidateChanged=void 0,this.getLocalVideoStats=void 0}}class Di extends Oi{constructor(e,t){super(e,t),this.establishPromise=void 0}}let Pi=function(e){return e.VIDEO="video",e.AUDIO="audio",e}({}),Li=function(e){return e[e.UDP=0]="UDP",e[e.TCP=1]="TCP",e[e.RELAY=2]="RELAY",e}({}),ki=function(e){return e[e.FIRST_CONNECTION=0]="FIRST_CONNECTION",e[e.TCP_RESTART=1]="TCP_RESTART",e[e.RELAY_RESTART=2]="RELAY_RESTART",e[e.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",e[e.OLD_RESTART=11]="OLD_RESTART",e[e.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED",e}({}),Mi=function(e){return e.LocalVideoTrack="videoTrack",e.LocalAudioTrack="audioTrack",e.LocalVideoLowTrack="videoLowTrack",e}({}),Ui=function(e){return e.New="new",e.Connected="connected",e.Reconnecting="reconnecting",e.Disconnected="disconnected",e}({}),Vi=function(e){return e.StateChange="stateChange",e.IceConnectionStateChange="iceConnectionStateChange",e.RequestMuteLocal="requestMuteLocal",e.RequestUnmuteLocal="requestUnmuteLocal",e.RequestRePublish="requestRePublish",e.RequestRePublishDataChannel="requestRePublishDataChannel",e.RequestReSubscribe="requestReSubscribe",e.RequestUploadStats="requestUploadStats",e.RequestUpload="requestUpload",e.MediaReconnectStart="MediaReconnectStart",e.MediaReconnectEnd="MediaReconnectEnd",e.NeedSignalRTT="NeedSignalRTT",e.RequestRestartICE="RequestRestartIce",e.PeerConnectionStateChange="PeerConnectionStateChange",e.RequestReconnect="RequestReconnect",e.RequestReconnectPC="RequestReconnectPC",e.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",e.P2PLost="P2PLost",e.UpdateVideoEncoder="UpdateVideoEncoder",e.ConnectionTypeChange="ConnectionTypeChange",e.RequestLowStreamParameter="RequestLowStreamParameter",e.QueryClientConnectionState="QueryClientConnectionState",e.LocalCandidate="LocalCandidate",e.RequestP2PMuteLocal="requestP2PMuteLocal",e.RequestP2PUnPublish="RequestP2PUnPublish",e.RequestP2PUnmuteRemote="RequestP2PUnmuteRemote",e.RequestP2PMuteRemote="RequestP2PMuteRemote",e.RequestP2PRestartICE="RequestP2PRestartICE",e}({}),xi=function(e){return e.CONNECTING="CONNECTING",e.RECONNECTING="RECONNECTING",e.CONNECTED="CONNECTED",e.CLOSED="CLOSED",e}({}),Fi=function(e){return e.CONNECTION_STATE_CHANGE="connection-state-change",e.STATE_CHANGE="state-change",e.INSPECT_RESULT="inspect-result",e.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",e.REQUEST_NEW_WORKER_URL="request-new-worker-url",e}({}),Bi=function(e){return e.CONNECTED="transmitter:connected",e.RECONNECTING="transmitter:reconnecting",e.WILL_RECONNECT="transmitter:will_reconnect",e.CLOSED="transmitter:closed",e.FAILED="transmitter:failed",e.ON_MESSAGE="transmitter:on_message",e.REQUEST_NEW_URLS="transmitter:request_new_urls",e.RECONNECT_WAITTING_FINISH="transmitter:reconnect_waitting_finish",e.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",e.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",e.FAILBACK="transmitter:failback",e.PRE_CONNECT_PC="transmitter:pre_connect_pc",e}({}),Gi=function(e){return e.CAMERA_CHANGED="camera-changed",e.MICROPHONE_CHANGED="microphone-changed",e.PLAYBACK_DEVICE_CHANGED="playback-device-changed",e.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",e.AUTOPLAY_FAILED="autoplay-failed",e.AUDIO_CONTEXT_STATE_CHANGED="audio-context-state-changed",e.SECURITY_POLICY_VIOLATION="security-policy-violation",e}({}),ji=function(e){return e.CONNECTING="CONNECTING",e.RECONNECTING="RECONNECTING",e.CONNECTED="CONNECTED",e.CLOSED="CLOSED",e}({}),Wi=function(e){return e.CONNECTION_STATE_CHANGE="connection-state-change",e.STATE_CHANGE="state-change",e.INSPECT_RESULT="inspect-result",e.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",e.REQUEST_NEW_WORKER_URL="request-new-worker-url",e}({}),Hi=function(e){return e.CALL="call",e.CANDIDATE="candidate",e.PUBLISH="publish",e.UNPUBLISH="unpublish",e.CONTROL="control",e.RESTART_ICE="restart_ice",e.ACK="ack",e.RESPONSE="response",e.JOIN="join",e.CHECK="check",e}({}),Ki=function(e){return e.ABORT="abort",e}({}),Yi=function(e){return e.MUTE_LOCAL_AUDIO="mute_local_audio",e.MUTE_LOCAL_VIDEO="mute_local_video",e.UNMUTE_LOCAL_AUDIO="unmute_local_audio",e.UNMUTE_LOCAL_VIDEO="unmute_local_video",e}({}),qi=function(e){return e.P2P_TOKEN_TIMEOUT="p2p_token_timeout",e.P2P_TOKEN_CHANGED="p2p_token_changed",e}({});const Ji={[ei.ACCESS_POINT]:{[ni.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[ni.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[ni.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[ni.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[ni.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[ni.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[ni.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[ni.NO_SERVICE_AVAILABLE_VOICE]:{desc:"no unilbs voice service available",retry:!0},[ni.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[ni.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[ni.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[ni.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[ni.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[ni.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[ni.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[ni.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[ni.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[ni.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[ei.UNILBS]:{[ii.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[ii.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[ii.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[ii.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[ii.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[ii.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[ii.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[ii.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[ii.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[ii.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[ii.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[ii.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1}},[ei.STRING_UID_ALLOCATOR]:{[ti.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[ti.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[ti.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function Xi(e){const t=Ji[Math.floor(e/1e4)];if(!t)return{desc:"unknown error",retry:!1};const i=t[e%1e4];if(!i){if(Math.floor(e/1e4)===ei.ACCESS_POINT){const t=e%1e4;if("1"===t.toString()[0])return{desc:e.toString(),retry:!1};if("2"===t.toString()[0])return{desc:e.toString(),retry:!0}}return{desc:"unknown error",retry:!1}}return i}const zi={[si.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[si.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[si.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[si.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[si.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[si.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[si.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[si.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[si.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[si.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[si.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[si.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[si.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[si.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[si.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[si.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[si.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[si.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[si.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[si.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[si.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[si.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[si.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[si.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[si.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[si.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[si.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[si.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[si.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[si.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[si.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[si.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[si.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[si.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[si.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[si.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[si.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[si.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[si.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[si.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[si.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[si.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[si.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[si.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[si.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[si.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[si.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[si.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[si.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[si.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[si.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[si.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[si.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[si.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[si.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[si.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[si.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[si.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[si.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[si.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[si.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[si.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[si.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function Qi(e){const t=zi[e];return t||{desc:"UNKNOWN_ERROR_".concat(e),action:"failed"}}function Zi(e){return e.every((e=>e.readyState===WebSocket.CLOSED||e.readyState===WebSocket.CLOSING))}function $i(e,t){if("string"==typeof e)return e;const{proxy:i,host:n,port:s}=e;if(t){const e=E("JOIN_GATEWAY_FALLBACK_PORT")||443;return 443===e?"wss://".concat(n,"/ws/?p=").concat(Number(s)+150):"wss://".concat(n,":").concat(e,"/ws/?p=").concat(Number(s)+150)}return i?"wss://".concat(i,"/ws/?h=").concat(n,"&p=").concat(s):"wss://".concat(n,":").concat(s)}const en=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,tn=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,nn=/wss:\/\/(.+):([0-9]+)\/?/,sn=/wss:\/\/(.[^\/]+)\/?/;let on=0;class an{constructor(e,t){this.id=0,this.store=void 0,this.recordIndex=void 0,this.websockets=[],this.try443PortDuration=2e3,this.forceCloseWSDuration=5e3,this.try443PortTimeout=null,this.forceCloseTimeout=null,this.isTry443PortFailed=!1,this.isNormalPortFailed=!1,this.useDoubleDomain=!1,this.useProxy=!1,this.startTime=Date.now(),this.id=++on,this.try443PortDuration=E("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=e||5e3,this.store=t}closeAllWebsockets(){this.websockets.forEach((e=>{e.onopen=null,e.onclose=null,e.onmessage=null,e.close()})),this.websockets.length=0}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout)}logger(){var e;const i=Date.now()-this.startTime;for(var n=arguments.length,s=new Array(n),o=0;o<n;o++)s[o]=arguments[o];t.debug("[choose-best-ws ".concat(null===(e=this.store)||void 0===e?void 0:e.clientId," ").concat(this.id,"] ").concat(i,"ms:"),...s)}createWebSocket(e,t,i){this.logger("createWebSocket:",e,{isTry443Port:t,hasTimeoutDetection:i});const n=E("GATEWAY_DOMAINS"),s=Date.now(),o=[],a=n.find((t=>e.host.includes(t)));a||(this.useDoubleDomain=!1);const r=[];if(this.useDoubleDomain)n.forEach((i=>{r.push($i(Xt(Xt({},e),{},{host:e.host.replace(a,i)}),t))}));else{const i=Xt({},e);if(t&&a){const e=n.find((e=>e!==a));e&&(i.host=i.host.replace(a,e))}r.push($i(i,t))}try{r.forEach((e=>{const t=new WebSocket(e);t.binaryType="arraybuffer",o.push(t),this.logger("ws is connecting:",t.url)}))}catch(n){if(this.logger("ws create failed"),o.forEach((e=>e.close())),o.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createWebSocket(e,t,i);if(!t&&443!==Number(e.port))return this.createWebSocket(e,!0,i);throw new ui(h.WS_ERR,"init websocket failed! Error: ".concat(n.toString()))}const c=m();this.store&&this.store.recordJoinChannelService({urls:o.map((e=>e.url)),service:"gateway"},this.recordIndex),o.forEach((e=>{e.onopen=()=>{this.logger("onopen: ws ".concat(e.url," open cost ").concat(Date.now()-s,"ms")),this.websockets.forEach((t=>{t!==e&&(t.onopen=null,t.onclose=null,t.onmessage=null,t.close(),this.logger("close backup websocket: ".concat(t.url)))})),this.websockets.length=0,c.resolve(e)},e.onclose=i=>{this.logger("onclose: ws ".concat(e.url," closed cost ").concat(Date.now()-s,"ms state: ").concat(e.readyState)),t?this.isTry443PortFailed=Zi(o):this.isNormalPortFailed=Zi(o),this.logger("443: ".concat(this.useProxy?"not try":this.isTry443PortFailed?"failed":"trying"," 47xx: ").concat(this.isNormalPortFailed?"failed":"trying")),(t&&this.isTry443PortFailed||!t&&(this.isTry443PortFailed||this.useProxy)&&this.isNormalPortFailed)&&(this.logger("onclose: all websocket is closed, ".concat(i.reason)),c.reject({code:i.code,reason:gi.A_ROUND_WS_FAILED}))},e.onmessage=t=>this.logger("".concat(e.url," onmessage: ").concat(t.data))})),this.websockets.push(...o);return i||(()=>{const i=()=>{this.logger("5s timeout close un-opens, isWebsocket created: ",c.isResolved),this.websockets.forEach((e=>e.readyState!==WebSocket.OPEN&&e.close()))};if(t||this.useProxy)return this.logger("add 5s timeout at ".concat(t?"try-443":"proxy"," condition")),this.forceCloseTimeout=window.setTimeout(i,this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout((()=>{if(this.logger("2s timeout, isWebsocket created: ",c.isResolved),c.isResolved)return i();S()&&f()&&i(),this.createWebSocket(e,!0,!0).then((e=>c.resolve(e))).catch((e=>{this.isNormalPortFailed&&c.reject(e),this.logger("try 443 port to create ws failed")})),this.forceCloseTimeout=window.setTimeout(i,this.forceCloseWSDuration)}),this.try443PortDuration)})(),c.promise}chooseBestWebsocket(e,i,n,s){return this.useDoubleDomain=!!i,"string"==typeof e&&(e=function(e){let i,n,s;return[,i,n,s]=e.match(en)||[],i||([,n,s]=e.match(tn)||[]),n&&s||([,n,s]=e.match(nn)||[]),n&&s||([,n]=e.match(sn)||[]),n||t.warning("un-destructible url: ",e),{proxy:i,host:n,port:s||"443"}}(e)),this.recordIndex=s,this.useProxy=!!e.proxy,n&&this.useProxy&&(t.warn("cannot use 443 only when use proxy"),n=!1),this.createWebSocket(e,!!n,!1).finally((()=>this.clearTimeout()))}}class rn extends _{get url(){return this.websocket&&this.websocket.url||null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){["tryNext","recover"].includes(e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,"reconnecting"===this._state?this.emit(hi.RECONNECTING,this.reconnectReason):"connected"===this._state?this.emit(hi.CONNECTED):"closed"===this._state?this.emit(hi.CLOSED):"failed"===this._state&&this.emit(hi.FAILED))}resetReconnectCount(e){t.debug("websocket reset reconnect count, reason: "+e),this.reconnectCount=0}constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5?arguments[5]:void 0;super(),this.connectionID=0,this.currentURLIndex=0,this.urls=[],this._reconnectMode="tryNext",this.reconnectReason=void 0,this._initMutex=new C("websocket"),this.name=void 0,this._state="closed",this.reconnectInterrupter=void 0,this.websocket=void 0,this.retryConfig=void 0,this.reconnectCount=0,this.forceCloseTimeout=5e3,this.onlineReconnectListener=void 0,this.useCompress=void 0,this.tryDoubleDomain=!1,this.use443PortOnly=!1,this.wsInflateLength=0,this.wsDeflateLength=0,this.closeEstablishingWs=()=>{},this.store=void 0,this.joinGatewayRecordIndex=void 0,this.store=o,this.name=e,this.retryConfig=Xt({},t),this.useCompress=i,this.tryDoubleDomain=n,this.use443PortOnly=s;const{timeout:a,timeoutFactor:r}=t,c=Math.max(300,Math.floor(3*a/5)),d=Math.max(1.2,Math.floor(8*r)/10);T.ONLINE&&(this.retryConfig.timeout=c,this.retryConfig.timeoutFactor=d),R.on(I.NETWORK_STATE_CHANGE,((e,t)=>{e!==t&&(this.resetReconnectCount("network state change: ".concat(t," -> ").concat(e)),e===T.ONLINE?(this.retryConfig.timeout=c,this.retryConfig.timeoutFactor=d):(this.retryConfig.timeout=a,this.retryConfig.timeoutFactor=r))}))}getConnection(){return this.websocket||void 0}async init(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const i=await this._initMutex.lock();this.forceCloseTimeout=t,this.urls=e,this.state="connecting";try{const e=m(),t=this.urls[this.currentURLIndex];E("ENABLE_PREALLOC_PC")&&this.emit(Bi.PRE_CONNECT_PC),this.createWebSocketConnection(t).then(e.resolve).catch(e.reject),this.once(hi.CLOSED,(()=>{e.reject(new l(h.WS_DISCONNECT))})),this.once(hi.CONNECTED,e.resolve),await e.promise}catch(e){}finally{i()}}close(e,t){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;const e=this.websocket;t?setTimeout((()=>e.close()),500):e.close(),this.websocket=void 0}this.state=e?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(e,i){if(!this.websocket)return void t.warning("[".concat(this.name,"] can not reconnect, no websocket"));void 0!==e&&(this.reconnectMode=e),t.debug("[".concat(this.name,"] reconnect is triggered initiative")),"number"==typeof this.joinGatewayRecordIndex&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(i)]},this.joinGatewayRecordIndex);const n=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),n&&n.bind(this.websocket)({code:9999,reason:i})}sendMessage(e){let t=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new l(h.WS_ABORT,"websocket is not ready");try{t||(e=JSON.stringify(e)),this.websocket.send(e)}catch(e){throw new l(h.WS_ERR,"send websocket message error"+e.toString())}}setWsInflateData(e){this.wsDeflateLength=this.wsDeflateLength+e.originLength,this.wsInflateLength=this.wsInflateLength+e.compressedLength}getWsInflateData(){const e=this.wsInflateLength,t=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:e,wsDeflateLength:t}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(e){var i;const n=m();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;const s=e=>{var i;null===(i=this.store)||void 0===i||i.signalChannelOpen(),t.debug("[".concat(this.name,"] websocket opened:"),e),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),n.resolve()},o=async e=>{var i;if(t.debug("[".concat(this.name,"] websocket close ").concat(null===(i=this.websocket)||void 0===i?void 0:i.url,", code: ").concat(e.code,", reason: ").concat(e.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)n.reject(new l(h.WS_DISCONNECT,"websocket close: ".concat(e.code))),this.close();else{"connected"===this.state&&(this.reconnectReason=e.reason,this.state="reconnecting");const i=y(this,hi.WILL_RECONNECT,this.reconnectMode,e.reason)||this.reconnectMode,s=await this.reconnectWithAction(i);if("closed"===this.state)return void t.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!s)return n.reject(new l(h.WS_DISCONNECT,"websocket reconnect failed: ".concat(e.code))),this.close(!0);n.resolve()}},a=e=>{this.emit(hi.ON_MESSAGE,e)},r=e=>{t.warn("[".concat(this.connectionID,"] ws open error ").concat(e))};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),E("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(e=E("GATEWAY_WSS_ADDRESS")),t.debug("[".concat(this.name,"] start connect, url:"),e);const c=null===(i=this.store)||void 0===i?void 0:i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var d;const t=await this.chooseBestWebsocketConnection(e);this.websocket=t,s&&s(this.websocket.url),this.websocket.onclose=o,this.websocket.onmessage=a,this.websocket.onerror=r,null===(d=this.store)||void 0===d||d.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this.joinGatewayRecordIndex=c}catch(e){const i="closed"===this.state,s=e instanceof l,a=s&&e.code===h.WS_ABORT,r=s&&e.code===h.WS_ERR,d=s?e.message:e&&(e.reason||e.toString());t.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(d)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:a?"aborted":"error",errors:[e]},c),i||r?(n.reject(i?new l(h.WS_DISCONNECT,"websocket is closed: ".concat(d)):new l(h.WS_ERR,"init websocket failed: ".concat(d))),r&&t.error("[".concat(this.name,"] init websocket failed: ").concat(d))):o&&o(e)}return n.promise}async reconnectWithAction(e){let i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount)return!1;if(0===this.urls.length)return!1;if("closed"===this.state)return!1;t.warning("[choose-best-ws] action: =>",e),this.onlineReconnectListener||R.isOnline||!R.onlineWaiter||(this.onlineReconnectListener=R.onlineWaiter.then((()=>{this.onlineReconnectListener=void 0})));let n=!0;if(this.reconnectInterrupter=()=>n=!1,i){const i=g(this.reconnectCount,this.retryConfig);t.debug("[".concat(this.name,"] wait ").concat(i,"ms to reconnect websocket, mode: ").concat(e)),await Promise.race([A(i),this.onlineReconnectListener||new Promise((()=>{}))])}if("closed"===this._state||!n)return!1;this.reconnectCount+=1;const s=async(e,t)=>{this.emit(hi.RECONNECT_CREATE_CONNECTION,t),await this.createWebSocketConnection(e)};try{if("retry"===e)this.emit(hi.RECONNECT_WAITTING_FINISH,e),await s(this.urls[this.currentURLIndex],e);else if("tryNext"===e){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);t.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),this.emit(hi.RECONNECT_WAITTING_FINISH,e),await s(this.urls[this.currentURLIndex],e)}else"recover"===e&&(t.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.emit(hi.RECONNECT_WAITTING_FINISH,e),this.urls=await v(this,hi.REQUEST_NEW_URLS),this.currentURLIndex=0,await s(this.urls[this.currentURLIndex],e))}catch(n){var o;t.error("[".concat(this.name,"] reconnect failed ").concat(n&&n.toString()));const s=null==n||null===(o=n.data)||void 0===o?void 0:o.desc;return Array.isArray(s)&&s.includes("dynamic key expired")?(this.emit(hi.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):this.reconnectWithAction(e,i)}return!0}}class cn extends rn{constructor(e,t){super(e,t,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(e,i){const n=m(),s=(o=this.forceCloseTimeout,a=this.store,new an(o,a));var o,a;this.closeEstablishingWs=()=>{t.debug("[choose-best-ws] close establishing websockets"),s.closeAllWebsockets(),n.reject(new l(h.WS_ABORT,"choose best websocket aborted"))};const r=E("GATEWAY_DOMAINS");return t.debug("[choose-best-ws] currentDomain: ",e,", domains: ",r,"total: ".concat(this.urls.length),"current: ".concat(this.currentURLIndex+1)),s.chooseBestWebsocket(e,this.tryDoubleDomain,this.use443PortOnly,i).then(n.resolve).catch(n.reject),n.promise.finally((()=>{this.closeEstablishingWs=void 0}))}}class dn extends _{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===oi.CONNECTED?this.emit(ai.WS_CONNECTED):e===oi.RECONNECTING?this.emit(ai.WS_RECONNECTING,this._websocketReconnectReason):e===oi.CLOSED&&this.emit(ai.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,t){super(),this._disconnectedReason=void 0,this._websocketReconnectReason=void 0,this._connectionState=oi.CLOSED,this.reconnectToken=void 0,this.websocket=void 0,this.openConnectionTime=void 0,this.clientId=void 0,this.lastMsgTime=Date.now(),this.uploadCache=[],this.uploadCacheInterval=void 0,this.rttRolling=new w(5),this.pingpongTimer=void 0,this.wsInflateDataTimer=void 0,this.pingpongTimeoutCount=0,this.joinResponse=void 0,this.multiIpOption=void 0,this.initError=void 0,this.spec=void 0,this.store=void 0,this.onWebsocketMessage=e=>{if(e.data instanceof ArrayBuffer)return void this.emit(ai.ON_BINARY_DATA,e.data);const t=JSON.parse(e.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(t,"_id")){const e="res-@".concat(t._id);this.emit(e,t._result,t._message)}else if(Object.prototype.hasOwnProperty.call(t,"_type")){if(this.emit(t._type,t._message),t._type===di.ON_NOTIFICATION&&this.handleNotification(t._message),t._type===di.ON_USER_BANNED)switch(t._message.error_code){case 14:this.close(b.UID_BANNED);break;case 15:this.close(b.IP_BANNED);break;case 16:this.close(b.CHANNEL_BANNED)}if(t._type===di.ON_USER_LICENSE_BANNED)switch(t._message.error_code){case si.ERR_LICENSE_MISSING:this.close(b.LICENSE_MISSING);break;case si.ERR_LICENSE_EXPIRED:this.close(b.LICENSE_EXPIRED);break;case si.ERR_LICENSE_MINUTES_EXCEEDED:this.close(b.LICENSE_MINUTES_EXCEEDED);break;case si.ERR_LICENSE_PERIOD_INVALID:this.close(b.LICENSE_PERIOD_INVALID);break;case si.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(b.LICENSE_MULTIPLE_SDK_SERVICE);break;case si.ERR_LICENSE_ILLEGAL:this.close(b.LICENSE_ILLEGAL);break;default:this.close()}}},this.clientId=e.clientId,this.spec=e,this.store=t,this.websocket=new cn("gateway-".concat(this.clientId),this.spec.retryConfig,!0,E("JOIN_GATEWAY_USE_DUAL_DOMAIN"),E("JOIN_GATEWAY_USE_443PORT_ONLY"),t),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===oi.CONNECTED&&this.reconnect("retry",N.OFFLINE)}))}async request(e,i,n,s){const o=O(6,""),a={_id:o,_type:e,_message:i},r=this.websocket.connectionID,c=()=>new Promise(((t,i)=>{if(this.connectionState===oi.CONNECTED)return t();const n=()=>{this.off(ai.WS_CLOSED,s),t()},s=()=>{this.off(ai.WS_CONNECTED,n),i(new ui(h.WS_ABORT))};this.once(ai.WS_CONNECTED,n),this.once(ai.WS_CLOSED,s),e!==ri.PUBLISH&&e!==ri.PUBLISH_DATASTREAM&&e!==ri.SUBSCRIBE&&e!==ri.SUBSCRIBE_DATASTREAM&&e!==ri.UNSUBSCRIBE&&e!==ri.UNSUBSCRIBE_DATASTREAM&&e!==ri.UNPUBLISH&&e!==ri.UNPUBLISH_DATASTREAM&&e!==ri.CONTROL&&e!==ri.RESTART_ICE||this.once(ai.DISCONNECT_P2P,(()=>{i(new ui(h.DISCONNECT_P2P))})),e!==ri.PUBLISH&&e!==ri.RESTART_ICE||this.once(ai.ABORT_P2P_EXECUTION,(()=>{i(new ui(h.DISCONNECT_P2P))}))}));if(this.connectionState!==oi.CONNECTING&&this.connectionState!==oi.RECONNECTING||e===ri.JOIN||e===ri.REJOIN||await c(),this.websocket.sendMessage(a,!0),s)return;const d=new Promise(((n,s)=>{let a=!1;const c=(t,s)=>{a=!0,n({isSuccess:"success"===t,message:s||{}}),this.off(ai.WS_CLOSED,d),this.off(ai.WS_RECONNECTING,d),this.emit(ai.REQUEST_SUCCESS,e,i)};this.once("res-@".concat(o),c);const d=()=>{s(new ui(h.WS_ABORT,"type: ".concat(e))),this.off(ai.WS_CLOSED,d),this.off(ai.WS_RECONNECTING,d),this.off("res-@".concat(o),c)};this.once(ai.WS_CLOSED,d),this.once(ai.WS_RECONNECTING,d),A(E("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==r||a||(t.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(ai.REQUEST_TIMEOUT,e,i))}))}));let l=null;try{l=await d}catch(t){if(this.connectionState===oi.CLOSED||e===ri.LEAVE)throw new ui(h.WS_ABORT);return!this.spec.forceWaitGatewayResponse||n?t.throw():e===ri.JOIN||e===ri.REJOIN?null:(await c(),await this.request(e,i))}if(l.isSuccess)return l.message;const u=Number(l.message.error_code||l.message.code),p=Qi(u),_=new ui(h.UNEXPECTED_RESPONSE,"".concat(p.desc,": ").concat(l.message.error_str),{code:u,data:l.message,desc:p.desc});return"success"===p.action?l.message:(t.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(u,", message: ").concat(p.desc,", action: ").concat(p.action)),u===si.ERR_TOO_MANY_BROADCASTERS?e===ri.JOIN||e===ri.REJOIN?(this.initError=_,this.close(),_.throw()):_.throw():"failed"===p.action?_.throw():"quit"===p.action?(this.initError=_,this.close(),_.throw()):(u===si.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,t.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",N.MULTI_IP)):this.reconnect(p.action,N.SERVER_ERROR),e===ri.JOIN||e===ri.REJOIN?null:await this.request(e,i)))}waitMessage(e,t){return new Promise((i=>{const n=s=>{(!t||t(s))&&(this.off(e,n),i(s))};this.on(e,n)}))}uploadWRTCStats(e){if(!this.store.sessionId)return void t.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const i={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(ci.WRTC_STATS,i)}upload(e,t){const i={_type:e,_message:t};try{this.websocket.sendMessage(i)}catch(e){const t=E("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>t&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==oi.CONNECTED)return;const e=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(e._type,e._message)}),E("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,t){const i={_type:e,_message:t};this.websocket.sendMessage(i)}init(e,t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Promise(((t,i)=>{this.once(ai.WS_CONNECTED,(()=>t(this.joinResponse))),this.once(ai.WS_CLOSED,(()=>i(this.initError||new ui(h.WS_ABORT)))),this.connectionState=oi.CONNECTING,this.websocket.init(e).catch(i),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval((()=>{this.handleWsInflateData()}),2e4)}))}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||b.LEAVE,this.connectionState=oi.CLOSED,t.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close()}async join(){if(!this.joinResponse){this.emit(ai.ABORT_P2P_EXECUTION);const e=await v(this,ai.REQUEST_JOIN_INFO),t=await this.request(ri.JOIN,e);if(!t)return this.emit(ai.REPORT_JOIN_GATEWAY,gi.TIMEOUT,this.url||""),!1;this.joinResponse=t,this.emit(ai.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=oi.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new ui(h.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const e=D(this,ai.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;const t=await this.request(ri.REJOIN,e);return!!t&&(this.connectionState=oi.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),t.peers&&t.peers.forEach((e=>{this.emit(di.ON_USER_ONLINE,{uid:e.uid}),e.audio&&this.emit(di.ON_ADD_AUDIO_STREAM,{uid:e.uid,uint_id:e.uint_id,audio:!0,ssrcId:e.audio_ssrc}),e.video&&this.emit(di.ON_ADD_VIDEO_STREAM,{uid:e.uid,uint_id:e.uint_id,video:!0,ssrcId:e.video_ssrc}),e.audio_mute?this.emit(di.MUTE_AUDIO,{uid:e.uid}):this.emit(di.UNMUTE_AUDIO,{uid:e.uid}),e.video_mute?this.emit(di.MUTE_VIDEO,{uid:e.uid}):this.emit(di.UNMUTE_VIDEO,{uid:e.uid}),e.audio_enable_local?this.emit(di.ENABLE_LOCAL_AUDIO,{uid:e.uid}):this.emit(di.DISABLE_LOCAL_AUDIO,{uid:e.uid}),e.video_enable_local?this.emit(di.ENABLE_LOCAL_VIDEO,{uid:e.uid}):this.emit(di.DISABLE_LOCAL_VIDEO,{uid:e.uid}),e.audio||e.video||this.emit(di.ON_REMOVE_STREAM,{uid:e.uid,uint_id:e.uint_id})})),!0)}reconnect(e,t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,t)}handleNotification(e){t.debug("[".concat(this.clientId,"] receive notification: "),e);const i=Qi(e.code);if("success"!==i.action){if("failed"!==i.action)return"quit"===i.action?("ERR_REPEAT_JOIN_CHANNEL"===i.desc&&this.close(b.UID_BANNED),void this.close()):void this.reconnect(i.action,N.SERVER_ERROR);t.error("[".concat(this.clientId,"] ignore error: "),i.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=E("PING_PONG_TIME_OUT"),i=Date.now();this.pingpongTimeoutCount>=e&&(t.warning("[".concat(this.clientId,"] PING-PONG Timeout. Last Socket Message: ").concat(i-this.lastMsgTime,"ms")),i-this.lastMsgTime>E("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",N.TIMEOUT):this.request(ri.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const e=Date.now()-i;this.rttRolling.add(e),E("REPORT_STATS")&&this.send(ri.PING_BACK,{pingpongElapse:e})})).catch((e=>{}))}handleWsInflateData(){const{wsInflateLength:e,wsDeflateLength:t}=this.websocket.getWsInflateData();0!==e&&0!==t&&this.upload(ci.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:t,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(hi.RECONNECT_WAITTING_FINISH,(e=>{this.emit(ai.WS_RECONNECT_WAITTING_FINISH,e)})),this.websocket.on(hi.RECONNECT_CREATE_CONNECTION,(e=>{this.emit(ai.WS_RECONNECT_CREATE_CONNECTION,e)})),this.websocket.on(hi.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(hi.CLOSED,(()=>{this.connectionState=oi.CLOSED})),this.websocket.on(hi.FAILED,(()=>{this._disconnectedReason=b.NETWORK_ERROR,this.connectionState=oi.CLOSED})),this.websocket.on(hi.RECONNECTING,(e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===oi.CONNECTED?this.connectionState=oi.RECONNECTING:this.connectionState=oi.CONNECTING})),this.websocket.on(hi.WILL_RECONNECT,((e,i,n)=>{const s=D(this,ai.IS_P2P_DISCONNECTED),o=s||"retry"!==e;s&&"retry"===e&&(t.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),e="tryNext",i=gi.P2P_DISCONNECTED),o&&(t.debug("".concat(this.clientId," will renewSession, reconnect mode: ").concat(e)),this.emit(ai.REPORT_JOIN_GATEWAY,i||gi.UNKNOWN_REASON,this.url||""),this.reconnectToken=void 0,this.emit(ai.DISCONNECT_P2P)),n(e)})),this.websocket.on(hi.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch((e=>{t.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",N.SERVER_ERROR)})):this.join().catch((e=>{if(this.emit(ai.REPORT_JOIN_GATEWAY,e,this.url||""),e instanceof ui){if(e.code===h.UNEXPECTED_RESPONSE&&e.data.code===si.ERR_NO_AUTHORIZED)return this.initError=new ui(h.CAN_NOT_GET_GATEWAY_SERVER,"AgoraRTCError CAN_NOT_GET_GATEWAY_SERVER: dynamic key expired"),t.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",N.SERVER_ERROR);t.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",N.SERVER_ERROR):(this.initError=e,this.close())}}))})),this.websocket.on(hi.REQUEST_NEW_URLS,((e,t)=>{v(this,ai.REQUEST_RECOVER,this.multiIpOption).then(e).catch(t)})),this.websocket.on(hi.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(di.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})),this.websocket.on(Bi.PRE_CONNECT_PC,(()=>{this.emit(ai.PRE_CONNECT_PC)}))}}let ln=function(e){return e[e.CHOOSE_SERVER=11]="CHOOSE_SERVER",e[e.CLOUD_PROXY=18]="CLOUD_PROXY",e[e.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",e[e.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK",e}({});function hn(e){return e.match(/^[\.\:\d]+$/)?"".concat(e.replace(/[^\d]/g,"-"),".").concat(E("TURN_DOMAIN")):(t.info("Unidentified as ip: ".concat(e,", use as host")),e)}function un(e,i){e.addresses||(e.addresses=[]);const n=function(e,i){if(E("CONNECT_GATEWAY_WITHOUT_DOMAIN"))return e.map((e=>{let{ip:t,port:i}=e;return{address:"".concat(t,":").concat(i)}}));const n=E("GATEWAY_DOMAINS");let s=n[1]&&i.includes(n[1])?1:0;return e.map((e=>{let{domain_prefix:i,port:o,ip:a}=e;if(i)return{address:"".concat(i,".").concat(n[s++%n.length],":").concat(o)};const r=/^[\.\:\d]+$/.test(a),c=r?"".concat(a.replace(/[^\d]/g,"-"),".").concat(n[s++%n.length],":").concat(o):"".concat(a,":").concat(o);return r||t.info("Unidentified as ip: ".concat(a,", use as host")),{ip:a,port:o,address:c}}))}(e.addresses,i),s=Array.isArray(e.detail)&&e.detail[18];if(s&&"string"==typeof s){const e=s.split(";");for(let t=0;t<e.length;t++){const i=e[t].trim();n[t]&&i&&(n[t].ip6=i)}}const o=e.detail&&e.detail.candidate;let a;if(o){const[e,t]=o.split(":");e&&t&&(a={port:Number(t),ip:e,address:"".concat(e,":").concat(t)})}return{gatewayAddrs:n,apGatewayAddress:a,uid:e.uid,cid:e.cid,cert:e.cert,vid:e.detail&&e.detail[8],uni_lbs_ip:e.detail&&e.detail[1],res:e,csIp:e.detail&&e.detail[502]}}function pn(e){return"number"==typeof e?e:e.exact||e.ideal||e.max||e.min||0}function _n(e){const t=e._encoderConfig;if(!t)return{};const i={resolution:t.width&&t.height?"".concat(pn(t.width),"x").concat(pn(t.height)):void 0,maxVideoBW:t.bitrateMax,minVideoBW:t.bitrateMin};return"number"==typeof t.frameRate?(i.maxFrameRate=t.frameRate,i.minFrameRate=t.frameRate):t.frameRate&&(i.maxFrameRate=t.frameRate.max||t.frameRate.ideal||t.frameRate.exact||t.frameRate.min,i.minFrameRate=t.frameRate.min||t.frameRate.ideal||t.frameRate.exact||t.frameRate.max),i}function En(e){return e>=0&&e<.17?1:e>=.17&&e<.36?2:e>=.36&&e<.59?3:e>=.59&&e<=1?4:e>1?5:0}function mn(e,t){let i,n,s;switch(t){case ln.CHOOSE_SERVER:n=4096,s="choose server";break;case ln.CLOUD_PROXY:n=1048576,s="proxy";break;case ln.CLOUD_PROXY_5:n=4194304,s="proxy5";break;case ln.CLOUD_PROXY_FALLBACK:n=4194310,s="proxy fallback";break;default:throw new ui(h.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:e.detail&&e.detail[502],retry:!1})}if(e.response_body.forEach((t=>{t.buffer&&t.buffer.flag===n&&(i={code:t.buffer.code,addresses:(t.buffer.edges_services||[]).map((e=>Xt(Xt({},e),{},{ticket:t.buffer.cert}))),server_ts:e.enter_ts,uid:t.buffer.uid,cid:t.buffer.cid,cname:t.buffer.cname,detail:Xt(Xt({},t.buffer.detail),e.detail),flag:t.buffer.flag,opid:e.opid,cert:t.buffer.cert})})),!i)throw new ui(h.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(s," from multi unilbs response"),{csIp:e.detail&&e.detail[502]});return i}async function Sn(e,t){return await Promise.all(e.addresses.map((async e=>({address:hn(e.ip),tcpport:e.port,udpport:e.port,username:t&&E("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?t.toString():Vt.username,password:t&&E("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await P(t.toString()):Vt.password}))))}function fn(e,i){const n=i.getMediaStreamTrack(!0).getSettings(),s=i.videoHeight||n.height,o=i.videoWidth||n.width;return s&&o?Math.max(Math.min(s,o)/Math.min(pn(e.height),pn(e.width)),1):(t.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function Cn(e){let{candidateType:t,relayProtocol:i,type:n,address:s,port:o,protocol:a}=e;return"local-candidate"===n?{candidateType:t,relayProtocol:i,protocol:a}:{candidateType:t,relayProtocol:i,address:s,port:o,protocol:a}}class Tn extends _{constructor(e,t){super(),this.signal=void 0,this.token=void 0,this.tokenTimeout=void 0,this.tokenInterval=void 0,this._sequence=0,this.userMap=new Map,this.encoder=new TextEncoder,this.signal=e,this.token=t;const i=()=>{this.signal.connectionState===oi.CONNECTED&&this.check(),0===this.userMap.size?this.tokenInterval=window.setTimeout(i,1e3):this.tokenInterval=window.setTimeout(i,3*E("P2P_TOKEN_INTERVAL"))};i()}async send(e,i,n,s,o){var a,r;if(0===this.userMap.size)return;const c=Array.from(this.userMap.values())[0].token;"string"!=typeof i&&(i=JSON.stringify(i)),s=null!==(a=s)&&void 0!==a?a:O(6,""),o=null!==(r=o)&&void 0!==r?r:this._sequence++;const d={_id:s,_type:e,_seq:o,_message:i,token:"".concat(this.token,"_").concat(c)};E("SHOW_P2P_LOG")&&t.debug("send message",d,"noNeedResponse : ".concat(n));this.splitMessage(JSON.stringify(d)).forEach((e=>{this.signal.request(ri.DATA_STREAM,{payload:L(this.encoder.encode(e))})}));const u=new Promise(((i,o)=>{const a=window.setTimeout((()=>{this.off("res-@".concat(s,"_ack"),r),this.off("res-@".concat(s),u),this.off(Ki.ABORT,c),t.debug("[external-signal] request timeout, type: ".concat(e,", requestId: ").concat(s)),0===this.userMap.size?o(new l(h.INVALID_REMOTE_USER)):o(new l(h.TIMEOUT))}),E("EXTERNAL_SIGNAL_REQUEST_TIMEOUT")),r=()=>{a&&window.clearTimeout(a),this.off(Ki.ABORT,c),n&&i()},c=()=>{a&&window.clearTimeout(a),this.off("res-@".concat(s,"_ack"),r),this.off("res-@".concat(s),u),o(new l(h.EXTERNAL_SIGNAL_ABORT,"type: ".concat(e,", requestId: ").concat(s)))};this.once(Ki.ABORT,c),this.once("res-@".concat(s,"_ack"),r);const u=(t,n)=>{p=!0,a&&window.clearTimeout(a),this.off("res-@".concat(s,"_ack"),r),this.off(Ki.ABORT,c),"success"===t?i(n):o(new l(h.P2P_MESSAGE_FAILED,"request ".concat(e," failed, requestId: ").concat(s)))};let p=!1;n||(this.once("res-@".concat(s),u),A(E("SIGNAL_REQUEST_TIMEOUT")).then((()=>{p||t.warning("external_signal request timeout, type: ".concat(e,", requestId: ").concat(s,", ").concat(d))})))}));try{return await u}catch(t){if(t.code===h.TIMEOUT)return await this.send(e,i,n,s,o);throw t}}onMessage(e){const{_uid:i}=e;let n,s=this.userMap.get(i);if(s)n=s.splitMessageMap;else{if(this.userMap.size>0||!("_type"in e)||e._type!==Hi.CHECK)return;const{token:t}=e;n=new Map,s={uid:i,isStart:!0,token:t,splitMessageMap:n,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map},this.userMap.set(i,s),this.signal.emit(di.ON_USER_ONLINE,{uid:i}),this.handleUserOnline()}if("id"in e&&"total"in e){var o;const{id:t,total:s}=e,a=null!==(o=n.get(t))&&void 0!==o?o:[];if(a.push(e),n.has(t)||n.set(t,a),a.length!==s)return;{const s=a.sort(((e,t)=>e.index-t.index)).map((e=>e.payload)).join("");n.delete(t),(e=JSON.parse(s))._uid=i}}const{_type:a,token:r}=e;if([Hi.ACK,Hi.CHECK].includes(a))return a===Hi.CHECK&&this.handleCheckToken(s,r),void this.receiveMessage(e);r==="".concat(s.token,"_").concat(this.token)?this.handleReceivedMessage(e):t.debug('Receive unexpected message", '.concat(r,", cur_token: ").concat(s.token,"_").concat(this.token),e)}check(){const e={_id:O(6,""),token:this.token,_type:Hi.CHECK};E("SHOW_P2P_LOG")&&t.debug("send message",e),this.signal.request(ri.DATA_STREAM,{payload:L(this.encoder.encode(JSON.stringify(e)))})}ack(e){const i={_id:e,_type:Hi.ACK,token:this.token};E("SHOW_P2P_LOG")&&t.debug("send message",i),this.signal.request(ri.DATA_STREAM,{payload:L(this.encoder.encode(JSON.stringify(i)))})}response(e,t,i){this.send(Hi.RESPONSE,JSON.stringify({success:!i,message:t}),!0,e)}handleReceivedMessage(e){const i=()=>{this.userMap.forEach((e=>{const{receivedMessagesMap:t,nextExpectedSequenceNumber:i}=e;for(;t.has(i);){const n=t.get(i);t.delete(i),this.receiveMessage(n),e.nextExpectedSequenceNumber++}}))};if(!e)return void i();const{_uid:n,_seq:s}=e,o=this.userMap.get(n),{receivedMessagesMap:a,isStart:r,nextExpectedSequenceNumber:c}=o;if(s<c)return this.ack(e._id),void t.debug("[external-signal] receive old message, seq: ".concat(s,", ").concat(e._message));a.set(s,e),r&&s===c&&(this.receiveMessage(e),a.delete(c),o.nextExpectedSequenceNumber++,i())}receiveMessage(e){const{_id:i,_type:n,_message:s,_uid:o}=e;if(E("SHOW_P2P_LOG")&&t.debug("receive message",e),i){let t;switch(e._type!==Hi.ACK&&(s&&(t=JSON.parse(s)),this.ack(e._id)),e._type){case Hi.CANDIDATE:case Hi.CONTROL:this.signal.emit(n,t,o);break;case Hi.PUBLISH:case Hi.UNPUBLISH:case Hi.RESTART_ICE:case Hi.CALL:t.uid=o,v(this.signal,n,t).then((t=>{this.response(e._id,t)})).catch((()=>{this.response(e._id,void 0,!0)}));break;case Hi.ACK:this.getListeners("res-@".concat(i,"_ack")).length>0&&this.emit("res-@".concat(i,"_ack"));break;case Hi.RESPONSE:{const{success:e,message:n}=t;this.emit("res-@".concat(i),e?"success":"failed",n);break}}}}splitMessage(e){if(e.length<Tn.MAX_MESSAGE_SIZE)return[e];const t=[],{remoteToken:i}=JSON.parse(e),n=O(6,"");let s=0,o=800;const a=Math.ceil(e.length/o);for(;e.length>0;){s++;const r={id:n,index:s,total:a,payload:e.slice(0,o),token:"".concat(this.token,"_").concat(i)};JSON.stringify(r).length>Tn.MAX_MESSAGE_SIZE?o-=50:(t.push(r),e=e.slice(o))}return t.map((e=>JSON.stringify(e)))}handleCheckToken(e,i){return e.token!==i?(t.debug("token changed, from ".concat(e.token," to ").concat(i)),this.reset(e.uid,i),!1):(this.tokenTimeout&&(window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0),this.tokenTimeout=window.setTimeout((()=>{t.debug("token timeout, ".concat(i)),this.reset(e.uid)}),E("MAX_P2P_TIMEOUT")),!0)}async handleUserOnline(){const e=await v(this.signal,Hi.CALL,void 0),t=await this.send(Hi.CALL,e);this.signal.emit(ai.P2P_CONNECTION,t,!0)}async reset(e,i){const n=this.userMap.get(e);n&&(this.emit(Ki.ABORT),this.signal.emit(di.ON_USER_OFFLINE,{uid:n.uid,reason:qi.P2P_TOKEN_CHANGED}),this._sequence=0,this.userMap.clear(),i||(t.debug("change local token from ".concat(i," to ").concat(i)),this.token=O(6,"")))}clear(){this._sequence=0,this.userMap.clear(),this.tokenInterval&&window.clearTimeout(this.tokenInterval),this.tokenInterval=void 0,this.tokenTimeout&&window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0,this.emit(Ki.ABORT)}}Tn.MAX_SIZE=1,Tn.MAX_MESSAGE_SIZE=1024;class Rn extends _{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===oi.CONNECTED?this.emit(ai.WS_CONNECTED):e===oi.RECONNECTING?this.emit(ai.WS_RECONNECTING,this._websocketReconnectReason):e===oi.CLOSED&&this.emit(ai.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,i){super(),this._disconnectedReason=void 0,this._websocketReconnectReason=void 0,this._connectionState=oi.CLOSED,this.reconnectToken=void 0,this.p2pToken=void 0,this.websocket=void 0,this.openConnectionTime=void 0,this.clientId=void 0,this.lastMsgTime=Date.now(),this.uploadCache=[],this.uploadCacheInterval=void 0,this.rttRolling=new w(5),this.pingpongTimer=void 0,this.pingpongTimeoutCount=0,this.joinResponse=void 0,this.multiIpOption=void 0,this.initError=void 0,this.spec=void 0,this.store=void 0,this._external_signal=void 0,this.onWebsocketMessage=e=>{if(e.data instanceof ArrayBuffer)return void this.emit(ai.ON_BINARY_DATA,e.data);const i=JSON.parse(e.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(i,"_id")){const e="res-@".concat(i._id);this.emit(e,i._result,i._message)}else if(Object.prototype.hasOwnProperty.call(i,"_type")){switch(i._type){case di.ON_DATA_STREAM:return void this.handleDataStream(i._message);case di.MUTE_AUDIO:case di.MUTE_VIDEO:case di.ON_P2P_LOST:case di.ON_USER_ONLINE:return;case di.ON_USER_OFFLINE:const{uid:e}=i._message;return t.debug("[".concat(this.clientId,"] user-offline uid: ").concat(e)),void this._external_signal.reset(e)}if(this.emit(i._type,i._message),i._type===di.ON_NOTIFICATION&&this.handleNotification(i._message),i._type===di.ON_USER_BANNED)switch(i._message.error_code){case 14:this.close(b.UID_BANNED);break;case 15:this.close(b.IP_BANNED);break;case 16:this.close(b.CHANNEL_BANNED)}if(i._type===di.ON_USER_LICENSE_BANNED)switch(i._message.error_code){case si.ERR_LICENSE_MISSING:this.close(b.LICENSE_MISSING);break;case si.ERR_LICENSE_EXPIRED:this.close(b.LICENSE_EXPIRED);break;case si.ERR_LICENSE_MINUTES_EXCEEDED:this.close(b.LICENSE_MINUTES_EXCEEDED);break;case si.ERR_LICENSE_PERIOD_INVALID:this.close(b.LICENSE_PERIOD_INVALID);break;case si.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(b.LICENSE_MULTIPLE_SDK_SERVICE);break;case si.ERR_LICENSE_ILLEGAL:this.close(b.LICENSE_ILLEGAL);break;default:this.close()}}},this.clientId=e.clientId,this.spec=e,this.store=i,this.websocket=new cn("gateway-".concat(this.clientId),this.spec.retryConfig,!0,E("JOIN_GATEWAY_USE_DUAL_DOMAIN"),E("JOIN_GATEWAY_USE_443PORT_ONLY"),i),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===oi.CONNECTED&&this.reconnect("retry",N.OFFLINE)})),this.p2pToken=O(6,""),this._external_signal=new Tn(this,this.p2pToken)}async request(e,i,n,s){const o=O(6,""),a={_id:o,_type:e,_message:i},r=this.websocket.connectionID,c=()=>new Promise(((e,t)=>{if(this.connectionState===oi.CONNECTED)return e();const i=()=>{this.off(ai.WS_CLOSED,n),e()},n=()=>{this.off(ai.WS_CONNECTED,i),t(new l(h.WS_ABORT))};this.once(ai.WS_CONNECTED,i),this.once(ai.WS_CLOSED,n)}));if(this.connectionState!==oi.CONNECTING&&this.connectionState!==oi.RECONNECTING||e===ri.JOIN||e===ri.REJOIN||await c(),this.websocket.sendMessage(a,!0),s)return;const d=new Promise(((n,s)=>{let a=!1;const c=(t,s)=>{a=!0,n({isSuccess:"success"===t,message:s||{}}),this.off(ai.WS_CLOSED,d),this.off(ai.WS_RECONNECTING,d),this.emit(ai.REQUEST_SUCCESS,e,i)};this.once("res-@".concat(o),c);const d=()=>{s(new l(h.WS_ABORT,"type: ".concat(e))),this.off(ai.WS_CLOSED,d),this.off(ai.WS_RECONNECTING,d),this.off("res-@".concat(o),c)};this.once(ai.WS_CLOSED,d),this.once(ai.WS_RECONNECTING,d),A(E("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==r||a||(t.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(ai.REQUEST_TIMEOUT,e,i))}))}));let u=null;try{u=await d}catch(t){if(this.connectionState===oi.CLOSED||e===ri.LEAVE)throw new l(h.WS_ABORT);return!this.spec.forceWaitGatewayResponse||n?t.throw():e===ri.JOIN||e===ri.REJOIN?null:(await c(),await this.request(e,i))}if(u.isSuccess)return u.message;const p=Number(u.message.error_code||u.message.code),_=Qi(p),m=new l(h.UNEXPECTED_RESPONSE,"".concat(_.desc,": ").concat(u.message.error_str),{code:p,data:u.message,desc:_.desc});return"success"===_.action?u.message:(t.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(p,", message: ").concat(_.desc,", action: ").concat(_.action)),p===si.ERR_TOO_MANY_BROADCASTERS?e===ri.JOIN||e===ri.REJOIN?(this.initError=m,this.close(),m.throw()):m.throw():"failed"===_.action?m.throw():"quit"===_.action?(this.initError=m,this.close(),m.throw()):(p===si.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=u.message.option,t.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",N.MULTI_IP)):this.reconnect(_.action,N.SERVER_ERROR),e===ri.JOIN||e===ri.REJOIN?null:await this.request(e,i)))}waitMessage(e,t){return new Promise((i=>{const n=s=>{(!t||t(s))&&(this.off(e,n),i(s))};this.on(e,n)}))}uploadWRTCStats(e){if(!this.store.sessionId)return void t.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const i={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(ci.WRTC_STATS,i)}upload(e,t){const i={_type:e,_message:t};try{this.websocket.sendMessage(i)}catch(e){const t=E("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>t&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==oi.CONNECTED)return;const e=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(e._type,e._message)}),E("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,t){const i={_type:e,_message:t};this.websocket.sendMessage(i)}async sendExtensionMessage(e,t,i){return await this._external_signal.send(e,t,i)}init(e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Promise(((t,i)=>{this.once(ai.WS_CONNECTED,(()=>t(this.joinResponse))),this.once(ai.WS_CLOSED,(()=>i(this.initError||new l(h.WS_ABORT)))),this.connectionState=oi.CONNECTING,this.websocket.init(e).catch(i)}))}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._external_signal.clear(),this._disconnectedReason=e||b.LEAVE,this.connectionState=oi.CLOSED,t.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),this.p2pToken=O(6,""),this._external_signal.clear(),this._external_signal=new Tn(this,this.p2pToken)}async join(){if(!this.joinResponse){this.emit(ai.ABORT_P2P_EXECUTION);const e=await v(this,ai.REQUEST_JOIN_INFO),t=await this.request(ri.JOIN,e);if(!t)return this.emit(ai.REPORT_JOIN_GATEWAY,h.TIMEOUT,this.url||""),!1;this.joinResponse=t,this.emit(ai.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=oi.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}reconnect(e,t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,t)}handleDataStream(e){try{const t=k(e.payload),i=(new TextDecoder).decode(t),n=JSON.parse(i);"total"in n&&"id"in n||Object.values(Hi).includes(n._type)?(n._uid=e.uid,this._external_signal.onMessage(n)):this.emit(di.ON_DATA_STREAM,e)}catch(t){this.emit(di.ON_DATA_STREAM,e)}}handleNotification(e){t.debug("[".concat(this.clientId,"] receive notification: "),e);const i=Qi(e.code);if("success"!==i.action){if("failed"!==i.action)return"quit"===i.action?("ERR_REPEAT_JOIN_CHANNEL"===i.desc&&this.close(b.UID_BANNED),void this.close()):void this.reconnect(i.action,N.SERVER_ERROR);t.error("[".concat(this.clientId,"] ignore error: "),i.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=E("PING_PONG_TIME_OUT"),i=Date.now();this.pingpongTimeoutCount>=e&&(t.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(i-this.lastMsgTime,"ms")),i-this.lastMsgTime>E("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",N.TIMEOUT):this.request(ri.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const e=Date.now()-i;this.rttRolling.add(e),E("REPORT_STATS")&&this.send(ri.PING_BACK,{pingpongElapse:e})})).catch((e=>{}))}handleWebsocketEvents(){this.websocket.on(hi.RECONNECT_WAITTING_FINISH,(e=>{this.emit(ai.WS_RECONNECT_WAITTING_FINISH,e)})),this.websocket.on(hi.RECONNECT_CREATE_CONNECTION,(e=>{this.emit(ai.WS_RECONNECT_CREATE_CONNECTION,e)})),this.websocket.on(hi.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(hi.CLOSED,(()=>{this.connectionState=oi.CLOSED})),this.websocket.on(hi.FAILED,(()=>{this._disconnectedReason=b.NETWORK_ERROR,this.connectionState=oi.CLOSED})),this.websocket.on(hi.RECONNECTING,(e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===oi.CONNECTED?this.connectionState=oi.RECONNECTING:this.connectionState=oi.CONNECTING})),this.websocket.on(hi.WILL_RECONNECT,((e,i,n)=>{"retry"!==e?(t.debug("".concat(this.clientId," websocket will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0):t.debug("".concat(this.clientId," reconnect mode is retry, no need to renew session")),n(e)})),this.websocket.on(hi.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.join().catch((e=>{if(this.emit(ai.REPORT_JOIN_GATEWAY,e,this.url||""),e instanceof l&&e.code===h.UNEXPECTED_RESPONSE&&e.data.code===si.ERR_NO_AUTHORIZED)return t.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",N.SERVER_ERROR);t.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",N.SERVER_ERROR):(this.initError=e,this.close())}))})),this.websocket.on(hi.REQUEST_NEW_URLS,((e,t)=>{v(this,ai.REQUEST_RECOVER,this.multiIpOption).then(e).catch(t)})),this.websocket.on(hi.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(di.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}))}}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var In={exports:{}},gn=In.exports=(()=>{var e={8:(e,t,i)=>{i.r(t),i.d(t,{Parser:()=>I,Printer:()=>w,parse:()=>D,print:()=>P});const n="\n",s="".concat("\r").concat(n),o=" ";let a;function r(e){return e>="0"&&e<="9"}function c(e){return e>="!"&&e<="~"}function d(e){return c(e)||e>=""&&e<=""}function l(e){return"!"===e||e>="#"&&e<="'"||e>="*"&&e<="+"||e>="-"&&e<="."||e>="0"&&e<="9"||e>="A"&&e<="Z"||e>="^"&&e<="~"}function h(e){return e>="1"&&e<="9"}function u(e){return e>="A"&&e<="Z"||e>="a"&&e<="z"}function p(e){return"d"===e||"h"===e||"m"===e||"s"===e}function _(e){return e>""&&e<"\t"||e>"\v"&&e<"\f"||e>""&&e<""}function E(e){return u(e)||r(e)||"+"===e||"/"===e}function m(e){return r(e)||u(e)||"+"===e||"/"===e||"-"===e||"_"===e}function S(e){return u(e)||r(e)||"+"===e||"/"===e}function f(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function C(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?f(Object(i),!0).forEach((function(t){T(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):f(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function T(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}!function(e){e.VERSION="v",e.ORIGIN="o",e.SESSION_NAME="s",e.INFORMATION="i",e.URI="u",e.EMAIL="e",e.PHONE="p",e.CONNECTION="c",e.BANDWIDTH="b",e.TIME="t",e.REPEAT="r",e.ZONE_ADJUSTMENTS="z",e.KEY="k",e.ATTRIBUTE="a",e.MEDIA="m"}(a||(a={}));class R{consumeText(e,t){let i=t;for(;i<e.length;){const t=e[i];if("\0"===t||"\r"===t||t===n)break;i+=1}if(i-t==0)throw new Error("Invalid text, at ".concat(e));return i}consumeUnicastAddress(e,t,i){return this.consumeTill(e,t,o)}consumeOneOrMore(e,t,i){let n=t;for(;i(e[n]);)n++;if(n-t==0)throw new Error("Invalid rule at ".concat(t,"."));return n}consumeSpace(e,t){if(e[t]===o)return t+1;throw new Error("Invalid space at ".concat(t,"."))}consumeIP4Address(e,t){let i=t;for(let t=0;t<4;t++)if(i=this.consumeDecimalUChar(e,i),3!==t){if("."!==e[i])throw new Error("Invalid IP4 address.");i++}return i}consumeDecimalUChar(e,t){let i=t;for(let t=0;t<3&&r(e[i]);t++,i++);if(i-t==0)throw new Error("Invalid decimal uchar.");const n=parseInt(e.slice(t,i));if(n>=0&&n<=255)return i;throw new Error("Invalid decimal uchar")}consumeIP6Address(e,t){let i=this.consumeHexpart(e,t);return":"===e[i]?(i+=1,i=this.consumeIP4Address(e,i),i):i}consumeHexpart(e,t){let i=t;if(":"===e[i]&&":"===e[i+1]){i+=2;try{i=this.consumeHexseq(e,i)}catch(e){}return i}if(i=this.consumeHexseq(e,i),":"===e[i]&&":"===e[i+1]){i+=2;try{i=this.consumeHexseq(e,i)}catch(e){}return i}return i}consumeHexseq(e,t){let i=t;for(;i=this.consumeHex4(e,i),":"===e[i]&&":"!==e[i+1];)i+=1;return i}consumeHex4(e,t){let i=0;for(;i<4;i++)if(!((n=e[t+i])>="0"&&n<="9"||n>="a"&&n<="f"||n>="A"&&n<="F")){if(0===i)throw new Error("Invalid hex 4");break}var n;return t+i}consumeFQDN(e,t){let i=t;for(;r(e[i])||u(e[i])||"-"===e[i]||"."===e[i];)i+=1;if(i-t<4)throw new Error("Invalid FQDN");return i}consumeExtnAddr(e,t){return this.consumeOneOrMore(e,t,d)}consumeMulticastAddress(e,t,i){switch(i){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(e,t);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(e,t);default:try{return this.consumeFQDN(e,t)}catch(i){return this.consumeExtnAddr(e,t)}}}consumeIP6MulticastAddress(e,t){const i=this.consumeHexpart(e,t);return"/"===e[i]?this.consumeInteger(e,i+1):i}consumeIP4MulticastAddress(e,t){let i=t+3;const n=e.slice(t,i),s=parseInt(n);if(s<224||s>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let t=0;t<3;t++){if("."!==e[i])throw new Error("Invalid IP4 multicast address.");i+=1,i=this.consumeDecimalUChar(e,i)}return"/"===e[i]&&(i+=1),i=this.consumeTTL(e,i),"/"===e[i]&&(i=this.consumeInteger(e,i)),i}consumeInteger(e,t){if(!h(e[t]))throw new Error("Invalid integer.");for(t+=1;r(e[t]);)t+=1;return t}consumeTTL(e,t){if("0"===e[t])return t+1;if(!h(e[t]))throw new Error("Invalid TTL.");t+=1;for(let i=0;i<2&&r(e[t]);i++)t+=1;return t}consumeToken(e,t){return this.consumeOneOrMore(e,t,l)}consumeTime(e,t){let i=t;if("0"===e[i])return i+1;for(h(e[i])&&(i+=1);r(e[i]);)i++;if(i-t<10)throw new Error("Invalid time");return i}consumeAddress(e,t){return this.consumeTill(e,t,o)}consumeTypedTime(e,t){let i=t;return i=this.consumeOneOrMore(e,i,r),p(e[i])?i+1:i}consumeRepeatInterval(e,t){if(!h(e[t]))throw new Error("Invalid repeat interval");for(t+=1;r(e[t]);)t+=1;return p(e[t])&&(t+=1),t}consumePort(e,t){return this.consumeOneOrMore(e,t,r)}consume(e,t,i){for(let n=0;n<i.length;n++){if(t+n>=e.length)throw new Error("consume exceeding value length");if(e[t+n]!==i[n])throw new Error("consume ".concat(i," failed at ").concat(n))}return t+i.length}consumeTill(e,t,i){let n=t;for(;n<e.length&&("string"!=typeof i||e[n]!==i)&&("function"!=typeof i||!i(e[n]));)n++;return n}}class I extends R{constructor(){super(),T(this,"records",[]),T(this,"currentLine",0)}parse(e){const t=this.probeEOL(e);this.records=e.split(t).filter((e=>!!e.trim())).map(this.parseLine),this.currentLine=0;const i=this.parseVersion(),n=this.parseOrigin(),s=this.parseSessionName(),o=this.parseInformation(),a=this.parseUri(),r=this.parseEmail(),c=this.parsePhone(),d=this.parseConnection(),l=this.parseBandWidth(),h=this.parseTimeFields(),u=this.parseKey(),p=this.parseSessionAttribute(),_=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:i,origin:n,sessionName:s,information:o,uri:a,emails:r,phones:c,connection:d,bandwidths:l,timeFields:h,key:u,attributes:p,mediaDescriptions:_}}getCurrentRecord(){const e=this.records[this.currentLine];if(!e)throw new Error("Record doesn't exit.");return e}probeEOL(e){for(let t=0;t<e.length;t++)if(e[t]===n)return"\r"===e[t-1]?s:n;throw new Error("Invalid newline character.")}parseLine(e,t){if(e.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");const i=e[0];if("="!==e[1])throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:i,value:e.slice(2),line:t,cur:0}}parseSessionAttribute(){const e=new A;for(;this.currentLine<this.records.length;){const t=this.getCurrentRecord();if(t.type!==a.ATTRIBUTE)break;const i={attField:this.extractOneOrMore(t,(e=>l(e)&&":"!==e)),_cur:0};":"===t.value[t.cur]&&(t.cur+=1,i.attValue=this.extractOneOrMore(t,_)),e.parse(i),this.currentLine++}return e.digest()}parseMediaAttributes(e){const t=new v(e);for(;this.currentLine<this.records.length;){const e=this.getCurrentRecord();if(e.type!==a.ATTRIBUTE)break;const i={attField:this.extractOneOrMore(e,(e=>l(e)&&":"!==e)),_cur:0};":"===e.value[e.cur]&&(e.cur+=1,i.attValue=this.extractOneOrMore(e,_)),t.parse(i),this.currentLine++}return t.digest()}parseKey(){const e=this.getCurrentRecord();if(e.type===a.KEY){if("prompt"===e.value||"clear:"===e.value||"base64:"===e.value||"uri:"===e.value)return e.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){const e=this.getCurrentRecord();if(e.type===a.ZONE_ADJUSTMENTS){const t=[];for(;;)try{const i=this.extract(e,this.consumeTime);this.consumeSpaceForRecord(e);let n=!1;"-"===e.value[e.cur]&&(n=!0,e.cur+=1);const s=this.extract(e,this.consumeTypedTime);t.push({time:i,typedTime:s,back:n})}catch(e){break}if(0===t.length)throw new Error("Invalid zone adjustments");return this.currentLine++,t}return[]}parseRepeat(){const e=[];for(;;){const t=this.getCurrentRecord();if(t.type!==a.REPEAT)break;{const i=this.extract(t,this.consumeRepeatInterval),n=this.parseTypedTime(t);e.push({repeatInterval:i,typedTimes:n}),this.currentLine++}}return e}parseTypedTime(e){const t=[];for(;;)try{this.consumeSpaceForRecord(e),t.push(this.extract(e,this.consumeTypedTime))}catch(e){break}if(0===t.length)throw new Error("Invalid typed time.");return t}parseTime(){const e=this.getCurrentRecord(),t=this.extract(e,this.consumeTime);this.consumeSpaceForRecord(e);const i=this.extract(e,this.consumeTime);return this.currentLine++,{startTime:t,stopTime:i}}parseBandWidth(){const e=[];for(;this.currentLine<this.records.length;){const t=this.getCurrentRecord();if(t.type!==a.BANDWIDTH)break;{const i=this.extractOneOrMore(t,l);if(":"!==t.value[t.cur])throw new Error("Invalid bandwidth field.");t.cur++;const n=this.extractOneOrMore(t,r);e.push({bwtype:i,bandwidth:n}),this.currentLine++}}return e}parseVersion(){const e=this.getCurrentRecord();if(e.type!==a.VERSION)throw new Error("first sdp record must be version");const t=e.value.slice(0,this.consumeOneOrMore(e.value,0,r));if(t.length!==e.value.length)throw new Error('invalid proto version, "v='.concat(e.value,'"'));return this.currentLine++,t}parseOrigin(){const e=this.getCurrentRecord();if(e.type!==a.ORIGIN)throw new Error("second line of sdp must be origin");const t=this.extractOneOrMore(e,d);this.consumeSpaceForRecord(e);const i=this.extractOneOrMore(e,r);this.consumeSpaceForRecord(e);const n=this.extractOneOrMore(e,r);this.consumeSpaceForRecord(e);const s=this.extractOneOrMore(e,l);this.consumeSpaceForRecord(e);const o=this.extractOneOrMore(e,l);this.consumeSpaceForRecord(e);const c=this.extract(e,this.consumeUnicastAddress);return this.currentLine++,{username:t,sessId:i,sessVersion:n,nettype:s,addrtype:o,unicastAddress:c}}parseSessionName(){const e=this.getCurrentRecord();if(e.type===a.SESSION_NAME){const t=this.extract(e,this.consumeText);return this.currentLine++,t}}parseInformation(){const e=this.getCurrentRecord();if(e.type!==a.INFORMATION)return;const t=this.extract(e,this.consumeText);return this.currentLine++,t}parseUri(){const e=this.getCurrentRecord();if(e.type===a.URI)return this.currentLine++,e.value}parseEmail(){const e=[];for(;;){const t=this.getCurrentRecord();if(t.type!==a.EMAIL)break;e.push(t.value),this.currentLine++}return e}parsePhone(){const e=[];for(;;){const t=this.getCurrentRecord();if(t.type!==a.PHONE)break;e.push(t.value),this.currentLine++}return e}parseConnection(){const e=this.getCurrentRecord();if(e.type===a.CONNECTION){const t=this.extractOneOrMore(e,l);this.consumeSpaceForRecord(e);const i=this.extractOneOrMore(e,l);this.consumeSpaceForRecord(e);const n=this.extract(e,this.consumeAddress);return this.currentLine++,{nettype:t,addrtype:i,address:n}}}parseMedia(){const e=this.getCurrentRecord(),t=this.extract(e,this.consumeToken);this.consumeSpaceForRecord(e);let i=this.extract(e,this.consumePort);"/"===e.value[e.cur]&&(e.cur+=1,i+=this.extract(e,this.consumeInteger)),this.consumeSpaceForRecord(e);const n=[];for(n.push(this.extract(e,this.consumeToken));"/"===e.value[e.cur];)e.cur+=1,n.push(this.extract(e,this.consumeToken));if(0===n.length)throw new Error("Invalid proto");const s=this.parseFmt(e);return this.currentLine++,{mediaType:t,port:i,protos:n,fmts:s}}parseTimeFields(){const e=[];for(;this.getCurrentRecord().type===a.TIME;){const t=this.parseTime(),i=this.parseRepeat(),n=this.parseZone();e.push({time:t,repeats:i,zones:n})}return e}parseMediaDescription(){const e=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===a.MEDIA;){const t=this.parseMedia(),i=this.parseInformation(),n=this.parseConnections(),s=this.parseBandWidth(),o=this.parseKey(),a=this.parseMediaAttributes(t);e.push({media:t,information:i,connections:n,bandwidths:s,key:o,attributes:a})}return e}parseConnections(){const e=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===a.CONNECTION;)e.push(this.parseConnection());return e}parseFmt(e){const t=[];for(;;)try{this.consumeSpaceForRecord(e),t.push(this.extract(e,this.consumeToken))}catch(e){break}if(0===t.length)throw new Error("Invalid fmts");return t}extract(e,t){for(var i=arguments.length,n=new Array(i>2?i-2:0),s=2;s<i;s++)n[s-2]=arguments[s];const o=t.call(this,e.value,e.cur,...n),a=e.value.slice(e.cur,o);return e.cur=o,a}extractOneOrMore(e,t){const i=this.consumeOneOrMore(e.value,e.cur,t),n=e.value.slice(e.cur,i);return e.cur=i,n}consumeSpaceForRecord(e){if(e.value[e.cur]!==o)throw new Error("Invalid space at ".concat(e.cur,"."));e.cur+=1}}class g extends R{constructor(){super(...arguments),T(this,"attributes",void 0),T(this,"digested",!1)}extractOneOrMore(e,t,i){const n=this.consumeOneOrMore(e.attValue,e._cur,t),s=e.attValue.slice(e._cur,n),[o,a]=i||[];if("number"==typeof o&&s.length<o)throw new Error("error in length, should be more or equal than ".concat(o," characters."));if("number"==typeof a&&s.length>a)throw new Error("error in length, should be less or equal than ".concat(a," characters."));return e._cur=n,s}consumeAttributeSpace(e){if(e.attValue[e._cur]!==o)throw new Error("Invalid space at ".concat(e._cur,"."));e._cur+=1}extract(e,t){if(!e.attValue)throw new Error("Nothing to extract from attValue.");for(var i=arguments.length,n=new Array(i>2?i-2:0),s=2;s<i;s++)n[s-2]=arguments[s];const o=t.call(this,e.attValue,e._cur,...n),a=e.attValue.slice(e._cur,o);return e._cur=o,a}atEnd(e){if(!e.attValue)throw new Error;return e._cur>=e.attValue.length}peekChar(e){if(!e.attValue)throw new Error;return e.attValue[e._cur]}peek(e,t){if(!e.attValue)throw new Error;for(let i=0;i<t.length;i++)if(t[i]!==e.attValue[e._cur+i])return!1;return!0}parseIceUfrag(e){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(e,E,[4,256])}parseIcePwd(e){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(e,E,[22,256])}parseIceOptions(e){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");const t=[];for(;!this.atEnd(e);){t.push(this.extractOneOrMore(e,E));try{this.consumeAttributeSpace(e)}catch(t){if(this.atEnd(e))break;throw t}}this.attributes.iceOptions=t}parseFingerprint(e){const t=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill);this.attributes.fingerprints.push({hashFunction:t,fingerprint:i})}parseExtmap(e){const t=this.extractOneOrMore(e,r);let i;"/"===this.peekChar(e)&&(this.extract(e,this.consume,"/"),i=this.extract(e,this.consumeToken)),this.consumeAttributeSpace(e);const n=this.extract(e,this.consumeTill,o),s=C(C({entry:parseInt(t,10)},i&&{direction:i}),{},{extensionName:n});this.peekChar(e)===o&&(this.consumeAttributeSpace(e),s.extensionAttributes=this.extract(e,this.consumeTill)),this.attributes.extmaps.push(s)}parseSetup(e){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");const t=this.extract(e,this.consumeTill);if("active"!==t&&"passive"!==t&&"actpass"!==t&&"holdconn"!==t)throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=t}}class A extends g{constructor(){super(...arguments),T(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(e){if(this.digested)throw new Error("already digested");try{switch(e.attField){case"group":this.parseGroup(e);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(e);break;case"ice-pwd":this.parseIcePwd(e);break;case"ice-options":this.parseIceOptions(e);break;case"fingerprint":this.parseFingerprint(e);break;case"setup":this.parseSetup(e);break;case"tls-id":this.parseTlsId(e);break;case"identity":this.parseIdentity(e);break;case"extmap":this.parseExtmap(e);break;case"msid-semantic":this.parseMsidSemantic(e);break;default:e.ignored=!0,this.attributes.unrecognized.push(e)}}catch(t){throw console.error("parsing session attribute ".concat(e.attField,' error, "a=').concat(e.attField,":").concat(e.attValue,'"')),t}if(!e.ignored&&e.attValue&&!this.atEnd(e))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(e){const t=this.extract(e,this.consumeToken),i=[];for(;!this.atEnd(e)&&this.peekChar(e)===o;)this.consumeAttributeSpace(e),i.push(this.extract(e,this.consumeToken));this.attributes.groups.push({semantic:t,identificationTag:i})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(e){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(e,m)}parseIdentity(e){const t=this.extractOneOrMore(e,S),i=[];for(;!this.atEnd(e)&&this.peekChar(e)===o;){this.consumeAttributeSpace(e);const t=this.extract(e,this.consumeToken);this.extract(e,this.consume,"=");const n=this.extractOneOrMore(e,(e=>e!==o&&_(e)));i.push({name:t,value:n})}this.attributes.identities.push({assertionValue:t,extensions:i})}parseMsidSemantic(e){this.peekChar(e)===o&&this.consumeAttributeSpace(e);const t={semantic:this.extract(e,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(e)}catch(e){break}if("*"===this.peekChar(e)){this.extract(e,this.consume,"*"),t.applyForAll=!0;break}{const i=this.extract(e,this.consumeTill,o);t.identifierList.push(i)}}this.attributes.msidSemantic=t}}class v extends g{constructor(e){super(),T(this,"attributes",void 0),-1!==e.protos.indexOf("RTP")||e.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(e){if(this.digested)throw new Error("already digested");try{switch(e.attField){case"extmap":this.parseExtmap(e);break;case"setup":this.parseSetup(e);break;case"ice-ufrag":this.parseIceUfrag(e);break;case"ice-pwd":this.parseIcePwd(e);break;case"ice-options":this.parseIceOptions(e);break;case"candidate":this.parseCandidate(e);break;case"remote-candidate":this.parseRemoteCandidate(e);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(e);break;case"rtpmap":this.parseRtpmap(e);break;case"ptime":this.parsePtime(e);break;case"maxptime":this.parseMaxPtime(e);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(e);break;case"ssrc":this.parseSSRC(e);break;case"fmtp":this.parseFmtp(e);break;case"rtcp-fb":this.parseRtcpFb(e);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(e);break;case"mid":this.parseMid(e);break;case"msid":this.parseMsid(e);break;case"imageattr":this.parseImageAttr(e);break;case"rid":this.parseRid(e);break;case"simulcast":this.parseSimulcast(e);break;case"sctp-port":this.parseSctpPort(e);break;case"max-message-size":this.parseMaxMessageSize(e);break;case"ssrc-group":this.parseSSRCGroup(e);break;default:e.ignored=!0,this.attributes.unrecognized.push(e)}}catch(t){throw console.error("parsing media attribute ".concat(e.attField,' error, "a=').concat(e.attField,":").concat(e.attValue,'"')),t}if(!e.ignored&&e.attValue&&!this.atEnd(e))throw new Error("attribute parsing error")}parseCandidate(e){const t=this.extractOneOrMore(e,E,[1,32]);this.consumeAttributeSpace(e);const i=this.extractOneOrMore(e,r,[1,5]);this.consumeAttributeSpace(e);const n=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e);const s=this.extractOneOrMore(e,r,[1,10]);this.consumeAttributeSpace(e);const a=this.extract(e,this.consumeAddress);this.consumeAttributeSpace(e);const d=this.extract(e,this.consumePort);this.consumeAttributeSpace(e),this.extract(e,this.consume,"typ"),this.consumeAttributeSpace(e);const l={foundation:t,componentId:i,transport:n,priority:s,connectionAddress:a,port:d,type:this.extract(e,this.consumeToken),extension:{}};for(this.peek(e," raddr")&&(this.extract(e,this.consume," raddr"),this.consumeAttributeSpace(e),l.relAddr=this.extract(e,this.consumeAddress)),this.peek(e," rport")&&(this.extract(e,this.consume," rport"),this.consumeAttributeSpace(e),l.relPort=this.extract(e,this.consumePort));this.peekChar(e)===o;){this.consumeAttributeSpace(e);const t=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e),l.extension[t]=this.extractOneOrMore(e,c)}this.attributes.candidates.push(l)}parseRemoteCandidate(e){const t=[];for(;;){const i=this.extractOneOrMore(e,r,[1,5]);this.consumeAttributeSpace(e);const n=this.extract(e,this.consumeAddress);this.consumeAttributeSpace(e);const s=this.extract(e,this.consumePort);t.push({componentId:i,connectionAddress:n,port:s});try{this.consumeAttributeSpace(e)}catch(e){break}}this.attributes.remoteCandidatesList.push(t)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(e){const t=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill,"/");this.extract(e,this.consume,"/");const n={encodingName:i,clockRate:this.extractOneOrMore(e,r)};this.atEnd(e)||"/"!==this.peekChar(e)||(this.extract(e,this.consume,"/"),n.encodingParameters=parseInt(this.extract(e,this.consumeTill),10));const s=this.attributes.payloads.find((e=>e.payloadType===parseInt(t,10)));s?s.rtpMap=n:this.attributes.payloads.push({payloadType:parseInt(t,10),rtpMap:n,rtcpFeedbacks:[]})}parsePtime(e){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(e,this.consumeTill)}parseMaxPtime(e){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(e,this.consumeTill)}parseDirection(e){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=e.attField}parseSSRC(e){const t=this.extractOneOrMore(e,r);this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill,":");let n;":"===this.peekChar(e)&&(this.extract(e,this.consume,":"),n=this.extract(e,this.consumeTill));const s=this.attributes.ssrcs.find((e=>e.ssrcId===parseInt(t,10)));s?s.attributes[i]=n:this.attributes.ssrcs.push({ssrcId:parseInt(t,10),attributes:{[i]:n}})}parseFmtp(e){const t=this.extract(e,this.consumeTill,o);this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill),n={};i.split(";").forEach((e=>{let[t,i]=e.split("=");t=t.trim();const s="string"==typeof i?i.trim():null;"string"==typeof t&&t.length>0&&(n[t]=s)}));const s=this.attributes.payloads.find((e=>e.payloadType===parseInt(t,10)));s?s.fmtp={parameters:n}:this.attributes.payloads.push({payloadType:parseInt(t,10),rtcpFeedbacks:[],fmtp:{parameters:n}})}parseFmtParameters(e){const t={},i=this.extract(e,this.consumeTill,"=");e._cur++;const n=this.extract(e,this.consumeTill,";");for(t[i]=n;";"===e.attValue[e._cur];){const i=this.extract(e,this.consumeTill,"=");e._cur++;const n=this.extract(e,this.consumeTill,";");t[i]=n}return t}parseRtcpFb(e){let t="";t="*"===this.peekChar(e)?this.extract(e,this.consume,"*"):this.extract(e,this.consumeTill,o),this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill,o);let n;if("trr-int"===i)n={type:i,interval:this.extract(e,this.consumeTill)};else{const t={type:i};this.peekChar(e)===o&&(this.consumeAttributeSpace(e),t.parameter=this.extract(e,this.consumeToken),this.peekChar(e)===o&&(t.additional=this.extract(e,this.consumeTill))),n=t}if("*"===t)this.attributes.rtcpFeedbackWildcards.push(n);else{const e=this.attributes.payloads.find((e=>e.payloadType===parseInt(t,10)));e?e.rtcpFeedbacks.push(n):this.attributes.payloads.push({payloadType:parseInt(t,10),rtcpFeedbacks:[n]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(e){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");const t={port:this.extract(e,this.consumePort)};this.peekChar(e)===o&&(this.consumeAttributeSpace(e),t.netType=this.extractOneOrMore(e,l),this.consumeAttributeSpace(e),t.addressType=this.extractOneOrMore(e,l),this.consumeAttributeSpace(e),t.address=this.extract(e,this.consumeAddress)),this.attributes.rtcp=t}parseMsid(e){const t={id:this.extractOneOrMore(e,l,[1,64])};this.peekChar(e)===o&&(this.consumeAttributeSpace(e),t.appdata=this.extractOneOrMore(e,l,[1,64])),this.attributes.msids.push(t)}parseImageAttr(e){this.attributes.imageattr.push(e.attValue)}parseRid(e){const t=this.extractOneOrMore(e,(e=>u(e)||r(e)||"_"===e||"-"===e));this.consumeAttributeSpace(e);const i={id:t,direction:this.extract(e,this.consumeToken),params:[]};if(this.peekChar(e)===o){if(this.consumeAttributeSpace(e),this.peek(e,"pt=")){this.extract(e,this.consume,"pt=");const t=[];for(;;){const i=this.extract(e,this.consumeToken);t.push(i);try{this.extract(e,this.consume,",")}catch(e){break}}i.payloads=t,this.peekChar(e)===o&&this.extract(e,this.consume,o)}for(;;){const t=this.extract(e,this.consumeToken);switch(t){case"depend":{const n={type:t,rids:this.extract(e,this.consume,"=").split(",")};i.params.push(n);break}default:{const n={type:t};"="===this.peekChar(e)&&(this.extract(e,this.consume,"="),n.val=this.extract(e,this.consumeTill,";")),i.params.push(n)}}try{this.extract(e,this.consume,";")}catch(e){break}}}this.attributes.rids.push(i)}parseSimulcast(e){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=e.attValue,this.extract(e,this.consumeTill)}parseSctpPort(e){this.attributes.sctpPort=this.extractOneOrMore(e,r,[1,5])}parseMaxMessageSize(e){this.attributes.maxMessageSize=this.extractOneOrMore(e,r,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(e){this.attributes.mid=this.extract(e,this.consumeToken)}parseSSRCGroup(e){const t=this.extract(e,this.consumeToken),i=[];for(;;)try{this.consumeAttributeSpace(e);const t=this.extract(e,this.consumeInteger);i.push(parseInt(t,10))}catch(e){break}this.attributes.ssrcGroups.push({semantic:t,ssrcIds:i})}}function y(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class w{constructor(){y(this,"eol",s)}print(e,t){let i="";return t&&(this.eol=t),i+=this.printVersion(e.version),i+=this.printOrigin(e.origin),i+=this.printSessionName(e.sessionName),i+=this.printInformation(e.information),i+=this.printUri(e.uri),i+=this.printEmail(e.emails),i+=this.printPhone(e.phones),i+=this.printConnection(e.connection),i+=this.printBandwidth(e.bandwidths),i+=this.printTimeFields(e.timeFields),i+=this.printKey(e.key),i+=this.printSessionAttributes(e.attributes),i+=this.printMediaDescription(e.mediaDescriptions),i}printVersion(e){return"v=".concat(e).concat(this.eol)}printOrigin(e){return"o=".concat(e.username," ").concat(e.sessId," ").concat(e.sessVersion," ").concat(e.nettype," ").concat(e.addrtype," ").concat(e.unicastAddress).concat(this.eol)}printSessionName(e){return e?"s=".concat(e).concat(this.eol):""}printInformation(e){return e?"i=".concat(e).concat(this.eol):""}printUri(e){return e?"u=".concat(e).concat(this.eol):""}printEmail(e){let t="";for(const i of e)t+="e=".concat(i).concat(this.eol);return t}printPhone(e){let t="";for(const i of e)t+="e=".concat(i).concat(this.eol);return t}printConnection(e){return e?"c=".concat(e.nettype," ").concat(e.addrtype," ").concat(e.address).concat(this.eol):""}printBandwidth(e){let t="";for(const i of e)t+="b=".concat(i.bwtype,":").concat(i.bandwidth).concat(this.eol);return t}printTimeFields(e){let t="";for(const i of e){t+="t=".concat(i.time.startTime," ").concat(i.time.startTime).concat(this.eol);for(const e of i.repeats)t+="r=".concat(e.repeatInterval," ").concat(e.typedTimes.join(" ")).concat(this.eol);i.zoneAdjustments&&(t+="z=",t+="z=".concat(i.zoneAdjustments.map((e=>"".concat(e.time," ").concat(e.back?"-":""," ").concat(e.typedTime))).join(" ")).concat(this.eol),t+=this.eol)}return t}printKey(e){return e?"k=".concat(e).concat(this.eol):""}printAttributes(e){let t="";for(const i of e)t+="a=".concat(i.attField).concat(i.attValue?":".concat(i.attValue):"").concat(this.eol);return t}printMediaDescription(e){let t="";for(const i of e)t+=this.printMedia(i.media),t+=this.printInformation(i.information),t+=this.printConnections(i.connections),t+=this.printBandwidth(i.bandwidths),t+=this.printKey(i.key),t+=this.printMediaAttributes(i);return t}printConnections(e){let t="";for(const i of e)t+=this.printConnection(i);return t}printMedia(e){return"m=".concat(e.mediaType," ").concat(e.port," ").concat(e.protos.join("/")," ").concat(e.fmts.join(" ")).concat(this.eol)}printSessionAttributes(e){return new N(this.eol).print(e)}printMediaAttributes(e){return new O(this.eol).print(e)}}class b{constructor(e){y(this,"eol",void 0),this.eol=e}printIceUfrag(e){return void 0===e?"":"a=ice-ufrag:".concat(e).concat(this.eol)}printIcePwd(e){return void 0===e?"":"a=ice-pwd:".concat(e).concat(this.eol)}printIceOptions(e){return void 0===e?"":"a=ice-options:".concat(e.join(o)).concat(this.eol)}printFingerprints(e){return e.length>0?e.map((e=>"a=fingerprint:".concat(e.hashFunction).concat(o).concat(e.fingerprint))).join(this.eol)+this.eol:""}printExtmap(e){return e.map((e=>"a=extmap:".concat(e.entry).concat(e.direction?"/".concat(e.direction):"").concat(o).concat(e.extensionName).concat(e.extensionAttributes?"".concat(o).concat(e.extensionAttributes):"").concat(this.eol))).join("")}printSetup(e){return void 0===e?"":"a=setup:".concat(e).concat(this.eol)}printUnrecognized(e){return e.map((e=>"a=".concat(e.attField).concat(e.attValue?":".concat(e.attValue):"").concat(this.eol))).join("")}}class N extends b{print(e){let t="";return t+=this.printGroups(e.groups),t+=this.printMsidSemantic(e.msidSemantic),t+=this.printIceLite(e.iceLite),t+=this.printIceUfrag(e.iceUfrag),t+=this.printIcePwd(e.icePwd),t+=this.printIceOptions(e.iceOptions),t+=this.printFingerprints(e.fingerprints),t+=this.printSetup(e.setup),t+=this.printTlsId(e.tlsId),t+=this.printIdentity(e.identities),t+=this.printExtmap(e.extmaps),t+=this.printUnrecognized(e.unrecognized),t}printGroups(e){let t="";return e.length>0&&(t+=e.map((e=>"a=group:".concat(e.semantic).concat(e.identificationTag.map((e=>"".concat(o).concat(e))).join("")).concat(this.eol))).join("")),t}printIceLite(e){return void 0===e?"":"a=ice-lite"+this.eol}printTlsId(e){return e?"a=tls-id:".concat(e).concat(this.eol):""}printIdentity(e){return 0===e.length?"":e.map((e=>"a=identity:".concat(e.assertionValue).concat(e.extensions.map((e=>"".concat(o).concat(e.name).concat(e.value?"=".concat(e.value):"")))))).join(this.eol)+this.eol}printMsidSemantic(e){if(!e)return"";let t="a=msid-semantic:".concat(e.semantic);return e.applyForAll?t+="".concat(o,"*"):e.identifierList.length>0&&(t+=e.identifierList.map((e=>"".concat(o).concat(e)))),t+this.eol}}class O extends b{print(e){const t=e.attributes;let i="";return i+=this.printRTCP(t.rtcp),i+=this.printIceUfrag(t.iceUfrag),i+=this.printIcePwd(t.icePwd),i+=this.printIceOptions(t.iceOptions),i+=this.printCandidates(t.candidates),i+=this.printRemoteCandidatesList(t.remoteCandidatesList),i+=this.printEndOfCandidates(t.endOfCandidates),i+=this.printFingerprints(t.fingerprints),i+=this.printSetup(t.setup),i+=this.printMid(t.mid),i+=this.printExtmap(t.extmaps),i+=this.printRTPRelated(t),i+=this.printPtime(t.ptime),i+=this.printMaxPtime(t.maxPtime),i+=this.printDirection(t.direction),i+=this.printSSRCGroups(t.ssrcGroups),i+=this.printSSRC(t.ssrcs),i+=this.printRTCPMux(t.rtcpMux),i+=this.printRTCPMuxOnly(t.rtcpMuxOnly),i+=this.printRTCPRsize(t.rtcpRsize),i+=this.printMSId(t.msids),i+=this.printImageattr(t.imageattr),i+=this.printRid(t.rids),i+=this.printSimulcast(t.simulcast),i+=this.printSCTPPort(t.sctpPort),i+=this.printMaxMessageSize(t.maxMessageSize),i+=this.printUnrecognized(t.unrecognized),i}printCandidates(e){return e.map((e=>"a=candidate:".concat(e.foundation).concat(o).concat(e.componentId).concat(o).concat(e.transport).concat(o).concat(e.priority).concat(o).concat(e.connectionAddress).concat(o).concat(e.port).concat(o,"typ").concat(o).concat(e.type).concat(e.relAddr?"".concat(o,"raddr").concat(o).concat(e.relAddr):"").concat(e.relPort?"".concat(o,"rport").concat(o).concat(e.relPort):"").concat(Object.keys(e.extension).map((t=>"".concat(o).concat(t).concat(o).concat(e.extension[t]))).join("")).concat(this.eol))).join("")}printRemoteCandidatesList(e){return e.map((e=>"a=remote-candidates:".concat(e.join(o)).concat(this.eol))).join("")}printEndOfCandidates(e){return void 0===e?"":"a=end-of-candidates"+this.eol}printRTPRelated(e){if(!e.payloads)return"";const t=e.payloads;let i="";i+=e.rtcpFeedbackWildcards.map((e=>this.printRTCPFeedback("*",e))).join("");for(const e of t)i+=this.printRtpMap(e.payloadType,e.rtpMap),i+=this.printFmtp(e.payloadType,e.fmtp),i+=e.rtcpFeedbacks.map((t=>this.printRTCPFeedback(e.payloadType,t))).join("");return i}printFmtp(e,t){if(!t)return"";const i=Object.keys(t.parameters);return 1===i.length&&null===t.parameters[i[0]]?"a=fmtp:".concat(e).concat(o).concat(i[0]).concat(this.eol):"a=fmtp:".concat(e).concat(o).concat(Object.keys(t.parameters).map((e=>"".concat(e,"=").concat(t.parameters[e]))).join(";")).concat(this.eol)}printRtpMap(e,t){return t?"a=rtpmap:".concat(e).concat(o).concat(t.encodingName,"/").concat(t.clockRate).concat(t.encodingParameters?"/".concat(t.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(e,t){let i="a=rtcp-fb:".concat(e).concat(o),n=t;return"trr-int"===n.type?i+="ttr-int".concat(o).concat(n.interval):(i+="".concat(n.type),n.parameter&&(i+="".concat(o).concat(n.parameter),n.additional&&(i+="".concat(o).concat(n.additional)))),i+this.eol}printPtime(e){return void 0===e?"":"a=ptime:".concat(e).concat(this.eol)}printMaxPtime(e){return void 0===e?"":"a=maxptime:".concat(e).concat(this.eol)}printDirection(e){return void 0===e?"":"a=".concat(e).concat(this.eol)}printSSRC(e){return e.map((e=>Object.keys(e.attributes).map((t=>"a=ssrc:".concat(e.ssrcId.toString(10)).concat(o).concat(t).concat(e.attributes[t]?":".concat(e.attributes[t]):"").concat(this.eol))).join(""))).join("")}printRTCPMux(e){return void 0===e?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(e){return void 0===e?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(e){return void 0===e?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(e){if(void 0===e)return"";let t="a=rtcp:".concat(e.port);return e.netType&&(t+="".concat(o).concat(e.netType)),e.addressType&&(t+="".concat(o).concat(e.addressType)),e.address&&(t+="".concat(o).concat(e.address)),t+this.eol}printMSId(e){return e.map((e=>"a=msid:".concat(e.id).concat(e.appdata?"".concat(o).concat(e.appdata):"").concat(this.eol))).join("")}printImageattr(e){return e.map((e=>"a=imageattr:".concat(e).concat(this.eol))).join("")}printRid(e){return e.map((e=>{let t="a=rid:".concat(e.id).concat(o).concat(e.direction);return e.payloads&&(t+="".concat(o,"pt=").concat(e.payloads.join(","))),e.params.length>0&&(t+="".concat(o).concat(e.params.map((e=>"depend"===e.type?"depend=".concat(e.rids.join(",")):"".concat(e.type,"=").concat(e.val))).join(";"))),t+this.eol})).join("")}printSimulcast(e){return void 0===e?"":"a=simulcast:".concat(e).concat(this.eol)}printSCTPPort(e){return void 0===e?"":"a=sctp-port:".concat(e).concat(this.eol)}printMaxMessageSize(e){return void 0===e?"":"a=max-message-size:".concat(e).concat(this.eol)}printMid(e){return void 0===e?"":"a=mid:".concat(e).concat(this.eol)}printSSRCGroups(e){return e.map((e=>"a=ssrc-group:".concat(e.semantic).concat(e.ssrcIds.map((e=>"".concat(o).concat(e.toString(10)))).join("")).concat(this.eol))).join("")}}function D(e){return(new I).parse(e)}function P(e,t){return(new w).print(e,t)}}},t={};function i(n){if(t[n])return t[n].exports;var s=t[n]={exports:{}};return e[n](s,s.exports,i),s.exports}return i.d=(e,t)=>{for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i(8)})();function An(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:E("SVC_MODE");if(E("ENABLE_SVC"))return function(e){return e in Zt}(e)?e:Zt.L1T3}function vn(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments.length>3?arguments[3]:void 0;const{filterRTX:s,filterVideoFec:o,filterAudioFec:a,filterAudioCodec:r,filterVideoCodec:c}=t,{useXR:d}=i;let l=[],h=[],u=[],p=[],_=!1,m=!1;if(gn.parse(e).mediaDescriptions.forEach((e=>{n&&n!==e.attributes.direction||("video"!==e.media.mediaType||_||(h=e.attributes.payloads,p=e.attributes.extmaps,_=!0),"audio"!==e.media.mediaType||m||(l=e.attributes.payloads,u=e.attributes.extmaps,m=!0))})),!p||0===h.length)throw new Error("Cannot get video capabilities from SDP.");if(!u||0===l.length)throw new Error("Cannot get audio capabilities from SDP.");if(h.forEach((e=>{var t;null!==(t=e.rtpMap)&&void 0!==t&&t.clockRate&&(e.rtpMap.clockRate=parseInt(e.rtpMap.clockRate)),d&&e.rtcpFeedbacks.push({type:"rrtr"})})),l.forEach((e=>{var t;null!==(t=e.rtpMap)&&void 0!==t&&t.clockRate&&(e.rtpMap.clockRate=parseInt(e.rtpMap.clockRate)),d&&e.rtcpFeedbacks.push({type:"rrtr"})})),s&&(l=l.filter((e=>{var t;return"rtx"!==(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())})),h=h.filter((e=>{var t;return"rtx"!==(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())}))),o&&(h=h.filter((e=>{var t;return!/(red)|(ulpfec)|(flexfec)/i.test((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName)||"")}))),a&&(l=l.filter((e=>{var t;return!/(red)|(ulpfec)|(flexfec)/i.test((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName)||"")}))),r&&(null==r?void 0:r.length)>0&&(l=l.filter((e=>{var t;return r.includes((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"")}))),c&&(null==c?void 0:c.length)>0){const e=h.filter((e=>{var t;return c.includes((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"")}));h=e.concat(s?[]:Wn(e,h))}const S=E("UNSUPPORTED_VIDEO_CODEC");return S&&S.length>0&&(h=h.filter((e=>!(e.rtpMap&&S.includes(e.rtpMap.encodingName.toLowerCase()))))),{audioCodecs:l,videoCodecs:h,audioExtensions:u,videoExtensions:p}}function yn(e){const t=gn.parse(e);let i,n;for(const e of t.mediaDescriptions){if(!i){const t=e.attributes.iceUfrag,n=e.attributes.icePwd;if(!t||!n)throw new Error("Cannot get iceUfrag or icePwd from SDP.");i={iceUfrag:t,icePwd:n}}if(!n){const t=e.attributes.fingerprints;t.length>0&&(n={fingerprints:t})}}if(!n&&t.attributes.fingerprints.length>0&&(n={fingerprints:t.attributes.fingerprints}),!n||!i)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:i,dtlsParameters:n}}function wn(e,t){const i=[],n=e.attributes.ssrcGroups.filter((e=>"FID"===e.semantic)),s=e.attributes.ssrcGroups.find((e=>"SIM"===e.semantic)),o=e.attributes.ssrcs;if(s)s.ssrcIds.forEach((e=>{var s;const o=null===(s=n.find((t=>t.ssrcIds[0]===e)))||void 0===s?void 0:s.ssrcIds[1];i.push({ssrcId:e,rtx:t?o:void 0})}));else if(n.length>0){const e=n[0].ssrcIds[0],s=n[0].ssrcIds[1];i.push({ssrcId:e,rtx:t?s:void 0})}else{if(0===o.length)throw new Error("No ssrcs found on local media description.");i.push({ssrcId:o[0].ssrcId})}return i}function bn(e,i,n){const{cname:s}=e;let o;i?o=Nn(i):(o=e.iceParameters.candidates.map((e=>({foundation:e.foundation,componentId:"1",transport:e.protocol,priority:e.priority.toString(),connectionAddress:e.ip,port:e.port.toString(),type:e.type,extension:{}}))),t.debug("Using candidates from gateway."));const a={fingerprints:e.dtlsParameters.fingerprints.map((e=>({hashFunction:e.algorithm,fingerprint:e.fingerprint})))},r={iceUfrag:e.iceParameters.iceUfrag,icePwd:e.iceParameters.icePwd};let c;switch(e.dtlsParameters.role){case"server":c="passive";break;case"client":c="active";break;case"auto":c="actpass"}const d=Bn(e.rtpCapabilities),l=[];return Array.isArray(n)&&n.length>0&&n.forEach((e=>{l.push({kind:Pi.VIDEO,ssrcId:e.v,rtx:e.v_rtx,mslabel:"".concat(e.v,"_").concat(e.a)},{kind:Pi.AUDIO,ssrcId:e.a,mslabel:"".concat(e.v,"_").concat(e.a)})})),{dtlsParameters:a,iceParameters:r,candidates:o,rtpCapabilities:d,setup:c,cname:s,preSSRCs:l}}function Nn(e){let i=[];return e.ip&&"number"==typeof e.port&&(i=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip,port:e.port.toString(),type:"host",extension:{}}],t.debug("Using remote candidate from AP ".concat(e.ip,":").concat(e.port)),e.ip6&&(i.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip6,port:e.port.toString(),type:"host",extension:{}}),t.debug("Using IPV6 remote candidate from AP ".concat(e.ip6,":").concat(e.port)))),i}function On(e,t,i){const n=[],s=[];return e.forEach((e=>{let{ssrcId:o,rtx:a}=e;const r=O(8,"track-"),c={ssrcId:o,attributes:Xt({label:r,mslabel:i=i||O(10,""),msid:"".concat(i," ").concat(r)},t&&{cname:t})};if(n.push(c),void 0!==a){const e={ssrcId:a,attributes:Xt({label:r,mslabel:i,msid:"".concat(i," ").concat(r)},t&&{cname:t})};n.push(e),s.push({semantic:"FID",ssrcIds:[o,a]})}})),e.length>1&&s.push({semantic:"SIM",ssrcIds:e.map((e=>{let{ssrcId:t}=e;return t}))}),{ssrcs:n,ssrcGroups:s}}function Dn(e,t){t instanceof qe&&e.attributes.payloads.forEach((e=>{var i;const n=null===(i=e.rtpMap)||void 0===i?void 0:i.encodingName.toLowerCase();if(!n||-1===["opus","pcmu","pcma","g722"].indexOf(n))return;e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.minptime="10",e.fmtp.parameters.useinbandfec="1";const s=t._encoderConfig;s&&"pcmu"!==n&&"pcma"!==n&&"g722"!==n&&(s.bitrate&&!f()&&(e.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*s.bitrate))),s.sampleRate&&(e.fmtp.parameters.maxplaybackrate="".concat(s.sampleRate),e.fmtp.parameters["sprop-maxcapturerate"]="".concat(s.sampleRate)),s.stereo&&(e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"))}))}function Pn(e){const t=e.attributes.unrecognized.findIndex((e=>"x-google-flag"===e.attField&&"conference"===e.attValue));-1!==t&&e.attributes.unrecognized.splice(t,1)}function Ln(e,t){if(!(t instanceof Je&&t._encoderConfig&&-1===t._hints.indexOf(ze.SCREEN_TRACK)))return;const i=t._encoderConfig;Xe().supportMinBitrate&&i.bitrateMin&&e.attributes.payloads.forEach((e=>{var t;["h264","h265","vp8","vp9","av1"].includes((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"")&&(e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters["x-google-min-bitrate"]="".concat(i.bitrateMin))})),Xe().supportMinBitrate&&!t._hints.includes(ze.LOW_STREAM)&&i.bitrateMax&&e.attributes.payloads.forEach((e=>{var t;["h264","h265","vp8","vp9","av1"].includes((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"")&&(e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters["x-google-start-bitrate"]="".concat(E("X_GOOGLE_START_BITRATE")||Math.floor(i.bitrateMax)))}))}function kn(e){if("video"!==e.media.mediaType)return;const t=U();if(t.name!==V.SAFARI&&t.os!==x.IOS)return;const i=e.attributes.extmaps.findIndex((e=>/video-orientation/g.test(e.extensionName)));-1!==i&&e.attributes.extmaps.splice(i,1)}function Mn(e,t,i){if(!t)return;let n,s;if("video"===e.media.mediaType?(n=i.videoExtensions,s=i.videoCodecs):(n=i.audioExtensions,s=i.audioCodecs),!0===t.twcc){const t=n.find((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName));if(t){e.attributes.extmaps.find((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName))||e.attributes.extmaps.push({entry:t.entry,extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"});const i=function(e,t){return t.filter((t=>!!e.find((e=>e.payloadType===t.payloadType&&!!e.rtcpFeedbacks.find((e=>"transport-cc"===e.type))))))}(s,e.attributes.payloads);i.forEach((e=>{e.rtcpFeedbacks.find((e=>"transport-cc"===e.type))||e.rtcpFeedbacks.push({type:"transport-cc"})}))}}else if(!1===t.twcc){const t=e.attributes.extmaps.findIndex((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName));-1!==t&&e.attributes.extmaps.splice(t,1),e.attributes.payloads.forEach((e=>{const t=e.rtcpFeedbacks.findIndex((e=>"transport-cc"===e.type));-1!==t&&e.rtcpFeedbacks.splice(t,1)}))}if(!0===t.remb){const t=n.find((e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.extensionName));if(t){e.attributes.extmaps.find((e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.extensionName))||e.attributes.extmaps.push({entry:t.entry,extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"});const i=function(e,t){return t.filter((t=>!!e.find((e=>e.payloadType===t.payloadType&&!!e.rtcpFeedbacks.find((e=>"goog-remb"===e.type))))))}(s,e.attributes.payloads);i.forEach((e=>{e.rtcpFeedbacks.find((e=>"goog-remb"===e.type))||e.rtcpFeedbacks.push({type:"goog-remb"})}))}}else if(!1===t.remb){const t=e.attributes.extmaps.findIndex((e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.extensionName));-1!==t&&e.attributes.extmaps.splice(t,1),e.attributes.payloads.forEach((e=>{const t=e.rtcpFeedbacks.findIndex((e=>"goog-remb"===e.type));-1!==t&&e.rtcpFeedbacks.splice(t,1)}))}}function Un(e,t,i){if(f())return;if("video"!==e.media.mediaType)return;if(!(t instanceof Je))return;if("vp9"!==i&&"vp8"!==i)return;if("vp8"===i&&!E("SIMULCAST"))return;if("vp9"===i&&E("ENABLE_SVC"))return;if(void 0===t._scalabilityMode||t._scalabilityMode.numSpatialLayers<=1)return;const n="vp8"===i?2:t._scalabilityMode.numSpatialLayers,s=e.attributes.ssrcs[0],o=e.attributes.ssrcGroups.find((e=>"FID"===e.semantic&&e.ssrcIds[0]===s.ssrcId)),a={semantic:"SIM",ssrcIds:[s.ssrcId]};for(let t=1;t<n;t++)e.attributes.ssrcs.push({ssrcId:s.ssrcId+t,attributes:M(s.attributes)}),a.ssrcIds.push(s.ssrcId+t),o&&(e.attributes.ssrcs.push({ssrcId:o.ssrcIds[1]+t,attributes:M(s.attributes)}),e.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[s.ssrcId+t,o.ssrcIds[1]+t]}));e.attributes.ssrcGroups.unshift(a)}async function Vn(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=new RTCPeerConnection;n.addTransceiver("video",{direction:"sendonly"}),n.addTransceiver("audio",{direction:"sendonly"}),n.addTransceiver("video",{direction:"recvonly"}),n.addTransceiver("audio",{direction:"recvonly"});const s=(await n.createOffer()).sdp,{send:o,recv:a,sendrecv:r}=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2?arguments[2]:void 0;const s=vn(n,e,i,"sendonly"),o=vn(n,e,i,"recvonly"),a={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},c={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Fn(s,o,"videoExtensions",a,r,c),Fn(s,o,"videoCodecs",a,r,c),Fn(s,o,"audioExtensions",a,r,c),Fn(s,o,"audioCodecs",a,r,c),E("RAISE_H264_BASELINE_PRIORITY")){const e=c.videoCodecs.findIndex((e=>{var t,i;return"h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())&&"42001f"===(null===(i=e.fmtp)||void 0===i?void 0:i.parameters["profile-level-id"])}));if(-1!==e){const i=c.videoCodecs.findIndex((e=>{var t;return"h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())}));if(i<e){t.debug("raising H264 baseline profile priority");const n=c.videoCodecs[e];c.videoCodecs.splice(e,1),c.videoCodecs.splice(i,0,n)}-1!==i&&(r.videoCodecs=r.videoCodecs.filter((e=>{var t,i;return!("h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())&&"42001f"!==(null===(i=e.fmtp)||void 0===i?void 0:i.parameters["profile-level-id"]))}))),-1!==i&&E("FILTER_SEND_H264_BASELINE")&&(a.videoCodecs=a.videoCodecs.filter((e=>{var t,i;return!("h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())&&"42001f"!==(null===(i=e.fmtp)||void 0===i?void 0:i.parameters["profile-level-id"]))})))}}return{send:a,recv:r,sendrecv:c}}(e,i,s);try{n.close()}catch(e){}return{send:o,recv:a,sendrecv:r}}function xn(){const e={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},i=vn(arguments.length>2?arguments[2]:void 0,arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},"recvonly"),n={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},s={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Fn(e,i,"videoExtensions",n,s,o),Fn(e,i,"videoCodecs",n,s,o),Fn(e,i,"audioExtensions",n,s,o),Fn(e,i,"audioCodecs",n,s,o),E("RAISE_H264_BASELINE_PRIORITY")){const e=o.videoCodecs.findIndex((e=>e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()&&e.fmtp&&"42001f"===e.fmtp.parameters["profile-level-id"]));if(-1!==e){const i=o.videoCodecs.findIndex((e=>e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()));if(i<e){t.debug("raising H264 baseline profile priority");const n=o.videoCodecs[e];o.videoCodecs.splice(e,1),o.videoCodecs.splice(i,0,n)}-1!==i&&(s.videoCodecs=s.videoCodecs.filter((e=>!(e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()&&e.fmtp&&"42001f"!==e.fmtp.parameters["profile-level-id"]))))}}return{send:n,recv:s,sendrecv:o}}function Fn(e,t,i,n,s,o){if("videoExtensions"===i||"audioExtensions"===i){const a=[];return e[i].forEach((e=>{t[i].some(((t,i)=>{if(e.entry===t.entry&&e.extensionName===t.extensionName)return a.push(i),!0}))?o[i].push(e):n[i].push(e)})),void t[i].forEach(((e,t)=>{-1===a.indexOf(t)&&s[i].push(e)}))}if("videoCodecs"===i||"audioCodecs"===i){const a=[];return e[i].forEach((e=>{t[i].some(((t,i)=>{if(e.payloadType===t.payloadType&&JSON.stringify(e)===JSON.stringify(t))return a.push(i),!0}))?o[i].push(e):n[i].push(e)})),void t[i].forEach(((e,t)=>{-1===a.indexOf(t)&&s[i].push(e)}))}}function Bn(e){const{send:t,recv:i,sendrecv:n}=e;if(!n){if(!t||!i)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:t,recv:i}}let s,o;return t?(s={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},s.audioCodecs=[...t.audioCodecs,...n.audioCodecs],s.videoCodecs=[...t.videoCodecs,...n.videoCodecs],s.audioExtensions=[...t.audioExtensions,...n.audioExtensions],s.videoExtensions=[...t.videoExtensions,...n.videoExtensions]):s=n,i?(o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},o.audioCodecs=[...i.audioCodecs,...n.audioCodecs],o.videoCodecs=[...i.videoCodecs,...n.videoCodecs],o.audioExtensions=[...i.audioExtensions,...n.audioExtensions],o.videoExtensions=[...i.videoExtensions,...n.videoExtensions]):o=n,{send:s,recv:o}}function Gn(e){if("audio"!==e.media.mediaType)return;e.attributes.payloads.filter((e=>{var t;return"opus"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())})).forEach((e=>{e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"}))}function jn(e,i,n,s){let o=[];if(e===Pi.VIDEO){if(E("H264_PROFILE_LEVEL_ID")&&"h264"===s&&(o=i.videoCodecs.filter((e=>(e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").includes(s)&&e&&e.fmtp&&e.fmtp.parameters["profile-level-id"]===E("H264_PROFILE_LEVEL_ID")))),!Array.isArray(o)||0===o.length){let e=[];const a=[],r=[],c=[];if(n.videoCodecs.forEach((t=>{const i=t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"";i.includes(s)?e.push(t):i.includes("vp9")?a.push(t):i.includes("vp8")?r.push(t):i.includes("h264")&&c.push(t)})),0===e.length){let i="";0!==a.length?(e=a,i="vp9"):0!==r.length?(e=r,i="vp8"):0!==c.length&&(e=c,i="h264"),t.warning("codec ".concat(s," not included in rtpCapabilities, fallback to default payloads: ").concat(i))}0!==e.length&&(o=i.videoCodecs.filter((t=>e.some((e=>e.payloadType===t.payloadType)))))}if(0===o.length&&(t.warning("codec ".concat(s," not included in rtpCapabilities, fallback to default payloads: ").concat(i.videoCodecs[0].rtpMap&&i.videoCodecs[0].rtpMap.encodingName)),o=i.videoCodecs),E("USE_PUB_RTX")||E("USE_SUB_RTX")){const e=Wn(o,i.videoCodecs);o=[...o,...e]}}else o=i.audioCodecs.filter((e=>(e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").includes(s))),0===o.length&&(t.warning("codec ".concat(s," not included in rtpCapabilities, fallback to opus")),o=i.audioCodecs.filter((e=>(e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").includes("opus"))));return o}function Wn(e,t){const i=e.map((e=>e.payloadType.toString()));return t.filter((e=>e.rtpMap&&"rtx"===e.rtpMap.encodingName&&e.fmtp&&e.fmtp.parameters.apt&&i.includes(e.fmtp&&e.fmtp.parameters.apt)))}async function Hn(e,t,i){const n=t.toString(),s=Yn(n,"offer","remote","exchangeSDP");await e.setRemoteDescription({type:"offer",sdp:n});const o=await e.createAnswer();if(!o.sdp)throw new Error("cannot get answer sdp");let a=o.sdp;a=Kn(a,i||{}),null==s||s(a||""),await e.setLocalDescription({type:"answer",sdp:a})}function Kn(e,t,i){const n=gn.parse(e),{useXR:s}=t;return n.mediaDescriptions.forEach((e=>{e.attributes.mid&&(Array.isArray(i)&&!i.includes(e.attributes.mid)||("audio"===e.media.mediaType&&Gn(e),s&&["audio","video"].includes(e.media.mediaType)&&e.attributes.payloads.forEach((e=>{-1===e.rtcpFeedbacks.findIndex((e=>"rrtr"===e.type))&&e.rtcpFeedbacks.push({type:"rrtr"})}))))})),gn.print(n)}function Yn(e,i,n,s){if(E("SDP_LOGGING"))return t.upload("exchanging ".concat(n," ").concat(i," SDP during P2PConnection.").concat(s,"\n"),e),"offer"===i?e=>{Yn(e,"answer","local"===n?"remote":"local",s)}:void 0}function qn(e,t){return typeof E(e)===t?E(e):void 0}const Jn=new Map;class Xn extends _{get state(){return this._state}set state(e){if(e===this._state)return;const t=this._state;this._state=e,"DISCONNECTED"===e&&this._disconnectedReason?this.emit(Ii.CONNECTION_STATE_CHANGE,e,t,this._disconnectedReason):this.emit(Ii.CONNECTION_STATE_CHANGE,e,t)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(e){t.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(e)),this._joinGatewayStartTime=e}constructor(e,t){super(),this.store=void 0,this.joinInfo=void 0,this.key=void 0,this.ntpOffset=0,this.signal=void 0,this.role=void 0,this.inChannelInfo={joinAt:null,duration:0},this.spec=void 0,this._state="DISCONNECTED",this._statsCollector=void 0,this._disconnectedReason=void 0,this.isSignalRecover=!1,this.hasChangeBGPAddress=!1,this.trafficStatsInterval=void 0,this.networkQualityInterval=void 0,this._joinGatewayStartTime=0,this._signalTimeout=!1,this._clientRoleOptions=void 0,this._isProactiveJoin=!1,this.store=e,this.spec=t,this.signal=this.store.useP2P?new Rn(Xt(Xt({},t),{},{retryConfig:t.websocketRetryConfig}),e):new dn(Xt(Xt({},t),{},{retryConfig:t.websocketRetryConfig}),e),this._statsCollector=t.statsCollector,this.role=t.role||"audience",this._clientRoleOptions=t.clientRoleOptions,this.handleSignalEvents()}async join(e,n,s){this.store.joinGatewayStart(),"disabled"!==e.cloudProxyServer&&(this.hasChangeBGPAddress=!0);const o=Date.now();let a=Jn.get(e.cname);if(a||(a=new Map,Jn.set(e.cname,a)),this._isProactiveJoin=!0,a.has(e.uid)){const t=new ui(h.UID_CONFLICT);throw i.joinGateway(e.sid,{lts:o,succ:!1,ec:t.code,addr:null,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!e.proxyServer,signalChannel:"0",preload:e.preload}),this._isProactiveJoin=!1,t}a.set(e.uid,!0),this.joinInfo=e,this.key=n;let r=0;this.joinGatewayStartTime=o;const c=e.proxyServer;try{t.debug("[".concat(this.store.clientId,"] use websocket join uid ").concat(r));const i=e.gatewayAddrs.map((t=>{let{address:i}=t;const[n,s]=i.split(":"),o={host:n,port:s};return e.proxyServer&&(o.proxy=e.proxyServer),o}));r=(await this.signal.init(i,s)).uid,t.debug("[".concat(this.store.clientId,"] websocket join uid ").concat(r," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(n){var d;throw t.error("[".concat(this.store.clientId,"] User join failed"),n.toString()),i.joinGateway(e.sid,{lts:o,succ:!1,ec:(null===(d=n.data)||void 0===d?void 0:d.desc)||n.code,errorMsg:n.message,addr:this.signal.url,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!c,signalChannel:"0",preload:e.preload}),this._isProactiveJoin=!1,a.delete(e.uid),this.signal.close(),n}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),t.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval((()=>{this.updateTrafficStats().catch((e=>{t.warning("[".concat(this.store.clientId,"] get traffic stats error"),e.toString())}))}),3e3),this.networkQualityInterval=window.setInterval((()=>{navigator&&void 0!==navigator.onLine&&!navigator.onLine?this.emit(Ii.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(Ii.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):"CONNECTED"===this.state&&this._statsCollector.trafficStats?this.emit(Ii.NETWORK_QUALITY,{uplinkNetworkQuality:En(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:En(this._statsCollector.trafficStats.B_dnq)}):this.emit(Ii.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})}),2e3),this.store.joinGatewayEnd(),r}async leave(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=arguments.length>1?arguments[1]:void 0;if("DISCONNECTED"!==this.state){i!==b.FALLBACK&&(this.state="DISCONNECTING");try{e||this.signal.connectionState!==oi.CONNECTED||await F(this.signal.request(ri.LEAVE,void 0,!0),3e3)}catch(e){t.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),e)}this.signal.close(i),i!==b.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}}async publish(e,i,n){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new ui(h.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const s={state:"offer",p2p_id:this.store.p2pId,ortc:i,mode:this.spec.mode,extend:E("PUB_EXTEND"),twcc:!!E("PUBLISH_TWCC"),rtx:!!E("USE_PUB_RTX")};try{return(await this.signal.request(ri.PUBLISH,s,!0))._message}catch(s){if(n&&s.data&&s.data.code===si.ERR_PUBLISH_REQUEST_INVALID)return t.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),s.toString()),await this.tryUnpubBeforeRepub(e,i),this.publish(e,i,!1);throw s}}async publishDataChannel(e,i,n){var s;if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new ui(h.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const o={stream_id:i.streamId,ordered:i.ordered?1:0,max_retrans_times:null!==(s=i.maxRetransmits)&&void 0!==s?s:10,channel_id:i.channelId,metadata:i.metadata};try{await this.signal.request(ri.PUBLISH_DATASTREAM,o,!0)}catch(s){if(n&&s.data&&s.data.code===si.ERR_PUBLISH_REQUEST_INVALID)return t.warning("[".concat(this.store.clientId,"] receive publish datachannels error code, retry"),s.toString()),await this.tryUnpubDataChannelBeforeRepub(e,i),this.publishDataChannel(e,i,!1);throw s}}async unpublish(e,i){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new ui(h.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request(ri.UNPUBLISH,{stream_id:i,ortc:e},!0)}catch(e){t.warning("[".concat(this.store.clientId,"] unpublish warning: "),e)}}async unpublishDataChannel(e){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new ui(h.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await Promise.all(e.map((e=>this.signal.request(ri.UNPUBLISH_DATASTREAM,{channel_id:e},!0))))}catch(e){t.warning("unpublish datachannels warning: ",e)}}async presubscribe(e,i,n){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new ui(h.INVALID_OPERATION,"can not presubscribe when connection state is ".concat(this.state));const s={stream_id:e,stream_type:i,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!E("SUBSCRIBE_TWCC"),rtx:!!E("USE_SUB_RTX")||void 0,extend:E("SUB_EXTEND"),svc:Array.isArray(E("SVC"))&&0!==E("SVC").length?E("SVC"):void 0};try{return await this.signal.request(ri.PRE_SUBSCRIBE,s,!0)}catch(s){if(n&&s.data&&s.data.code===si.ERR_SUBSCRIBE_REQUEST_INVALID)return t.warning("[".concat(this.store.clientId,"] pre-subscribe error, retry"),s.toString()),this.presubscribe(e,i,!1);throw s}}async subscribe(e,i,n){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new ui(h.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));const s={stream_id:e,stream_type:i.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!E("SUBSCRIBE_TWCC"),rtx:!!E("USE_SUB_RTX"),extend:E("SUB_EXTEND"),ssrcId:i.ssrcId,svc:Array.isArray(E("SVC"))&&0!==E("SVC").length?E("SVC"):void 0};try{return(await this.signal.request(ri.SUBSCRIBE,s,!0))._message}catch(s){if(n&&s.data&&s.data.code===si.ERR_SUBSCRIBE_REQUEST_INVALID)return t.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),s.toString()),await this.tryUnsubBeforeResub(e,i),await this.subscribe(e,i,!1);throw s}}async subscribeDataChannel(e,i,n){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new ui(h.INVALID_OPERATION,"can not subscribe datachannel when connection state is ".concat(this.state));const s={uid:e,stream_id:i.id,channel_id:i.datachannelId};try{return void await this.signal.request(ri.SUBSCRIBE_DATASTREAM,s,!0)}catch(s){if(n&&s.data&&s.data.code===si.ERR_SUBSCRIBE_REQUEST_INVALID)return t.warning("[".concat(this.store.clientId,"] receiver subscribe datachannel error code, retry"),s.toString()),await this.tryUnsubDataChannelBeforeResub(e,i),await this.subscribeDataChannel(e,i,!1);throw s}}async subscribeAll(e,i){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new ui(h.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));const n={p2p_id:this.store.p2pId,users:e,dtx:!1,rtx:!!E("USE_SUB_RTX"),twcc:!!E("SUBSCRIBE_TWCC"),svc:Array.isArray(E("SVC"))&&0!==E("SVC").length?E("SVC"):void 0};try{return await this.signal.request(ri.SUBSCRIBE_STREAMS,n,!0)}catch(n){if(i&&n.data&&n.data.code===si.ERR_SUBSCRIBE_REQUEST_INVALID)return t.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),n.toString()),await this.tryMassUnsubBeforeResub(e),await this.subscribeAll(e,!1);throw n}}async setVideoProfile(e){const i=function(e){if(!(e.bitrateMax&&e.bitrateMin&&e.frameRate&&e.height&&e.width))return;let t=e.frameRate,i=e.width,n=e.height,s=!0;return"number"!=typeof t&&(t=t.exact||t.ideal||t.max||t.min||0,t||(s=!1)),"number"!=typeof i&&(i=i.exact||i.ideal||i.max||i.min||0,i||(s=!1)),"number"!=typeof n&&(n=n.exact||n.ideal||n.max||n.min||0,t||(s=!1)),s?{stream_type:0,width:i,height:n,fps:t,start_bps:1e3*e.bitrateMax,min_bps:1e3*e.bitrateMin,target_bps:1e3*e.bitrateMax}:void 0}(e);if(i)return this.signal.request(ri.SET_VIDEO_PROFILE,i);t.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))}async unsubscribe(e,i){try{await this.signal.request(ri.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:e,stream_id:i},!0)}catch(e){t.warning("[".concat(this.store.clientId,"] unsubscribe warning: "),e)}}async unsubscribeDataChannel(e,i){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new ui(h.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await Promise.all(e.map((e=>this.signal.request(ri.UNSUBSCRIBE_DATASTREAM,{stream_id:e,uid:i},!0))))}catch(e){t.warning("unsubscribeDataChannel warning: ",e)}}async massUnsubscribe(e){try{await this.signal.request(ri.UNSUBSCRIBE_STREAMS,e,!0)}catch(e){t.warning("[".concat(this.store.clientId,"] massUnsubscribeAll warning: "),e)}}async reconnectPC(e){const{iceParameters:t,dtlsParameters:i,rtpCapabilities:n}=e;return{gatewayEstablishParams:await this.signal.request(ri.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:t,dtlsParameters:i,rtpCapabilities:n}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request(ri.GATEWAY_INFO)}async renewToken(e){await this.signal.request(ri.RENEW_TOKEN,e),this.key=e.token}async setClientRole(e,t){if(t&&(this._clientRoleOptions=Object.assign({},t)),"CONNECTED"!==this.state)return void(this.role=e);let i,n=0;"audience"===e?this._clientRoleOptions&&this._clientRoleOptions.delay?(i=this._clientRoleOptions.delay,n=1):n=this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:n=0,await this.signal.request(ri.SET_CLIENT_ROLE,{role:e,level:n,delay:i,client_ts:Date.now()}),this.role=e}async setRemoteVideoStreamType(e,t){await this.signal.request(ri.SWITCH_VIDEO_STREAM,{stream_id:e,stream_type:t})}async setDefaultRemoteVideoStreamType(e){await this.signal.request(ri.DEFAULT_VIDEO_STREAM,{stream_type:e})}async setStreamFallbackOption(e,t){await this.signal.request(ri.SET_FALLBACK_OPTION,{stream_id:e,fallback_type:t})}async pickSVCLayer(e,t){await this.signal.request(ri.PICK_SVC_LAYER,{stream_id:e,spatial_layer:t.spatialLayer,temporal_layer:t.temporalLayer})}async setRTM2Flag(e){await this.signal.request(ri.SET_RTM2_FLAG,{rtm2_flag:e})}async sendExtensionMessage(e,t,i){if(this.signal instanceof Rn)return this.signal.sendExtensionMessage(e,t,i)}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),Xt({},this.inChannelInfo)}async getGatewayVersion(){return(await this.signal.request(ri.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){const e=Jn.get(this.joinInfo.cname);e&&e.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0)}updateTurnConfigFromSignal(){if(!this.joinInfo)return;const e=function(e){let t;return t=e.startsWith("dc")?e.match(/(dc\:\/\/)?([^:]+):(\d+)/):e.match(/(wss\:\/\/)?([^:]+):(\d+)/),t?{username:Vt.username,password:Vt.password,turnServerURL:t[2],tcpport:parseInt(t[3])+30,udpport:parseInt(t[3])+30,forceturn:!1}:null}(("disabled"===this.joinInfo.cloudProxyServer?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],e&&"off"!==this.joinInfo.turnServer.mode&&"disabled"===this.joinInfo.cloudProxyServer&&this.joinInfo.turnServer.serversFromGateway.push(Xt(Xt({},Vt),{},{turnServerURL:e.turnServerURL,tcpport:e.tcpport,udpport:e.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}async updateTrafficStats(){if("CONNECTED"!==this.state)return;const e=await this.signal.request(ri.TRAFFIC_STATS,void 0,!0);e.timestamp=Date.now(),null!=e.ntp_offset&&(this.ntpOffset=e.ntp_offset),e.peer_delay.forEach((e=>{const t=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find((t=>t.peer_uid===e.peer_uid));t&&t.B_st!==e.B_st&&B((()=>{this.emit(Ii.STREAM_TYPE_CHANGE,e.peer_uid,e.B_st)}))})),this._statsCollector.updateTrafficStats(e)}getJoinMessage(e){if(!this.joinInfo||!this.key)throw new ui(h.UNEXPECTED_ERROR,"can not generate join message, no join info");const t=Object.assign({},this.joinInfo.apResponse);let i=E("REPORT_APP_SCENARIO");if("string"!=typeof i)try{i=JSON.stringify(i)}catch(e){i=void 0}i&&i.length>128&&(i=void 0);const n=!(f()||G(87)||Qe())&&("boolean"==typeof E("ENABLE_PRE_SUB")&&E("ENABLE_PRE_SUB")),s=!Qe()&&qn("ENABLE_PREALLOC_PC","boolean"),o=Xt({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:j,browser:navigator.userAgent,process_id:E("PROCESS_ID"),mode:this.store.useP2P?"p2p":this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:this.hasChangeBGPAddress,ap_response:t,extend:E("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:"proxy3"===this.joinInfo.cloudProxyServer?"1":"proxy5"===this.joinInfo.cloudProxyServer?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:i,attributes:{userAttributes:{enablePublishedUserList:E("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:E("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:"number"==typeof E("SUBSCRIBE_AUDIO_FILTER_TOPN")?E("SUBSCRIBE_AUDIO_FILTER_TOPN"):void 0,enablePublishAudioFilter:"boolean"==typeof E("ENABLE_PUBLISH_AUDIO_FILTER")?E("ENABLE_PUBLISH_AUDIO_FILTER"):void 0,enableUserLicenseCheck:"boolean"==typeof E("ENABLE_USER_LICENSE_CHECK")?E("ENABLE_USER_LICENSE_CHECK"):void 0,enableRTX:!0===E("USE_PUB_RTX")||!0===E("USE_SUB_RTX")||void 0,disableFEC:E("DISABLE_FEC"),enableNTPReport:!!E("ENABLE_NTP_REPORT")||void 0,enableInstantVideo:!!E("ENABLE_INSTANT_VIDEO")||void 0,enableFulllinkAvSync:!!E("ENABLE_FULL_LINK_AV_SYNC")||void 0,enableDataStream2:qn("ENABLE_DATASTREAM_2","boolean"),enableAutFeedback:!!E("ENABLE_AUT_FEEDBACK")||void 0,rtm2Flag:"number"==typeof this.joinInfo.rtmFlag?this.joinInfo.rtmFlag:void 0,enableUserAutoRebalanceCheck:!!E("ENABLE_USER_AUTO_REBALANCE_CHECK"),enableXR:qn("USE_XR","boolean"),enableLossbasedBwe:qn("ENABLE_LOSSBASED_BWE","boolean"),enableAutCC:!!E("ENABLE_AUT_CC")||void 0,enableCCFallback:qn("ENABLE_CC_FALLBACK","boolean"),enablePreallocPC:s,preSubNum:n?qn("PRE_SUB_NUM","number"):void 0,enablePubTWCC:qn("PUBLISH_TWCC","boolean"),enableSubTWCC:qn("SUBSCRIBE_TWCC","boolean"),enablePubRTX:qn("USE_PUB_RTX","boolean"),enableSubRTX:qn("USE_SUB_RTX","boolean"),enableSubSVC:E("ENABLE_SVC")?E("ENABLE_SVC_DEFAULT_CODECS"):Array.isArray(E("SVC"))&&0!==E("SVC").length?E("SVC"):void 0}},join_ts:this.joinGatewayStartTime},e);return this.joinInfo.stringUid&&(o.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(o.aes_mode=this.joinInfo.aesmode,E("ENCRYPT_AES")?(o.aes_secret=this.joinInfo.aespassword,o.aes_encrypt=!0):o.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(o.aes_salt=this.joinInfo.aessalt)),t.addresses[this.signal.websocket.currentURLIndex]&&(o.ap_response.ticket=t.addresses[this.signal.websocket.currentURLIndex].ticket,delete t.addresses),void 0!==this.joinInfo.defaultVideoStream&&(o.default_video_stream=this.joinInfo.defaultVideoStream),o}getRejoinMessage(){if(!this.joinInfo)throw new ui(h.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on(ai.WS_RECONNECT_WAITTING_FINISH,(e=>{["tryNext","recover"].includes(e)&&this.joinInfo&&i.adjustSessionStartTime(this.joinInfo.sid)})),this.signal.on(ai.WS_RECONNECT_CREATE_CONNECTION,(e=>{this.joinGatewayStartTime=Date.now()})),this.signal.on(ai.WS_RECONNECTING,(e=>{this.joinInfo&&i.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:e||N.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",i.sessionInit(this.joinInfo.sid,{lts:(new Date).getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode,stringUid:this.joinInfo.stringUid,channelProfile:"live"===this.spec.mode?1:0,channelMode:0,lsid:this.joinInfo.sid,clientRole:"audience"===this.role?2:1,buildFormat:3}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())})),this.signal.on(ai.WS_CLOSED,(e=>{let n;switch(e){case b.LEAVE:n=N.LEAVE;break;case b.UID_BANNED:case b.IP_BANNED:case b.CHANNEL_BANNED:case b.SERVER_ERROR:n=N.SERVER_ERROR;break;case b.FALLBACK:n=N.FALLBACK;break;case b.LICENSE_MISSING:case b.LICENSE_EXPIRED:case b.LICENSE_MINUTES_EXCEEDED:case b.LICENSE_PERIOD_INVALID:case b.LICENSE_MULTIPLE_SDK_SERVICE:case b.LICENSE_ILLEGAL:case b.TOKEN_EXPIRE:n=e;break;default:n=N.NETWORK_ERROR}t.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(n||"undefined -> "+N.NETWORK_ERROR)),this.joinInfo&&i.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:e===b.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:n}),this._disconnectedReason=e,e!==b.FALLBACK&&(this.state="DISCONNECTED"),this.reset()})),this.signal.on(ai.WS_CONNECTED,(()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo&&("audience"===this.role&&this._clientRoleOptions&&(this._clientRoleOptions.level||this._clientRoleOptions.delay)&&(t.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(this._clientRoleOptions.level,", delay: ").concat(this._clientRoleOptions.delay)),this.setClientRole(this.role,this._clientRoleOptions)),i.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:"0",preload:this.joinInfo.preload}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&1===this.joinInfo.setLocalAPVersion)){const e=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!e)return void t.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(e));W("EVENT_REPORT_DOMAIN",e[1]),W("EVENT_REPORT_BACKUP_DOMAIN",e[1]),W("LOG_UPLOAD_SERVER","".concat(e[1],":6444"))}})),this.signal.on(di.ON_UPLINK_STATS,(e=>{this._statsCollector.updateUplinkStats(e)})),this.signal.on(ai.REQUEST_RECOVER,((e,t,i)=>{if(!this.joinInfo)return i(new ui(h.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));e&&(this.joinInfo.multiIP=e,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,v(this,Ii.REQUEST_NEW_GATEWAY_LIST).then(t).catch(i)})),this.signal.on(ai.REQUEST_JOIN_INFO,(async e=>{var t;if(this.updateTurnConfigFromSignal(),this.store.useP2P)return void e(this.getJoinMessage({ortc:{}}));const{iceParameters:i,dtlsParameters:n,rtpCapabilities:s}=await v(this,Ii.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:null===(t=this.joinInfo)||void 0===t?void 0:t.turnServer});e(this.getJoinMessage({ortc:{iceParameters:i,dtlsParameters:n,rtpCapabilities:s,version:"2"}}))})),this.signal.on(ai.REQUEST_REJOIN_INFO,(e=>{e(this.getRejoinMessage())})),this.signal.on(ai.REPORT_JOIN_GATEWAY,((e,t)=>{if(!this.joinInfo)return;let n,s="";var o;e instanceof ui?(n=(null===(o=e.data)||void 0===o?void 0:o.desc)||e.code,s=e.message):n=e;i.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:n,errorMsg:s,addr:t,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:"0",preload:this.joinInfo.preload}),this._isProactiveJoin=!1})),this.signal.on(ai.IS_P2P_DISCONNECTED,(e=>{e(D(this,Ii.IS_P2P_DISCONNECTED))})),this.signal.on(ai.DISCONNECT_P2P,(()=>{this.emit(Ii.DISCONNECT_P2P)})),this.signal.on(ai.REQUEST_SUCCESS,(()=>{this._signalTimeout=!1})),this.signal.on(ai.REQUEST_TIMEOUT,(()=>{this._signalTimeout=!0})),this.signal.on(ai.JOIN_RESPONSE,(e=>{const t=this.getCurrentGatewayAddress();this.emit(Ii.JOIN_RESPONSE,e,t)})),this.signal.on(ai.PRE_CONNECT_PC,(async()=>{if(this.joinInfo){this.updateTurnConfigFromSignal();const e=this.getCurrentGatewayAddress(),t=E("FINGERPRINT")||this.joinInfo.apResponse.addresses[this.signal.currentURLIndex].fingerprint;if(e&&t){const i=Nn(e);this.emit(Ii.PRE_CONNECT_PC,{candidates:i,fingerprint:t})}}}))}async tryUnsubBeforeResub(e,i){try{await this.signal.request(ri.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:e,ortc:[i]},!0)}catch(e){throw t.warning("[".concat(this.store.clientId,"] tryUnsubBeforeResub warning"),e),e}}async tryUnsubDataChannelBeforeResub(e,i){try{await this.signal.request(ri.UNSUBSCRIBE,{stream_id:i.id},!0)}catch(e){throw t.warning("unsubscribe datachannel warning",e),e}}async tryUnpubBeforeRepub(e,i){try{await this.signal.request(ri.UNPUBLISH,{stream_id:e,ortc:i},!0)}catch(e){throw t.warning("[".concat(this.store.clientId,"] tryUnpubBeforeRepub warning: "),e),e}}async tryUnpubDataChannelBeforeRepub(e,i){try{await this.signal.request(ri.UNPUBLISH_DATASTREAM,{channnel_id:i.channelId},!0)}catch(e){throw t.warning("unpublish datastream warning: ",e),e}}async tryMassUnsubBeforeResub(e){const i={users:e.map((e=>({stream_id:e.stream_id,stream_type:e.stream_type})))};try{await this.signal.request(ri.UNSUBSCRIBE_STREAMS,i,!0)}catch(e){throw t.warning("[".concat(this.store.clientId,"] tryMassUnsubBeforeResub warning"),e),e}}async muteLocal(e,i){const n={action:e.find((e=>e.stream_type===Ri.Audio))?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:i};try{await this.signal.request(ri.CONTROL,n,!0,!0)}catch(e){throw t.warning("[".concat(this.store.clientId,"] gateway muteLocal warning: "),e),e}}async unmuteLocal(e,i){const n={action:e.find((e=>e.stream_type===Ri.Audio))?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:i};try{await this.signal.request(ri.CONTROL,n,!0,!0)}catch(e){throw t.warning("[".concat(this.store.clientId,"] gateway unmuteLocal warning: "),e),e}}async muteRemote(e,i){const n={action:e===Pi.AUDIO?"mute_remote_audio":"mute_remote_video",p2p_id:this.store.p2pId,stream_id:i};try{await this.signal.request(ri.CONTROL,n,!0,!0)}catch(e){throw t.warning("[".concat(this.store.clientId,"] gateway muteRemote warning: "),e),e}}async unmuteRemote(e,i){const n={action:e===Pi.AUDIO?"unmute_remote_audio":"unmute_remote_video",p2p_id:this.store.p2pId,stream_id:i};try{await this.signal.request(ri.CONTROL,n,!0,!0)}catch(e){throw t.warning("[".concat(this.store.clientId,"] gateway unmuteRemote warning: "),e),e}}uploadWRTCStats(e){this.signal.uploadWRTCStats(e)}upload(e,t){this.signal.upload(e,t)}getSignalRTT(){return this.signal.rtt}async restartICE(e){const i={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:e};try{return await this.signal.request(ri.RESTART_ICE,i,!0)}catch(e){throw t.warning("[".concat(this.store.clientId,"] P2PChannel.restartICE warning: "),e),e}}reconnect(){"CONNECTED"===this.state&&this.signal.reconnect(void 0,N.P2P_FAILED)}getCurrentGatewayAddress(){var e,i;if(!E("GATEWAY_WSS_ADDRESS"))return E("USE_CANDIDATE_FROM_AP_DETAIL")&&null!==(e=this.joinInfo)&&void 0!==e&&e.apGatewayAddress?(t.debug("[".concat(this.store.clientId,"] use candidate from ap detail, ").concat(JSON.stringify(this.joinInfo.apGatewayAddress))),this.joinInfo.apGatewayAddress):null!==(i=this.joinInfo)&&void 0!==i&&i.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(e){await this.signal.request(ri.SET_PARAMETER,{enablePublishAudioFilter:e})}}let zn=0,Qn=0;function Zn(e,t,i,n){return new Promise(((s,o)=>{t.timeout=t.timeout||E("HTTP_CONNECT_TIMEOUT"),t.responseType=t.responseType||"json",t.data&&!i?(t.data=JSON.stringify(t.data),zn+=H(t.data)):i&&(t.data.size?zn+=t.data.size:t.data instanceof FormData?zn+=K(t.data):zn+=H(JSON.stringify(t.data))),t.headers=t.headers||{},t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.method="POST",t.url=e,Dt.request(t).then((e=>{"string"==typeof e.data?Qn+=H(e.data):e.data instanceof ArrayBuffer||e.data instanceof Uint8Array?Qn+=e.data.byteLength:Qn+=H(JSON.stringify(e.data)),n&&s({data:e.data,headers:e.headers}),s(e.data)})).catch((e=>{Dt.isCancel(e)?o(new ui(h.OPERATION_ABORTED,"cancel token canceled")):"ECONNABORTED"===e.code?o(new ui(h.NETWORK_TIMEOUT,e.message)):e.response?o(new ui(h.NETWORK_RESPONSE_ERROR,e.response.status)):o(new ui(h.NETWORK_ERROR,e.message))}))}))}const $n=()=>{const e=E("AREAS");0===e.length&&e.push(vi.GLOBAL);return e.reduce(((e,t,i)=>{const n=es(t);return n?0===i?n:"".concat(e,",").concat(n):e}),"")},es=e=>e===vi.OVERSEA?"".concat(wi.ASIA,",").concat(wi.EUROPE,",").concat(wi.AFRICA,",").concat(wi.NORTH_AMERICA,",").concat(wi.SOUTH_AMERICA,",").concat(wi.OCEANIA):wi[e],ts=e=>{const t={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return e.map((e=>{const i=bi[e],n=Object.keys(i);n&&n.map((e=>{"CODE"!==e&&(t[e]=t[e].concat(i[e]))}))})),t},is={GLOBAL:{ASIA:[vi.CHINA,vi.JAPAN,vi.INDIA,vi.KOREA,vi.HKMC],EUROPE:[],NORTH_AMERICA:[vi.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},ns=Object.keys(is[vi.GLOBAL]),ss=[vi.CHINA,vi.NORTH_AMERICA,vi.EUROPE,vi.ASIA,vi.JAPAN,vi.INDIA,vi.OCEANIA,vi.SOUTH_AMERICA,vi.AFRICA,vi.KOREA,vi.HKMC,vi.US],os=function(e,t){let i=[];if(e.includes(vi.GLOBAL)){const o=[vi.GLOBAL,vi.OVERSEA],a=Object.keys(bi);if(t===vi.GLOBAL)throw new ui(h.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(t===vi.CHINA)i=[vi.OVERSEA];else if(s=t,ns.includes(s)){const e=(n=t,is[vi.GLOBAL][n]||[]),s=[...o,t,...e];i=a.filter((e=>!s.includes(e)))}else if(function(e){let t=!1;return ns.forEach((i=>{is[vi.GLOBAL][i].includes(e)&&(t=!0)})),t}(t)){const e=function(e){let t;return ns.forEach((i=>{is[vi.GLOBAL][i].includes(e)&&(t=i)})),t}(t),n=[...o,e,t];i=a.filter((e=>!n.includes(e)))}else i=e;i=function(e){const t=[];return ss.forEach((i=>{e.includes(i)&&t.push(i)})),t.concat(e.filter((e=>!ss.includes(e))))}(i)}else i=e;var n,s;return i};function as(e){if(!e&&E("AREAS").includes(vi.EXTENSIONS))return t.debug("update area from ap : reset"),void rs(Ut,!0);if(!E("AREAS").includes(vi.GLOBAL)||!e)return;let i=bi.EXTENSIONS;i&&(i={CODE:es(vi.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(e,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(e,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(e,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(e,".agora.io"),"cds-ap-web-2-".concat(e,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(e,".agora.io"),"sua-ap-web-2-".concat(e,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(e,".agora.io"),"uap-ap-web-2-".concat(e,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(e,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(e,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(e,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(e,".agora.io")]},t.debug("update area from ap success: ".concat(e,",config is "),i),W("AREAS",[vi.EXTENSIONS],!0),Object.keys(i).map((e=>{if("LOG_UPLOAD_SERVER"===e||"EVENT_REPORT_DOMAIN"===e||"EVENT_REPORT_BACKUP_DOMAIN"===e||"PROXY_SERVER_TYPE3"===e){const t=i[e];W(e,t[0])}else W(e,i[e])})))}function rs(e){let n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const s=i.reportApiInvoke(null,{name:Y.SET_AREA,options:e,tag:q.TRACER});try{let i=[];if("string"==typeof e&&(i=[e]),Array.isArray(e)&&(e.forEach((e=>{if(!yi.includes(e))throw new ui(h.INVALID_PARAMS,"invalid area code")})),i=e),"[object Object]"===Object.prototype.toString.call(e)){const{areaCode:t,excludedArea:n}=e;if(!t)throw new ui(h.INVALID_PARAMS,"area code is needed");let s=t;"string"==typeof t&&(s=[t]),i=n?os(s,n):s}if(!n){if(d.AREAS){const e=new ui(h.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return s.onError(e),void t.warning("setArea is prohibited because of config-distribute")}if(i.includes(vi.GLOBAL)&&E("AREAS")===vi.EXTENSIONS){const e=new ui(h.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return s.onError(e),void t.warning("setArea is prohibited because of ap extensions")}}W("AREAS",i,n);const o=ts(i);Object.keys(o).map((e=>{if("LOG_UPLOAD_SERVER"===e||"EVENT_REPORT_DOMAIN"===e||"EVENT_REPORT_BACKUP_DOMAIN"===e||"PROXY_SERVER_TYPE3"===e){const t=o[e];W(e,t[0])}else W(e,o[e])})),t.debug("set area success:",i.join(","))}catch(e){throw s.onError(e),e}s.onSuccess()}let cs=1;function ds(e,n,s,o,a){cs+=1;const r={sid:s.sid,command:"convergeAllocateEdge",uid:"666",appId:s.appId,ts:Math.floor(Date.now()/1e3),seq:cs,requestId:cs,version:j,cname:s.cname},c={service_name:n,json_body:JSON.stringify(r)};let d,l,u=e[0];return J((async()=>{d=Date.now();const e=await Zn(u,{data:c,cancelToken:o,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(l=Date.now()-d,0!==e.code){const i=new ui(h.UNEXPECTED_RESPONSE,"live streaming ap error, code"+e.code,{retry:!0,responseTime:l});throw t.error(i.toString()),i}const i=JSON.parse(e.json_body);if(200!==i.code){const e=new ui(h.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(i.code,", reason: ").concat(i.reason),{code:i.code,responseTime:l});throw t.error(e.toString()),e}if(!i.servers||0===i.servers.length){const e=new ui(h.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:i.code,responseTime:l});throw t.error(e.toString()),e}const s=function(e,t){return{addressList:e.servers.map((e=>"wss://".concat(e.address.replace(/\./g,"-"),".").concat(E("WORKER_DOMAIN"),":").concat(e.wss,"?serviceName=").concat(encodeURIComponent(t)))),workerToken:e.workerToken,vid:e.vid}}(i,n);return E("LIVE_STREAMING_ADDRESS")&&(s.addressList=E("LIVE_STREAMING_ADDRESS")instanceof Array?E("LIVE_STREAMING_ADDRESS"):[E("LIVE_STREAMING_ADDRESS")]),Xt(Xt({},s),{},{responseTime:l})}),((t,o)=>(i.apworkerEvent(s.sid,{success:!0,sc:200,serviceName:n,responseDetail:JSON.stringify(t.addressList),firstSuccess:0===o,responseTime:l,serverIp:e[o%e.length]}),!1)),((t,o)=>(i.apworkerEvent(s.sid,{success:!1,sc:t.data&&t.data.code||200,serviceName:n,responseTime:l,serverIp:e[o%e.length]}),!!(t.code!==h.OPERATION_ABORTED&&t.code!==h.UNEXPECTED_RESPONSE||t.data&&t.data.retry)&&(u=e[(o+1)%e.length],!0))),a)}function ls(e,n,s,o){let{url:a,areaCode:r}=e;const{clientId:c,sid:d}=n,l=Date.now();let u;const[p,_]=Es(n,r,[ln.CHOOSE_SERVER]);let E=R.networkState;return J((async()=>{E&&R.networkState===T.OFFLINE&&R.onlineWaiter&&await Promise.race([R.onlineWaiter,A(o&&o.maxRetryTimeout||X.maxRetryTimeout)]),E=R.networkState;const{data:e,headers:t}=await Zn(a,{data:p,cancelToken:s,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);u="1"===t.http3?1:-1,i.reportResourceTiming(a,d),us(e,a,n,l,[ln.CHOOSE_SERVER],u);const r=mn(e,ln.CHOOSE_SERVER);return ps(r),un(r,a)}),(e=>(e&&i.joinChooseServer(d,{lts:l,succ:!0,csAddr:a,opid:_,serverList:e.gatewayAddrs.map((e=>e.address)),ec:null,cid:e.cid.toString(),uid:e.uid.toString(),csIp:e.csIp,unilbsServerIds:[ln.CHOOSE_SERVER].toString(),isHttp3:u}),!1)),(e=>e.code!==h.OPERATION_ABORTED&&(e.code===h.CAN_NOT_GET_GATEWAY_SERVER?e.data.retry:(i.joinChooseServer(d,{lts:l,succ:!1,csAddr:a,serverList:null,opid:_,ec:e.code,csIp:e.data&&e.data.csIp,unilbsServerIds:[ln.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:E}),isHttp3:u}),t.warning("[".concat(c||"sid-".concat(d.slice(0,6)),"] Choose server network error, retry"),e),!0))),o)}function hs(e,n,s,o){let a,{url:r,areaCode:c,serviceIds:d}=e;const l=Date.now(),[u,p]=Es(n,c,d);let _;return J((async()=>{_&&R.networkState===T.OFFLINE&&R.onlineWaiter&&await Promise.race([R.onlineWaiter,A(o&&o.maxRetryTimeout||X.maxRetryTimeout)]),_=R.networkState;const{data:e,headers:t}=await Zn(r,{data:u,cancelToken:s,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);a="1"===t.http3?1:-1,i.reportResourceTiming(r,n.sid),us(e,r,n,l,d,a);const c=mn(e,ln.CHOOSE_SERVER),h=mn(e,"proxy5"===n.cloudProxyServer?ln.CLOUD_PROXY_5:"proxy3"===n.cloudProxyServer||"proxy4"===n.cloudProxyServer?ln.CLOUD_PROXY:ln.CLOUD_PROXY_FALLBACK);return ps(c),{gatewayInfo:un(c,r),proxyInfo:h,url:r}}),(e=>(e.gatewayInfo&&i.joinChooseServer(n.sid,{lts:l,succ:!0,csAddr:r,serverList:e.gatewayInfo.gatewayAddrs.map((e=>e.address)),ec:null,opid:p,cid:e.gatewayInfo.cid.toString(),uid:e.gatewayInfo.uid.toString(),csIp:e.gatewayInfo.csIp,unilbsServerIds:d.toString(),isHttp3:a}),e.proxyInfo&&i.joinWebProxyAP(n.sid,{lts:l,sucess:1,apServerAddr:r,turnServerAddrList:e.proxyInfo.addresses.map((e=>e.ip)).join(","),errorCode:null,eventType:n.cloudProxyServer,unilbsServerIds:d.toString()}),!1)),(e=>e.code!==h.OPERATION_ABORTED&&(e.code===h.CAN_NOT_GET_GATEWAY_SERVER?e.data.retry:(i.joinWebProxyAP(n.sid,{lts:l,sucess:0,apServerAddr:r,turnServerAddrList:null,errorCode:e.code,eventType:n.cloudProxyServer,unilbsServerIds:d.toString(),extend:JSON.stringify({networkState:_})}),t.warning("[".concat(n.clientId,"] multi unilbs network error, retry"),e),!0))),o)}const us=(e,n,s,o,a,r)=>{const{sid:c,clientId:d,cloudProxyServer:l}=s,u=[],p=t=>{4096===t.flag?i.joinChooseServer(c,{lts:o,succ:!1,csAddr:n,opid:e.opid,serverList:null,ec:t.error.message,csIp:t.error.data&&t.error.data.csIp,unilbsServerIds:a.toString(),isHttp3:r}):1048576!==t.flag&&4194304!==t.flag&&4194310!==t.flag||i.joinWebProxyAP(c,{lts:o,sucess:0,apServerAddr:n,turnServerAddrList:null,errorCode:t.error.code,eventType:l,unilbsServerIds:a.toString()})};if(e.response_body.forEach((i=>{const n=i.buffer.code;if(23===i.uri&&0===n&&!i.buffer.edges_services)if(4194310===i.buffer.flag)t.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),i.buffer.edges_services=[];else{const t={error:new ui(h.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:e.detail[502]}),flag:i.buffer.flag};u.push(t),p(t)}if(0!==n){const s=Xi(n),o={error:new ui(h.CAN_NOT_GET_GATEWAY_SERVER,s.desc,{desc:s.desc,retry:s.retry,csIp:e.detail[502]}),flag:i.buffer.flag};4194310===i.buffer.flag?t.warning(o.error.toString()):u.push(o),p(o)}})),u.length)throw t.warning("[".concat(d||"sid-".concat(c.slice(0,6)),"] multi unilbs ").concat(n," failed, ").concat(u.map((e=>"flag: ".concat(e.flag,", message: ").concat(e.error.message,", retry: ").concat(e.error.data.retry))).join(" | "))),new ui(h.CAN_NOT_GET_GATEWAY_SERVER,u.map((e=>"flag: ".concat(e.flag,", message: ").concat(e.error.message))).join(" | "),{retry:!!u.find((e=>e.error.data.retry)),csIp:e.detail[502],desc:[...new Set(u.map((e=>{var t;return null==e||null===(t=e.error)||void 0===t||null===(t=t.data)||void 0===t?void 0:t.desc})).filter((e=>!!e)))]})},ps=e=>{var i,n,s,o;if(e.addresses&&0===e.addresses.length&&0===e.code)throw new ui(h.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:e.detail&&e.detail[502]});E("AP_AREA")&&(null!==(s=e.detail)&&void 0!==s&&s[23]&&"string"==typeof(null===(o=e.detail)||void 0===o?void 0:o[23])?as(e.detail[23].toLowerCase()):as());if(null!==(i=e.detail)&&void 0!==i&&i[19]&&"string"==typeof(null===(n=e.detail)||void 0===n?void 0:n[19])){const t=e.detail[19],i=null==t?void 0:t.split(";");for(let t=0;t<i.length;t++){const n=i[t].trim();e.addresses[t]&&i&&(e.addresses[t].fingerprint=n)}}if(E("GATEWAY_ADDRESS")&&E("GATEWAY_ADDRESS").length>0){t.debug("assign gateway address to",E("GATEWAY_ADDRESS"));const i=E("GATEWAY_ADDRESS").map((t=>{var i,n;const s=null!==(i=null===(n=e.addresses.find((e=>e.ip===t.ip&&e.port===t.port)))||void 0===n?void 0:n.fingerprint)&&void 0!==i?i:"";return{ip:t.ip,port:t.port,ticket:e.addresses[0]&&e.addresses[0].ticket,fingerprint:s}}));e.addresses=i}},_s=(e,i)=>{if(e.response_body&&e.response_body.length){const t=e.response_body[0];if(0!==t.buffer.code){const e=Xi(t.buffer.code);throw new ui(h.UPDATE_TICKET_FAILED,"[".concat(t.buffer.code,"]: ").concat(e.desc),{retry:e.retry})}return t.buffer.ticket}throw t.debug("update ticket request received ap response without response body:",i),new ui(h.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},Es=(e,t,i)=>{const n=Math.floor(Math.random()*10**12),s={appid:e.appId,client_ts:Date.now(),opid:n,sid:e.sid,request_bodies:[{uri:22,buffer:{cname:e.cname,detail:Xt({6:e.stringUid,11:t,12:E("USE_NEW_TOKEN")?"1":void 0,22:t},e.apRTM?{26:"RTM2"}:{}),key:e.token,service_ids:i,uid:e.uid||0}}]};s.request_bodies.forEach((t=>{e.multiIP&&e.multiIP.gateway_ip&&(t.buffer.detail[5]=JSON.stringify({vocs_ip:[e.multiIP.uni_lbs_ip],vos_ip:[e.multiIP.gateway_ip]}))}));const o=new FormData;return o.append("request",JSON.stringify(s)),[o,n]},ms=(e,t)=>{const i=Math.floor(Math.random()*10**12),n={appid:e.appId,client_ts:Date.now(),opid:i,sid:e.sid,request_bodies:[{uri:28,buffer:{cname:e.cname,detail:{1:"",6:e.stringUid,12:"1"},token:e.token,service_ids:t,uid:e.uid||0,edges_services:e.apResponse.addresses.map((e=>({ip:e.ip,port:e.port})))}}]},s=new FormData;return s.append("request",JSON.stringify(n)),[s,i]};function Ss(e){return Promise.all(e.map((e=>e.then((e=>{throw e}),(e=>e))))).then((e=>{throw e}),(e=>e))}const fs=async e=>{let{fragementLength:t,referenceList:i,asyncMapHandler:n,allFailedhandler:s,promisesCollector:o}=e,a=0;const r=t;let c,d=0;const l=async()=>{const e=(()=>{const e=a*r,t=e+r;return i.slice(e,t).map(n)})();o&&o.push(...e);try{c=await Ss(e)}catch(e){if(d+=r,a++,!(d>=i.length))return void await l();s(e)}e.forEach((e=>e.cancel()))};return await l(),c},Cs=async e=>{let{referenceList:t,asyncMapHandler:i,closeFn:n}=e;const s=t.length;let o=0;const a=async()=>{const e=i(t.shift());try{return await e}catch(e){if(o++,o>=s||null!=n&&n(e))throw e;return a()}};return a()};async function Ts(e,i,n,s){const o=async function(e,i,n,s){let o=null;const a=[],r=async()=>{const o=E("WEBCS_DOMAIN").slice(0,E("AJAX_REQUEST_CONCURRENT")).map((t=>({url:e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v2/transpond/webrtc?v=2"):"https://".concat(t,"/api/v2/transpond/webrtc?v=2"),areaCode:$n()}))),r=s.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:o.map((e=>e.url))}),c=await fs({fragementLength:E("FRAGEMENT_LENGTH"),referenceList:o,asyncMapHandler:s=>(t.debug("[".concat(e.clientId,"] Connect to choose_server:"),s.url),ls(s,e,i,n)),allFailedhandler:e=>{throw s.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},r),e[0]},promisesCollector:a});return s.recordJoinChannelService({endTs:Date.now(),status:"success"},r),c},c=async()=>{if(await A(1e3),null!==o)return o;const r=E("WEBCS_DOMAIN_BACKUP_LIST").map((t=>({url:e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v2/transpond/webrtc?v=2"):"https://".concat(t,"/api/v2/transpond/webrtc?v=2"),areaCode:$n()}))),c=s.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:r.map((e=>e.url))}),d=await fs({fragementLength:E("FRAGEMENT_LENGTH"),referenceList:r,asyncMapHandler:s=>(t.debug("[".concat(e.clientId,"] Connect to backup choose_server:"),s.url),ls(s,e,i,n)),allFailedhandler:e=>{throw s.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},c),e[0]},promisesCollector:a});return s.recordJoinChannelService({endTs:Date.now(),status:"success"},c),d};try{return o=await Ss([r(),c()]),a.length&&a.forEach((e=>e.cancel&&"function"==typeof e.cancel&&e.cancel())),o}catch(e){throw e[0]}}(e,i,n,s);return{gatewayInfo:await o}}async function Rs(e,i,n,s,o){const a=e.cloudProxyServer;if("disabled"===a){if(!s)return;if(e.useLocalAccessPoint)return await Ts(e,i,n,o);if(E("JOIN_WITH_FALLBACK_MEDIA_PROXY")){const{gatewayInfo:t,proxyInfo:s}=await ys(e,i,n,o);if(e.turnServer&&"auto"!==e.turnServer.mode)return{gatewayInfo:t};const a=s.map((e=>({turnServerURL:e.address,tcpport:e.tcpport||Vt.tcpport,udpport:e.udpport||Vt.udpport,username:e.username||Vt.username,password:e.password||Vt.password,forceturn:!1,security:!0})));if(o.useP2P){var r;const i=null!==(r=e.uid)&&void 0!==r?r:t.uid,n="glb:".concat(i.toString()),o=await P(n),c=s.map((e=>({turnServerURL:e.address,tcpport:e.tcpport||Vt.tcpport,udpport:e.udpport||Vt.udpport,username:n,password:o,forceturn:!1,security:!0})));a.push(...c)}return e.turnServer={mode:"manual",servers:a},{gatewayInfo:t}}return await Ts(e,i,n,o)}const{proxyInfo:c,gatewayInfo:d}=await ys(e,i,n,o),l={gatewayInfo:d},h=c.map((e=>({turnServerURL:e.address,tcpport:"proxy3"===a?void 0:e.tcpport?e.tcpport:Vt.tcpport,udpport:"proxy4"===a?void 0:e.udpport?e.udpport:Vt.udpport,username:e.username||Vt.username,password:e.password||Vt.password,forceturn:"proxy4"!==a,security:"proxy5"===a})));if(o.useP2P){var u;const t=null!==(u=e.uid)&&void 0!==u?u:d.uid,i="glb:".concat(t.toString()),n=await P(i),s=c.map((e=>({turnServerURL:e.address,tcpport:"proxy3"===a?void 0:e.tcpport||Vt.tcpport,udpport:"proxy4"===a?void 0:e.udpport||Vt.udpport,username:i,password:n,forceturn:"proxy4"!==a,security:"proxy5"===a})));h.push(...s)}return e.turnServer={mode:"manual",servers:h},t.debug("[".concat(e.clientId,"] set proxy server: ").concat(e.proxyServer,", mode: ").concat(a)),l}async function Is(e,n,s,o,a){const r=E("ACCOUNT_REGISTER").slice(0,E("AJAX_REQUEST_CONCURRENT"));let c=[];c=n.proxyServer?r.map((e=>"https://".concat(n.proxyServer,"/ap/?url=").concat(e+"/api/v1"))):r.map((e=>"https://".concat(e,"/api/v1")));const d=null==a?void 0:a.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:c});try{const r=await async function(e,n,s,o,a){const r=Date.now(),c={sid:s.sid,opid:10,appid:s.appId,string_uid:n};let d=e[0];const l=await J((()=>Zn(d+"".concat(-1===d.indexOf("?")?"?":"&","action=stringuid"),{data:c,cancelToken:o,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}})),((s,o)=>{if(0===s.code){if(s.uid<=0||s.uid>=Math.pow(2,32))throw t.error("Invalid Uint Uid ".concat(n," => ").concat(s.uid),s),i.reqUserAccount(c.sid,{lts:r,success:!1,serverAddr:d,stringUid:c.string_uid,uid:s.uid,errorCode:h.INVALID_UINT_UID_FROM_STRING_UID,extend:c}),new ui(h.INVALID_UINT_UID_FROM_STRING_UID);return i.reqUserAccount(c.sid,{lts:r,success:!0,serverAddr:d,stringUid:c.string_uid,uid:s.uid,errorCode:null,extend:c}),!1}const a=Xi(s.code);return a.retry&&(d=e[(o+1)%e.length]),i.reqUserAccount(c.sid,{lts:r,success:!1,serverAddr:d,stringUid:c.string_uid,uid:s.uid,errorCode:a.desc,extend:c}),a.retry}),((t,n)=>t.code!==h.OPERATION_ABORTED&&(i.reqUserAccount(c.sid,{lts:r,success:!1,serverAddr:d,stringUid:c.string_uid,uid:null,errorCode:t.code,extend:c}),d=e[(n+1)%e.length],!0)),a);if(0!==l.code){const e=Xi(l.code);throw new ui(h.UNEXPECTED_RESPONSE,e.desc)}return l}(c,e,n,s,o);return null==a||a.recordJoinChannelService({status:"success",endTs:Date.now()},d),r.uid}catch(e){throw null==a||a.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[e]},d),e}}async function gs(e,t,i){const n=E("ACCOUNT_REGISTER");let s=[];s=t.proxyServer?n.map((e=>"https://".concat(t.proxyServer,"/ap/?url=").concat(e+"/api/v1"))):n.map((e=>"https://".concat(e,"/api/v1")));try{const n=await Cs({referenceList:s,asyncMapHandler:n=>async function(e,t,i,n){const s=Date.now(),o={sid:i.sid,opid:10,appid:i.appId,string_uid:t};try{const t=await Zn(e+"".concat(-1===e.indexOf("?")?"?":"&","action=stringuid"),{data:o,cancelToken:n,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}});if(0!==t.code){const e=Xi(t.code);throw new ui(h.UNEXPECTED_RESPONSE,"preload sua error:".concat(e.desc),e)}if(t.uid<=0||t.uid>=Math.pow(2,32))throw new ui(h.INVALID_UINT_UID_FROM_STRING_UID);return{requestTime:s,url:e,req:o,uid:t.uid,elapse:Date.now()-s}}catch(e){throw e}}(n,e,t,i),closeFn:e=>e.code===h.OPERATION_ABORTED||e.code===h.UNEXPECTED_RESPONSE&&!e.data.retry});return n}catch(e){throw e}}async function As(e,t,n){const s=E("CDS_AP").slice(0,E("AJAX_REQUEST_CONCURRENT")).map((t=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v1"):"https://".concat(t,"/api/v1?action=config"))).map((i=>function(e,t,i,n){const s=U(),o={flag:64,cipher_method:0,features:{device:s.name,system:s.os,system_general:navigator.userAgent,vendor:t.appId,version:j,cname:t.cname,sid:t.sid,session_id:t.sid,detail:"",proxyServer:t.proxyServer}};return J((()=>Zn(e,{data:o,timeout:1e3,cancelToken:i,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}})),void 0,(e=>e.code!==h.OPERATION_ABORTED),n)}(i,e,t,n)));let o=null,a=null,r={};try{o=await Ss(s)}catch(e){if(e.code===h.OPERATION_ABORTED)throw e;a=e}s.forEach((e=>e.cancel()));if(i.reportApiInvoke(e.sid,{name:Y.REQUEST_CONFIG_DISTRIBUTE,options:{error:a,res:o}}).onSuccess(),o&&o.test_tags)try{r=function(e){if(!e.test_tags)return{};const t=e.test_tags,i=Object.keys(t),n={};return i.forEach((e=>{const i=e.slice(4).trim(),s=JSON.parse(t[e])[1];n[i]=s})),n}(o)}catch(e){}return r}async function vs(e,i){const n=E("WEBCS_DOMAIN").concat(E("WEBCS_DOMAIN_BACKUP_LIST")).map((e=>({url:"https://".concat(e,"/api/v2/transpond/webrtc?v=2"),areaCode:$n(),serviceIds:[ln.CHOOSE_SERVER,ln.CLOUD_PROXY_FALLBACK]})));try{const s=await Cs({referenceList:n,asyncMapHandler:n=>async function(e,i,n){let s,{url:o,areaCode:a,serviceIds:r}=e;const c=Date.now(),[d,l]=Es(i,a,r);let u=R.networkState;try{u&&R.networkState===T.OFFLINE&&R.onlineWaiter&&await Promise.race([R.onlineWaiter,A(X.maxRetryTimeout)]),u=R.networkState;const{data:e,headers:i}=await Zn(o,{data:d,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);s="1"===i.http3?1:-1,(e=>{const i=[];if(e.response_body.forEach((n=>{const s=n.buffer.code;if(23===n.uri&&0===s&&!n.buffer.edges_services)if(4194310===n.buffer.flag)n.buffer.edges_services=[];else{const t={error:new ui(h.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:e.detail[502]}),flag:n.buffer.flag};i.push(t)}if(0!==s){const o=Xi(s),a={error:new ui(h.CAN_NOT_GET_GATEWAY_SERVER,o.desc,{desc:o.desc,retry:o.retry,csIp:e.detail[502]}),flag:n.buffer.flag};4194310===n.buffer.flag?t.warning(a.error.toString()):i.push(a)}})),i.length)throw new ui(h.CAN_NOT_GET_GATEWAY_SERVER,i.map((e=>"flag: ".concat(e.flag,", message: ").concat(e.error.message))).join(" | "),{retry:!!i.find((e=>e.error.data.retry)),csIp:e.detail[502],desc:[...new Set(i.map((e=>{var t;return null==e||null===(t=e.error)||void 0===t||null===(t=t.data)||void 0===t?void 0:t.desc})).filter((e=>!!e)))]})})(e);const a=mn(e,ln.CHOOSE_SERVER),r=mn(e,ln.CLOUD_PROXY_FALLBACK);return ps(a),{gatewayInfo:un(a,o),proxyInfo:r,opid:l,requestTime:c,url:o,isHttp3:s,elapse:Date.now()-c}}catch(e){throw e}}(n,e,i),closeFn:e=>e.code===h.OPERATION_ABORTED||e.code===h.CAN_NOT_GET_GATEWAY_SERVER&&!e.data.retry});return s}catch(e){throw e}}async function ys(e,n,s,o){const a=E("PROXY_SERVER_TYPE3"),r=(e,t,i)=>{let n=i||a;return Array.isArray(n)&&(n=t%2==0?a[1]:a[0]),"https://".concat(n,"/ap/?url=").concat(e)};let c=null;const d=[],l=async()=>{const i=E("WEBCS_DOMAIN").slice(0,E("AJAX_REQUEST_CONCURRENT")).map(((t,i)=>{let n;return n="disabled"===e.cloudProxyServer&&e.proxyServer?r("".concat(t,"/api/v2/transpond/webrtc?v=2"),i,e.proxyServer):"disabled"===e.cloudProxyServer||"fallback"===e.cloudProxyServer?"https://".concat(t,"/api/v2/transpond/webrtc?v=2"):r("".concat(t,"/api/v2/transpond/webrtc?v=2"),i),{url:n,areaCode:$n(),serviceIds:[ln.CHOOSE_SERVER,"proxy5"===e.cloudProxyServer?ln.CLOUD_PROXY_5:"proxy3"===e.cloudProxyServer||"proxy4"===e.cloudProxyServer?ln.CLOUD_PROXY:ln.CLOUD_PROXY_FALLBACK]}})),a=o.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:i.map((e=>e.url))}),c=await fs({fragementLength:E("FRAGEMENT_LENGTH"),referenceList:i,asyncMapHandler:i=>(t.debug("[".concat(e.clientId,"] Connect to choose_server:"),i.url),hs(i,e,n,s)),allFailedhandler:e=>{throw o.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},a),e[0]},promisesCollector:d});return o.recordJoinChannelService({endTs:Date.now(),status:"success"},a),c},u=async()=>{if(await A(1e3),null!==c)return c;const i=E("WEBCS_DOMAIN_BACKUP_LIST").map(((t,i)=>{let n;return n="disabled"===e.cloudProxyServer&&e.proxyServer?r("".concat(t,"/api/v2/transpond/webrtc?v=2"),i,e.proxyServer):"disabled"===e.cloudProxyServer||"fallback"===e.cloudProxyServer?"https://".concat(t,"/api/v2/transpond/webrtc?v=2"):r("".concat(t,"/api/v2/transpond/webrtc?v=2"),i),{url:n,areaCode:$n(),serviceIds:[ln.CHOOSE_SERVER,"proxy5"===e.cloudProxyServer?ln.CLOUD_PROXY_5:"proxy3"===e.cloudProxyServer||"proxy4"===e.cloudProxyServer?ln.CLOUD_PROXY:ln.CLOUD_PROXY_FALLBACK]}})),a=o.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:i.map((e=>e.url))}),l=await fs({fragementLength:E("FRAGEMENT_LENGTH"),referenceList:i,asyncMapHandler:i=>(t.debug("[".concat(e.clientId,"] Connect to backup choose_server:"),i.url),hs(i,e,n,s)),allFailedhandler:e=>{throw o.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},a),e[0]},promisesCollector:d});return o.recordJoinChannelService({endTs:Date.now(),status:"success"},a),l};let p,_,m;try{({gatewayInfo:p,proxyInfo:_,url:m}=await Ss([l(),u()]))}catch(e){throw e[0]}if(d.length&&d.forEach((e=>e.cancel&&"function"==typeof e.cancel&&e.cancel())),!p||!_)throw new ui(h.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(e.apUrl=m,"disabled"!==e.cloudProxyServer&&Array.isArray(a)&&m){const n=/^https?:\/\/(.+?)(\/.*)?$/.exec(m)[1];a.includes(n)&&(e.proxyServer=n,t.setProxyServer(n),i.setProxyServer(n))}return c={gatewayInfo:p,proxyInfo:await Sn(_,p.uid)},c}async function ws(e,i,n){let s=null;const o=[],a=async a=>{const r=E(a?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map((t=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v2/transpond/webrtc?v=2"):"https://".concat(t,"/api/v2/transpond/webrtc?v=2")));return a&&(await A(1e3),null!==s)?s:await fs({fragementLength:E("FRAGEMENT_LENGTH"),referenceList:r,asyncMapHandler:s=>(t.debug("[".concat(e.clientId,"] update ticket, Connect to ").concat(a?"backup":""," choose_server:"),s),function(e,i,n,s){const[o]=ms(i,[ln.CHOOSE_SERVER]);let a=R.networkState;return J((async()=>{a&&R.networkState===T.OFFLINE&&R.onlineWaiter&&await Promise.race([R.onlineWaiter,A(s&&s.maxRetryTimeout||X.maxRetryTimeout)]),a=R.networkState;const t=await Zn(e,{data:o,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0);return _s(t,e)}),(()=>!1),(e=>e.code!==h.OPERATION_ABORTED&&(e.code===h.UPDATE_TICKET_FAILED?e.data.retry:(t.warning("[".concat(i.clientId,"] update ticket network error, retry"),e),!0))),s)}(s,e,i,n)),allFailedhandler:e=>{throw e[0]},promisesCollector:o})};try{return s=await Ss([a(!1),a(!0)]),o.length&&o.forEach((e=>e.cancel&&"function"==typeof e.cancel&&e.cancel())),s}catch(e){throw e[0]}}class bs extends _{get isSuccess(){return!!this.configs}constructor(){super(),this.configs=void 0,this.joinInfo=void 0,this.cancelToken=void 0,this.retryConfig={timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4},this.interval=void 0,this.mutex=new C("config-distribute"),this.mutableParamsRead=!1}startGetConfigDistribute(e,t){this.joinInfo=e,this.cancelToken=t,this.interval&&this.stopGetConfigDistribute(),E("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval((()=>{this.updateConfigDistribute()}),E("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0}async awaitConfigDistributeComplete(){if(!this.mutex.isLocked)return;(await this.mutex.lock())()}async updateConfigDistribute(){if(!this.mutableParamsRead){this.mutableParamsRead=!0;i.reportApiInvoke(null,{options:void 0,name:Y.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:q.TRACER}).onSuccess(JSON.stringify(d))}if(!this.joinInfo||!this.cancelToken||!this.retryConfig)return void t.debug("[config-distribute] get config distribute interrupted have no joininfo");let e;const n=await this.mutex.lock();try{e=await As(this.joinInfo,this.cancelToken,this.retryConfig),t.debug("[config-distribute] get config distribute",JSON.stringify(e)),e.limit_bitrate&&this.handleBitrateLimit(e.limit_bitrate),this.cacheGlobalParameterConfig(e),this.configs=e}catch(e){const i=new ui(h.NETWORK_RESPONSE_ERROR,e);t.warning("[config-distribute] ".concat(i.toString()))}finally{n()}}getBitrateLimit(){return this.configs?this.configs.limit_bitrate:void 0}handleBitrateLimit(e){var t;(t=e)&&t.uplink&&t.id&&void 0!==t.uplink.max_bitrate&&void 0!==t.uplink.min_bitrate&&(this.configs&&this.configs.limit_bitrate?this.configs&&this.configs.limit_bitrate&&this.configs.limit_bitrate.id!==e.id&&this.emit(Ni.UPDATE_BITRATE_LIMIT,e):this.emit(Ni.UPDATE_BITRATE_LIMIT,e))}getLowStreamConfigDistribute(){return this.configs&&this.configs.limit_bitrate&&Xt({},this.configs.limit_bitrate.low_stream_uplink)}cacheGlobalParameterConfig(e){const i=Object.keys(e).filter((e=>/^webrtc_ng_global_parameter/.test(e))).sort();for(let t=0;t<i.length;t++)for(let n=i.length-1;n>t;n--){const t=i[n];if("number"==typeof e[t].__priority){const s=e[t].__priority,o=i[n-1];if("number"==typeof e[o].__priority){if(!(s>e[o].__priority))continue;{const e=t;i[n]=i[n-1],i[n-1]=e}}else{const e=t;i[n]=i[n-1],i[n-1]=e}}}const n={};i.forEach((t=>{const i=e[t],s=i.__expires;Object.keys(i).forEach((e=>{"__priority"===e||"__expires"===e||Object.prototype.hasOwnProperty.call(n,e)||(n[e]=Xt({value:i[e]},s&&{expires:s}))}))}));try{!function(e){try{const i=Date.now();Object.keys(e).forEach((n=>{switch(n){case"ENABLE_EVENT_REPORT":case"UPLOAD_LOG":case"ENABLE_AG_ADAPTATION":case"FORCE_AG_HIGH_FRAMERATE":case"FORCE_SUPPORT_AG_ADAPTATION":case"ENCODER_CONFIG_LIMIT":case"CAMERA_CAPTURE_CONFIG":case"ENABLE_PRELOAD":if(Object.prototype.hasOwnProperty.call(c,n)){const{value:s,expires:o}=e[n];if(o&&o<=i)return;d[n]=s,c[n]=s,t.debug("Update global parameters from config distribute",n,s)}}}))}catch(i){t.error("Error update config immediately: ".concat(e),i.message)}}(n);const e=JSON.stringify(n),i=window.btoa(e);window.localStorage.setItem("websdk_ng_global_parameter",i),t.debug("Caching global parameters ".concat(e))}catch(e){t.error("Error caching global parameters:",e.message)}}}class Ns extends _{constructor(){super(...arguments),this.resultStorage=new Map}setLocalAudioStats(e,t,i){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",e,this.checkAudioInputLevel(i,t)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",e,this.checkSendAudioBitrate(i,t))}setLocalVideoStats(e,t,i){this.record("SEND_VIDEO_BITRATE_TOO_LOW",e,this.checkSendVideoBitrate(i,t)),this.record("FRAMERATE_INPUT_TOO_LOW",e,this.checkFramerateInput(i,t)),this.record("FRAMERATE_SENT_TOO_LOW",e,this.checkFramerateSent(i))}setRemoteAudioStats(e,t){const i=e.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",i,this.checkAudioOutputLevel(t))}setRemoteVideoStats(e,t){const i=e.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",i,this.checkVideoDecode(t))}record(e,t,i){if(E("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(e)||this.resultStorage.set(e,{result:[],isPrevNormal:!0});const n=this.resultStorage.get(e);if(n&&(n.result.push(i),n.result.length>=5)){const i=n.result.includes(!0);n.isPrevNormal&&!i&&this.emit("exception",Os[e],e,t),!n.isPrevNormal&&i&&this.emit("exception",Os[e]+2e3,e+"_RECOVER",t),n.isPrevNormal=i,n.result=[]}}checkAudioOutputLevel(e){return!(e.receiveBitrate>0&&0===e.receiveLevel)}checkAudioInputLevel(e,t){return t instanceof Ze&&!t.isActive||(!!t.muted||0!==e.sendVolumeLevel)}checkFramerateInput(e,t){let i=null;t._encoderConfig&&t._encoderConfig.frameRate&&(i=pn(t._encoderConfig.frameRate));const n=e.captureFrameRate;return!i||!n||!(i>10&&n<5||i<10&&i>=5&&n<=1)}checkFramerateSent(e){return!(e.captureFrameRate&&e.sendFrameRate&&e.captureFrameRate>5&&e.sendFrameRate<=1)}checkSendVideoBitrate(e,t){return!!t.muted||0!==e.sendBitrate}checkSendAudioBitrate(e,t){return t instanceof Ze&&!t.isActive||(!!t.muted||0!==e.sendBitrate)}checkVideoDecode(e){return 0===e.receiveBitrate||0!==e.decodeFrameRate}}const Os={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003};const Ds=new class{markSubscribeStart(e,t){performance.mark("agora-web-sdk/".concat(e,"/subscribe-").concat(t))}markPublishStart(e,t){performance.mark("agora-web-sdk/".concat(e,"/publish-").concat(t))}measureFromSubscribeStart(e,t){const i=performance.getEntriesByName("agora-web-sdk/".concat(e,"/subscribe-").concat(t));if(i.length>0){const e=i[i.length-1];return Math.round(performance.now()-e.startTime)}return 0}measureFromPublishStart(e,t){const i=performance.getEntriesByName("agora-web-sdk/".concat(e,"/publish-").concat(t));if(i.length>0){const e=i[i.length-1];return Math.round(performance.now()-e.startTime)}return 0}};function Ps(e){if(Array.isArray(e))return e.map((e=>e));if(!Ls(e))return e;const t={};for(const i in e){const n=e[i];Ls(n)||Array.isArray(n)?t[i]=Ps(n):t[i]=n}return t}function Ls(e){return!("object"!=typeof e||Array.isArray(e)||!e)}class ks{constructor(e){this.input=[],this.size=void 0,this.size=e}add(e){this.input.push(e),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return 0===this.input.length?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}}const Ms={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},Us={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],selectedCandidatePair:{id:"unknown",localCandidate:Ms,remoteCandidate:Ms}},Vs={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0,framesDroppedCount:0,outputFrameRate:0},xs={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0,qpSumPerFrame:0},Fs={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0},Bs={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packetsDiscarded:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0};class Gs{constructor(e,t){this.onFirstVideoReceived=void 0,this.onFirstVideoDecoded=void 0,this.onFirstAudioReceived=void 0,this.onFirstVideoDecodedTimeout=void 0,this.onFirstAudioDecoded=void 0,this.onSelectedLocalCandidateChanged=void 0,this.onSelectedRemoteCandidateChanged=void 0,this.videoIsReady=!1,this.videoIsReady2={},this.pc=void 0,this.options=void 0,this.intervalTimer=void 0,this.stats=Ps(Us),this.isFirstVideoReceived={},this.isFirstVideoDecoded={},this.isFirstAudioReceived={},this.isFirstAudioDecoded={},this.isFirstVideoDecodedTimeout={},this.lossRateWindowStats=[],this.pc=e,this.options=t,this.intervalTimer=window.setInterval((async()=>{this.updateStats()}),this.options.updateInterval)}getStats(){return this.stats}getSelectedCandidatePair(){return new Promise((e=>{e({local:Xt({},Ms),remote:Xt({},Ms)})}))}setVideoIsReady(e){this.videoIsReady=e}setVideoIsReady2(e,t){this.videoIsReady2[e]=t}getVideoIsReady(e){return this.videoIsReady2[e]||!1}setIsFirstAudioDecoded(e){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(e){this.lossRateWindowStats.push(e),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);const t=this.lossRateWindowStats.length,i=["videoSend","audioSend","videoRecv","audioRecv"];let n=0,s=0,o=0,a=0;for(const r of i)e[r].forEach(((e,i)=>{if(!this.lossRateWindowStats[t-1][r][i]||!this.lossRateWindowStats[0][r][i])return;const c=this.lossRateWindowStats[t-1][r][i].packets-this.lossRateWindowStats[0][r][i].packets,d=this.lossRateWindowStats[t-1][r][i].packetsLost-this.lossRateWindowStats[0][r][i].packetsLost;"videoSend"===r||"audioSend"===r?(n+=c,o+=d):(s+=c,a+=d),Number.isNaN(c)||Number.isNaN(c)?e.packetLostRate=0:e.packetLostRate=c<=0||d<=0?0:d/(c+d)}));e.sendPacketLossRate=n<=0||o<=0?0:o/(n+o),e.recvPacketLossRate=s<=0||a<=0?0:a/(s+a)}}class js extends Gs{constructor(){super(...arguments),this._stats=Us,this.lastDecodeVideoReceiverStats=new Map}async updateStats(){const e=await this._getStats(),t=this.statsResponsesToObjects(e);this._stats=Ps(Us);const i=t.filter((e=>"ssrc"===e.type));this.processSSRCStats(i);const n=t.find((e=>"VideoBwe"===e.type));n&&this.processBandwidthStats(n),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processBandwidthStats(e){this._stats.bitrate={actualEncoded:Number(e.googActualEncBitrate),targetEncoded:Number(e.googTargetEncBitrate),retransmit:Number(e.googRetransmitBitrate),transmit:Number(e.googTransmitBitrate)},this._stats.sendBandwidth=Number(e.googAvailableSendBandwidth)}processSSRCStats(e){e.forEach((e=>{const t=e.id.includes("send");switch("".concat(e.mediaType,"_").concat(t?"send":"recv")){case"video_send":{const t=Ps(xs);t.codec=e.googCodecName,t.adaptionChangeReason="none",e.googCpuLimitedResolution&&(t.adaptionChangeReason="cpu"),e.googBandwidthLimitedResolution&&(t.adaptionChangeReason="bandwidth"),t.avgEncodeMs=Number(e.googAvgEncodeMs),t.inputFrame={width:Number(e.googFrameWidthInput)||Number(e.googFrameWidthSent),height:Number(e.googFrameHeightInput)||Number(e.googFrameHeightSent),frameRate:Number(e.googFrameRateInput)},t.sentFrame={width:Number(e.googFrameWidthSent),height:Number(e.googFrameHeightSent),frameRate:Number(e.googFrameRateInput)},t.firsCount=Number(e.googFirReceived),t.nacksCount=Number(e.googNacksReceived),t.plisCount=Number(e.googPlisReceived),t.frameCount=Number(e.framesEncoded),t.bytes=Number(e.bytesSent),t.packets=Number(e.packetsSent),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.rttMs=Number(e.googRtt||0),this._stats.videoSend.push(t),this._stats.rtt=t.rttMs;break}case"video_recv":{const t=Ps(Vs),i=this.lastDecodeVideoReceiverStats.get(Number(e.ssrc));if(t.codec=e.googCodecName,t.targetDelayMs=Number(e.googTargetDelayMs),t.renderDelayMs=Number(e.googRenderDelayMs),t.currentDelayMs=Number(e.googCurrentDelayMs),t.minPlayoutDelayMs=Number(e.googMinPlayoutDelayMs),t.decodeMs=Number(e.googDecodeMs),t.maxDecodeMs=Number(e.googMaxDecodeMs),t.receivedFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateReceived)},t.decodedFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateDecoded)},t.decodeFrameRate=Number(e.googFrameRateDecoded),t.outputFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateOutput)},t.jitterBufferMs=Number(e.googJitterBufferMs),t.firsCount=Number(e.googFirsSent),t.nacksCount=Number(e.googNacksSent),t.plisCount=Number(e.googPlisSent),t.framesDecodeCount=Number(e.framesDecoded),t.bytes=Number(e.bytesReceived),t.packets=Number(e.packetsReceived),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.packets>0&&!this.isFirstVideoReceived[t.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(t.ssrc),this.isFirstVideoReceived[t.ssrc]=!0),t.framesDecodeCount>0&&!this.isFirstVideoDecoded[t.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(t.ssrc,t.decodedFrame.width,t.decodedFrame.height),this.isFirstVideoDecoded[t.ssrc]=!0),i){const n=i.stats,s=Date.now()-i.lts;t.framesDecodeFreezeTime=n.framesDecodeFreezeTime,t.framesDecodeInterval=n.framesDecodeInterval,t.framesDecodeCount>n.framesDecodeCount&&this.isFirstVideoDecoded[t.ssrc]?(i.lts=Date.now(),t.framesDecodeInterval=s,t.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc,10))?t.framesDecodeFreezeTime+=t.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):t.framesDecodeCount<i.stats.framesDecodeCount&&(t.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(t.ssrc,{stats:Xt({},t),lts:Date.now()}),this._stats.videoRecv.push(t);break}case"audio_recv":{const t=Ps(Bs);t.codec=e.googCodecName,t.outputLevel=Math.abs(Number(e.audioOutputLevel))/32767,t.decodingCNG=Number(e.googDecodingCNG),t.decodingCTN=Number(e.googDecodingCTN),t.decodingCTSG=Number(e.googDecodingCTSG),t.decodingNormal=Number(e.googDecodingNormal),t.decodingPLC=Number(e.googDecodingPLC),t.decodingPLCCNG=Number(e.googDecodingPLCCNG),t.expandRate=Number(e.googExpandRate),t.accelerateRate=Number(e.googAccelerateRate),t.preemptiveExpandRate=Number(e.googPreemptiveExpandRate),t.secondaryDecodedRate=Number(e.googSecondaryDecodedRate),t.speechExpandRate=Number(e.googSpeechExpandRate),t.preferredJitterBufferMs=Number(e.googPreferredJitterBufferMs),t.jitterBufferMs=Number(e.googJitterBufferMs),t.jitterMs=Number(e.googJitterReceived),t.bytes=Number(e.bytesReceived),t.packets=Number(e.packetsReceived),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.receivedFrames=Number(e.googDecodingCTN)||Number(e.packetsReceived),t.droppedFrames=Number(e.googDecodingPLC)+Number(e.googDecodingPLCCNG)||Number(e.packetsLost),t.receivedFrames>0&&!this.isFirstAudioReceived[t.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(t.ssrc),this.isFirstAudioReceived[t.ssrc]=!0),t.decodingNormal>0&&!this.isFirstAudioDecoded[t.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(t.ssrc),this.isFirstAudioDecoded[t.ssrc]=!0),this._stats.audioRecv.push(t);break}case"audio_send":{const t=Ps(Fs);t.codec=e.googCodecName,t.inputLevel=Math.abs(Number(e.audioInputLevel))/32767,t.aecReturnLoss=Number(e.googEchoCancellationReturnLoss||0),t.aecReturnLossEnhancement=Number(e.googEchoCancellationReturnLossEnhancement||0),t.residualEchoLikelihood=Number(e.googResidualEchoLikelihood||0),t.residualEchoLikelihoodRecentMax=Number(e.googResidualEchoLikelihoodRecentMax||0),t.bytes=Number(e.bytesSent),t.packets=Number(e.packetsSent),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.rttMs=Number(e.googRtt||0),this._stats.rtt=t.rttMs,this._stats.audioSend.push(t);break}}}))}_getStats(){return new Promise(((e,t)=>{this.pc.getStats(e,t)}))}statsResponsesToObjects(e){const t=[];return e.result().forEach((e=>{const i={id:e.id,timestamp:e.timestamp.valueOf().toString(),type:e.type};e.names().forEach((t=>{i[t]=e.stat(t)})),t.push(i)})),t}}class Ws extends Gs{constructor(){super(...arguments),this._stats=Us,this.report=void 0,this.lastDecodeVideoReceiverStats=new Map,this.lastVideoFramesRecv=new Map,this.lastVideoFramesSent=new Map,this.lastVideoFramesDecode=new Map,this.lastVideoFramesOutput=new Map,this.lastVideoJBDelay=new Map,this.lastAudioJBDelay=new Map,this.mediaBytesSent=new Map,this.mediaBytesRetransmit=new Map,this.mediaBytesTargetEncode=new Map,this.lastEncoderMs=new Map}async updateStats(){this.report=await this.pc.getStats(),this._stats=Ps(Us),this.report.forEach((e=>{switch(e.type){case $t.OUTBOUND:case $t.INBOUND:{const t=e.mediaType||e.kind,i=!t&&"frameWidth"in e,n=!t&&!("frameWidth"in e);e.type===$t.OUTBOUND?"audio"===t||n?this.processAudioOutboundStats(e):("video"===t||i)&&this.processVideoOutboundStats(e):e.type===$t.INBOUND&&("audio"===t||n?this.processAudioInboundStats(e):("video"===t||i)&&this.processVideoInboundStats(e));break}case $t.TRANSPORT:{const t=this.report.get(e.selectedCandidatePairId);t&&this.processCandidatePairStats(t);break}case $t.CANDIDATE_PAIR:e.selected&&this.processCandidatePairStats(e)}})),this.updateSendBitrate(),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}async getSelectedCandidatePair(){const e=await this.pc.getStats(),t={local:Xt({},Ms),remote:Xt({},Ms)};return e.forEach((i=>{let n;if(i.type===$t.TRANSPORT&&(n=e.get(i.selectedCandidatePairId)),i.type===$t.CANDIDATE_PAIR&&i.selected&&(n=i),n){const i=(e,t)=>{e.type=t.type,e.id=t.id,t.address&&(e.address=t.address),t.candidateType&&(e.candidateType=t.candidateType),t.port&&(e.port=t.port),t.priority&&(e.priority=t.priority),t.protocol&&(e.protocol=t.protocol),t.relayProtocol&&(e.relayProtocol=t.relayProtocol)};if(n.localCandidateId){const s=e.get(n.localCandidateId);s&&i(t.local,s)}if(n.remoteCandidateId){const s=e.get(n.remoteCandidateId);s&&i(t.remote,s)}}})),t}processCandidatePairStats(e){if(this._stats.sendBandwidth=e.availableOutgoingBitrate||0,e.currentRoundTripTime&&(this._stats.rtt=1e3*e.currentRoundTripTime),this._stats.videoSend.forEach((t=>{e.currentRoundTripTime&&(t.rttMs=1e3*e.currentRoundTripTime)})),this._stats.audioSend.forEach((t=>{e.currentRoundTripTime&&(t.rttMs=1e3*e.currentRoundTripTime)})),this._stats.selectedCandidatePair.id=e.id,e.localCandidateId){const t=this.report.get(e.localCandidateId);t&&this.processCandidateStats(t)}if(e.remoteCandidateId){const t=this.report.get(e.remoteCandidateId);t&&this.processCandidateStats(t)}}processCandidateStats(e){let t;e.type===$t.LOCAL_CANDIDATE&&(t=this._stats.selectedCandidatePair.localCandidate),e.type===$t.REMOTE_CANDIDATE&&(t=this._stats.selectedCandidatePair.remoteCandidate),t&&(t.type=e.type,t.id=e.id,e.address&&(t.address=e.address),e.candidateType&&(t.candidateType=e.candidateType),e.port&&(t.port=e.port),e.priority&&(t.priority=e.priority),e.protocol&&(t.protocol=e.protocol),e.relayProtocol&&(t.relayProtocol=e.relayProtocol),e.type===$t.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==t.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(Xt({},t),Xt({},this.stats.selectedCandidatePair.localCandidate)),e.type===$t.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==t.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(Xt({},t),Xt({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(e){let t=this._stats.audioRecv.find((t=>t.ssrc===e.ssrc));t||(t=Ps(Bs),this._stats.audioRecv.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsReceived,t.packetsLost=e.packetsLost,t.packetsDiscarded=e.packetsDiscarded,t.bytes=e.bytesReceived,t.jitterMs=1e3*e.jitter,this.processAudioTrackReceiverStats(e,e.trackId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),t.receivedFrames||(t.receivedFrames=e.packetsReceived),t.droppedFrames||(t.droppedFrames=e.packetsLost),t.receivedFrames>0&&!this.isFirstAudioReceived[t.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(t.ssrc),this.isFirstAudioReceived[t.ssrc]=!0),t.outputLevel&&t.outputLevel>0&&!this.isFirstAudioDecoded[t.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(t.ssrc),this.isFirstAudioDecoded[t.ssrc]=!0),"number"==typeof e.concealedSamples&&(t.concealedSamples=e.concealedSamples)}processVideoInboundStats(e){let t=this._stats.videoRecv.find((t=>t.ssrc===e.ssrc));t||(t=Ps(Vs),this._stats.videoRecv.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsReceived,t.packetsLost=e.packetsLost,t.bytes=e.bytesReceived,t.firsCount=e.firCount,t.nacksCount=e.nackCount,t.plisCount=e.pliCount,t.framesDecodeCount=e.framesDecoded,t.framesDroppedCount=e.framesDropped,t.totalInterFrameDelay=e.totalInterFrameDelay,t.totalSquaredInterFrameDelay=e.totalSquaredInterFrameDelay,t.totalFreezesDuration=e.totalFreezesDuration;const i=this.lastDecodeVideoReceiverStats.get(t.ssrc),n=this.lastVideoFramesDecode.get(t.ssrc),s=this.lastVideoFramesOutput.get(t.ssrc),o=Date.now();if(t.framesDecodeCount>0&&!this.isFirstVideoDecoded[t.ssrc]){const e=t.decodedFrame?t.decodedFrame.width:0,i=t.decodedFrame?t.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(t.ssrc,e,i),this.isFirstVideoDecoded[t.ssrc]=!0}if(i){const n=i.stats,s=o-i.lts;t.framesDecodeFreezeTime=n.framesDecodeFreezeTime,t.framesDecodeInterval=n.framesDecodeInterval,!this.isFirstVideoDecoded[t.ssrc]&&s>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[t.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(t.ssrc),this.isFirstVideoDecodedTimeout[t.ssrc]=!0),t.framesDecodeCount>n.framesDecodeCount&&this.isFirstVideoDecoded[t.ssrc]?(i.lts=Date.now(),t.framesDecodeInterval=s,t.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc))?t.framesDecodeFreezeTime+=t.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):t.framesDecodeCount<n.framesDecodeCount&&(t.framesDecodeInterval=0),e.framesDecoded&&e.qpSum&&(i.stats.framesDecodeCount>e.framesDecoded?t.qpSumPerFrame=e.qpSum/e.framesDecoded:t.qpSumPerFrame=(e.qpSum-i.qpSum)/(e.framesDecoded-i.stats.framesDecodeCount))}n&&o-n.lts>=800?(t.decodeFrameRate=Math.round((t.framesDecodeCount-n.count)/((o-n.lts)/1e3)),this.lastVideoFramesDecode.set(t.ssrc,{count:t.framesDecodeCount,lts:o,rate:t.decodeFrameRate})):n?t.decodeFrameRate=n.rate:this.lastVideoFramesDecode.set(t.ssrc,{count:t.framesDecodeCount,lts:o,rate:0}),t.framesDroppedCount&&e.framesReceived&&(s&&o-s.lts>=800?(t.outputFrameRate=Math.round((e.framesReceived-t.framesDroppedCount-s.count)/((o-s.lts)/1e3)),this.lastVideoFramesOutput.set(t.ssrc,{count:e.framesReceived-t.framesDroppedCount,lts:o,rate:Math.max(t.outputFrameRate,0)})):s?t.outputFrameRate=s.rate:this.lastVideoFramesOutput.set(t.ssrc,{count:e.framesReceived-t.framesDroppedCount,lts:o,rate:0})),e.totalDecodeTime&&(t.decodeMs=1e3*e.totalDecodeTime),this.processVideoTrackReceiverStats(e,e.trackId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),e.framerateMean&&(t.framesRateFirefox=e.framerateMean),t.packets>0&&!this.isFirstVideoReceived[t.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(t.ssrc),this.isFirstVideoReceived[t.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(t.ssrc,{stats:Xt({},t),lts:i?i.lts:Date.now(),qpSum:e.qpSum})}processVideoOutboundStats(e){let t=this._stats.videoSend.find((t=>t.ssrc===e.ssrc));t||(t=Ps(xs),this._stats.videoSend.push(t));const i=this.mediaBytesSent.get(e.ssrc);if(i)i.add(e.bytesSent);else{const t=new ks(10);t.add(e.bytesSent),this.mediaBytesSent.set(e.ssrc,t)}if(void 0!==e.retransmittedBytesSent){const t=this.mediaBytesRetransmit.get(e.ssrc);if(t)t.add(e.retransmittedBytesSent);else{const t=new ks(10);t.add(e.retransmittedBytesSent),this.mediaBytesRetransmit.set(e.ssrc,t)}}if(e.totalEncodedBytesTarget){const t=this.mediaBytesTargetEncode.get(e.ssrc);if(t)t.add(e.totalEncodedBytesTarget);else{const t=new ks(10);t.add(e.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(e.ssrc,t)}}if(t.ssrc=e.ssrc,t.bytes=e.bytesSent,t.packets=e.packetsSent,t.firsCount=e.firCount,t.nacksCount=e.nackCount,t.plisCount=e.pliCount,t.frameCount=e.framesEncoded,t.adaptionChangeReason=e.qualityLimitationReason,t.scalabilityMode=e.scalabilityMode,e.totalEncodeTime&&e.framesEncoded){const i=this.lastEncoderMs.get(e.ssrc);if(!i||i.lastFrameCount>e.framesEncoded)t.avgEncodeMs=1e3*e.totalEncodeTime/e.framesEncoded;else{const n=e.framesEncoded-i.lastFrameCount,s=e.totalEncodeTime-i.lastEncoderTime;t.avgEncodeMs=1e3*s/n}}if(e.framesEncoded&&e.qpSum){const i=this.lastEncoderMs.get(e.ssrc);!i||i.lastFrameCount>e.framesEncoded?t.qpSumPerFrame=e.qpSum/e.framesEncoded:t.qpSumPerFrame=(e.qpSum-i.lastQpSum)/(e.framesEncoded-i.lastFrameCount)}if(this.lastEncoderMs.set(e.ssrc,{lastFrameCount:e.framesEncoded,lastEncoderTime:e.totalEncodeTime,lastQpSum:e.qpSum,lts:Date.now()}),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),e.mediaSourceId&&this.processVideoMediaSource(e.mediaSourceId,t),this.processVideoTrackSenderStats(e,e.trackId,t),e.remoteId)this.processRemoteInboundStats(e.remoteId,t);else{const i=this.findRemoteStatsId(e.ssrc,$t.REMOTE_INBOUND);i&&this.processRemoteInboundStats(i,t)}}processAudioOutboundStats(e){let t=this._stats.audioSend.find((t=>t.ssrc===e.ssrc));if(t||(t=Ps(Fs),this._stats.audioSend.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsSent,t.bytes=e.bytesSent,e.mediaSourceId&&this.processAudioMediaSource(e.mediaSourceId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),this.processAudioTrackSenderStats(e,e.trackId,t),e.remoteId)this.processRemoteInboundStats(e.remoteId,t);else{const i=this.findRemoteStatsId(e.ssrc,$t.REMOTE_INBOUND);i&&this.processRemoteInboundStats(i,t)}}findRemoteStatsId(e,t){const i=Array.from(this.report.values()).find((i=>i.type===t&&i.ssrc===e));return i?i.id:null}processVideoMediaSource(e,t){const i=this.report.get(e);i&&i.width&&i.height&&i.framesPerSecond&&(t.inputFrame={width:i.width,height:i.height,frameRate:i.framesPerSecond})}processAudioMediaSource(e,t){const i=this.report.get(e);i&&(t.inputLevel=i.audioLevel)}processVideoTrackSenderStats(e,t,i){var n,s,o,a;const r=t?this.report.get(t):void 0,c=null!==(n=null==r?void 0:r.framesSent)&&void 0!==n?n:e.framesSent;if("number"!=typeof c)return;let d=null!==(s=null==r?void 0:r.frameWidth)&&void 0!==s?s:e.frameWidth,l=null!==(o=null==r?void 0:r.frameHeight)&&void 0!==o?o:e.frameHeight,h=null!==(a=null==r?void 0:r.framesPerSecond)&&void 0!==a?a:e.framesPerSecond;if("number"==typeof d&&"number"==typeof l||(d=0,l=0),null==h){const e=Date.now(),t=this.lastVideoFramesSent.get(i.ssrc);t&&e-t.lts>=800?(h=Math.round((c-t.count)/((e-t.lts)/1e3)),this.lastVideoFramesSent.set(i.ssrc,{count:c,lts:e,rate:h})):t?h=t.rate:this.lastVideoFramesSent.set(i.ssrc,{count:c,lts:e,rate:0})}i.sentFrame={width:d,height:l,frameRate:Math.max(0,h)}}processVideoTrackReceiverStats(e,t,i){var n,s,o,a,r;const c=t?this.report.get(t):void 0,d=null!==(n=null==c?void 0:c.framesReceived)&&void 0!==n?n:e.framesReceived,l=null!==(s=null==c?void 0:c.frameWidth)&&void 0!==s?s:e.frameWidth,h=null!==(o=null==c?void 0:c.frameHeight)&&void 0!==o?o:e.frameHeight,u=null!==(a=null==c?void 0:c.jitterBufferDelay)&&void 0!==a?a:e.jitterBufferDelay,p=null!==(r=null==c?void 0:c.jitterBufferEmittedCount)&&void 0!==r?r:e.jitterBufferEmittedCount;if("number"==typeof d){const e=this.lastVideoFramesRecv.get(i.ssrc),t=Date.now();i.framesReceivedCount=d;let n=0;e&&t-e.lts>=800?(n=Math.round((d-e.count)/((t-e.lts)/1e3)),this.lastVideoFramesRecv.set(i.ssrc,{count:d,lts:t,rate:n})):e?n=e.rate:this.lastVideoFramesRecv.set(i.ssrc,{count:d,lts:t,rate:0}),i.receivedFrame={width:l||0,height:h||0,frameRate:n||0},i.decodedFrame={width:l||0,height:h||0,frameRate:i.decodeFrameRate||0},i.outputFrame={width:l||0,height:h||0,frameRate:i.outputFrameRate||i.decodeFrameRate||0}}if(u&&p){const e=this.lastVideoJBDelay.get(i.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let t=e.jitterBufferMs;const n=p-e.jitterBufferEmittedCount;n>0&&(t=1e3*(u-e.jitterBufferDelay)/n),i.jitterBufferMs=t,i.currentDelayMs=Math.round(t),this.lastVideoJBDelay.set(i.ssrc,{jitterBufferDelay:u,jitterBufferEmittedCount:p,jitterBufferMs:i.currentDelayMs})}}processAudioTrackSenderStats(e,t,i){var n,s,o,a;const r=t?this.report.get(t):void 0,c=null!==(n=null!==(s=null==r?void 0:r.echoReturnLoss)&&void 0!==s?s:e.echoReturnLoss)&&void 0!==n?n:0,d=null!==(o=null!==(a=null==r?void 0:r.echoReturnLossEnhancement)&&void 0!==a?a:e.echoReturnLossEnhancement)&&void 0!==o?o:0;i.aecReturnLoss=c,i.aecReturnLossEnhancement=d}processAudioTrackReceiverStats(e,t,i){var n,s,o,a,r,c,d;const l=t?this.report.get(t):void 0,h=null!==(n=null==l?void 0:l.removedSamplesForAcceleration)&&void 0!==n?n:e.removedSamplesForAcceleration,u=null!==(s=null==l?void 0:l.totalSamplesReceived)&&void 0!==s?s:e.totalSamplesReceived,p=null!==(o=null==l?void 0:l.jitterBufferDelay)&&void 0!==o?o:e.jitterBufferDelay,_=null!==(a=null==l?void 0:l.jitterBufferEmittedCount)&&void 0!==a?a:e.jitterBufferEmittedCount,E=null!==(r=null==l?void 0:l.audioLevel)&&void 0!==r?r:null==e?void 0:e.audioLevel,m=null!==(c=null==l?void 0:l.totalSamplesDuration)&&void 0!==c?c:null==e?void 0:e.totalSamplesDuration,S=null!==(d=null==l?void 0:l.concealedSamples)&&void 0!==d?d:e.concealedSamples;if(h&&u&&(i.accelerateRate=h/u),p&&_){const e=this.lastAudioJBDelay.get(i.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let t=e.jitterBufferMs;const n=_-e.jitterBufferEmittedCount;n>0&&(t=1e3*(p-e.jitterBufferDelay)/n),i.jitterBufferMs=Math.round(t),this.lastAudioJBDelay.set(i.ssrc,{jitterBufferDelay:p,jitterBufferEmittedCount:_,jitterBufferMs:i.jitterBufferMs})}i.outputLevel=E;let f=1920;m&&u&&(f=u/m/50,i.receivedFrames=Math.round(u/f)),S&&(i.droppedFrames=Math.round(S/f))}processRemoteInboundStats(e,t){const i=this.report.get(e);i&&(t.packetsLost=i.packetsLost,i.roundTripTime&&(t.rttMs=1e3*i.roundTripTime),i.jitter&&(t.jitterMs=1e3*i.jitter),i.timestamp&&(t.timestamp=i.timestamp))}getCodecFromCodecStats(e){const t=this.report.get(e);if(!t)return"";const i=t.mimeType.match(/\/(.*)$/);return i&&i[1]?i[1]:""}updateSendBitrate(){let e=0,t=null,i=null;this.mediaBytesSent.forEach((t=>{e+=t.diffMean()})),this.mediaBytesRetransmit.forEach((e=>{t=null===t?e.diffMean():t+e.diffMean()})),this.mediaBytesTargetEncode.forEach((e=>{i=null===i?e.diffMean():i+e.diffMean()}));const n=null!==t?e-t:e;this._stats.bitrate={actualEncoded:8*n/(this.options.updateInterval/1e3),transmit:8*e/(this.options.updateInterval/1e3)},null!==t&&(this._stats.bitrate.retransmit=8*t/(this.options.updateInterval/1e3)),null!==i&&(this._stats.bitrate.targetEncoded=8*i/(this.options.updateInterval/1e3))}}class Hs extends Gs{updateStats(){return Promise.resolve()}}function Ks(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:250,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:8,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:500,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1e4;const o=function(){const e=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return e&&e[0]?Number(e[0].split("/")[1]):null}();return o?o<76?new js(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:s}):new Ws(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:s}):function(e){if(!window.RTCStatsReport)return!1;const t=e.getStats();return!!(t instanceof Promise||z(t))}(e)?new Ws(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:s}):new Hs(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:s})}let Ys=class{get localCapabilities(){return M(this._localCapabilities)}get rtpCapabilities(){return M(this._rtpCapabilities)}get candidates(){return M(this._candidates)}get iceParameters(){return M(this._iceParameters)}get dtlsParameters(){return M(this._dtlsParameters)}constructor(e){this.sessionDesc=void 0,this._localCapabilities=void 0,this._rtpCapabilities=void 0,this._candidates=void 0,this._iceParameters=void 0,this._dtlsParameters=void 0,this.setup=void 0,this.currentMidIndex=void 0,this.cname="o/i14u9pJrxRKAsu",this.firefoxSsrcMidMap=new Map,e=M(e);const{remoteIceParameters:t,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:s,localCapabilities:o,direction:a,setup:r,videoCodec:c,audioCodec:d}=e;let l;this.setup=r,l=a===li.RECEIVE_ONLY?gn.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=extmap-allow-mixed\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n"):gn.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=extmap-allow-mixed\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=recvonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=recvonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n"),this._rtpCapabilities=s,this._candidates=n,this._iceParameters=t,this._dtlsParameters=i,this._localCapabilities=o;const h=a===li.RECEIVE_ONLY?this.rtpCapabilities.send:this.rtpCapabilities.recv,u=a===li.RECEIVE_ONLY?this._localCapabilities.recv:this._localCapabilities.send,p=a===li.RECEIVE_ONLY?s.send.videoCodecs:jn(Pi.VIDEO,h,u,c),_=a===li.RECEIVE_ONLY?s.send.audioCodecs:jn(Pi.AUDIO,h,u,d);for(const e of l.mediaDescriptions)e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd,e.attributes.fingerprints=i.fingerprints,e.attributes.candidates=n,e.attributes.setup=this.setup,"application"===e.media.mediaType&&(e.attributes.sctpPort="5000"),"video"===e.media.mediaType&&(e.media.fmts=p.map((e=>e.payloadType.toString(10))),e.attributes.payloads=p,e.attributes.extmaps=h.videoExtensions),"audio"===e.media.mediaType&&(e.media.fmts=_.map((e=>e.payloadType.toString(10))),e.attributes.payloads=_,e.attributes.extmaps=h.audioExtensions,Gn(e));this.sessionDesc=l,this.currentMidIndex=l.mediaDescriptions.length-1}toString(){return gn.print(this.sessionDesc)}hasMid(e){return Array.isArray(e)?e.every((e=>this.hasMid(e))):this.sessionDesc.mediaDescriptions.some((t=>t.attributes.mid===e))}send(e,t,i,n,s){i=i.replace(/ /g,"-");const{ssrcs:o,ssrcGroups:a}=On(t,this.cname,E("SYNC_GROUP")?i:void 0),r=this.findPreloadMediaDesc(o);if(r){if(f()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,r.attributes.mid),s&&(s.twcc||s.remb)){const e=this.sessionDesc.mediaDescriptions.indexOf(r);return this.sessionDesc.mediaDescriptions[e]=this.mungSendMediaDesc(r,s),{mid:r.attributes.mid,needExchangeSDP:!0}}return{mid:r.attributes.mid,needExchangeSDP:!1}}{const t=this.findAvailableMediaIndex(e,o,n);let i;return-1===t?(i=this.createOrRecycleSendMedia(e,o,a,"sendonly",n,s),this.updateBundleMids()):(i=M(this.sessionDesc.mediaDescriptions[t]),i.attributes.direction="sendonly",i.attributes.ssrcs=o,i.attributes.ssrcGroups=a,this.sessionDesc.mediaDescriptions[t]=this.mungSendMediaDesc(i,s)),f()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,i.attributes.mid),{needExchangeSDP:!0,mid:i.attributes.mid}}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach((e=>{e.attributes.ssrcs=[]})),this.updateBundleMids()}receive(e,t,i){const n=[];return e.forEach((e=>{const s=e._mediaStreamTrack.kind,o=this.findAvailableRecvMediaIndex(s);let a,r=!1;-1===o?(r=!0,a=this.createOrRecycleRecvMedia(e,[],"recvonly",t,i),this.updateBundleMids()):(a=M(this.sessionDesc.mediaDescriptions[o]),a.attributes.direction="recvonly"),n.push({mid:a.attributes.mid,needCreateTransceiver:r})})),n}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach((e=>{e.media.port="0",e.attributes.direction="inactive"})),this.updateBundleMids()}addRemoteCandidate(e){const{foundation:t,protocol:i,address:n,port:s,type:o,relatedAddress:a,relatedPort:r,priority:c}=new RTCIceCandidate(e),d={foundation:null!=t?t:"",componentId:"1",transport:null!=i?i:"",priority:c?c+"":"",connectionAddress:null!=n?n:"",port:s?s+"":"",type:o?o+"":"",relAddr:null!=a?a:"",relPort:r?r+"":"",extension:{}};this.candidates.some((e=>e.priority===d.priority&&e.connectionAddress===d.connectionAddress&&e.port===d.port))||(this._candidates.push(d),this.sessionDesc.mediaDescriptions.forEach((e=>{e.attributes.candidates=this.candidates})))}clearRemoteCandidate(){this._candidates=[],this.sessionDesc.mediaDescriptions[0].attributes.candidates=this._candidates}createOrRecycleRecvMedia(e,t,i,n,s){const o=e._mediaStreamTrack.kind,a=this.rtpCapabilities.recv,r=jn(o,a,this.localCapabilities.send,o===Pi.AUDIO?s:n),c=o===Pi.VIDEO?a.videoExtensions:a.audioExtensions,d="".concat(++this.currentMidIndex);let l={media:{mediaType:o,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:r.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:r,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};l=this.mungRecvMediaDsec(l,e);const h=this.findFirstClosedMedia(o);if(h){const e=this.sessionDesc.mediaDescriptions.indexOf(h);this.sessionDesc.mediaDescriptions[e]=l}else this.sessionDesc.mediaDescriptions.push(l);return l}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>e.includes(t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="inactive"}))}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>e.includes(t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="recvonly"}))}findAvailableMediaIndex(e,t,i){return this.sessionDesc.mediaDescriptions.findIndex((n=>{const s=n.media.mediaType===e&&"0"!==n.media.port&&("sendonly"===n.attributes.direction||"sendrecv"===n.attributes.direction)&&0===n.attributes.ssrcs.length;if(f()){if(s){const e=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(e||"0"!==n.attributes.mid&&"1"!==n.attributes.mid)||!(!e||e!==n.attributes.mid)}return!1}return s&&n.attributes.mid===i}))}findAvailableRecvMediaIndex(e){return this.sessionDesc.mediaDescriptions.findIndex((t=>{const i=t.media.mediaType===e&&"0"!==t.media.port&&("recvonly"===t.attributes.direction||"sendrecv"===t.attributes.direction);return"0"!==t.attributes.mid&&"1"!==t.attributes.mid&&i}))}predictReceivingMids(e){const t=[];for(let i=0;i<e;i++)t.push((this.currentMidIndex+i+1).toString(10));return t}restartICE(e){e=M(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}createOrRecycleSendMedia(e,t,i,n,s,o){const a=this.rtpCapabilities.send,r=e===Pi.VIDEO?a.videoCodecs:a.audioCodecs,c=e===Pi.VIDEO?a.videoExtensions:a.audioExtensions;f()&&(s="".concat(++this.currentMidIndex));let d={media:{mediaType:e,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:r.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:r,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:s}};d=this.mungSendMediaDesc(d,o);const l=this.findFirstClosedMedia(e);if(l){const e=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[e]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}mungRecvMediaDsec(e,t,i){const n=M(e);return Pn(n),Dn(n,t),Ln(n,t),kn(n),Mn(n,i,this.localCapabilities.send),n}mungSendMediaDesc(e,t){const i=M(e);return Mn(i,t,this.localCapabilities.recv),Gn(i),i}updateRecvMedia(e,t){const i=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==i){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],t);this.sessionDesc.mediaDescriptions[i]=e}}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((e=>"0"!==e.media.port)).map((e=>e.attributes.mid))}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find((t=>{var i;return(null===(i=t.attributes)||void 0===i||null===(i=i.ssrcs[0])||void 0===i?void 0:i.ssrcId)===e[0].ssrcId}))}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find((t=>f()?"0"===t.media.port&&t.media.mediaType===e:"0"===t.media.port))}};const qs=["sdp"];var Js;let Xs=(Js=class e extends Oi{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,t;return null!==(e=null===(t=this.peerConnection.getReceivers()[0])||void 0===t||null===(t=t.transport)||void 0===t?void 0:t.state)&&void 0!==e?e:null}get localCodecs(){return[]}set isInRestartIce(e){this._isInRestartIce=e}get isInRestartIce(){return this._isInRestartIce}constructor(t,i,n){super(t,i),this.direction=void 0,this.name=void 0,this.store=void 0,this.spec=void 0,this.peerConnection=void 0,this.initialOffer=void 0,this.transport=void 0,this.statsFilter=void 0,this.localCandidateCount=0,this._isInRestartIce=!1,this.mutex=new C("P2PConnection-mutex"),this.onLocalCandidate=void 0,this.remoteSDP=void 0,this.pendingCandidates=[],this.localCapabilities=void 0,this.isReady=!1,this.restartCnt=0,this.curTurnServerIndex=0,this.store=i,this.spec=t,this.peerConnection=new RTCPeerConnection(e.resolvePCConfiguration(t,i.p2pTransport),{optional:[{googDscp:!0}]}),this.direction=null!=n?n:li.SEND_ONLY,this.name=this.direction===li.SEND_ONLY?"sendP2PConnection":"recvP2PConnection",this.statsFilter=Ks(this.peerConnection,E("STATS_UPDATE_INTERVAL"),void 0,f()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1}async establish(e){try{const i=await Vn();if(this.localCapabilities=Bn(i),e){const{sdp:i}=e,n=function(e,t){if(null==e)return{};var i,n,s=function(e,t){if(null==e)return{};var i={};for(var n in e)if({}.hasOwnProperty.call(e,n)){if(t.indexOf(n)>=0)continue;i[n]=e[n]}return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)i=o[n],t.indexOf(i)>=0||{}.propertyIsEnumerable.call(e,i)&&(s[i]=e[i])}return s}(e,qs),s=function(){const e={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},i=vn(arguments.length>2?arguments[2]:void 0,arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},"sendonly"),n={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},s={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Fn(i,e,"videoExtensions",n,s,o),Fn(i,e,"videoCodecs",n,s,o),Fn(i,e,"audioExtensions",n,s,o),Fn(i,e,"audioCodecs",n,s,o),E("RAISE_H264_BASELINE_PRIORITY")){const e=o.videoCodecs.findIndex((e=>e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()&&e.fmtp&&"42001f"===e.fmtp.parameters["profile-level-id"]));if(-1!==e){const i=o.videoCodecs.findIndex((e=>e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()));if(i<e){t.debug("raising H264 baseline profile priority");const n=o.videoCodecs[e];o.videoCodecs.splice(e,1),o.videoCodecs.splice(i,0,n)}-1!==i&&E("FILTER_SEND_H264_BASELINE")&&(n.videoCodecs=n.videoCodecs.filter((e=>!(e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()&&e.fmtp&&"42001f"!==e.fmtp.parameters["profile-level-id"]))))}}return{send:n,recv:s,sendrecv:o}}({},{},i);this.remoteSDP=new Ys({remoteIceParameters:n.iceParameters,remoteDtlsParameters:n.dtlsParameters,candidates:[],remoteRTPCapabilities:s,localCapabilities:this.localCapabilities,direction:this.direction,setup:"actpass",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()}),this.isReady=!0;const o=await this.peerConnection.createAnswer();if(!o.sdp)throw new Error("Cannot get answer sdp when trying to establish PeerConnection.");const a=yn(o.sdp);await this.peerConnection.setLocalDescription(o);const r=await xn({},{},o.sdp);this.localCapabilities=Bn(r);const c=this.peerConnection.getTransceivers()[0];return null!=c&&c.receiver&&c.receiver.transport&&this.tryBindTransportEvents(c.receiver.transport),Xt(Xt({},a),{},{sdp:o.sdp})}{this.peerConnection.addTransceiver("video",{direction:"sendonly"}),this.peerConnection.addTransceiver("audio",{direction:"sendonly"});const e=await this.peerConnection.createOffer();if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const t=yn(e.sdp);return this.initialOffer=e,Xt(Xt({},t),{},{sdp:e.sdp})}}catch(e){throw new l(h.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");await this.peerConnection.setLocalDescription(this.initialOffer);const{sdp:t,iceParameters:i,dtlsParameters:n}=e,s=await xn({},{},t);this.remoteSDP=new Ys({remoteIceParameters:i,remoteDtlsParameters:n,candidates:[],remoteRTPCapabilities:s,localCapabilities:this.localCapabilities,direction:this.direction,setup:"active",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()});const o=this.peerConnection.getTransceivers()[0];null!=o&&o.sender&&o.sender.transport&&this.tryBindTransportEvents(o.sender.transport)}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(e.toString()))}}async addRemoteCandidate(e){try{e&&this.pendingCandidates.push(e),this.peerConnection.remoteDescription&&this.isReady&&(this.pendingCandidates.forEach((e=>{this.peerConnection.addIceCandidate(e)})),this.pendingCandidates=[])}catch(e){throw new l(h.ADD_CANDIDATE_FAILED,"P2PConnection.addRemoteCandidate failed; ".concat(e.toString()))}}send(e,t,i){var n=this;return zt((function*(){const s=yield Yt(n.mutex.lock("From P2PConnection.send"));try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const o=[],a=n.remoteSDP.receive(e,t,i);e.forEach(((e,t)=>{if(a[t].needCreateTransceiver){const t=n.peerConnection.addTransceiver(e._mediaStreamTrack,{direction:"sendonly"});o.push(t),e._updateRtpTransceiver(t)}else{const i=n.peerConnection.getTransceivers().find((e=>e.mid===a[t].mid));if(!i)throw new Error("cannot find transceiver when sendPeerconnection send, mid is ".concat(a[t].mid));o.push(i),e._updateRtpTransceiver(i)}})),f()&&!0===E("SIMULCAST")&&(yield Yt(n.applySimulcastForFirefox(o,e)));const r=a.map((e=>e.mid)),c=yield Yt(n.peerConnection.createOffer()),d=n.mungSendOfferSDP(c.sdp,e,r),l=gn.parse(d),h=r.map((e=>{const t=l.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("Cannot extract ssrc from mediaDescription.");return wn(t,E("USE_PUB_RTX"))})),u=o.map(((e,t)=>{const i=r[t];return{localSSRC:h[t],id:i}}));yield Yt(n.peerConnection.setLocalDescription({type:"offer",sdp:d}));try{yield u}catch(e){const t=n.remoteSDP.toString();throw yield Yt(n.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield Yt(n.peerConnection.setRemoteDescription({type:"answer",sdp:t})),yield Yt(n.stopSending(r,!0)),e}yield Yt(n.applySimulcastEncodings(o,e)),yield Yt(n.applySendEncodings(o,e));const p=n.remoteSDP.toString(),_=n.logSDPExchange(d,"offer","local","send");return null==_||_(p),yield Yt(n.setRemoteDescription({type:"answer",sdp:p})),o.map(((e,t)=>{const i=r[t];return{localSSRC:h[t],id:i}}))}catch(e){throw e instanceof l?e:new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(e.toString()))}finally{s()}}))()}async stopSending(e,t){const i=t?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const t=this.peerConnection.getTransceivers().filter((t=>-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length (".concat(t.length,") doesn't match mids' length (").concat(e.length,") when trying to call P2PConnection.stopSending."));t.map((e=>{var t;e.direction="inactive",null===(t=e.stop)||void 0===t||t.call(e)}));const n=await this.peerConnection.createOffer(),s=this.logSDPExchange(n.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(n),this.remoteSDP.stopReceiving(e);const o=this.remoteSDP.toString();null==s||s(o),await this.setRemoteDescription({type:"answer",sdp:o})}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(e.toString()))}finally{i&&i()}}async receive(e,i,n,s){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:o,needExchangeSDP:a}=this.remoteSDP.send(e,i,n,s);if(a){const i=this.remoteSDP.toString(),n=this.logSDPExchange(i,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:i});const s=await this.peerConnection.createAnswer(),a=this.mungReceiveAnswerSDP(s.sdp,o,e);null==n||n(a||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:a}),t.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else t.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."));const r=this.peerConnection.getTransceivers().find((e=>e.mid===o));if(!r||null===r.mid)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:r.receiver.track,mid:r.mid,transceiver:r}}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async mockReceive(e,i,n,s){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:o,needExchangeSDP:a}=this.remoteSDP.send(e,i,n,s);if(a){const i=this.remoteSDP.toString(),n=this.logSDPExchange(i,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:i});const s=await this.peerConnection.createAnswer(),a=this.mungReceiveAnswerSDP(s.sdp,o,e);null==n||n(a||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:a}),t.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else t.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."))}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","stopReceiving");await this.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}async restartICE(t){try{if(this.store.p2pTransport===Q.Auto&&(this.store.p2pTransport=Q.SdRtn,Xe().supportPCSetConfiguration&&this.peerConnection.setConfiguration(e.resolvePCConfiguration(this.spec,this.store.p2pTransport))),this.restartCnt>3&&(this.restartCnt=0,Xe().supportPCSetConfiguration&&this.peerConnection.setConfiguration(e.resolvePCConfiguration(this.spec,this.store.p2pTransport,++this.curTurnServerIndex))),!t){this.restartCnt++,this.isReady=!1;const e=await this.peerConnection.createOffer({iceRestart:!0});if(!e.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const{iceParameters:t}=yn(e.sdp);return this.store.descriptionStart(),this.direction===li.SEND_ONLY&&await this.peerConnection.setLocalDescription(e),t}if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");if(this.remoteSDP.restartICE(t),this.store.descriptionStart(),this.direction===li.RECEIVE_ONLY){this.restartCnt++,await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()});const e=await this.peerConnection.createAnswer();if(!e.sdp)throw new Error("Cannot get answer sdp when trying to iceRestart.");const{iceParameters:t}=yn(e.sdp);return await this.peerConnection.setLocalDescription(e),t}await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()}),this.isReady=!0}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}close(){var e;this.peerConnection.close(),this.peerConnection.onicecandidate=null,null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.transport=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),n=this.mungSendOfferSDP(i.sdp,[t],[e]);this.remoteSDP.updateRecvMedia(e,t);const s=this.remoteSDP.toString(),o=this.logSDPExchange(n,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:n}),null==o||o(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const i=this.peerConnection.getTransceivers().filter((t=>t.mid===e));1===i.length&&(this.isVP8Simulcast(t)?f()||await this.applySimulcastEncodings(i,[t]):await this.applySendEncodings(i,[t]))}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const i=this.peerConnection.getTransceivers().find((e=>e.mid===t));i&&await i.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){const e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){const t=e[0].transport.iceTransport,{local:i,remote:n}=t.getSelectedCandidatePair();return{local:Xt(Xt({},Ms),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:Xt(Xt({},Ms),{},{candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;["connected","completed"].includes(this.peerConnection.iceConnectionState)&&(this.isReady=!1),null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;"connected"===this.peerConnection.connectionState&&(this.restartCnt=0),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.startICECandidate()}startICECandidate(){this.peerConnection.onicecandidate||(this.localCandidateCount=0,this.peerConnection.onicecandidate=e=>{if(e.candidate){var i;if(e.candidate.candidate)null===(i=this.onLocalCandidate)||void 0===i||i.call(this,e.candidate.toJSON());this.localCandidateCount+=1}else t.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount)})}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(i,n){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const o={iceServers:[]};return i.iceServers?o.iceServers=i.iceServers:i.turnServer&&"off"!==i.turnServer.mode&&(Z(i.turnServer.servers)?o.iceServers=i.turnServer.servers:(o.iceServers&&o.iceServers.push(...e.turnServerConfigToIceServers(i.turnServer.servers,n,s)),E("USE_TURN_SERVER_OF_GATEWAY")&&o.iceServers&&i.turnServer.serversFromGateway&&o.iceServers.push(...e.turnServerConfigToIceServers(i.turnServer.serversFromGateway,n,s)),[Q.Relay,Q.SdRtn].includes(n)&&(o.iceTransportPolicy="relay"),E("FORCE_TURN_TCP")?o.iceTransportPolicy="relay":i.turnServer.servers.concat(i.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(o.iceTransportPolicy="relay")})))),E("ENABLE_ENCODED_TRANSFORM")&&Xe().supportWebRTCEncodedTransform&&(o.encodedInsertableStreams=!0),t.debug("P2PConnection p2pTransport is ".concat(n)),o}static turnServerConfigToIceServers(e,i){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const s=[],o=e.filter((e=>e.tcpport));t.debug("P2PConnection turnServers is ".concat(o,", current index is ").concat(n));const a=o.length>n?o[n]:o[0];switch(i){case Q.SdRtn:const t=e.filter((e=>e.username.includes("glb:")&&e.turnServerURL==e.turnServerURL)),i=t.length>n?t[n]:t[0];i&&(s.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(hn(i.turnServerURL),":").concat(i.tcpport,"?transport=udp")}),s.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(hn(i.turnServerURL),":").concat(i.tcpport,"?transport=tcp")}));break;case Q.Relay:a&&(s.push({username:a.username,credential:a.password,credentialType:"password",urls:"turn:".concat(a.turnServerURL,":").concat(a.tcpport,"?transport=udp")}),s.push({username:a.username,credential:a.password,credentialType:"password",urls:"turns:".concat(hn(a.turnServerURL),":").concat(a.tcpport,"?transport=tcp")}));break;default:a&&(s.push({username:a.username,credential:a.password,credentialType:"password",urls:"turn:".concat(a.turnServerURL,":").concat(a.tcpport,"?transport=udp")}),s.push({username:a.username,credential:a.password,credentialType:"password",urls:"turns:".concat(hn(a.turnServerURL),":").concat(a.tcpport,"?transport=tcp")}),s.push({username:a.username,credential:a.password,credentialType:"password",urls:"stun:".concat(a.turnServerURL,":").concat(a.tcpport)}))}return s}tryBindTransportEvents(e){if(e){this.transport=e,e.onstatechange=()=>{var t;null!=e&&e.state&&(null===(t=this.onDTLSTransportStateChange)||void 0===t||t.call(this,e.state))},e.onerror=e=>{var t;null===(t=this.onDTLSTransportError)||void 0===t||t.call(this,"error"in e?e.error:e)};const i=e.iceTransport;i&&(i.onstatechange=()=>{const t=null==e?void 0:e.iceTransport.state;var i;t&&(null===(i=this.onICETransportStateChange)||void 0===i||i.call(this,t))},i.getSelectedCandidatePair&&(i.onselectedcandidatepairchange=()=>{if(i.getSelectedCandidatePair()){const{local:e,remote:n}=i.getSelectedCandidatePair();t.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:e.type,protocol:e.protocol}),", remote ").concat(JSON.stringify({candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port})," )"))}}))}}tryUnbindTransportEvents(){this.transport&&(this.transport.onstatechange=null,this.transport.onerror=null,this.transport.iceTransport&&(this.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,i){var n;if(!i){i=this.peerConnection.getSenders().find((t=>t.track===e._mediaStreamTrack))}if(!i)return t.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return t.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!Xe().supportSetRtpSenderParameters)return t.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const s={},o={};switch(e._optimizationMode){case"motion":s.degradationPreference="maintain-framerate";break;case"detail":s.degradationPreference="maintain-resolution";break;default:s.degradationPreference="balanced"}if(e._encoderConfig){const{bitrateMax:t,frameRate:i,scaleResolutionDownBy:n}=e._encoderConfig;t&&(o.maxBitrate=1e3*t),e._hints.includes(ze.LOW_STREAM)&&(i&&(o.maxFramerate=pn(i)),n&&n>=1&&(o.scaleResolutionDownBy=n))}if(E("DSCP_TYPE")&&$()){const e=E("DSCP_TYPE");["very-low","low","medium","high"].includes(e)&&(o.networkPriority=e)}const a=i.getParameters(),r=null===(n=a.encodings)||void 0===n?void 0:n[0];f()&&!r&&(s.encodings=[o]),r&&Object.assign(r,o),Object.assign(a,s),t.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(a.encodings))),await i.setParameters(a)}async applySendEncodings(e,i){try{if(!Xe().supportSetRtpSenderParameters)return;if(e.length!==i.length)return;for(let t=0;t<e.length;t++){const n=e[t],s=i[t];s instanceof Je&&!this.isVP8Simulcast(s)&&await this.updateRtpSenderEncodings(s,n.sender)}}catch(e){t.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,t,i){const n=gn.parse(e);return t.forEach(((e,t)=>{const s=i[t],o=n.mediaDescriptions.find((e=>e.attributes.mid===s));o&&(Dn(o,e),Un(o,e,this.store.codec))})),gn.print(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,i)=>{var n;null===(n=this.onFirstVideoDecoded)||void 0===n||n.call(this,e,t,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedLocalCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var t;null===(t=this.onFirstVideoDecodedTimeout)||void 0===t||t.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,t){if(e.length===t.length)for(let a=0;a<e.length;a++){var i,n,s,o;const r=e[a],c=t[a];if(c instanceof Je&&!c._hints.includes(ze.LOW_STREAM)&&null!==(i=c._encoderConfig)&&void 0!==i&&i.bitrateMax&&(null===(n=c._encoderConfig)||void 0===n?void 0:n.bitrateMax)>200&&null!==(s=c._scalabilityMode)&&void 0!==s&&s.numSpatialLayers&&(null===(o=c._scalabilityMode)||void 0===o?void 0:o.numSpatialLayers)>1&&"vp8"===this.store.codec){const e={},t={high:1e3*(c._encoderConfig.bitrateMax-50),medium:5e4};e.encodings=[{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:t.high}];const i=r.sender.getParameters();await r.sender.setParameters(Object.assign(i,e))}}}async applySimulcastEncodings(e,t){if(!f()&&e.length===t.length)for(let i=0;i<e.length;i++){const n=t[i];if(n instanceof Je&&this.isVP8Simulcast(n)){const t=e[i],s={},o={high:1e3*(n._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:o.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:o.medium,scaleResolutionDownBy:4}];const a=t.sender.getParameters();await t.sender.setParameters(Object.assign(a,s))}}}isVP8Simulcast(e){var t,i,n,s;return!!(e instanceof Je&&E("SIMULCAST")&&"vp8"===this.store.codec&&!e._hints.includes(ze.LOW_STREAM)&&null!==(t=e._encoderConfig)&&void 0!==t&&t.bitrateMax&&(null===(i=e._encoderConfig)||void 0===i?void 0:i.bitrateMax)>200&&null!==(n=e._scalabilityMode)&&void 0!==n&&n.numSpatialLayers&&(null===(s=e._scalabilityMode)||void 0===s?void 0:s.numSpatialLayers)>1)}logSDPExchange(e,i,n,s){if(E("SDP_LOGGING"))return t.upload("[".concat(this.store.clientId,"] exchanging ").concat(n," ").concat(i," SDP during P2PConnection.").concat(s,"\n"),e),"offer"===i?e=>{this.logSDPExchange(e,"answer","local"===n?"remote":"local",s)}:void 0}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((e=>{e.direction="inactive"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(e);const s=this.remoteSDP.toString();null==n||n(s),await this.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((async e=>{e.direction="sendonly"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(e);const s=this.remoteSDP.toString();null==n||n(s),await this.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(e.toString()))}}async getRemoteSSRC(e,t){var i,n;if(t=null!==(i=t)&&void 0!==i?i:null===(n=this.currentRemoteDescription)||void 0===n?void 0:n.sdp){var s;const i=null===(s=gn.parse(t).mediaDescriptions.find((t=>t.attributes.mid===e)))||void 0===s?void 0:s.attributes.ssrcs;return null==i?void 0:i[0].ssrcId}}async setRemoteDescription(e){await this.peerConnection.setRemoteDescription(e),["connected","completed"].includes(this.peerConnection.iceConnectionState)||(this.isReady=!0,this.addRemoteCandidate())}mungReceiveAnswerSDP(e,t,i){const n=gn.parse(e),s=n.mediaDescriptions.find((e=>e.attributes.mid===t));return s&&i===Pi.AUDIO&&"audio"===s.media.mediaType&&Gn(s),gn.print(n)}},jt(Js.prototype,"establish",[zs],Object.getOwnPropertyDescriptor(Js.prototype,"establish"),Js.prototype),jt(Js.prototype,"connect",[zs],Object.getOwnPropertyDescriptor(Js.prototype,"connect"),Js.prototype),jt(Js.prototype,"receive",[zs],Object.getOwnPropertyDescriptor(Js.prototype,"receive"),Js.prototype),jt(Js.prototype,"mockReceive",[zs],Object.getOwnPropertyDescriptor(Js.prototype,"mockReceive"),Js.prototype),jt(Js.prototype,"stopReceiving",[zs],Object.getOwnPropertyDescriptor(Js.prototype,"stopReceiving"),Js.prototype),jt(Js.prototype,"restartICE",[zs],Object.getOwnPropertyDescriptor(Js.prototype,"restartICE"),Js.prototype),jt(Js.prototype,"close",[zs],Object.getOwnPropertyDescriptor(Js.prototype,"close"),Js.prototype),jt(Js.prototype,"updateEncoderConfig",[zs],Object.getOwnPropertyDescriptor(Js.prototype,"updateEncoderConfig"),Js.prototype),jt(Js.prototype,"updateSendParameters",[zs],Object.getOwnPropertyDescriptor(Js.prototype,"updateSendParameters"),Js.prototype),jt(Js.prototype,"replaceTrack",[zs],Object.getOwnPropertyDescriptor(Js.prototype,"replaceTrack"),Js.prototype),jt(Js.prototype,"muteLocal",[zs],Object.getOwnPropertyDescriptor(Js.prototype,"muteLocal"),Js.prototype),jt(Js.prototype,"unmuteLocal",[zs],Object.getOwnPropertyDescriptor(Js.prototype,"unmuteLocal"),Js.prototype),Js);function zs(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("From P2PConnection.".concat(t));try{for(var s=arguments.length,o=new Array(s),a=0;a<s;a++)o[a]=arguments[a];return await n.apply(this,o)}finally{i()}},i}function Qs(e,i){let n=document.createElement("video"),s=document.createElement("canvas");n.setAttribute("style","display:none"),s.setAttribute("style","display:none"),n.setAttribute("muted",""),n.muted=!0,n.setAttribute("autoplay",""),n.autoplay=!0,n.setAttribute("playsinline",""),s.width=pn(i.width),s.height=pn(i.height);const o=pn(i.framerate||15);document.body.append(n),document.body.append(s);let a=e._mediaStreamTrack;n.srcObject=new MediaStream([a]),n.play();const r=s.getContext("2d");if(!r)throw new ui(h.UNEXPECTED_ERROR,"can not get canvas context");const c=Xe(),d=s.captureStream(c.supportRequestFrame?0:o).getVideoTracks()[0];d.canvas||(d.canvas=s),s.startCapture=()=>{if(!n)return s.stopCapture&&s.stopCapture();if(n.paused&&n.play(),n.videoHeight>2&&n.videoWidth>2){const e=n.videoWidth,i=n.videoHeight/e,o=s.width*i;Math.abs(o-s.height)>=2&&(t.debug("adjust low stream resolution","".concat(s.width,"x").concat(s.height," -> ").concat(s.width,"x").concat(o)),s.height=o)}r.drawImage(n,0,0,s.width,s.height),d.requestFrame&&d.requestFrame(),a!==e._mediaStreamTrack&&(a=e._mediaStreamTrack,n.srcObject=new MediaStream([a]))},s.stopCapture=$e((()=>s.startCapture&&s.startCapture()),o);const l=d.stop;return d.stop=()=>{l.call(d),n&&(n.remove(),n.srcObject=null,n=null),s&&(s.width=0,s.remove(),s.stopCapture&&s.stopCapture(),s.startCapture=void 0,s.stopCapture=void 0,s=null),t.debug("clean low stream renderer")},d}var Zs=function(e){return e[e.HEIGHT=2033]="HEIGHT",e[e.FRAME_RATE=2034]="FRAME_RATE",e[e.WIDTH=2035]="WIDTH",e}(Zs||{}),$s=function(e){return e[e.FRAME_RATE=2002]="FRAME_RATE",e[e.WIDTH=2003]="WIDTH",e[e.HEIGHT=2004]="HEIGHT",e[e.PACKAGE_LOST=2005]="PACKAGE_LOST",e[e.AVG_ENCODE=2007]="AVG_ENCODE",e[e.NACKS=2009]="NACKS",e[e.PLIS=2010]="PLIS",e[e.FIRS=2011]="FIRS",e[e.BITRATE=2012]="BITRATE",e[e.PACKAGE_RATE=2031]="PACKAGE_RATE",e[e.ADAPTATION=2032]="ADAPTATION",e[e.ACTUAL_ENCODED=2060]="ACTUAL_ENCODED",e[e.BANDWIDTH=2061]="BANDWIDTH",e[e.RETRANSMIT=2062]="RETRANSMIT",e[e.TARGET_ENCODED=2064]="TARGET_ENCODED",e[e.TRANSMIT=2066]="TRANSMIT",e[e.FREEZE=2082]="FREEZE",e[e.DISABLED=2095]="DISABLED",e[e.PLAYER_STATUS=2128]="PLAYER_STATUS",e[e.QP_SUM=2143]="QP_SUM",e}($s||{}),eo=function(e){return e[e.BITRATE=2069]="BITRATE",e[e.PACKAGE_LOST=2070]="PACKAGE_LOST",e[e.PACKAGE_RATE=2071]="PACKAGE_RATE",e[e.HEIGHT=2073]="HEIGHT",e[e.FRAME_RATE=2075]="FRAME_RATE",e[e.WIDTH=2077]="WIDTH",e}(eo||{}),to=function(e){return e[e.JITTER=-1]="JITTER",e[e.PACKAGE_LOST=2014]="PACKAGE_LOST",e[e.WIDTH=2018]="WIDTH",e[e.HEIGHT=2019]="HEIGHT",e[e.FRAME_RATE=2020]="FRAME_RATE",e[e.JITTER_BUFFER=2023]="JITTER_BUFFER",e[e.CURRENT_DELAY=2024]="CURRENT_DELAY",e[e.NACKS=2026]="NACKS",e[e.PLIS=2027]="PLIS",e[e.FIRS=2028]="FIRS",e[e.BITRATE=2029]="BITRATE",e[e.PACKAGE_RATE=2078]="PACKAGE_RATE",e[e.FREEZE=2084]="FREEZE",e[e.DISABLED=2101]="DISABLED",e[e.PLAYER_STATUS=2129]="PLAYER_STATUS",e[e.QP_SUM=2144]="QP_SUM",e[e.I_FRAME_DELAY=2149]="I_FRAME_DELAY",e}(to||{}),io=function(e){return e[e.FRAME_RATE_DECODE=2021]="FRAME_RATE_DECODE",e[e.FRAME_RATE_RENDER=2022]="FRAME_RATE_RENDER",e[e.FRAME_RATE_OUTPUT=2155]="FRAME_RATE_OUTPUT",e[e.FREEZE_TIME=2109]="FREEZE_TIME",e[e.FREEZE_TIME_RENDER=2147]="FREEZE_TIME_RENDER",e[e.FREEZE_DURATION=2156]="FREEZE_DURATION",e}(io||{}),no=function(e){return e[e.PCM_LEVEL=2104]="PCM_LEVEL",e}(no||{}),so=function(e){return e[e.PACKAGE_LOST=-1]="PACKAGE_LOST",e[e.LEVEL=2038]="LEVEL",e[e.BITRATE=2039]="BITRATE",e[e.PACKAGE_RATE=2040]="PACKAGE_RATE",e[e.AEC_RETURN_LOSS=2041]="AEC_RETURN_LOSS",e[e.AEC_RETURN_LOSS_ENH=2042]="AEC_RETURN_LOSS_ENH",e[e.FREEZE=2081]="FREEZE",e[e.DISABLED=2096]="DISABLED",e}(so||{}),oo=function(e){return e[e.BITRATE=2044]="BITRATE",e[e.PACKAGE_LOST=2045]="PACKAGE_LOST",e[e.PACKAGE_RATE=2046]="PACKAGE_RATE",e[e.CURRENT_DELAY=2047]="CURRENT_DELAY",e[e.JITTER_BUFFER=2054]="JITTER_BUFFER",e[e.JITTER=2055]="JITTER",e[e.FREEZE=2083]="FREEZE",e[e.DISABLED=2102]="DISABLED",e[e.PCM_LEVEL=2105]="PCM_LEVEL",e[e.PLAYER_STATUS=2130]="PLAYER_STATUS",e[e.CONCEALED_SAMPLES=2148]="CONCEALED_SAMPLES",e}(oo||{}),ao=function(e){return e[e.FREEZE_TIME=-1]="FREEZE_TIME",e[e.LEVEL=2043]="LEVEL",e}(ao||{}),ro=function(e){return e[e.RTT=2006]="RTT",e[e.CONN_TYPE=801]="CONN_TYPE",e}(ro||{});const co=1e3,lo=3;function ho(e,t,i){null!=i&&Number.isFinite(i)&&(e[t]=Math.round(Math.max(0,i)))}function uo(e){const t={[ro.CONN_TYPE]:0,[ro.RTT]:e.rtt};switch(e.selectedCandidatePair.localCandidate.candidateType){case"relay":{const i=e.selectedCandidatePair.localCandidate.relayProtocol;"udp"===i&&(t[ro.CONN_TYPE]=1),"tcp"===i&&(t[ro.CONN_TYPE]=3),"tls"===i&&(t[ro.CONN_TYPE]=4);break}case"srflx":t[ro.CONN_TYPE]=2}return t}function po(e){let t=0;switch(e){case"none":t=0;break;case"cpu":t=1;break;case"bandwidth":t=2;break;case"other":t=3}return t}class _o extends _{constructor(e){super(),this.store=void 0,this.uploadWRTCStatsTimer=void 0,this.uploadOutboundDenoiserStatsTimer=void 0,this.uploadExtStatsTimer=void 0,this.uploadExtUsageStatsTimer=void 0,this.uploadInboundExtStatsTimer=void 0,this.requestStats=void 0,this.requestTransportStats=void 0,this.requestLocalMedia=void 0,this.requestRemoteMedia=void 0,this.requestAllTracks=void 0,this.requestVideoIsReady=void 0,this.requestUploadStats=void 0,this.requestUpload=void 0,this.uploadOutboundStarted=!1,this.uploadInboundStarted=!1,this.uploadTransportStarted=!1,this.uploadExtensionUsageStarted=!1,this.lastRecvStats=void 0,this.lastSendStats=void 0,this.lastFullRecvStats=void 0,this.lastFullSendStats=void 0,this.needUploadRenderFreezeTime=!0,this.store=e}uploadWRTCStats(e){if(!this.requestStats||!this.requestUploadStats)return;let t,i;if(this.uploadTransportStarted&&(t=this.requestStats(),this.store.useP2P&&(i=this.requestStats(!0))),!t&&this.uploadOutboundStarted&&(t=this.requestStats()),!i&&this.uploadInboundStarted&&(i=this.requestStats(!0)),t||i){const n={};if(this.uploadTransportStarted&&t){const s=this.getTransportStats(t,i,e);s&&(n.misc=[s])}if(this.uploadOutboundStarted&&t){const i=this.getOutboundStats(t,e?this.lastSendStats:this.lastFullSendStats,e);i&&(n.outbound=[i])}if(this.uploadInboundStarted&&i){const t=this.getInboundStats(i,e?this.lastRecvStats:this.lastFullRecvStats,e);t&&(n.inbound=t)}this.requestUploadStats(n)}this.lastRecvStats=i,this.lastSendStats=t,e||(this.lastFullRecvStats=i,this.lastFullSendStats=t)}startUploadWRTCStats(){if(this.uploadWRTCStatsTimer)return;let e=1;this.uploadWRTCStatsTimer=window.setInterval((()=>{if(!this.uploadTransportStarted&&!this.uploadInboundStarted&&!this.uploadOutboundStarted)return this.stopUploadWRTCStats();this.uploadWRTCStats(e!==lo),++e===lo+1&&(e=1)}),co)}stopUploadWRTCStats(){window.clearInterval(this.uploadWRTCStatsTimer),this.uploadWRTCStatsTimer=void 0,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0)}getTransportStats(e,t,i){if(!this.requestStats)return;if(i)return null==e.rtt?void 0:{addition:{[ro.RTT]:e.rtt,[ro.CONN_TYPE]:void 0}};const n=uo(e);if(this.store.useP2P){if(t){const e=uo(t);n[ro.CONN_TYPE]+=e[ro.CONN_TYPE]<<3}n[ro.CONN_TYPE]+=110}else n[ro.CONN_TYPE]+=100;return{addition:n}}getOutboundStats(e,t,i){if(!this.requestUploadStats||!this.requestLocalMedia)return;const n=this.requestLocalMedia();if(!n||0===n.length)return;let s,o,a;return n.forEach((n=>{let[r,{track:c,ssrcs:d}]=n;switch(r){case Mi.LocalVideoLowTrack:case Mi.LocalVideoTrack:if(r===Mi.LocalVideoTrack){const n=function(e,t,i,n,s){const o=t.videoSend.find((t=>t.ssrc===e));if(!o)return;const a={},{sentFrame:r,inputFrame:c}=o;if(c&&r){const e=c.frameRate,t=r.frameRate;a[$s.FREEZE]=function(e,t){let i=!0;return i=!(e<=5)&&(e<=10?t<3:e<=20?t<4:t<5),i}(e,t)?1:0}if(ho(a,$s.QP_SUM,o.qpSumPerFrame),s)return a;switch(r&&(ho(a,$s.HEIGHT,r.height),ho(a,$s.WIDTH,r.width),ho(a,$s.FRAME_RATE,r.frameRate)),a[$s.DISABLED]=n._originMediaStreamTrack&&!n._originMediaStreamTrack.enabled||n._mediaStreamTrack&&!n._mediaStreamTrack.enabled?1:0,o.adaptionChangeReason){case"none":a[$s.ADAPTATION]=0;break;case"cpu":a[$s.ADAPTATION]=1;break;case"bandwidth":a[$s.ADAPTATION]=2;break;case"other":a[$s.ADAPTATION]=3}let d=0;o.adaptionChangeReason&&(d+=po(o.adaptionChangeReason)),t.qualityLimitationReason&&(d+=po(t.qualityLimitationReason)<<3),a[$s.ADAPTATION]=d,a[$s.PLAYER_STATUS]=et[n._player?n._player.videoElementStatus:"uninit"],ho(a,$s.NACKS,o.nacksCount),ho(a,$s.PLIS,o.plisCount),ho(a,$s.FIRS,o.firsCount),ho(a,$s.AVG_ENCODE,o.avgEncodeMs);const l=i&&i.videoSend.find((t=>t.ssrc===e));if(l){let e=s?co:co*lo;l.timestamp&&o.timestamp&&(e=o.timestamp-l.timestamp),null!=l.packets&&null!=o.packets&&ho(a,$s.PACKAGE_RATE,1e3*(o.packets-l.packets)/e),null!=o.packetsLost&&null!=l.packetsLost&&ho(a,$s.PACKAGE_LOST,o.packetsLost-l.packetsLost),null!=l.bytes&&null!=o.bytes&&ho(a,$s.BITRATE,8*(o.bytes-l.bytes)/e)}return a}(d[0].ssrcId,e,t,c,i),s=i?null:function(e,t,i){const n=t.videoSend.find((t=>t.ssrc===e));if(!n)return null;const s={},o=n.inputFrame,a=o&&o.height||i&&i.videoHeight||0,r=o&&o.width||i&&i.videoWidth||0,c=o&&o.frameRate||0;return ho(s,Zs.HEIGHT,a),ho(s,Zs.WIDTH,r),ho(s,Zs.FRAME_RATE,c),s}(d[0].ssrcId,e,c),a=i?null:function(e){const t={};return ho(t,$s.RETRANSMIT,e.bitrate.retransmit),ho(t,$s.TARGET_ENCODED,e.bitrate.targetEncoded),ho(t,$s.ACTUAL_ENCODED,e.bitrate.actualEncoded),ho(t,$s.TRANSMIT,e.bitrate.transmit),ho(t,$s.BANDWIDTH,e.sendBandwidth),t}(e);o=Object.assign({},n,s,a)}else a=i?void 0:function(e,t,i){const n=t.videoSend.find((t=>t.ssrc===e));if(!n)return;const s={},o=n.sentFrame;if(o&&(ho(s,eo.HEIGHT,o.height),ho(s,eo.WIDTH,o.width),ho(s,eo.FRAME_RATE,o.frameRate)),i){const t=i.videoSend.find((t=>t.ssrc===e));if(t){let e=co*lo;t.timestamp&&n.timestamp&&(e=n.timestamp-t.timestamp),null!=t.packets&&null!=n.packets&&ho(s,eo.PACKAGE_RATE,1e3*(n.packets-t.packets)/e),null!=n.packetsLost&&null!=t.packetsLost&&ho(s,eo.PACKAGE_LOST,n.packetsLost-t.packetsLost),null!=t.bytes&&null!=n.bytes&&ho(s,eo.BITRATE,8*(n.bytes-t.bytes)/e)}}return s}(d[0].ssrcId,e,t);break;case Mi.LocalAudioTrack:s=i?void 0:function(e,t,i,n){const s=t.audioSend.find((t=>t.ssrc===e));if(!s)return;const o={};o[so.DISABLED]=n._originMediaStreamTrack&&!n._originMediaStreamTrack.enabled||n._mediaStreamTrack&&!n._mediaStreamTrack.enabled?1:0;const a=100*n._source.getAccurateVolumeLevel(),r=s.inputLevel;if(null!=r){const e=Math.ceil(50*Math.log10(100*r+1));ho(o,so.LEVEL,e)}ho(o,no.PCM_LEVEL,a),ho(o,so.AEC_RETURN_LOSS,s.aecReturnLoss),ho(o,so.AEC_RETURN_LOSS_ENH,s.aecReturnLossEnhancement),o[so.FREEZE]=0;const c=i&&i.audioSend.find((t=>t.ssrc===e));if(c){let e=co*lo;c.timestamp&&s.timestamp&&(e=s.timestamp-c.timestamp),null!=c.bytes&&null!=s.bytes&&ho(o,so.BITRATE,8*(s.bytes-c.bytes)/e),null!=c.packets&&null!=s.packets&&ho(o,so.PACKAGE_RATE,1e3*(s.packets-c.packets)/e)}return o}(d[0].ssrcId,e,t,c)}})),{high:o,low:a,audio:s}}getInboundStats(e,t,i){if(!this.requestRemoteMedia)return;const n=this.requestRemoteMedia()||[],s=[];return n.forEach((n=>{let[o,a]=n;const r={peer:o.uid};if(a.has(Pi.VIDEO)&&o.videoTrack){const n=o._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(o._videoSSRC)||!1,s=o.videoTrack?function(e,t,i,n,s,o,a){var r;const c=t.videoRecv.find((t=>t.ssrc===e));if(!c)return;const d={},{receivedFrame:l,outputFrame:h,decodeFrameRate:u}=c,p=i&&i.videoRecv.find((t=>t.ssrc===e));if(d[to.FREEZE]=s&&ko.isRemoteVideoFreeze(n,c,p)?1:0,ho(d,io.FRAME_RATE_DECODE,u),ho(d,to.QP_SUM,c.qpSumPerFrame),c.framesRateFirefox&&ho(d,to.FRAME_RATE,c.framesRateFirefox),l&&ho(d,to.FRAME_RATE,l.frameRate),p){const e=t.timestamp-i.timestamp||(a?co:lo*co);null!=c.packetsLost&&null!=p.packetsLost&&ho(d,to.PACKAGE_LOST,c.packetsLost-p.packetsLost),null!=p.bytes&&null!=c.bytes&&ho(d,to.BITRATE,8*(c.bytes-p.bytes)/e),null!=p.packets&&null!=c.packets&&ho(d,to.PACKAGE_RATE,1e3*(c.packets-p.packets)/e)}if(a)return d;l?(ho(d,to.HEIGHT,l.height),ho(d,to.WIDTH,l.width)):n&&(ho(d,to.HEIGHT,n._videoHeight||0),ho(d,to.WIDTH,n._videoWidth||0)),h&&ho(d,io.FRAME_RATE_OUTPUT,h.frameRate);const _=null===(r=n._player)||void 0===r?void 0:r.rendFrameRate.toFixed(0);if(_&&ho(d,io.FRAME_RATE_RENDER,+_),ho(d,to.JITTER_BUFFER,c.jitterBufferMs),ho(d,to.CURRENT_DELAY,c.currentDelayMs),ho(d,to.FIRS,c.firsCount),ho(d,to.NACKS,c.nacksCount),ho(d,to.PLIS,c.plisCount),n){d[to.DISABLED]=n._originMediaStreamTrack.enabled&&n._mediaStreamTrack.enabled?0:1;const e=n._player;if(e){const{freezeTimeCounterList:t,renderFreezeAccTime:i,videoElementStatus:n}=e;if(t&&t.length>0&&ho(d,io.FREEZE_TIME,t.splice(0,1)[0]),o&&"visible"===tt.visibility&&n===it.PLAYING&&Xe().supportRequestVideoFrameCallback){const t=Math.min(6e3,i);e.renderFreezeAccTime=Math.max(0,i-t),ho(d,io.FREEZE_TIME_RENDER,t)}if("number"==typeof c.totalFreezesDuration){const e=p&&p.totalFreezesDuration?c.totalFreezesDuration-p.totalFreezesDuration:c.totalFreezesDuration;ho(d,io.FREEZE_DURATION,1e3*e)}}}if(d[to.PLAYER_STATUS]=et[n._player?n._player.videoElementStatus:"uninit"],p&&void 0!==c.totalInterFrameDelay&&void 0!==c.totalSquaredInterFrameDelay&&void 0!==p.totalInterFrameDelay&&void 0!==p.totalSquaredInterFrameDelay){const e=c.totalInterFrameDelay-p.totalInterFrameDelay,t=c.totalSquaredInterFrameDelay-p.totalSquaredInterFrameDelay,i=c.framesDecodeCount-p.framesDecodeCount,n=e/i*1e3,s=Math.round(1e3*Math.sqrt((t-Math.pow(e,2)/i)/i));!isNaN(s)&&n+s>Math.max(3*n,n+150)&&(d[to.I_FRAME_DELAY]=s)}return d}(o._videoSSRC,e,t,o.videoTrack,!0===n,this.needUploadRenderFreezeTime,i):void 0;s&&(r.video=s)}if(a.has(Pi.AUDIO)&&o.audioTrack){const n=o.audioTrack?function(e,t,i,n,s){const o=t.audioRecv.find((t=>t.ssrc===e));if(!o)return;const a={},r=i&&i.audioRecv.find((t=>t.ssrc===e)),{receivedFrames:c,droppedFrames:d}=o;var l,h;if(ho(a,oo.JITTER,o.jitterMs),null!=c&&null!=d&&(a[oo.FREEZE]=(h=d,0===(l=c)||100*h/l>20?1:0)),r){const e=t.timestamp-i.timestamp||(s?co:co*lo);null!=o.packets&&null!=r.packets&&ho(a,oo.PACKAGE_RATE,1e3*(o.packets-r.packets)/e),null!=r.bytes&&null!=o.bytes&&ho(a,oo.BITRATE,8*(o.bytes-r.bytes)/e),null!=o.packetsLost&&null!=r.packetsLost&&ho(a,oo.PACKAGE_LOST,o.packetsLost-r.packetsLost)}if(s)return a;const u=100*n._source.getAccurateVolumeLevel(),p=o.outputLevel;if(null!=p){const e=Math.ceil(50*Math.log10(100*p+1));ho(a,ao.LEVEL,e)}if(ho(a,oo.PCM_LEVEL,u),n&&(a[oo.DISABLED]=n._originMediaStreamTrack.enabled&&n._mediaStreamTrack.enabled?0:1),ho(a,oo.JITTER_BUFFER,o.jitterBufferMs),ho(a,oo.CURRENT_DELAY,o.jitterBufferMs),a[oo.PLAYER_STATUS]=et[nt.getPlayerState(n.getTrackId())],r){const e=o.concealedSamples-r.concealedSamples;e>0&&ho(a,oo.CONCEALED_SAMPLES,e)}return a}(o._audioSSRC,e,t,o.audioTrack,i):void 0;n&&(r.audio=n)}(r.video||r.audio)&&s.push(r)})),this.needUploadRenderFreezeTime=!this.needUploadRenderFreezeTime,s}startUploadTransportStats(){this.uploadTransportStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats()}stopUploadTransportStats(){this.uploadTransportStarted=!1}startUploadOutboundStats(){this.uploadOutboundStarted||(this.uploadOutboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=window.setInterval((()=>{if(!this.requestAllTracks||!this.requestUpload)return;const e=(this.requestAllTracks()||[]).find((e=>e instanceof st));if(e&&e._external.getDenoiserStats){const t=e._external.getDenoiserStats();t&&this.requestUpload(ci.DENOISER_STATS,t)}}),2e3),this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=window.setInterval((()=>{if(!this.requestAllTracks||!this.requestUpload)return;this.requestAllTracks().forEach((e=>{e.getProcessorStats().forEach((e=>{this.requestUpload&&this.requestUpload(e.type,e.stats)}))}))}),2e3))}stopUploadOutboundStats(){this.uploadOutboundStarted&&(this.uploadOutboundStarted=!1,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=void 0)}startUploadInboundStats(){this.uploadInboundStarted||(this.uploadInboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=window.setInterval((()=>{if(!this.requestUpload||!this.requestRemoteMedia)return;(this.requestRemoteMedia()||[]).forEach((e=>{let[t,i]=e;if(i.has(Pi.VIDEO)&&t.videoTrack){t.videoTrack.getProcessorStats().forEach((e=>{this.requestUpload&&this.requestUpload(e.type,e.stats)}))}if(i.has(Pi.AUDIO)&&t.audioTrack){t.audioTrack.getProcessorStats().forEach((e=>{this.requestUpload&&this.requestUpload(e.type,e.stats)}))}}))}),2e3))}stopUploadInboundStats(){this.uploadInboundStarted&&(this.uploadInboundStarted=!1,this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0))}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer);const e=new Map;this.uploadExtUsageStatsTimer=window.setInterval((async()=>{const t=Date.now(),i={connectionInterval:E("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:t};let n=[];const s=this.requestAllTracks&&this.requestAllTracks()||[];for(const e of s)!e.muted&&e.enabled&&(n=n.concat(await e.getProcessorUsage()));const o=this.requestRemoteMedia&&this.requestRemoteMedia()||[];for(const[e,t]of o)t.has(Pi.VIDEO)&&e.videoTrack&&(n=n.concat(await e.videoTrack.getProcessorUsage())),t.has(Pi.AUDIO)&&e.audioTrack&&(n=n.concat(await e.audioTrack.getProcessorUsage()));if(0===n.length)return;i.details=function(e,t){const i={};for(const{id:a,value:r,level:c,direction:d}of e){var n;const e=null!==(n=t.get(a))&&void 0!==n?n:0,l=2===r?e+E("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:e;var s,o;t.set(a,l),i[a]?(2===r&&(i[a].value=r),c>i[a].level&&(i[a].level=c),"remote"===d&&(i[a].remoteUidCount+=1),i[a].totalTs=null!==(s=t.get(a))&&void 0!==s?s:0):i[a]={value:r,level:c,remoteUidCount:"local"===d?0:1,totalTs:null!==(o=t.get(a))&&void 0!==o?o:0}}return Object.keys(i).map((e=>{const{level:t,value:n,totalTs:s}=i[e];return{id:e,level:t,value:n,totalTs:s}}))}(n,e);const a=Date.now(),r=a>t?a:t+1;this.requestUpload&&this.requestUpload(ci.EXTENSION_USAGE_STATS,{usageStats:i,sendTs:r})}),E("EXTENSION_USAGE_UPLOAD_INTERVAL"))}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer),this.uploadExtUsageStatsTimer=void 0)}}class Eo{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio||this._audio_pre_subscribed)return this._audioTrack}get videoTrack(){if(this.hasVideo||this._video_pre_subscribed)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(e,t){this.uid=void 0,this._uintid=void 0,this._trust_in_room_=!0,this._trust_audio_enabled_state_=!0,this._trust_video_enabled_state_=!0,this._trust_audio_mute_state_=!0,this._trust_video_mute_state_=!0,this._audio_muted_=!1,this._video_muted_=!1,this._audio_enabled_=!0,this._video_enabled_=!0,this._audio_added_=!1,this._video_added_=!1,this._is_pre_created=!1,this._video_pre_subscribed=!1,this._audio_pre_subscribed=!1,this._trust_video_stream_added_state_=!0,this._trust_audio_stream_added_state_=!0,this._audioTrack=void 0,this._videoTrack=void 0,this._dataChannels=[],this._audioSSRC=void 0,this._videoSSRC=void 0,this._audioOrtc=void 0,this._videoOrtc=void 0,this._cname=void 0,this._rtxSsrcId=void 0,this._videoMid=void 0,this._audioMid=void 0,this.uid=e,this._uintid=t}}let mo=function(e){return e.SEND_ONLY="SEND_ONLY",e.RECEIVE_ONLY="RECEIVE_ONLY",e}({});function So(e,t){let i;switch(t){case Mi.LocalAudioTrack:i=Ri.Audio;break;case Mi.LocalVideoTrack:i=e._hints.includes(ze.SCREEN_TRACK)?Ri.Screen:Ri.High;break;case Mi.LocalVideoLowTrack:i=Ri.Low}return i}function fo(e){const t=Xe();if(e.some((e=>e._bypassWebAudio)))throw new l(h.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");if(!t.webAudioMediaStreamDest)throw new l(h.NOT_SUPPORTED,"cannot publish multiple tracks because your browser does not support audio mixing")}function Co(e,t){fo(e);const i=t||new Ze;return e.forEach((e=>i.addAudioTrack(e))),i}var To,Ro,Io,go,Ao,vo,yo,wo,bo,No,Oo,Do;let Po=(To=Lo(mo.SEND_ONLY),Ro=Lo(mo.SEND_ONLY),Io=Lo(),go=Lo(mo.RECEIVE_ONLY),Ao=Lo(mo.RECEIVE_ONLY),vo=Lo(mo.RECEIVE_ONLY),yo=Lo(mo.RECEIVE_ONLY),wo=Lo(mo.RECEIVE_ONLY),bo=Lo(mo.RECEIVE_ONLY),No=Lo(),Oo=Lo(mo.RECEIVE_ONLY),jt((Do=class extends _{get state(){return this._state}set state(e){const t=this._state;this._state=e,this.emit(Vi.StateChange,t,this._state)}constructor(e,i){super(),this.isPlanB=!1,this.store=void 0,this.statsUploader=void 0,this.sendConnection=void 0,this.recvConnection=void 0,this.localTrackMap=new Map,this.remoteUserMap=new Map,this.localDataChannels=[],this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.statsCollector=void 0,this.dtlsFailedCount=0,this.sendMutex=new C("P2PChannel2-send-mutex"),this.recvMutex=new C("P2PChannel2-recv-mutex"),this._state=Ui.Disconnected,this._restartStates=["disconnected","failed"],this.reconnectInterval=void 0,this.uploadUnplinkStarted=!1,this.uploadDownlinkStarted=!1,this.uplinkStateUploadInterval=void 0,this.downlinkStatsUploadInterval=void 0,this.handleMuteLocalTrack=async(e,t,i)=>{const n=await this.sendMutex.lock("Locking from P2PChannel2.handleMuteLocalTrack");try{if(!this.sendConnection||this.state!==Ui.Connected)return void i(new l(h.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established."));const a=this.filterTobeMutedTracks(e);if(0===a.length)return void t();const r=a.find((e=>"videoLowTrack"===e[0]));if(r){r[1].track._originMediaStreamTrack.stop()}await this.sendConnection.muteLocal(a.map((e=>{let[,{id:t}]=e;return t})));let c=!1;var s,o;if("video"===e.trackMediaType)c=!(null===(s=this.localTrackMap.get(Mi.LocalAudioTrack))||void 0===s||!s.track._muted);else c=void 0===(null===(o=this.localTrackMap.get(Mi.LocalVideoTrack))||void 0===o?void 0:o.id);const d=this.createMuteMessage(a);await ee(this,Vi.RequestMuteLocal,d);const u="video"===e.trackMediaType?Yi.MUTE_LOCAL_VIDEO:Yi.MUTE_LOCAL_AUDIO;await ee(this,Vi.RequestP2PMuteLocal,{action:u,message:d,isMuteAll:c}),t()}catch(e){i(e)}finally{n()}},this.handleUnmuteLocalTrack=async(e,t,i)=>{const n=await this.sendMutex.lock("Locking from P2PChannel2.handleUnmuteLocalTrack");try{if(!this.sendConnection||this.state!==Ui.Connected)return void i(new l(h.INVALID_OPERATION,"Cannot call P2PChannel2.handleUnmuteLocalTrack before sendConnection established."));const s=this.filterTobeUnmutedTracks(e);if(0===s.length)return void t();await this.sendConnection.unmuteLocal(s.map((e=>{let[,{id:t}]=e;return t})));const o=this.createUnmuteMessage(s),a="video"===e.trackMediaType?Yi.UNMUTE_LOCAL_VIDEO:Yi.UNMUTE_LOCAL_AUDIO;await ee(this,Vi.RequestP2PMuteLocal,{action:a,message:o}),t()}catch(e){i(e)}finally{n()}},this.handleUpdateVideoEncoder=async(e,t,i)=>{const n=await this.sendMutex.lock("Locking from P2PChannel2.handleSetVideoEncoder");try{const i=this.localTrackMap.get(Mi.LocalVideoTrack);if(!this.sendConnection||!i||i.track!==e||this.state!==Ui.Connected)return void t();const{id:s,track:o}=i;s&&(await this.sendConnection.updateSendParameters(s,o),await this.sendConnection.updateEncoderConfig(s,o),this.emit(Vi.UpdateVideoEncoder,o)),t()}catch(e){i(e)}finally{n()}},this.handleUpdateVideoSendParameters=async(e,t,i)=>{const n=await this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoSendParameters");try{const i=this.localTrackMap.get(Mi.LocalVideoTrack);if(!this.sendConnection||!i||i.track!==e||this.state!==Ui.Connected)return void t();const{id:s,track:o}=i;s&&await this.sendConnection.updateSendParameters(s,o),t()}catch(e){i(e)}finally{n()}},this.handleReplaceTrack=async(e,i,n,s)=>{let o;t.debug("[".concat(this.store.clientId,"] P2PChannel2 handleReplaceTrack for [track-id-").concat(e.getTrackId(),"]")),"boolean"==typeof s&&s||(o=await this.sendMutex.lock("From P2PChannel2.handleReplaceTrack"));try{var a;const t=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(!this.sendConnection||!t||void 0===t[1].id||this.state!==Ui.Connected)return void i();if(await(null===(a=this.sendConnection)||void 0===a?void 0:a.replaceTrack(e,t[1].id)),t[0]===Mi.LocalVideoTrack&&Xe().supportDualStreamEncoding){const t=this.localTrackMap.get(Mi.LocalVideoLowTrack);if(t){const i=e._mediaStreamTrack.clone();t.track._originMediaStreamTrack.stop(),t.track._mediaStreamTrack=i,t.track._originMediaStreamTrack=i,await new Promise(((e,i)=>{this.handleReplaceTrack(t.track,e,i,!0)}))}}i()}catch(e){n(e)}finally{var r;null===(r=o)||void 0===r||r()}},this.handleGetLocalVideoStats=e=>{e(this.statsCollector.getLocalVideoTrackStats())},this.handleGetLocalAudioStats=e=>{e(this.statsCollector.getLocalAudioTrackStats())},this.handleGetRemoteVideoStats=e=>this.statsCollector.getRemoteVideoTrackStats(e.uid)[e.uid],this.handleGetRemoteAudioStats=e=>this.statsCollector.getRemoteAudioTrackStats(e.uid)[e.uid],this.store=e,this.statsCollector=i,this.statsCollector.addP2PChannel(this),this.statsUploader=new _o(e),this.bindStatsUploaderEvents(),this.reconnectInterval=window.setInterval((()=>{[this.sendConnection,this.recvConnection].forEach((e=>{e&&("disconnected"!==e.iceConnectionState&&"failed"!==e.iceConnectionState||this.handleDisconnect(e.direction))}))}),E("ICE_RESTART_INTERVAL"))}async startP2PConnection(e,t){throw new l(h.NOT_SUPPORTED,"p2p mode does not support startP2PConnection.")}async connect(e){throw new l(h.NOT_SUPPORTED,"p2p mode does not support connect.")}async startP2P(e,i){let n;try{if(i){this.recvConnection&&(t.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset recvConnection.")),this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection)),n=await this.recvMutex.lock("From P2PChannel.startP2P"),this.recvConnection=new Xs(e,this.store,li.RECEIVE_ONLY),this.bindConnectionEvents(this.recvConnection);const s=await this.recvConnection.establish(i);return{iceParameters:s.iceParameters,dtlsParameters:s.dtlsParameters,sdp:s.sdp}}{this.state=Ui.New,this.sendConnection&&(t.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset sendConnection.")),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection)),n=await this.sendMutex.lock("From P2PChannel.startP2P"),this.sendConnection=new Xs(e,this.store),this.store.peerConnectionStart(),this.bindConnectionEvents(this.sendConnection);const i=await this.sendConnection.establish();return{iceParameters:i.iceParameters,dtlsParameters:i.dtlsParameters,sdp:i.sdp}}}finally{n&&n()}}async p2pConnect(e){if(!this.sendConnection)throw new l(h.UNEXPECTED_ERROR,"Cannot P2PChannel2.p2pConnect before P2PChannel2.startP2PConnection .");this.store.peerConnectionStart(),await this.sendConnection.connect(e),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=Ui.Connected}async addRemoteCandidate(e,t){if(t===li.RECEIVE_ONLY){if(!this.sendConnection)throw new l(h.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.sendConnection.addRemoteCandidate(e)}else{if(!this.recvConnection)throw new l(h.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.recvConnection.addRemoteCandidate(e)}}publish(e,t,i){var n=this;return zt((function*(){const s=yield Yt(n.sendMutex.lock("From P2PChannel.publish"));try{if(!n.sendConnection||n.state!==Ui.Connected){n.throwIfTrackTypeNotMatch(e);const t=e.filter((e=>-1===n.pendingLocalTracks.indexOf(e)));return void(n.pendingLocalTracks=n.pendingLocalTracks.concat(t))}n.store.pubId=n.store.pubId+1,Ds.markPublishStart(n.store.clientId,n.store.pubId);const o=n.filterTobePublishedTracks(e,t,i);if(0===o.length)return void(yield Yt(n.tryToUnmuteAudio(e)));o.forEach((e=>{let{track:t,type:i}=e;const s=Date.now();n.store.publish(t.getTrackId(),i===Mi.LocalAudioTrack?"audio":"video",s)})),n.bindLocalTrackEvents(o);const a=yield Yt(n.sendConnection.send(o.map((e=>{let{track:t}=e;return t})),n.store.codec,n.store.audioCodec)),r=(yield Yt(a.next())).value,c=n.createGatewayPublishMessage(o,r);try{yield c}catch(e){throw a.throw(e),(null==e?void 0:e.code)===h.WS_ABORT&&o.forEach((e=>{let{track:t}=e;-1===n.pendingLocalTracks.indexOf(t)&&n.pendingLocalTracks.push(t)})),n.unbindLocalTrackEvents(o),e}yield Yt(a.next()),o.forEach((e=>{let{type:t}=e;n.statsCollector.addLocalStats(t)})),n.statsUploader.startUploadOutboundStats(),n.assignLocalTracks(o,r),o.forEach((e=>{let{track:t,type:i}=e;const s=Date.now();n.store.publish(t.getTrackId(),i===Mi.LocalAudioTrack?"audio":"video",void 0,s)})),n.startUploadUplinkState()}finally{s()}}))()}async unpublish(e){if(!this.sendConnection||this.state!==Ui.Connected)return void(0===e.length?this.pendingLocalTracks.length=0:this.pendingLocalTracks=this.pendingLocalTracks.filter((t=>!e.includes(t))));const t=this.filterTobeUnpublishedTracks(e);if(0===t.length)return;const i=t.find((e=>"videoLowTrack"===e[0]));if(i){i[1].track.close()}const n=this.createGatewayUnpublishMessage(t);if(await this.sendConnection.stopSending(t.map((e=>{let[,{id:t}]=e;return t}))),this.withdrawLocalTracks(t),this.unbindLocalTrackEvents(t.map((e=>{let[t,{track:i}]=e;return{type:t,track:i}}))),t.forEach((e=>{let[t]=e;this.statsCollector.removeLocalStats(t)})),0===this.localTrackMap.size&&(this.statsUploader.stopUploadOutboundStats(),this.stopUploadUplinkState()),this.sendConnection&&this.state===Ui.Connected){if(i){i[1].track.close()}return n}e.forEach((e=>{const t=this.pendingLocalTracks.indexOf(e);-1!==t&&this.pendingLocalTracks.splice(t,1)}))}startUploadUplinkState(){if(this.uploadUnplinkStarted)return;this.uploadUnplinkStarted=!0,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval);const e=()=>{const e=[],t=[];Array.from(this.localTrackMap.entries()).forEach((i=>{let[n,{track:s,ssrcs:o}]=i;const a={stream_type:So(s,n),ssrcs:o};s._muted||!s._enabled?e.push(a):t.push(a)})),e.length>0&&e.forEach((e=>{ee(this,Vi.RequestMuteLocal,[e])})),t.length>0&&t.forEach((e=>{ee(this,Vi.RequestUnmuteLocal,[e])}))};e(),this.uplinkStateUploadInterval=window.setInterval((()=>{e()}),3e3)}stopUploadUplinkState(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval))}publishLowStream(e){return zt((function*(){throw new l(h.NOT_SUPPORTED,"p2p mode does not support publishLowStream.")}))()}async republish(){this.pendingLocalTracks.length>0&&(t.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await v(this,Vi.RequestRePublish,this.pendingLocalTracks),this.emit(Vi.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])}async unpublishLowStream(){throw new l(h.NOT_SUPPORTED,"p2p mode does not support unpublishLowStream.")}async subscribe(e,i,n,s){var o;if(!this.recvConnection)throw new l(h.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");if(null!==(o=this.remoteUserMap.get(e))&&void 0!==o&&o.has(i))return;const{track:a,mid:r,transceiver:c}=await this.recvConnection.receive(i,[{ssrcId:n}],String(e.uid),s);i===Pi.AUDIO?(e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(a):(e._audioTrack=new ot(a,e.uid,e._uintid,this.store),t.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),c&&e._audioTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoSSRC=n,e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(a):(e._videoTrack=new at(a,e.uid,e._uintid,this.store),t.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId()))),c&&e._videoTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(e,e._videoTrack));const d=this.remoteUserMap.get(e);d?d.set(i,r):this.remoteUserMap.set(e,new Map([[i,r]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadInboundStats(),this.startUploadDownlinkState();const u=this.pendingRemoteTracks.findIndex((t=>{let{user:n,kind:s}=t;return n.uid===e.uid&&i===s}));-1!==u&&(this.pendingRemoteTracks.splice(u,1),this.emit(Vi.MediaReconnectEnd,e.uid))}async mockSubscribe(e,t,i,n){if(!this.recvConnection)throw new l(h.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");await this.recvConnection.mockReceive(t,[{ssrcId:i}],String(e.uid),n)}async unsubscribe(e,t,i){const n=this.pendingRemoteTracks.filter((i=>{let{user:n,kind:s}=i;return void 0!==t?n.uid===e.uid&&t===s:n.uid===e.uid}));if(n.forEach((e=>{const t=this.pendingRemoteTracks.indexOf(e);this.pendingRemoteTracks.splice(t,1)})),this.recvConnection||i||n.forEach((t=>{let{kind:i}=t;var n;if(i===Pi.AUDIO)null===(n=e._audioTrack)||void 0===n||n._destroy(),e._audioTrack=void 0;else if(i===Pi.VIDEO){var s;null===(s=e._videoTrack)||void 0===s||s._destroy(),e._videoTrack=void 0}})),!this.recvConnection)return;const s=this.filterTobeUnSubscribedTracks(e,t);0!==s.length&&(await this.recvConnection.stopReceiving(s.map((e=>{let[,{id:t}]=e;return t}))),this.withdrawRemoteTracks(s),0===this.remoteUserMap.size&&(this.statsUploader.stopUploadInboundStats(),this.stopUploadDownlinkState()),s.forEach((e=>{let[t,{kind:n}]=e;var s,o;n===Pi.VIDEO&&t._videoSSRC&&(null===(s=this.recvConnection)||void 0===s||s.setStatsRemoteVideoIsReady(t._videoSSRC,!1));if(n===Pi.VIDEO)this.unbindRemoteTrackEvents(t._videoTrack),i||(null===(o=t._videoTrack)||void 0===o||o._destroy(),t._videoTrack=void 0);else if(n===Pi.AUDIO){var a;if(this.unbindRemoteTrackEvents(t._audioTrack),!i)null===(a=t._audioTrack)||void 0===a||a._destroy(),t._audioTrack=void 0}})),s.forEach((e=>{let[,{kind:t}]=e;ee(this,Vi.RequestP2PMuteRemote,t)})))}startUploadDownlinkState(){if(this.uploadDownlinkStarted)return;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);const e=()=>Array.from(this.remoteUserMap.entries()).forEach((e=>{let[,t]=e;[Pi.VIDEO,Pi.AUDIO].forEach((e=>{t.has(e)?ee(this,Vi.RequestP2PUnmuteRemote,e):ee(this,Vi.RequestP2PMuteRemote,e)}))}));e(),this.downlinkStatsUploadInterval=window.setInterval((()=>{e()}),3e3)}stopUploadDownlinkState(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval))}getAllDataChannels(){return this.localDataChannels}async massSubscribe(e){throw new l(h.NOT_SUPPORTED,"p2p mode does not support massSubscribe.")}async massSubscribeNoLock(e){throw new l(h.NOT_SUPPORTED,"p2p mode does not support massSubscribeNoLock.")}async massUnsubscribe(e){throw new l(h.NOT_SUPPORTED,"p2p mode does not support massUnsubscribe.")}async massUnsubscribeNoLock(e){throw new l(h.NOT_SUPPORTED,"p2p mode does not support massUnsubscribeNoLock.")}async muteRemote(e,i){if(!this.recvConnection)return;const n=this.remoteUserMap.get(e);if(!n)return void t.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid,"."));if(!n.get(i))return void t.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid," media type ").concat(i,"."));const s=i===Pi.VIDEO?e._videoSSRC:e._audioSSRC;void 0!==s&&this.recvConnection.setStatsRemoteVideoIsReady(s,!1)}async unmuteRemote(e,t){return this.unmuteRemoteNoLock(e,t)}async unmuteRemoteNoLock(e,i){if(!this.recvConnection)return;const n=this.remoteUserMap.get(e);if(!n)return void t.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid,"."));n.get(i)||t.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(i,"."))}getAllTracks(e){const t=this.localTrackMap.get(Mi.LocalAudioTrack);if((null==t?void 0:t.track)instanceof Ze){const i=t.track;return Array.from(this.localTrackMap.entries()).filter((e=>{let[t]=e;return t!==Mi.LocalAudioTrack})).filter((t=>{let[i]=t;return!(e&&i===Mi.LocalVideoLowTrack)})).map((e=>{let[,{track:t}]=e;return t})).concat(i.trackList)}return Array.from(this.localTrackMap.entries()).filter((t=>{let[i]=t;return!(e&&i===Mi.LocalVideoLowTrack)})).map((e=>{let[,{track:t}]=e;return t}))}reportPublishEvent(e,t,n,s,o){if(e){const n=this.localTrackMap.get(Mi.LocalAudioTrack),a=s?this.localTrackMap.get(Mi.LocalVideoLowTrack):this.localTrackMap.get(Mi.LocalVideoTrack);i.publish(this.store.sessionId,{eventElapse:Ds.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:null==n?void 0:n.track.getTrackLabel(),videoName:null==a?void 0:a.track.getTrackLabel(),screenshare:-1!==(null==a?void 0:a.track._hints.indexOf(ze.SCREEN_TRACK)),audio:!!n,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:o})}else{var a;n||(n=[]);const r=n.find((e=>e instanceof qe)),c=s?null===(a=this.localTrackMap.get(Mi.LocalVideoTrack))||void 0===a?void 0:a.track:n.find((e=>e instanceof Je));i.publish(this.store.sessionId,{eventElapse:Ds.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:null==r?void 0:r.getTrackLabel(),videoName:null==c?void 0:c.getTrackLabel(),screenshare:-1!==(null==c?void 0:c._hints.indexOf(ze.SCREEN_TRACK)),audio:!!r,video:!!c,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:o})}}reportSubscribeEvent(e,t,n,s){const o=s===Pi.VIDEO?n._videoSSRC:n._audioSSRC;o&&i.subscribe(this.store.sessionId,{succ:e,ec:t,video:s===Pi.VIDEO,audio:s===Pi.AUDIO,peerid:n.uid,subscribeRequestid:s===Pi.VIDEO?n._videoSSRC:n._audioSSRC,p2pid:this.store.p2pId,eventElapse:Ds.measureFromSubscribeStart(this.store.clientId,o)})}reset(){t.debug("[".concat(this.store.clientId,"] P2PChannel2.reset")),this.sendMutex=new C("P2PChannel2-send-mutex"),this.sendMutex=new C("P2PChannel2-recv-mutex"),this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const e=this.localTrackMap.get(Mi.LocalAudioTrack);if((null==e?void 0:e.track)instanceof Ze){if(e.track.trackList.length>0){const t=e.track;e.track.trackList.forEach((e=>{t.removeAudioTrack(e)}))}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.reconnectInterval&&(window.clearInterval(this.reconnectInterval),this.reconnectInterval=void 0),this.state=Ui.Disconnected}getStats(e){var t,i;return e?null===(i=this.recvConnection)||void 0===i?void 0:i.getStats():null===(t=this.sendConnection)||void 0===t?void 0:t.getStats()}getRemoteVideoIsReady(e){var t;return(null===(t=this.recvConnection)||void 0===t?void 0:t.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){const e=this.localTrackMap.get(Mi.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){const e=this.localTrackMap.get(Mi.LocalVideoTrack);if(e)return{width:e.track.videoWidth||0,height:e.track.videoHeight||0}}getEncoderConfig(e){const t=this.localTrackMap.get(e);return t&&t.track instanceof Je||t&&t.track instanceof qe?t.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,t){if(!e)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(e);return!!i&&(!t||i.has(t))}async hasRemoteMediaWithLock(e,t){if(!e)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(e);return!!i&&(!t||i.has(t))}getRemoteMedia(e){const t=Array.from(this.remoteUserMap.keys()).find((t=>t.uid===e));return t?{audioTrack:t.audioTrack,audioSSRC:t._audioSSRC,videoTrack:t.videoTrack,videoSSRC:t._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map((e=>{let[t]=e;return{uid:t.uid,level:t.audioTrack?100*t.audioTrack._source.getAccurateVolumeLevel():0}}));const t=this.localTrackMap.get(Mi.LocalAudioTrack);return t&&e.push({level:100*t.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=e.sort(((e,t)=>e.level-t.level)),e}async disconnectForReconnect(){this.sendConnection&&this.recvConnection&&(t.debug("[".concat(this.store.clientId,"] P2PChannel2.disconnectForReconnect closing P2PConnection")),this.state=Ui.Reconnecting,E("KEEP_LAST_FRAME")&&0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t]=e;var i;t._videoTrack&&t._videoTrack._player&&(null===(i=t._videoTrack._player.getVideoElement())||void 0===i||i.pause(),t._videoTrack._player.isKeepLastFrame=!0,t._videoTrack._originMediaStreamTrack.stop())})),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0,this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0,0!==this.localTrackMap.size&&(Array.from(this.localTrackMap.entries()).forEach((e=>{let[t,{track:i}]=e;switch(t){case Mi.LocalVideoTrack:i._hints.includes(ze.LOW_STREAM)?i.close():this.pendingLocalTracks.push(i);break;case Mi.LocalAudioTrack:i instanceof Ze?this.pendingLocalTracks=this.pendingLocalTracks.concat(i.trackList):this.pendingLocalTracks.push(i);case Mi.LocalVideoLowTrack:}})),this.emit(Vi.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,i]=e;Array.from(i.keys()).forEach((e=>{this.setPendingRemoteMedia(t,e)})),this.emit(Vi.MediaReconnectStart,t.uid)})),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),t.debug("[".concat(this.store.clientId,"] P2PChannel2 disconnected, waiting to reconnect.")))}hasPendingRemoteMedia(e,t){for(const i of this.pendingRemoteTracks){const{user:n,kind:s}=i;if((e instanceof Eo?e.uid:e)===n.uid&&t===s)return!0}return!1}setPendingRemoteMedia(e,t){this.hasPendingRemoteMedia(e,t)||this.pendingRemoteTracks.push({user:e,kind:t})}async restartICE(e,t){let i,n;if(e===li.SEND_ONLY){if(!this.sendConnection)throw new l(h.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established.");i=await this.sendMutex.lock("From P2PChannel.restartICE"),n=this.sendConnection}else{if(!this.recvConnection)throw new l(h.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before recvConnection established.");i=await this.recvMutex.lock("From P2PChannel.restartICE"),n=this.recvConnection}try{if(t){const e=await n.restartICE(t);return n.isInRestartIce=!1,e}{const e=await n.restartICE();if(e){const t=await v(this,Vi.RequestP2PRestartICE,{direction:li.RECEIVE_ONLY,iceParameter:e});await n.restartICE(t),n.isInRestartIce=!1}}}finally{i()}}getUplinkNetworkQuality(){if(!this.sendConnection)return 0;const e=this.sendConnection.getStats(),t=this.localTrackMap.get(Mi.LocalVideoTrack),i=this.localTrackMap.get(Mi.LocalAudioTrack),n=e.videoSend.find((e=>{var i;return e.ssrc===(null==t||null===(i=t.ssrcs)||void 0===i?void 0:i[0].ssrcId)})),s=e.audioSend.find((e=>{var t;return e.ssrc===(null==i||null===(t=i.ssrcs)||void 0===t?void 0:t[0].ssrcId)}));if(!n||!s)return 1;const o=y(this,Vi.NeedSignalRTT),a=n?n.rttMs:void 0,r=s?s.rttMs:void 0,c=a&&r?(a+r)/2:a||r,d=(c&&o?(c+o)/2:c||o)||0,l=100*e.sendPacketLossRate*.7/50+.3*d/1500,h=l<.17?1:l<.36?2:l<.59?3:l<.1?4:5,u=null==t?void 0:t.track;if(u&&u._encoderConfig&&-1===u._hints.indexOf(ze.SCREEN_TRACK)){const t=u._encoderConfig.bitrateMax,i=e.bitrate.actualEncoded;if(t&&i){const e=(1e3*t-i)/(1e3*t);return xt[e<.15?0:e<.3?1:e<.45?2:e<.6?3:4][h]}}return h}getDownlinkNetworkQuality(){if(!this.recvConnection)return 0;const e=this.recvConnection.getStats();let t=0;return Array.from(this.remoteUserMap.entries()).forEach((i=>{let[n]=i;const s=n._audioSSRC,o=n._videoSSRC,a=e.audioRecv.find((e=>e.ssrc===s)),r=e.videoRecv.find((e=>e.ssrc===o));if(!a&&!r)return void(t+=1);const c=y(this,Vi.NeedSignalRTT),d=e.rtt,l=(d&&c?(d+c)/2:d||c)||0,h=a?a.jitterMs:void 0,u=e.recvPacketLossRate;let p=.7*u*100/50+.3*l/1500;h&&(p=.6*u*100/50+.2*l/1500+.2*h/400);t+=p<.1?1:p<.17?2:p<.36?3:p<.59?4:5})),this.remoteUserMap.size>0?Math.round(t/this.remoteUserMap.size):t}async muteLocalTrack(e){return new Promise(((t,i)=>{this.handleMuteLocalTrack(e,t,i)}))}filterTobePublishedTracks(e,t,i){const n=[],s=Xe(),o=this.getAllTracks();e=e.filter((e=>-1===o.indexOf(e))),e=te(e);let a=!1,r=!1;for(const o of e){if(o instanceof Je&&(this.localTrackMap.has(Mi.LocalVideoTrack)||a?new l(h.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(n.push({track:o,type:Mi.LocalVideoTrack}),a=!0),t)){const e=this.getLowVideoTrack(o,i);n.push({track:e,type:Mi.LocalVideoLowTrack})}if(o instanceof qe){const e=this.localTrackMap.get(Mi.LocalAudioTrack);if(e){if(!(e.track instanceof Ze))throw new l(h.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(o._bypassWebAudio)throw new l(h.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");e.track.addAudioTrack(o),this.bindLocalAudioTrackEvents(o,!0)}else if(r){const e=n.find((e=>{let{type:t}=e;return t===Mi.LocalAudioTrack}));if(!(e.track instanceof Ze))throw new l(h.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(o._bypassWebAudio)throw new l(h.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");e.track.addAudioTrack(o)}else{if(!s.webAudioMediaStreamDest||o instanceof Ze||o._bypassWebAudio)n.push({track:o,type:Mi.LocalAudioTrack});else{const e=new Ze;e.addAudioTrack(o),n.push({track:e,type:Mi.LocalAudioTrack})}r=!0}}}return n}filterTobeUnpublishedTracks(e){const t=[],i=this.getAllTracks();e=e.filter((e=>-1!==i.indexOf(e))),e=te(e);for(const i of e){if(i instanceof qe){const e=this.localTrackMap.get(Mi.LocalAudioTrack);if(!e)continue;e.track instanceof Ze?(e.track.removeAudioTrack(i),this.unbindLocalAudioTrackEvents(i),0===e.track.trackList.length&&(t.push([Mi.LocalAudioTrack,e]),e.track.close())):t.push([Mi.LocalAudioTrack,e])}if(i instanceof Je){const e=this.localTrackMap.get(Mi.LocalVideoTrack);if(!e)continue;t.push([Mi.LocalVideoTrack,e]);const i=this.localTrackMap.get(Mi.LocalVideoLowTrack);i&&t.push([Mi.LocalVideoLowTrack,i])}}return t}bindLocalTrackEvents(e){e.forEach((e=>{let{track:t,type:i}=e;switch(i){case Mi.LocalVideoTrack:t.addListener(rt.GET_STATS,this.handleGetLocalVideoStats),t.addListener(rt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(rt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(rt.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.addListener(rt.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),t.addListener(rt.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.addListener(rt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(rt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case Mi.LocalAudioTrack:this.bindLocalAudioTrackEvents(t);case Mi.LocalVideoLowTrack:}}))}bindLocalAudioTrackEvents(e,t){e instanceof Ze?e.trackList.forEach((e=>{e.addListener(rt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(rt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(rt.GET_STATS,this.handleGetLocalAudioStats),e.addListener(rt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(rt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.addListener(rt.GET_STATS,this.handleGetLocalAudioStats),e.addListener(rt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(rt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(rt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(rt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),t||e.addListener(rt.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map((e=>{let[t,{track:i}]=e;return{track:i,type:t}}))),e.forEach((e=>{let{track:t,type:i}=e;switch(i){case Mi.LocalVideoTrack:t.off(rt.GET_STATS,this.handleGetLocalVideoStats),t.off(rt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(rt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(rt.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.off(rt.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),t.off(rt.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(rt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(rt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case Mi.LocalAudioTrack:this.unbindLocalAudioTrackEvents(t);case Mi.LocalVideoLowTrack:}}))}unbindLocalAudioTrackEvents(e){e instanceof Ze?e.trackList.forEach((e=>{e.off(rt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(rt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(rt.GET_STATS,this.handleGetLocalAudioStats),e.off(rt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(rt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.off(rt.GET_STATS,this.handleGetLocalAudioStats),e.off(rt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(rt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(rt.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(rt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(rt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,t){t instanceof at&&t.addListener(rt.GET_STATS,(t=>{t(this.handleGetRemoteVideoStats(e))})),t instanceof ot&&t.addListener(rt.GET_STATS,(t=>{t(this.handleGetRemoteAudioStats(e))}))}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(rt.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,i]=e;i.has(Pi.AUDIO)&&this.unbindRemoteTrackEvents(t._audioTrack),i.has(Pi.VIDEO)&&this.unbindRemoteTrackEvents(t._videoTrack)}))}createGatewayPublishMessage(e,t){return e.map(((e,i)=>{let n,{track:s,type:o}=e;switch(o){case Mi.LocalAudioTrack:n=Ri.Audio;break;case Mi.LocalVideoTrack:n=s._hints.includes(ze.SCREEN_TRACK)?Ri.Screen:Ri.High;break;case Mi.LocalVideoLowTrack:n=Ri.Low}return{kind:o===Mi.LocalAudioTrack?Pi.AUDIO:Pi.VIDEO,stream_type:n,mid:t[i].id,ssrcs:t[i].localSSRC,isMuted:s.muted||!s.enabled}}))}createGatewayUnpublishMessage(e){return e.map((e=>{let t,[i,{track:n,ssrcs:s,id:o}]=e;switch(i){case Mi.LocalVideoTrack:t=n._hints.includes(ze.SCREEN_TRACK)?Ri.Screen:Ri.High;break;case Mi.LocalAudioTrack:t=Ri.Audio;break;case Mi.LocalVideoLowTrack:t=Ri.Low}return{stream_type:t,ssrcs:s,mid:o}}))}assignLocalTracks(e,t){e.forEach(((e,i)=>{let{track:n,type:s}=e;this.localTrackMap.set(s,{track:n,id:t[i].id,ssrcs:t[i].localSSRC})}))}withdrawLocalTracks(e){e.forEach((e=>{let[t]=e;this.localTrackMap.delete(t)}))}bindConnectionEvents(e){e.onConnectionStateChange=async i=>{t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: ").concat(e.name,".onConnectionStateChange(").concat(i,")")),this.emit(Vi.PeerConnectionStateChange,i),"connected"!==i||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),"connected"===i&&(e.isInRestartIce=!1),this._restartStates.includes(i)&&!e.isInRestartIce&&("disconnected"===i&&await A(800),"disconnected"!==e.iceConnectionState&&"failed"!==e.iceConnectionState||this.handleDisconnect(e.direction))},e.onICEConnectionStateChange=e=>{"connected"!==e||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),i.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:q.TRACER}).onSuccess(),this.emit(Vi.IceConnectionStateChange,e)},e.onICETransportStateChange=e=>{t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},e.onDTLSTransportStateChange=e=>{t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},e.onDTLSTransportError=e=>{t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},e.onFirstAudioDecoded=e=>{const t=Array.from(this.remoteUserMap.keys()).find((t=>t._audioSSRC===e));var o;t&&(this.store.subscribe(t.uid,"audio",void 0,void 0,void 0,Date.now()),null===(o=t.audioTrack)||void 0===o||o.emit(ct.FIRST_FRAME_DECODED),i.firstRemoteFrame(this.store.sessionId,n.FIRST_AUDIO_DECODE,s.FIRST_AUDIO_DECODE,{peer:t._uintid,subscribeElapse:Ds.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=e=>{const t=Array.from(this.remoteUserMap.keys()).find((t=>t._audioSSRC===e));t&&i.firstRemoteFrame(this.store.sessionId,n.FIRST_AUDIO_RECEIVED,s.FIRST_AUDIO_RECEIVED,{peer:t._uintid,subscribeElapse:Ds.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(e,t,i)=>{this.reportVideoFirstFrameDecoded(e,t,i)},e.onFirstVideoReceived=e=>{const t=Array.from(this.remoteUserMap.keys()).find((t=>t._videoSSRC===e));t&&i.firstRemoteFrame(this.store.sessionId,n.FIRST_VIDEO_RECEIVED,s.FIRST_VIDEO_RECEIVED,{peer:t._uintid,subscribeElapse:Ds.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},e.onSelectedLocalCandidateChanged=(e,i)=>{const n="relay"===e.candidateType,s="relay"===i.candidateType;"unknown"!==i.candidateType&&n===s||this.emit(Vi.ConnectionTypeChange,n),t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(Cn(i))," -> ").concat(JSON.stringify(Cn(e)),")"))},e.onSelectedRemoteCandidateChanged=(e,i)=>{t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(Cn(i))," -> ").concat(JSON.stringify(Cn(e)),")"))},e.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)},e.onLocalCandidate=t=>{this.emit(Vi.LocalCandidate,{candidate:t,direction:e.direction})}}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0,e.onLocalCandidate=void 0}async handleDisconnect(e){const i=e===li.SEND_ONLY?this.sendConnection:this.recvConnection;i&&!i.isInRestartIce&&(i.isInRestartIce=!0,t.debug("[".concat(this.store.clientId,"] [P2PChannel-").concat(i.name,"] start use restartICE")),e===li.SEND_ONLY?this.restartICE(e):v(this,Vi.RequestP2PRestartICE,{direction:li.SEND_ONLY}))}filterTobeMutedTracks(e){const t=[];if(-1===this.getAllTracks().indexOf(e))return t;const i=this.localTrackMap.get(Mi.LocalAudioTrack);if(e instanceof qe&&(null==i?void 0:i.track)instanceof Ze)return i.track.isActive||t.push([Mi.LocalAudioTrack,i]),t;const n=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(n&&(t.push(n),n[0]===Mi.LocalVideoTrack)){const e=this.localTrackMap.get(Mi.LocalVideoLowTrack);e&&t.push([Mi.LocalVideoLowTrack,e])}return t}filterTobeUnmutedTracks(e){const t=[],i=this.localTrackMap.get(Mi.LocalAudioTrack);if(e instanceof qe&&(null==i?void 0:i.track)instanceof Ze)return i.track.isActive&&t.push([Mi.LocalAudioTrack,i]),t;const n=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(n)if(n[0]===Mi.LocalVideoTrack){t.push(n);const e=this.localTrackMap.get(Mi.LocalVideoLowTrack);e&&t.push([Mi.LocalVideoLowTrack,e])}else t.push(n);return t}createMuteMessage(e){return e.map((e=>{let t,[i,{track:n,ssrcs:s,id:o}]=e;switch(i){case Mi.LocalAudioTrack:t=Ri.Audio;break;case Mi.LocalVideoTrack:t=n._hints.includes(ze.SCREEN_TRACK)?Ri.Screen:Ri.High;break;case Mi.LocalVideoLowTrack:t=Ri.Low}return{stream_type:t,ssrcs:s,mid:o}}))}createUnmuteMessage(e){return e.map((e=>{let t,[i,{track:n,ssrcs:s,id:o}]=e;switch(i){case Mi.LocalAudioTrack:t=Ri.Audio;break;case Mi.LocalVideoTrack:t=n._hints.includes(ze.SCREEN_TRACK)?Ri.Screen:Ri.High;break;case Mi.LocalVideoLowTrack:t=Ri.Low}return{stream_type:t,ssrcs:s,mid:o}}))}filterTobeUnSubscribedTracks(e,t){const i=[],n=this.remoteUserMap.get(e);if(!n)return i;if(t){const s=n.get(t);if(!s)return i;i.push([e,{kind:t,id:s}])}else Array.from(n.entries()).forEach((t=>{let[n,s]=t;i.push([e,{kind:n,id:s}])}));return i}createUnsubscribeMessage(e){const t=[];return e.forEach((e=>{let[i,{kind:n,id:s}]=e;switch(n){case Pi.VIDEO:return void(i._videoSSRC&&t.push({stream_type:Pi.VIDEO,ssrcId:i._videoSSRC}));case Pi.AUDIO:return void(i._audioSSRC&&t.push({stream_type:Pi.AUDIO,ssrcId:i._audioSSRC}))}})),t}withdrawRemoteTracks(e){e.forEach((e=>{let[t,{kind:i}]=e;const n=this.remoteUserMap.get(t);n&&(n.delete(i),0===Array.from(n.entries()).length&&this.remoteUserMap.delete(t))}))}async updateBitrateLimit(e){const t=this.localTrackMap.get(Mi.LocalVideoTrack),i=this.localTrackMap.get(Mi.LocalVideoLowTrack);t&&await t.track.setBitrateLimit(e.uplink),i&&e.low_stream_uplink&&await i.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0})}isP2PDisconnected(){if(this.sendConnection&&this.recvConnection){const e=this.sendConnection.peerConnectionState,t=this.recvConnection.peerConnectionState;return"connected"!==e&&"connected"!==t}return!0}async tryToUnmuteAudio(e){for(let t=0;t<e.length;t++)if(e[t]instanceof qe){const i=this.filterTobeUnmutedTracks(e[t]);if(0===i.length)continue;const n=this.createUnmuteMessage(i);return void await ee(this,Vi.RequestUnmuteLocal,n)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=e=>this.getStats(e),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()).filter((e=>{let[,{ssrcs:t}]=e;return!!t})),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var t;return!(null===(t=this.recvConnection)||void 0===t||!t.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,t)=>this.emit(Vi.RequestUpload,e,t),this.statsUploader.requestUploadStats=e=>this.emit(Vi.RequestUploadStats,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await A(g(this.dtlsFailedCount,X)),this.emit(Vi.RequestReconnect)}async reconnectP2P(){}canPublishLowStream(){return this.localTrackMap.has(Mi.LocalVideoTrack)||this.pendingLocalTracks.some((e=>e instanceof Je))}throwIfTrackTypeNotMatch(e){if(e.filter((e=>e instanceof Je)).length>1)throw new l(h.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter((e=>e instanceof qe)).length>1&&(e.some((e=>e instanceof qe&&e._bypassWebAudio))||!Xe().webAudioMediaStreamDest))throw new l(h.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const t of e){if(t instanceof Je&&this.pendingLocalTracks.some((e=>e instanceof Je)))throw new l(h.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t instanceof qe&&this.pendingLocalTracks.some((e=>e instanceof qe))&&(!Xe().webAudioMediaStreamDest||t._bypassWebAudio||this.pendingLocalTracks.some((e=>e instanceof qe&&e._bypassWebAudio))))throw new l(h.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,t){const i=!E("DISABLE_DUAL_STREAM_USE_ENCODING")&&Xe().supportDualStreamEncoding,n=Xt(Xt({},{width:160,height:120,framerate:15,bitrate:50}),t);let s;s=i?e._mediaStreamTrack.clone():Qs(e,n);const o=O(8,"track-low-"),a=new Je(s,Xt(Xt({},i&&{scaleResolutionDownBy:fn(n,e)}),{},{frameRate:n.framerate,bitrateMax:n.bitrate,bitrateMin:n.bitrate}),void 0,void 0,o);return a.on(dt.TRANSCEIVER_UPDATED,(t=>{e._updateRtpTransceiver(t,lt.LOW_STREAM)})),a._hints.push(ze.LOW_STREAM),e.addListener(rt.NEED_CLOSE,(()=>{a.close()})),a}async globalLock(){return this.recvMutex.lock("From P2PChannel2.globalLock")}reportVideoFirstFrameDecoded(e,t,o,a){const r=Array.from(this.remoteUserMap.keys()).find((t=>t._videoSSRC===e));if(r){a||this.store.subscribe(r.uid,"video",void 0,void 0,void 0,void 0,Date.now());const c=this.store.keyMetrics,d=c.subscribe.find((e=>e.userId===r.uid&&"video"===e.type));i.firstRemoteVideoDecode(this.store.sessionId,n.FIRST_VIDEO_DECODE,s.FIRST_VIDEO_DECODE,{peer:r._uintid,videowidth:t,videoheight:o,subscribeElapse:Ds.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:c.requestAPEnd||0,apStart:c.requestAPStart||0,joinGwEnd:c.joinGatewayEnd||0,joinGwStart:c.joinGatewayStart||0,pcEnd:c.peerConnectionEnd||0,pcStart:c.peerConnectionStart||0,subscriberEnd:(null==d?void 0:d.subscribeEnd)||0,subscriberStart:(null==d?void 0:d.subscribeStart)||0,videoAddNotify:(null==d?void 0:d.streamAdded)||0,state:a?1:0})}}async remoteMediaSsrcChanged(e,t,i){if(!this.recvConnection)return!1;const n=this.remoteUserMap.get(e);if(!n)return!1;const s=n.get(t);if(!s)return!1;const o=await this.recvConnection.getRemoteSSRC(s);return void 0!==o&&o!==i}isPreSubScribe(e){return!1}async publishDataChannel(e){throw new l(h.NOT_SUPPORTED)}async unpublishDataChannel(e){throw new l(h.NOT_SUPPORTED)}async subscribeDataChannel(e,t){throw new l(h.NOT_SUPPORTED)}async unsubscribeDataChannel(e,t){throw new l(h.NOT_SUPPORTED)}hasPendingRemoteDataChannel(e,t){throw new l(h.NOT_SUPPORTED)}setPendingRemoteDataChannel(e,t){throw new l(h.NOT_SUPPORTED)}async preConnect(e){throw new l(h.NOT_SUPPORTED)}getEstablishParams(){throw new l(h.NOT_SUPPORTED)}async reSubscribe(e){throw new l(h.NOT_SUPPORTED)}async updateVideoStreamParameter(e,t){throw new l(h.NOT_SUPPORTED)}unbindRtpTransceiver(){0!==this.localTrackMap.size&&Array.from(this.localTrackMap.entries()).forEach((e=>{let[t,{track:i}]=e;t===Mi.LocalVideoLowTrack?i._updateRtpTransceiver(void 0,lt.LOW_STREAM):i._updateRtpTransceiver(void 0)}))}}).prototype,"p2pConnect",[To],Object.getOwnPropertyDescriptor(Do.prototype,"p2pConnect"),Do.prototype),jt(Do.prototype,"unpublish",[Ro],Object.getOwnPropertyDescriptor(Do.prototype,"unpublish"),Do.prototype),jt(Do.prototype,"unpublishLowStream",[Io],Object.getOwnPropertyDescriptor(Do.prototype,"unpublishLowStream"),Do.prototype),jt(Do.prototype,"subscribe",[go],Object.getOwnPropertyDescriptor(Do.prototype,"subscribe"),Do.prototype),jt(Do.prototype,"mockSubscribe",[Ao],Object.getOwnPropertyDescriptor(Do.prototype,"mockSubscribe"),Do.prototype),jt(Do.prototype,"unsubscribe",[vo],Object.getOwnPropertyDescriptor(Do.prototype,"unsubscribe"),Do.prototype),jt(Do.prototype,"muteRemote",[yo],Object.getOwnPropertyDescriptor(Do.prototype,"muteRemote"),Do.prototype),jt(Do.prototype,"unmuteRemote",[wo],Object.getOwnPropertyDescriptor(Do.prototype,"unmuteRemote"),Do.prototype),jt(Do.prototype,"hasRemoteMediaWithLock",[bo],Object.getOwnPropertyDescriptor(Do.prototype,"hasRemoteMediaWithLock"),Do.prototype),jt(Do.prototype,"disconnectForReconnect",[No],Object.getOwnPropertyDescriptor(Do.prototype,"disconnectForReconnect"),Do.prototype),jt(Do.prototype,"remoteMediaSsrcChanged",[Oo],Object.getOwnPropertyDescriptor(Do.prototype,"remoteMediaSsrcChanged"),Do.prototype),Do);function Lo(e){return function(t,i,n){const s=t[i];if("function"!=typeof s)throw new Error("Cannot use mutex on object property.");return n.value=async function(){for(var t=arguments.length,n=new Array(t),o=0;o<t;o++)n[o]=arguments[o];switch(e){case mo.SEND_ONLY:{const e=await this.sendMutex.lock("From P2PChannel2.".concat(i));try{return await s.apply(this,n)}finally{e()}}case mo.RECEIVE_ONLY:{const e=await this.recvMutex.lock("From P2PChannel2.".concat(i));try{return await s.apply(this,n)}finally{e()}}default:{const e=await this.sendMutex.lock("From P2PChannel2.".concat(i)),t=await this.recvMutex.lock("From P2PChannel2.".concat(i));try{return await s.apply(this,n)}finally{e(),t()}}}},n}}class ko{constructor(e){this.store=void 0,this.onStatsException=void 0,this.onUploadPublishDuration=void 0,this.onStatsChanged=void 0,this.localStats=new Map,this.remoteStats=new Map,this.updateStatsInterval=void 0,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0,this.exceptionMonitor=void 0,this.p2pChannel=void 0,this.scalabilityMode=Zt.L1T1,this.updateStats=()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))},this.store=e,this.exceptionMonitor=new Ns,this.exceptionMonitor.on("exception",((e,t,i)=>{this.onStatsException&&this.onStatsException(e,t,i)}))}startUpdateStats(){this.updateStatsInterval||(this.updateStatsInterval=window.setInterval(this.updateStats,1e3))}stopUpdateStats(){this.updateStatsInterval&&(window.clearInterval(this.updateStatsInterval),this.updateStatsInterval=void 0)}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(Mi.LocalAudioTrack)||Xt({},ht)}getLocalVideoTrackStats(){return this.localStats.get(Mi.LocalVideoTrack)||Xt({},ut)}getRemoteAudioTrackStats(e){const t=(e,t)=>{if(!this.trafficStats)return t;const i=this.trafficStats.peer_delay.find((t=>t.peer_uid===e));return i&&(t.publishDuration=i.B_ppad+(Date.now()-this.trafficStats.timestamp)),t},i={};if(e){var n;const s=null===(n=this.remoteStats.get(e))||void 0===n?void 0:n.audioStats;s&&(i[e]=t(e,s))}else Array.from(this.remoteStats.entries()).forEach((e=>{let[n,{audioStats:s}]=e;s&&(i[n]=t(n,s))}));return i}getRemoteNetworkQualityStats(e){const t={};if(e){var i;const n=null===(i=this.remoteStats.get(e))||void 0===i?void 0:i.networkStats;n&&(t[e]=n)}else Array.from(this.remoteStats.entries()).forEach((e=>{let[i,{networkStats:n}]=e;n&&(t[i]=n)}));return t}getRemoteVideoTrackStats(e){const t=(e,t)=>{if(!this.trafficStats)return t;const i=this.trafficStats.peer_delay.find((t=>t.peer_uid===e));return i&&(t.publishDuration=i.B_ppvd+(Date.now()-this.trafficStats.timestamp)),t},i={};if(e){var n;const s=null===(n=this.remoteStats.get(e))||void 0===n?void 0:n.videoStats;s&&(i[e]=t(e,s))}else Array.from(this.remoteStats.entries()).forEach((e=>{let[n,{videoStats:s}]=e;s&&(i[n]=t(n,s))}));return i}getRTCStats(){let e=0,t=0,i=0,n=0;const s=this.localStats.get(Mi.LocalAudioTrack);s&&(e+=s.sendBytes,t+=s.sendBitrate);const o=this.localStats.get(Mi.LocalVideoTrack);o&&(e+=o.sendBytes,t+=o.sendBitrate);const a=this.localStats.get(Mi.LocalVideoLowTrack);a&&(e+=a.sendBytes,t+=a.sendBitrate),this.remoteStats.forEach((e=>{let{audioStats:t,videoStats:s}=e;t&&(i+=t.receiveBytes,n+=t.receiveBitrate),s&&(i+=s.receiveBytes,n+=s.receiveBitrate)}));let r=1;return this.trafficStats&&(r+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:r,SendBitrate:t,SendBytes:e,RecvBytes:i,RecvBitrate:n,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(e){this.localStats.set(e,void 0)}removeLocalStats(e){e?this.localStats.delete(e):this.localStats.clear()}addRemoteStats(e){this.remoteStats.set(e,{})}removeRemoteStats(e){e?this.remoteStats.delete(e):this.remoteStats.clear()}addP2PChannel(e){this.p2pChannel=e}updateTrafficStats(e){e.peer_delay=e.peer_delay.filter((e=>void 0!==e.B_ppad||void 0!==e.B_ppvd));e.peer_delay.filter((e=>-1===this.trafficStatsPeerList.indexOf(e.peer_uid))).forEach((e=>{var t;const i=null===(t=this.p2pChannel)||void 0===t?void 0:t.getRemoteMedia(e.peer_uid),n=null!=i&&i.videoSSRC?Ds.measureFromSubscribeStart(this.store.clientId,i.videoSSRC):0,s=null!=i&&i.audioSSRC?Ds.measureFromSubscribeStart(this.store.clientId,i.audioSSRC):0;void 0!==e.B_ppad&&void 0!==e.B_ppvd&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(e.peer_uid,e.B_ppad,e.B_ppvd,n>s?n:s),this.trafficStatsPeerList.push(e.peer_uid))})),this.trafficStats=e}updateUplinkStats(e){this.uplinkStats&&this.uplinkStats.B_fir!==e.B_fir&&t.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(e.B_fir)),this.uplinkStats=e}static isRemoteVideoFreeze(e,t,i){if(!e)return!1;const n=!!i&&t.framesDecodeFreezeTime>i.framesDecodeFreezeTime,s=!i||t.framesDecodeCount>i.framesDecodeCount;return n||!s}static isRemoteAudioFreeze(e){return!!e&&e._isFreeze()}isLocalVideoFreeze(e){return!(!e.inputFrame||!e.sentFrame)&&(e.inputFrame.frameRate>5&&e.sentFrame.frameRate<3)}updateLocalStats(e){Array.from(this.localStats.entries()).forEach((i=>{let[n,s]=i;switch(n){case Mi.LocalVideoTrack:case Mi.LocalVideoLowTrack:{const i=s,a=Xt({},ut),r=e.getStats(),c=e.getLocalMedia(n);if(r){const n=r.videoSend.find((e=>e.ssrc===(null==c?void 0:c.ssrcs[0].ssrcId)));if(n){const s=e.getLocalVideoSize(),o=e.getEncoderConfig(Mi.LocalVideoTrack);"H264"!==n.codec&&"H265"!==n.codec&&"VP8"!==n.codec&&"VP9"!==n.codec&&"AV1X"!==n.codec&&"AV1"!==n.codec||(a.codecType=n.codec),a.sendBytes=n.bytes,a.sendBitrate=i?8*Math.max(0,a.sendBytes-i.sendBytes):0,n.inputFrame?(a.captureFrameRate=n.inputFrame.frameRate,a.captureResolutionHeight=n.inputFrame.height,a.captureResolutionWidth=n.inputFrame.width):s&&(a.captureResolutionWidth=s.width,a.captureResolutionHeight=s.height),n.sentFrame?(a.sendFrameRate=n.sentFrame.frameRate,a.sendResolutionHeight=n.sentFrame.height,a.sendResolutionWidth=n.sentFrame.width):s&&(a.sendResolutionWidth=s.width,a.sendResolutionHeight=s.height),n.avgEncodeMs&&(a.encodeDelay=n.avgEncodeMs),o&&o.bitrateMax&&(a.targetSendBitrate=1e3*o.bitrateMax),a.sendPackets=n.packets,a.sendPacketsLost=n.packetsLost,a.sendJitterMs=n.jitterMs,a.sendRttMs=n.rttMs,a.totalDuration=i?i.totalDuration+1:1,a.totalFreezeTime=i?i.totalFreezeTime:0,this.isLocalVideoFreeze(n)&&(a.totalFreezeTime+=1),n.scalabilityMode&&this.scalabilityMode!==n.scalabilityMode&&(t.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(n.scalabilityMode)),this.scalabilityMode=n.scalabilityMode)}this.trafficStats&&(a.currentPacketLossRate=(this.trafficStats.B_pvlr4||0)/100)}var o;if(this.localStats.set(n,a),(null==i?void 0:i.sendResolutionWidth)!==a.sendResolutionWidth||(null==i?void 0:i.sendResolutionHeight)!==a.sendResolutionHeight)null===(o=this.onStatsChanged)||void 0===o||o.call(this,"resolution",{width:a.sendResolutionWidth,height:a.sendResolutionHeight});a&&c&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,c.track,a);break}case Mi.LocalAudioTrack:{const t=s,i=Xt({},ht),o=e.getStats(),a=e.getLocalMedia(n);if(o){const n=o.audioSend.find((e=>e.ssrc===(null==a?void 0:a.ssrcs[0].ssrcId)));if(n){if("opus"!==n.codec&&"aac"!==n.codec&&"PCMU"!==n.codec&&"PCMA"!==n.codec&&"G722"!==n.codec||(i.codecType=n.codec),n.inputLevel)i.sendVolumeLevel=Math.round(32767*n.inputLevel);else{const t=e.getLocalAudioVolume();t&&(i.sendVolumeLevel=Math.round(32767*t))}i.sendBytes=n.bytes,i.sendPackets=n.packets,i.sendPacketsLost=n.packetsLost,i.sendJitterMs=n.jitterMs,i.sendRttMs=n.rttMs,i.sendBitrate=t?8*Math.max(0,i.sendBytes-t.sendBytes):0}}this.trafficStats&&(i.currentPacketLossRate=(this.trafficStats.B_palr4||0)/100),this.localStats.set(Mi.LocalAudioTrack,i),i&&a&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,a.track,i);break}}}))}updateRemoteStats(e){Array.from(this.remoteStats.entries()).forEach((t=>{var i,n;let[s,{videoStats:o,audioStats:a,videoPcStats:r}]=t;const c=a,d=o,l=r,h=Xt({},pt),u=Xt({},_t),p=Xt({},Et),{audioTrack:_,videoTrack:E,audioSSRC:m,videoSSRC:S}=e.getRemoteMedia(s);let f;f=e instanceof Po?e.getStats(!0):e.getStats();const C=null===(i=f)||void 0===i?void 0:i.audioRecv.find((e=>e.ssrc===m)),T=null===(n=f)||void 0===n?void 0:n.videoRecv.find((e=>e.ssrc===S)),R=this.trafficStats&&this.trafficStats.peer_delay.find((e=>e.peer_uid===s));if(C&&("opus"!==C.codec&&"aac"!==C.codec&&"PCMU"!==C.codec&&"PCMA"!==C.codec&&"G722"!==C.codec||(h.codecType=C.codec),C.outputLevel?h.receiveLevel=Math.round(32767*C.outputLevel):_&&(h.receiveLevel=Math.round(32767*_.getVolumeLevel())),h.receiveBytes=C.bytes,h.receivePackets=C.packets,h.receivePacketsLost=C.packetsLost,h.receivePacketsDiscarded=C.packetsDiscarded,h.packetLossRate=h.receivePacketsLost/(h.receivePackets+h.receivePacketsLost),h.receiveBitrate=c?8*Math.max(0,h.receiveBytes-c.receiveBytes):0,h.totalDuration=c?c.totalDuration+1:1,h.totalFreezeTime=c?c.totalFreezeTime:0,h.freezeRate=h.totalFreezeTime/h.totalDuration,h.receiveDelay=C.jitterBufferMs,h.totalDuration>10&&ko.isRemoteAudioFreeze(_)&&(h.totalFreezeTime+=1)),T){"H264"!==T.codec&&"H265"!==T.codec&&"VP8"!==T.codec&&"VP9"!==T.codec&&"AV1X"!==T.codec&&"AV1"!==T.codec||(u.codecType=T.codec),u.receiveBytes=T.bytes,u.receiveBitrate=d?8*Math.max(0,u.receiveBytes-d.receiveBytes):0,u.decodeFrameRate=T.decodeFrameRate<0?0:T.decodeFrameRate,u.renderFrameRate=T.decodeFrameRate<0?0:T.decodeFrameRate,T.outputFrame&&(u.renderFrameRate=T.outputFrame.frameRate),T.receivedFrame?(u.receiveFrameRate=T.receivedFrame.frameRate,u.receiveResolutionHeight=T.receivedFrame.height,u.receiveResolutionWidth=T.receivedFrame.width):E&&(u.receiveResolutionHeight=E._videoHeight||0,u.receiveResolutionWidth=E._videoWidth||0),void 0!==T.framesRateFirefox&&(u.receiveFrameRate=Math.round(T.framesRateFirefox)),u.receivePackets=T.packets,u.receivePacketsLost=T.packetsLost,u.packetLossRate=u.receivePacketsLost/(u.receivePackets+u.receivePacketsLost),u.totalDuration=d?d.totalDuration+1:1,u.totalFreezeTime=d?d.totalFreezeTime:0,u.receiveDelay=T.jitterBufferMs||0;const t=!!S&&e.getRemoteVideoIsReady(S);E&&t&&ko.isRemoteVideoFreeze(E,T,l)&&(u.totalFreezeTime+=1),u.freezeRate=u.totalFreezeTime/u.totalDuration}R&&(h.end2EndDelay=R.B_ad,u.end2EndDelay=R.B_vd,h.transportDelay=R.B_ed,u.transportDelay=R.B_ed,h.currentPacketLossRate=R.B_ealr4/100,u.currentPacketLossRate=R.B_evlr4/100,p.uplinkNetworkQuality=R.B_punq?R.B_punq:0,p.downlinkNetworkQuality=R.B_pdnq?R.B_pdnq:0),this.remoteStats.set(s,{audioStats:h,videoStats:u,videoPcStats:T,networkStats:p}),_&&this.exceptionMonitor.setRemoteAudioStats(_,h),E&&this.exceptionMonitor.setRemoteVideoStats(E,u)}))}}class Mo{constructor(){this.destChannelMediaInfos=new Map,this.srcChannelMediaInfo=void 0}setSrcChannelInfo(e){Si(e),this.srcChannelMediaInfo=e}addDestChannelInfo(e){Si(e),this.destChannelMediaInfos.set(e.channelName,e)}removeDestChannelInfo(e){pi(e),this.destChannelMediaInfos.delete(e)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function Uo(e){if(!(e instanceof Mo)){return new ui(h.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw()}const t=e.getSrcChannelMediaInfo(),i=e.getDestChannelMediaInfo();if(!t){return new ui(h.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw()}if(0===i.size){return new ui(h.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw()}}var Vo;let xo=(Vo=class e extends Di{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>Object.keys(ie).includes(e))))]}constructor(t,i){super(t,i),this.store=void 0,this.peerConnection=void 0,this.remoteSDP=void 0,this.initialOffer=void 0,this.statsFilter=void 0,this.useRTX=!1,this.localCapabilities=void 0,this.localCandidateCount=0,this.allCandidatesReceived=!1,this.establishPromise=void 0,this.mutex=new C("P2PConnection-mutex"),this.store=i,this.peerConnection=new RTCPeerConnection(e.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.statsFilter=Ks(this.peerConnection,E("STATS_UPDATE_INTERVAL"),void 0,f()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{const e=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const t=yn(e.sdp),i=vn(e.sdp,{filterRTX:!this.useRTX,filterVideoFec:E("FILTER_VIDEO_FEC"),filterAudioFec:E("FILTER_AUDIO_FEC"),filterAudioCodec:["opus"]});return this.localCapabilities=i,this.initialOffer=e,Xt(Xt({},t),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:i},offerSDP:e.sdp})}catch(e){throw new l(h.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async updateRemoteConnect(){}async connect(e){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{constructor(e){this.sessionDesc=void 0,this.localCapabilities=void 0,this.rtpCapabilities=void 0,this.candidates=void 0,this.iceParameters=void 0,this.dtlsParameters=void 0,this.setup=void 0,this.currentMidIndex=void 0,this.cname=void 0,e=M(e);const{iceParameters:t,dtlsParameters:i,candidates:n,rtpCapabilities:s,setup:o,localCapabilities:a,sdkCodec:r,cname:c}=e,d=gn.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE audio video\na=msid-semantic: WMS\na=ice-lite\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendrecv\na=rtcp-mux\na=rtcp-rsize\na=mid:audio\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendrecv\na=rtcp-mux\na=rtcp-rsize\na=mid:video\n");this.rtpCapabilities=s,this.candidates=n,this.iceParameters=t,this.dtlsParameters=i,this.setup=o,this.localCapabilities=a,this.cname=c;for(let e=0;e<d.mediaDescriptions.length;e++){const a=d.mediaDescriptions[e];if(a.attributes.iceUfrag=t.iceUfrag,a.attributes.icePwd=t.icePwd,a.attributes.fingerprints=i.fingerprints,a.attributes.candidates=n,a.attributes.setup=o,"video"===a.media.mediaType){a.media.fmts=s.videoCodecs.map((e=>e.payloadType.toString(10)));let e=s.videoCodecs.filter((e=>{var t;return null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase().includes(r)}));0===e.length&&(e=s.videoCodecs),a.attributes.payloads=e,a.attributes.extmaps=s.videoExtensions}"audio"===a.media.mediaType&&(a.media.fmts=s.audioCodecs.map((e=>e.payloadType.toString(10))),a.attributes.payloads=s.audioCodecs,a.attributes.extmaps=s.audioExtensions),d.mediaDescriptions[e]=this.mungMediaDesc(a)}this.sessionDesc=d,this.currentMidIndex=d.mediaDescriptions.length-1}toString(){return gn.print(this.sessionDesc)}send(e,t,i){const{ssrcs:n,ssrcGroups:s}=On(t,this.cname),o=this.sessionDesc.mediaDescriptions.find((t=>e===Pi.VIDEO?"video"===t.media.mediaType:"audio"===t.media.mediaType)),a=n[0].attributes.label,r=n[0].attributes.mslabel;return o.attributes.ssrcs=o.attributes.ssrcs.concat(n),o.attributes.ssrcGroups=o.attributes.ssrcGroups.concat(s),{id:a,mslabel:r}}batchSend(e){return e.map((e=>{let{kind:t,ssrcMsg:i}=e;return this.send(t,i,void 0)}))}stopSending(e){this.sessionDesc.mediaDescriptions.forEach((t=>{const i=[],n=[],s=[];t.attributes.ssrcs.forEach((t=>{e.includes(t.attributes.label||"")?s.push(t):i.push(t)})),t.attributes.ssrcGroups.forEach((e=>{s.map((e=>e.ssrcId)).includes(e.ssrcIds[0])||n.push(e)})),t.attributes.ssrcs=i,t.attributes.ssrcGroups=n}))}mute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}receive(e,t,i){e.forEach(((e,t)=>{const i=e._mediaStreamTrack,n=this.sessionDesc.mediaDescriptions.findIndex((e=>e.attributes.mid===i.kind)),s=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],e);this.sessionDesc.mediaDescriptions[n]=s}))}stopReceiving(e){}updateCandidates(e){e===Li.TCP?this.candidates.forEach((e=>{-1===this.candidates.findIndex((t=>"tcp"===t.transport&&t.connectionAddress===e.connectionAddress&&t.port===e.port))&&this.candidates.push(Xt(Xt({},e),{},{foundation:"tcpcandidate",priority:Number(e.priority)-1+"",transport:"tcp",port:Number(e.port)+90+""}))})):this.candidates=this.candidates.filter((e=>"tcp"!==e.transport));for(const e of this.sessionDesc.mediaDescriptions)e.attributes.candidates=this.candidates}restartICE(e){e=M(e),this.iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}predictReceivingMids(e){const t=[];for(let i=0;i<e;i++)t.push((this.currentMidIndex+i+1).toString(10));return t}mungRecvMediaDsec(e,t){const i=M(e);return Dn(i,t),Ln(i,t),i}updateRecvMedia(e,t){const i=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==i){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],t);this.sessionDesc.mediaDescriptions[i]=e}}bumpMid(e){this.currentMidIndex+=e}updateTrackLabel(e,t,i){const n=this.sessionDesc.mediaDescriptions.find((t=>e===Pi.VIDEO?"video"===t.attributes.mid:"audio"===t.attributes.mid));if(n){const e=n.attributes.ssrcs.find((e=>e.attributes.label===t));var s;e&&(e.attributes.label=i,null===(s=e.attributes.msid)||void 0===s||s.replace(t,i))}}mungMediaDesc(e){const t=M(e);return Pn(t),function(e){const t=e.attributes.extmaps.find((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName));t&&e.attributes.extmaps.splice(e.attributes.extmaps.indexOf(t),1),e.attributes.payloads.forEach((e=>{const t=e.rtcpFeedbacks.findIndex((e=>"transport-cc"===e.type));-1!==t&&e.rtcpFeedbacks.splice(t,1)}))}(t),t}getSSRC(e){for(const t of this.sessionDesc.mediaDescriptions)for(const i of t.attributes.ssrcs)if(i.attributes.label===e)return[i]}}(Xt(Xt({},e),{},{rtpCapabilities:e.rtpCapabilities.send,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec}));const t=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:t})}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(e.toString()))}}async updateRemoteRTPCapabilities(e,t){throw new l(h.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}getPreMedia(e){}send(e,t){var i=this;return zt((function*(){const n=yield Yt(i.mutex.lock());try{if(!i.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const s=e.map((e=>i.peerConnection.addTrack(e._mediaStreamTrack))),o=yield Yt(i.peerConnection.createOffer()),a=gn.parse(o.sdp),r=e.map((e=>{const t=e._mediaStreamTrack,n=a.mediaDescriptions.find((e=>e.attributes.mid===t.kind));if(!n)throw new Error("Cannot extract ssrc from mediaDescription.");return function(e,t,i){const n=e.attributes.ssrcs.filter((e=>e.attributes.label===t)),s=e.attributes.ssrcGroups;if(0===n.length)throw new Error("Cannot extract ssrc from plan-b SDP.");if(s&&n.length>1){const e=s.find((e=>-1!==e.ssrcIds.indexOf(n[0].ssrcId)));return e?[{ssrcId:e.ssrcIds[0],rtx:i?e.ssrcIds[1]:void 0}]:[{ssrcId:n[0].ssrcId}]}return[{ssrcId:n[0].ssrcId}]}(n,t.id,i.useRTX)}));let c;try{c=yield r}catch(e){throw s.forEach((e=>{ne()&&e.replaceTrack(null),i.peerConnection.removeTrack(e)})),e}const d=i.mungSendOfferSDP(o.sdp,e);i.remoteSDP.receive(e,t,c);const l=i.remoteSDP.toString();return yield Yt(i.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield Yt(i.applySendEncodings(s,e)),yield Yt(i.peerConnection.setRemoteDescription({type:"answer",sdp:l})),e.map(((e,t)=>{const i=e._mediaStreamTrack.id;return{localSSRC:r[t],id:i}}))}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(e.toString()))}finally{n()}}))()}async stopSending(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const t=this.peerConnection.getSenders().filter((t=>{var i;return-1!==e.indexOf((null===(i=t.track)||void 0===i?void 0:i.id)||"")}));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");t.map((e=>{ne()&&e.replaceTrack(null),this.peerConnection.removeTrack(e)}));const i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i),this.remoteSDP.stopReceiving(e);const n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(e.toString()))}}async receive(e,t,i,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{id:i,mslabel:s}=this.remoteSDP.send(e,t,n),o=new Promise(((t,n)=>{const o=setTimeout((()=>{n(new Error("Cannot receive track, id: ".concat(i)))}),1e4),a=n=>{const r=U();if(("Safari"===r.name&&11===Number(r.version)||se())&&n.track.id!==i&&n.streams[0].id===s){var c;const s=n.streams[0].getTracks()[0];return null===(c=this.remoteSDP)||void 0===c||c.updateTrackLabel(e,i,n.track.id),this.peerConnection.removeEventListener("track",a),clearTimeout(o),void t(s)}if(n.track.id===i)return this.peerConnection.removeEventListener("track",a),clearTimeout(o),void t(n.track)};this.peerConnection.addEventListener("track",a)})),a=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:a});const r=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(r);return{track:await o,id:i}}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(i)}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}async muteRemote(e){}async unmuteRemote(e){}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getSenders().filter((t=>{var i;return-1!==e.indexOf((null===(i=t.track)||void 0===i?void 0:i.id)||"")}));if(t.length!==e.length)throw new Error("sender' length doesn't match mids' length.");t.map((e=>{if(ne()&&e.track)e.track.enabled=!1;else{const t=e.getParameters();t.encodings.forEach((e=>e.active=!1)),e.setParameters(t)}}))}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getSenders().filter((t=>{var i;return-1!==e.indexOf((null===(i=t.track)||void 0===i?void 0:i.id)||"")}));if(t.length!==e.length)throw new Error("Senders' length doesn't match mids' length.");t.map((async e=>{if(ne()&&e.track)e.track.enabled=!0;else{const t=e.getParameters();t.encodings.forEach((e=>e.active=!0)),await e.setParameters(t)}}));const i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i);const n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(e.toString()))}}restartICE(e){var i=this;return zt((function*(){const n=yield Yt(i.mutex.lock("From P2PConnection.restartICE"));try{if(!i.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(Xe().supportPCSetConfiguration){const n=i.peerConnection.getConfiguration(),s=e===Li.RELAY?"relay":"all";n.iceTransportPolicy!==s&&(t.debug("[".concat(i.store.clientId,"] restartICE change iceTransportPolicy from [").concat(n.iceTransportPolicy,"] to [").concat(s,"]")),n.iceTransportPolicy=s,i.peerConnection.setConfiguration(n))}else if(e===Li.RELAY)return;e!==Li.RELAY&&i.remoteSDP.updateCandidates(e);const s=yield Yt(i.peerConnection.createOffer({iceRestart:!0}));if(!s.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const o=yn(s.sdp),{remoteIceParameters:a}=yield o.iceParameters;i.remoteSDP.restartICE(a);const r=i.remoteSDP.toString();yield Yt(i.peerConnection.setLocalDescription(s)),yield Yt(i.peerConnection.setRemoteDescription({type:"answer",sdp:r}))}catch(e){t.warning("[".concat(i.store.clientId,"] restart ICE failed, abort operation"),e)}finally{n()}}))()}close(){var e;this.peerConnection.close(),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const e=await this.peerConnection.createOffer(),i=this.mungSendOfferSDP(e.sdp,[t]);this.remoteSDP.updateRecvMedia(t._mediaStreamTrack.kind,t);const n=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const i=this.peerConnection.getSenders().filter((t=>{var i;return(null===(i=t.track)||void 0===i?void 0:i.id)===e}));1===i.length&&await this.applySendEncodings(i,[t])}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const i=this.peerConnection.getSenders().find((e=>{var i;return(null===(i=e.track)||void 0===i?void 0:i.id)===t}));i&&await i.replaceTrack(e._mediaStreamTrack)}createDataChannels(e,t){throw new l(h.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}stopDataChannels(e){throw new l(h.NOT_SUPPORTED,"Planb mode does not support stopDataChannels.")}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,t.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,t.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),E("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const i={iceServers:[],sdpSemantics:"plan-b"};return t.iceServers?i.iceServers=t.iceServers:t.turnServer&&"off"!==t.turnServer.mode&&(Z(t.turnServer.servers)?i.iceServers=t.turnServer.servers:(i.iceServers&&i.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.servers)),E("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&t.turnServer.serversFromGateway&&i.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(i.iceTransportPolicy="relay")})))),i}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}async updateRtpSenderEncodings(e,i){var n;if(!i){i=this.peerConnection.getSenders().find((t=>{var i;return(null===(i=t.track)||void 0===i?void 0:i.id)===e._mediaStreamTrack.id}))}if(!i)return t.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(!Xe().supportSetRtpSenderParameters)return t.warn("Browser not support set rtp-sender parameters");const s={},o={};if(e instanceof Je)switch(e._optimizationMode){case"motion":s.degradationPreference="maintain-framerate";break;case"detail":s.degradationPreference="maintain-resolution";break;default:s.degradationPreference="balanced"}if(E("DSCP_TYPE")&&$()){const e=E("DSCP_TYPE");["very-low","low","medium","high"].includes(e)&&(o.networkPriority=e)}const a=i.getParameters(),r=null===(n=a.encodings)||void 0===n?void 0:n[0];r&&Object.assign(r,o),Object.assign(a,s),t.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(a.encodings))),await i.setParameters(a)}async applySendEncodings(e,i){try{if(!Xe().supportSetRtpSenderParameters)return;if(e.length!==i.length)return;for(let t=0;t<e.length;t++){const n=e[t],s=i[t];n&&s&&await this.updateRtpSenderEncodings(s,n)}}catch(e){t.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,t){const i=gn.parse(e);return t.forEach(((e,t)=>{const n=e._mediaStreamTrack,s=i.mediaDescriptions.find((e=>e.attributes.mid===n.kind));s&&Dn(s,e)})),gn.print(i)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,i)=>{var n;null===(n=this.onFirstVideoDecoded)||void 0===n||n.call(this,e,t,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedLocalCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i||i.call(this,e,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const t=this.remoteSDP.batchSend(e).map(((t,i)=>{let{id:n,mslabel:s}=t;const{kind:o}=e[i];return new Promise(((e,t)=>{const i=setTimeout((()=>{t(new Error("Cannot receive track, id: ".concat(n)))}),1e4),a=t=>{const r=U();if("Safari"===r.name&&11===Number(r.version)&&t.track.id!==n&&t.streams[0].id===s){var c;const s=t.streams[0].getTracks()[0];return null===(c=this.remoteSDP)||void 0===c||c.updateTrackLabel(o,n,t.track.id),this.peerConnection.removeEventListener("track",a),clearTimeout(i),void e({track:s,id:n})}if(t.track.id===n)return this.peerConnection.removeEventListener("track",a),clearTimeout(i),void e({track:t.track,id:n})};this.peerConnection.addEventListener("track",a)}))})),i=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const n=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(n),await Promise.all(t)}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async getRemoteSSRC(e){if(!this.remoteSDP)return;const t=this.remoteSDP.getSSRC(e);return null==t?void 0:t[0].ssrcId}setConfiguration(t){if(Xe().supportPCSetConfiguration){const i=e.resolvePCConfiguration(t);this.peerConnection.setConfiguration(i)}}},jt(Vo.prototype,"connect",[Fo],Object.getOwnPropertyDescriptor(Vo.prototype,"connect"),Vo.prototype),jt(Vo.prototype,"stopSending",[Fo],Object.getOwnPropertyDescriptor(Vo.prototype,"stopSending"),Vo.prototype),jt(Vo.prototype,"receive",[Fo],Object.getOwnPropertyDescriptor(Vo.prototype,"receive"),Vo.prototype),jt(Vo.prototype,"stopReceiving",[Fo],Object.getOwnPropertyDescriptor(Vo.prototype,"stopReceiving"),Vo.prototype),jt(Vo.prototype,"muteRemote",[Fo],Object.getOwnPropertyDescriptor(Vo.prototype,"muteRemote"),Vo.prototype),jt(Vo.prototype,"unmuteRemote",[Fo],Object.getOwnPropertyDescriptor(Vo.prototype,"unmuteRemote"),Vo.prototype),jt(Vo.prototype,"muteLocal",[Fo],Object.getOwnPropertyDescriptor(Vo.prototype,"muteLocal"),Vo.prototype),jt(Vo.prototype,"unmuteLocal",[Fo],Object.getOwnPropertyDescriptor(Vo.prototype,"unmuteLocal"),Vo.prototype),jt(Vo.prototype,"close",[Fo],Object.getOwnPropertyDescriptor(Vo.prototype,"close"),Vo.prototype),jt(Vo.prototype,"updateEncoderConfig",[Fo],Object.getOwnPropertyDescriptor(Vo.prototype,"updateEncoderConfig"),Vo.prototype),jt(Vo.prototype,"updateSendParameters",[Fo],Object.getOwnPropertyDescriptor(Vo.prototype,"updateSendParameters"),Vo.prototype),jt(Vo.prototype,"replaceTrack",[Fo],Object.getOwnPropertyDescriptor(Vo.prototype,"replaceTrack"),Vo.prototype),jt(Vo.prototype,"getRemoteSSRC",[Fo],Object.getOwnPropertyDescriptor(Vo.prototype,"getRemoteSSRC"),Vo.prototype),Vo);function Fo(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("Locking from P2PConnection.".concat(t));try{for(var s=arguments.length,o=new Array(s),a=0;a<s;a++)o[a]=arguments[a];return await n.apply(this,o)}finally{i()}},i}const Bo="9",Go=4e4;class jo{get localCapabilities(){return M(this._localCapabilities)}get rtpCapabilities(){return M(this._rtpCapabilities)}get candidates(){return M(this._candidates)}get iceParameters(){return M(this._iceParameters)}get dtlsParameters(){return M(this._dtlsParameters)}constructor(e){this.sessionDesc=void 0,this._localCapabilities=void 0,this._rtpCapabilities=void 0,this._candidates=void 0,this._iceParameters=void 0,this._dtlsParameters=void 0,this.setup=void 0,this.currentMidIndex=void 0,this.cname=void 0,this.firefoxSsrcMidMap=new Map,e=M(e);const{iceParameters:t,dtlsParameters:i,candidates:n,rtpCapabilities:s,setup:o,localCapabilities:a,cname:r}=e;this._rtpCapabilities=s,this._candidates=n,this._iceParameters=t,this._dtlsParameters=i,this._localCapabilities=a,this.setup=o,this.cname=r,this.sessionDesc=this.updateRemoteRTPCapabilities(s),this.currentMidIndex=this.sessionDesc.mediaDescriptions.length-1}preloadRemoteMedia(e){const t=this.candidates,i=this.dtlsParameters,n=this.iceParameters,s=this.rtpCapabilities.send;let o=this.sessionDesc.mediaDescriptions.length-1;for(let a=1;a<e;a++){const e=2*a+2e4,r=2*a+Go,{ssrcs:c,ssrcGroups:d}=On([{ssrcId:e}],this.cname),{ssrcs:l,ssrcGroups:h}=On([{ssrcId:r,rtx:E("USE_SUB_RTX")?r+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:Bo,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.videoCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:t,extmaps:s.videoExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:l,ssrcGroups:h,rtcpFeedbackWildcards:[],payloads:s.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(++o)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:Bo,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.audioCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:t,extmaps:s.audioExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:c,ssrcGroups:d,rtcpFeedbackWildcards:[],payloads:s.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(++o)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return gn.print(this.sessionDesc)}send(e,t,i,n){const{ssrcs:s,ssrcGroups:o}=On(t,this.cname,E("SYNC_GROUP")?i:void 0),a=this.findPreloadMediaDesc(s);if(a){if(f()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,a.attributes.mid),n&&(n.twcc||n.remb)){const e=this.sessionDesc.mediaDescriptions.indexOf(a);return this.sessionDesc.mediaDescriptions[e]=this.mungSendMediaDesc(a,n),{mid:a.attributes.mid,needExchangeSDP:!0}}return{mid:a.attributes.mid,needExchangeSDP:!1}}{const t=this.findAvailableMediaIndex(e,s);let i;return-1===t||1===t&&(ne()||oe())||0===t&&E("USE_SUB_RTX")||ae()?(i=this.createOrRecycleSendMedia(e,s,o,"sendonly",n),this.updateBundleMids()):(i=M(this.sessionDesc.mediaDescriptions[t]),i.attributes.direction="sendonly",i.attributes.ssrcs=s,i.attributes.ssrcGroups=o,this.sessionDesc.mediaDescriptions[t]=this.mungSendMediaDesc(i,n)),f()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,i.attributes.mid),{mid:i.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){const{mediaDesc:e,needExchangeSDP:t}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:e.attributes.mid,needExchangeSDP:t}}batchSend(e){const t=e.map((e=>{let{kind:t,ssrcMsg:i,mslabel:n}=e;return this.send(t,i,n)})),i=[];let n=!1;return t.forEach((e=>{let{mid:t,needExchangeSDP:s}=e;s&&(n=!0),i.push(t)})),{mids:i,needExchangeSDP:n}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach((e=>{"0"===e.attributes.mid||f()||ae()?e.attributes.ssrcs=[]:(e.attributes.ssrcs=[],e.attributes.direction="inactive",e.media.port="0")})),this.updateBundleMids()}mute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>e.includes(t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="inactive"}))}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>e.includes(t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="recvonly"}))}receive(e,t,i,n){e.forEach(((e,s)=>{this.createOrRecycleRecvMedia(e,[],"recvonly",t,i,n[s])})),this.updateBundleMids()}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach((e=>{e.media.port="0",e.attributes.direction="inactive"})),this.updateBundleMids()}updateRemoteRTPCapabilities(e){const t=this.sessionDesc||gn.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=ice-lite\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n");this._rtpCapabilities=e;const i=this.rtpCapabilities.send,n=this.localCapabilities.send;for(const e of t.mediaDescriptions){if(e.attributes.iceUfrag=this._iceParameters.iceUfrag,e.attributes.icePwd=this._iceParameters.icePwd,e.attributes.fingerprints=this._dtlsParameters.fingerprints,e.attributes.candidates=this._candidates,e.attributes.setup=this.setup,"application"===e.media.mediaType&&(e.attributes.sctpPort="5000"),"video"===e.media.mediaType)if(0===i.videoCodecs.length){const t=n.videoCodecs.filter((e=>{var t;return null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase().includes("vp8")}))||[n.videoCodecs[0]];e.media.fmts=t.map((e=>e.payloadType.toString(10))),e.attributes.payloads=t,e.attributes.extmaps=[]}else if(e.media.fmts=i.videoCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=i.videoCodecs,e.attributes.extmaps=i.videoExtensions,E("PRELOAD_MEDIA_COUNT")>0){const{ssrcs:t,ssrcGroups:i}=On([{ssrcId:Go,rtx:E("USE_SUB_RTX")?40001:void 0}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}if("audio"===e.media.mediaType)if(0===i.audioCodecs.length){const t=n.audioCodecs.filter((e=>{var t;return null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase().includes("opus")}))||[n.audioCodecs[0]];e.media.fmts=t.map((e=>e.payloadType.toString(10))),e.attributes.payloads=t,e.attributes.extmaps=[]}else if(e.media.fmts=i.audioCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=i.audioCodecs,e.attributes.extmaps=i.audioExtensions,Gn(e),E("PRELOAD_MEDIA_COUNT")>0){const{ssrcs:t,ssrcGroups:i}=On([{ssrcId:2e4}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}}return this.sessionDesc=t,this.currentMidIndex=t.mediaDescriptions.length-1,this.sessionDesc}updateCandidates(e){const t=this._candidates.filter((e=>"udp"===e.transport));if(e===Li.TCP){if(0===t.length)return;if(E("TCP_CANDIDATE_ONLY")){const e=this._candidates.filter((e=>"tcp"===e.transport));t.forEach((t=>{-1===e.findIndex((e=>e.connectionAddress===t.connectionAddress))&&e.push(Xt(Xt({},t),{},{foundation:"tcpcandidate",priority:Number(t.priority)-1+"",transport:"tcp",port:Number(t.port)+90+""}))})),this._candidates=e}else{const e=[];t.forEach((t=>{e.push(Xt(Xt({},t),{},{foundation:"tcpcandidate",priority:Number(t.priority)-1+"",transport:"tcp",port:Number(t.port)+90+""}))})),this._candidates=[...t,...e]}}else if(e===Li.RELAY){if(0!==t.length)return;{const e=this._candidates.filter((e=>"tcp"===e.transport));e.forEach((e=>{t.push(Xt(Xt({},e),{},{foundation:"udpcandidate",priority:Number(e.priority)+1+"",transport:"udp",port:Number(e.port)-90+""}))})),this._candidates=[...t,...e]}}else if(0===t.length){this._candidates.filter((e=>"tcp"===e.transport)).forEach((e=>{t.push(Xt(Xt({},e),{},{foundation:"udpcandidate",priority:Number(e.priority)+1+"",transport:"udp",port:Number(e.port)-90+""}))})),this._candidates=t}else this._candidates=this._candidates.filter((e=>"tcp"!==e.transport));for(const e of this.sessionDesc.mediaDescriptions)e.attributes.candidates=this.candidates}restartICE(e){e=M(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}predictReceivingMids(e){const t=[];for(let i=0;i<e;i++)t.push((this.currentMidIndex+i+1).toString(10));return t}findAvailableMediaIndex(e,t){return this.sessionDesc.mediaDescriptions.findIndex((i=>{const n=i.media.mediaType===e&&"0"!==i.media.port&&("sendonly"===i.attributes.direction||"sendrecv"===i.attributes.direction)&&0===i.attributes.ssrcs.length;if(f()){if(n){const e=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(e||"0"!==i.attributes.mid&&"1"!==i.attributes.mid)||!(!e||e!==i.attributes.mid)}return!1}return n}))}createOrRecycleDataChannel(){for(const e of this.sessionDesc.mediaDescriptions)if("application"===e.media.mediaType)return{mediaDesc:e,needExchangeSDP:!1};this.currentMidIndex+=1;const e="".concat(this.currentMidIndex),t={media:{mediaType:"application",port:Bo,protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(e),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(t),{mediaDesc:t,needExchangeSDP:!0}}createOrRecycleRecvMedia(e,t,i,n,s,o){const a=e._mediaStreamTrack.kind,r=this.rtpCapabilities.recv,c=jn(a,r,this.localCapabilities.send,a===Pi.VIDEO?n:s),d=a===Pi.VIDEO?r.videoExtensions:r.audioExtensions;this.currentMidIndex+=1;const l="".concat(this.currentMidIndex);let h={media:{mediaType:a,port:Bo,protos:["UDP","TLS","RTP","SAVPF"],fmts:c.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:d,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:c,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(l)}};h=this.mungRecvMediaDsec(h,e,o);const u=this.findFirstClosedMedia(a);if(u){const e=this.sessionDesc.mediaDescriptions.indexOf(u);this.sessionDesc.mediaDescriptions[e]=h}else this.sessionDesc.mediaDescriptions.push(h);return h}updateRemoteCodec(e,i,n){const s=[...new Set(this._rtpCapabilities.recv.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>Object.keys(ie).includes(e))))],o=new Set(i);if(s.every((e=>o.has(e))))return t.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(i)),!1;const a=this._rtpCapabilities.recv.videoCodecs.filter((e=>i.some((t=>(e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").includes(t)))));if(0===a.length)return t.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(s," codecs: ").concat(i)),!1;const r=[...new Set(a.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")))];let c;if(t.debug("updateRemoteCodec, from ".concat(s," to ").concat(r)),0===e.length)c=this.sessionDesc.mediaDescriptions.filter((e=>"video"===e.media.mediaType&&"recvonly"===e.attributes.direction));else if(c=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&e.includes(t.attributes.mid)&&"recvonly"===t.attributes.direction)),c.length!==e.length)return t.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(e,", codecs: ").concat(i)),!1;if(E("USE_PUB_RTX")||E("USE_SUB_RTX")){const e=Wn(a,this.rtpCapabilities.recv.videoCodecs);a.push(...e)}this._rtpCapabilities.recv.videoCodecs=a;const d=this.localCapabilities.send,l=this.rtpCapabilities.recv,h=jn(Pi.VIDEO,l,d,n);return c.forEach((e=>{const i=h.map((e=>e.payloadType.toString(10)));t.debug("updateRemoteCodec mid: ".concat(e.attributes.mid,", from ").concat(e.attributes.payloads," to ").concat(h)),e.attributes.payloads=h,e.media.fmts=i})),!0}createOrRecycleSendMedia(e,t,i,n,s){const o=this.rtpCapabilities.send,a=e===Pi.VIDEO?o.videoCodecs:o.audioCodecs,r=e===Pi.VIDEO?o.videoExtensions:o.audioExtensions;this.currentMidIndex+=1;const c="".concat(this.currentMidIndex);let d={media:{mediaType:e,port:Bo,protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:r,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(c)}};d=this.mungSendMediaDesc(d,s);const l=this.findFirstClosedMedia(e);if(l){const e=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[e]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((e=>"0"!==e.media.port)).map((e=>e.attributes.mid))}mungRecvMediaDsec(e,t,i){const n=M(e);return Pn(n),Dn(n,t),Ln(n,t),kn(n),Mn(n,i,this.localCapabilities.send),n}mungSendMediaDesc(e,t){const i=M(e);return Mn(i,t,this.localCapabilities.recv),Gn(i),i}updateRecvMedia(e,t){const i=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==i){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],t);this.sessionDesc.mediaDescriptions[i]=e}}bumpMid(e){this.currentMidIndex+=e}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find((t=>f()?"0"===t.media.port&&t.media.mediaType===e:"0"===t.media.port))}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find((t=>{var i;return(null===(i=t.attributes)||void 0===i||null===(i=i.ssrcs[0])||void 0===i?void 0:i.ssrcId)===e[0].ssrcId}))}getSSRC(e){var t;return null===(t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e)))||void 0===t?void 0:t.attributes.ssrcs}}let Wo=function(e){return e.BANDWIDTH="bandwidth",e.CPU="cpu",e.NONE="none",e.OTHER="other",e}({});var Ho=function(e){return e[e.DOWN=0]="DOWN",e[e.UP=1]="UP",e}(Ho||{});const Ko=new Map;function Yo(e,t,i,n){let{scale:s}=e;if(0===s&&n===Ho.UP||s>=t.length-1&&n===Ho.DOWN)return e;let o=Xt(Xt({},e),{},{scale:n===Ho.DOWN?++s:--s});switch(i){case"maintain-framerate":o=Xt(Xt({},o),t[s].motion);break;case"maintain-resolution":o=Xt(Xt({},o),t[s].detail);break;case"balanced":o=Xt(Xt({},o),t[s].balanced)}return o}function qo(e,t){if(t){const i={overUse:0,underUse:0,adaptationList:Jo(t)};Ko.set(e,i)}else Ko.delete(e)}function Jo(e){const t=Xt({},e),{bitrateMax:i,frameRate:n,scaleResolutionDownBy:s,bitrateMin:o}=t,{MIN_FRAME_RATE:a,MAX_THRESHOLD_FRAMERATE:r,MAX_SCALE:c,BITRATE_MIN_THRESHOLD:d,BITRATE_MAX_THRESHOLD:l,BWE_SCALE_UP_THRESHOLD:h,BWE_SCALE_DOWN_THRESHOLD:u,PERF_SCALE_DOWN_THRESHOLD:p,PERF_SCALE_UP_THRESHOLD:_,BALANCE_BITRATE_FACTOR:E,BALANCE_FRAMERATE_FACTOR:m,BALANCE_RESOLUTION_FACTOR:S,MOTION_RESOLUTION_FACTOR:f,MOTION_BITRATE_FACTOR:C,DETAIL_FRAMERATE_FACTOR:T,DETAIL_BITRATE_FACTOR:R}=re,I=Math.min(t.frameRate,r),g=[{scale:0,threshold:{bwe_down:Math.round(Math.pow(u,1)*i),bwe_up:i,fps_down:Math.round(Math.pow(p,1)*I),fps_up:n},balanced:{scaleResolutionDownBy:1,frameRate:n,bitrateMax:i,bitrateMin:o},motion:{scaleResolutionDownBy:1,frameRate:n,bitrateMax:i,bitrateMin:o},detail:{scaleResolutionDownBy:1,frameRate:n,bitrateMax:i,bitrateMin:o}}];for(let e=1;e<=c;e++){const t={bwe_up:Math.round(Math.pow(h,e)*i),bwe_down:Math.round(Math.pow(u,e+1)*i),fps_up:Math.round(Math.pow(_,e)*I),fps_down:Math.round(Math.pow(p,e+1)*I)},r={scaleResolutionDownBy:s/Math.pow(S,e),frameRate:Math.max(Math.round(Math.pow(m,e)*n),a),bitrateMax:Math.max(Math.round(Math.pow(E,e)*i),l),bitrateMin:Math.max(Math.round(Math.pow(E,e)*o),d)},c={scaleResolutionDownBy:s/Math.pow(f,e),frameRate:n,bitrateMax:Math.max(Math.round(Math.pow(C,e)*i),l),bitrateMin:Math.max(Math.round(Math.pow(C,e)*o),d)},A={scaleResolutionDownBy:1,frameRate:Math.max(Math.round(Math.pow(T,e)*n),a),bitrateMax:Math.max(Math.round(Math.pow(R,e)*i),l),bitrateMin:Math.max(Math.round(Math.pow(R,e)*o),d)};g.push({scale:e,threshold:t,balanced:r,motion:c,detail:A})}return g}function Xo(e,t,i,n,s,o){const a=Ko.get(e)||{overUse:0,underUse:0,adaptationList:Jo(s)},{adaptationList:r}=a;Ko.set(e,a);const{OVERUSE_TIMES_THRESHOLD:c,UNDERUSE_TIMES_THRESHOLD:d}=re,{scale:l}=n;let h,u;return"number"==typeof t&&t>0&&function(e,t,i,n){if(t>=i.length)return!1;let{threshold:{fps_down:s}}=i[t];return E("FORCE_AG_HIGH_FRAMERATE")&&"maintain-framerate"===n&&(s=i[0].threshold.fps_down),e<s}(t,l,r,o)&&(a.overUse++,u=Wo.CPU,a.overUse>c)||"number"==typeof i&&i>0&&function(e,t,i){if(t>=i.length)return!1;const{threshold:{bwe_down:n}}=i[t];return e<n}(i,l,r)&&(a.overUse++,u=Wo.BANDWIDTH,a.overUse>c)?(a.overUse=0,a.underUse=0,h=Yo(n,r,o,Ho.DOWN),[h,u]):("number"==typeof t&&t>0&&"number"==typeof i&&i>0&&function(e,t,i,n){if(0===t)return;let{threshold:{fps_up:s}}=i[t];return E("FORCE_AG_HIGH_FRAMERATE")&&"maintain-framerate"===n&&(s=i[1].threshold.fps_up),e>s}(t,l,r,o)&&function(e,t,i){if(0===t)return;const{threshold:{bwe_up:n}}=i[t];return e>n}(i,l,r)&&(a.underUse++,a.underUse>d&&(a.overUse=0,a.underUse=0,h=Yo(n,r,o,Ho.UP),0===h.scale&&(u=Wo.NONE))),[h,u])}const zo=new Map;function Qo(e,t){const i=zo.get(e);if(i){const{timer:t}=i;window.clearTimeout(t),zo.delete(e)}t.qualityLimitationReason=Wo.NONE,qo(e)}var Zo;let $o=(Zo=class e extends Di{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,t;return null!==(e=null===(t=this.peerConnection.getReceivers()[0])||void 0===t||null===(t=t.transport)||void 0===t?void 0:t.state)&&void 0!==e?e:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>Object.keys(ie).includes(e))))]}constructor(t,i){super(t,i),this.store=void 0,this.peerConnection=void 0,this.id=O(5,"connection-"),this.remoteSDP=void 0,this.initialOffer=void 0,this.transportEventReceiver=void 0,this.statsFilter=void 0,this.extension={useXR:E("USE_XR")},this.localCapabilities=void 0,this.remoteCodecs=void 0,this.localCandidateCount=0,this.allCandidatesReceived=!1,this.isPreallocation=!1,this.preSSRCMap=new Map,this.dataStreamChannelMap=new Map,this.establishPromise=void 0,this.recoveredDataChannelIds=[],this.currentDataChannelId=1,this.mutex=new C("P2PConnection-mutex"),this.qualityLimitationReason=Wo.NONE,this.store=i,this.peerConnection=new RTCPeerConnection(e.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.statsFilter=Ks(this.peerConnection,E("STATS_UPDATE_INTERVAL"),void 0,f()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}getPreMedia(e){const t=this.preSSRCMap.get(e);if(void 0!==t){const e=this.peerConnection.getTransceivers().find((e=>e.mid===t));if(e)return{transceiver:e,track:e.receiver.track,id:t}}}async updateRemoteRTPCapabilities(e,i){if(this.remoteCodecs=i,!this.remoteSDP)return void t.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(i));if(this.remoteSDP.updateRemoteCodec(e,i,this.store.codec)){const e=await this.peerConnection.createOffer(),t=this.logSDPExchange(e.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(e);const i=this.remoteSDP.toString();null==t||t(i),await this.peerConnection.setRemoteDescription({type:"answer",sdp:i})}else t.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const e=await this.peerConnection.createOffer();if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const t=yn(e.sdp),i=await Vn({filterRTX:!E("USE_PUB_RTX")&&!E("USE_SUB_RTX"),filterVideoFec:E("FILTER_VIDEO_FEC"),filterAudioFec:E("FILTER_AUDIO_FEC"),filterVideoCodec:E("FILTER_VIDEO_CODEC")},this.extension);return this.localCapabilities=Bn(i),this.initialOffer=e,Xt(Xt({},t),{},{rtpCapabilities:i,offerSDP:e.sdp})}catch(e){throw new l(h.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new jo(Xt(Xt({},e),{},{localCapabilities:this.localCapabilities})),e.preallocation&&(this.isPreallocation=!0),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const i=this.remoteSDP.toString(),n=Kn(this.initialOffer.sdp,this.extension),s=this.logSDPExchange(n||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:n}),null==s||s(i),await this.peerConnection.setRemoteDescription({type:"answer",sdp:i});const o=this.peerConnection.getTransceivers()[0];if(null!=o&&o.receiver&&this.tryBindTransportEvents(o.receiver),E("PRELOAD_MEDIA_COUNT")>0){this.remoteSDP.preloadRemoteMedia(E("PRELOAD_MEDIA_COUNT"));const e=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const t=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(t)}const{preSSRCs:a}=e;if(Array.isArray(a)&&a.length>0){const{mids:e}=this.remoteSDP.batchSend(a.map((e=>({kind:e.kind,ssrcMsg:[{ssrcId:e.ssrcId,rtx:e.rtx}],mslabel:e.mslabel}))));e.forEach(((e,t)=>{this.preSSRCMap.set(a[t].ssrcId,e)})),await Hn(this.peerConnection,this.remoteSDP,this.extension),t.debug("[".concat(this.store.clientId,"] [P2PConnection] pre-batchReceive exchange SDP."))}}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(e.toString()))}}async updateRemoteConnect(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateRemoteConnect before remote SDP created");const{rtpCapabilities:i}=e;this.remoteSDP.updateRemoteRTPCapabilities(i),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const{preSSRCs:n}=e;if(Array.isArray(n)&&n.length>0){const{mids:e}=this.remoteSDP.batchSend(n.map((e=>Object.assign({},{kind:e.kind,ssrcMsg:[{ssrcId:e.ssrcId,rtx:e.rtx}],mslabel:e.mslabel}))));e.forEach(((e,t)=>{this.preSSRCMap.set(n[t].ssrcId,e)}))}await Hn(this.peerConnection,this.remoteSDP,this.extension),t.debug("[P2PConnection] updateRemoteRTPCapabilities by exchanging SDP.")}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.updateRemoteConnect failed; ".concat(e.toString()))}}send(e,t,i){var n=this;return zt((function*(){const s=yield Yt(n.mutex.lock("From P2PConnection.send"));try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const o=[];e.forEach((e=>{const t=n.peerConnection.addTransceiver(e._mediaStreamTrack,{direction:"sendonly"});o.push(t),e._updateRtpTransceiver(t)})),f()&&!0===E("SIMULCAST")&&(yield Yt(n.applySimulcastForFirefox(o,e)));const a=yield Yt(n.peerConnection.createOffer()),r=n.remoteSDP.predictReceivingMids(e.length),c=n.mungSendOfferSDP(a.sdp,e,r),d=gn.parse(c),l=r.map((e=>{const t=d.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("Cannot extract ssrc from mediaDescription.");return wn(t,E("USE_PUB_RTX"))}));let h;try{h=yield l}catch(s){h=[],n.remoteSDP.receive(e,t,i,h);const o=n.remoteSDP.toString();throw yield Yt(n.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield Yt(n.peerConnection.setRemoteDescription({type:"answer",sdp:o})),yield Yt(n.stopSending(r,!0)),s}n.remoteSDP.receive(e,t,i,h);const u=n.remoteSDP.toString(),p=n.logSDPExchange(c,"offer","local","send");return yield Yt(n.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield Yt(n.applySimulcastEncodings(o,e)),yield Yt(n.applySendEncodings(o,e)),null==p||p(u),yield Yt(n.peerConnection.setRemoteDescription({type:"answer",sdp:u})),o.map(((e,t)=>{const i=r[t];return{localSSRC:l[t],id:i,transceiver:e}}))}catch(e){throw e instanceof l?e:new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(e.toString()))}finally{s()}}))()}async createDataChannels(e,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let n=this.dataStreamChannelMap.get(e);if(n&&"open"===n.readyState)t.debug("[P2PConnection] Channels are already available and can be reused directly.");else{const t=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if("number"!=typeof t)throw new Error("create DataChannel error, because cannot get dc id");n=this.peerConnection.createDataChannel("datastream-channel",{id:t,negotiated:!0,ordered:!1,maxRetransmits:E("DATASTREAM_MAX_RETRANSMITS")}),n.binaryType="arraybuffer",this.dataStreamChannelMap.set(e,n)}i.forEach((e=>{e._updateOriginDataChannel(n)}));const{needExchangeSDP:s}=this.remoteSDP.sendDataChannel();if(s){const e=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const i=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(i),t.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else t.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(e){throw e instanceof l?e:new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(e.toString()))}}async stopDataChannels(e){try{const t=this.dataStreamChannelMap.get(e);return t&&(t.id&&this.recoveredDataChannelIds.push(t.id),t.close()),void this.dataStreamChannelMap.delete(e)}catch(e){throw e instanceof l?e:new l(h.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(e.toString()))}}async stopSending(e,t){const i=t?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const t=this.peerConnection.getTransceivers().filter((t=>-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");t.map((e=>{var t;Qo(this.id+e.mid,this),e.direction="inactive",null===(t=e.stop)||void 0===t||t.call(e)}));const n=await this.peerConnection.createOffer(),s=this.logSDPExchange(n.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(n),this.remoteSDP.stopReceiving(e);const o=this.remoteSDP.toString();null==s||s(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(e.toString()))}finally{i&&i()}}async receive(e,i,n,s){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:o,needExchangeSDP:a}=this.remoteSDP.send(e,i,n,s);a&&(await Hn(this.peerConnection,this.remoteSDP,this.extension),t.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP.")));const r=this.peerConnection.getTransceivers().find((e=>e.mid===o));if(!r)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:r.receiver.track,id:o,transceiver:r}}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const{mids:i,needExchangeSDP:n}=this.remoteSDP.batchSend(e);return n&&(await Hn(this.peerConnection,this.remoteSDP,this.extension),t.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))),i.map((e=>{const t=this.peerConnection.getTransceivers().find((t=>t.mid===e));if(!t)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:t.receiver.track,id:e,transceiver:t}}))}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");e.forEach((e=>{Array.from(this.preSSRCMap.entries()).some((t=>{let[i,n]=t;if(n===e)return this.preSSRCMap.delete(i),!0}))})),this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(e.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(e.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((e=>{e.direction="inactive"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(e);const s=this.remoteSDP.toString();null==n||n(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((async(e,t)=>{e.direction="sendonly"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(e);const s=this.remoteSDP.toString();null==n||n(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(e.toString()))}}restartICE(e){var i=this;return zt((function*(){const n=yield Yt(i.mutex.lock("From P2PConnection.restartICE"));try{if(!i.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(Xe().supportPCSetConfiguration){const n=i.peerConnection.getConfiguration(),s=e===Li.RELAY?"relay":"all";n.iceTransportPolicy!==s&&(t.debug("[".concat(i.store.clientId,"] restartICE change iceTransportPolicy from [").concat(n.iceTransportPolicy,"] to [").concat(s,"]")),n.iceTransportPolicy=s,i.peerConnection.setConfiguration(n))}else if(e===Li.RELAY)return;i.remoteSDP.updateCandidates(e);const s=yield Yt(i.peerConnection.createOffer({iceRestart:!0}));if(!s.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const o=yn(s.sdp),{remoteIceParameters:a}=yield o.iceParameters;i.remoteSDP.restartICE(a);const r=i.remoteSDP.toString(),c=i.logSDPExchange(s.sdp||"","offer","local","restartICE");i.store.descriptionStart(),yield Yt(i.peerConnection.setLocalDescription(s)),null==c||c(r),yield Yt(i.peerConnection.setRemoteDescription({type:"answer",sdp:r}))}catch(e){t.warning("[".concat(i.store.clientId,"] restart ICE failed, abort operation"),e)}finally{n()}}))()}close(){var e;this.peerConnection.getTransceivers().forEach((e=>{Qo(this.id+e.mid,this)})),this.preSSRCMap.clear(),this.peerConnection.close(),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return Xt(Xt({},this.statsFilter.getStats()),{},{qualityLimitationReason:this.qualityLimitationReason})}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),n=this.mungSendOfferSDP(i.sdp,[t],[e]);this.remoteSDP.updateRecvMedia(e,t);const s=this.remoteSDP.toString(),o=this.logSDPExchange(n,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:n}),null==o||o(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const i=this.peerConnection.getTransceivers().filter((t=>t.mid===e));1===i.length&&(this.isVP8Simulcast(t)?f()||await this.applySimulcastEncodings(i,[t]):await this.applySendEncodings(i,[t]))}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const i=this.peerConnection.getTransceivers().find((e=>e.mid===t));i&&await i.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){const e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){const t=e[0].transport.iceTransport,{local:i,remote:n}=t.getSelectedCandidatePair();return{local:Xt(Xt({},Ms),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:Xt(Xt({},Ms),{},{candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,t.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,t.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),E("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const i={iceServers:[]};return t.iceServers?i.iceServers=t.iceServers:t.turnServer&&"off"!==t.turnServer.mode&&(Z(t.turnServer.servers)?i.iceServers=t.turnServer.servers:(i.iceServers&&i.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.servers)),E("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&t.turnServer.serversFromGateway&&i.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),E("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(i.iceTransportPolicy="relay")})))),E("ENABLE_ENCODED_TRANSFORM")&&Xe().supportWebRTCEncodedTransform&&(i.encodedInsertableStreams=!0),i}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(hn(e.turnServerURL),":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&!E("FORCE_TURN_TCP")&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}tryBindTransportEvents(e){const i=e.transport;if(i){this.transportEventReceiver=e,i.onstatechange=()=>{var e;null!=i&&i.state&&(null===(e=this.onDTLSTransportStateChange)||void 0===e||e.call(this,i.state))},i.onerror=e=>{var t;null===(t=this.onDTLSTransportError)||void 0===t||t.call(this,"error"in e?e.error:e)};const n=i.iceTransport;n&&(n.onstatechange=()=>{const e=null==i?void 0:i.iceTransport.state;var t;e&&(null===(t=this.onICETransportStateChange)||void 0===t||t.call(this,e))},n.getSelectedCandidatePair&&(n.onselectedcandidatepairchange=()=>{if(n.getSelectedCandidatePair()){const{local:e,remote:i}=n.getSelectedCandidatePair();t.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:e.type,protocol:e.protocol}),", remote ").concat(JSON.stringify({candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port})," )"))}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,i){var n;if(!i){const t=this.peerConnection.getSenders();i=t.find((t=>t.track===e._mediaStreamTrack))}if(!i)return t.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return t.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!Xe().supportSetRtpSenderParameters)return t.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const s={},o={};switch(e._optimizationMode){case"motion":s.degradationPreference="maintain-framerate";break;case"detail":s.degradationPreference="maintain-resolution";break;case"balanced":s.degradationPreference="balanced"}const a=function(e,t){return e.getTransceivers().find((e=>e.sender.track===t||e.receiver.track===t))}(this.peerConnection,e._mediaStreamTrack),r=St(e);if(function(e){return!(!E("ENABLE_AG_ADAPTATION")||!(e instanceof mt||e._hints.includes(ze.CUSTOM_TRACK))||!E("FORCE_SUPPORT_AG_ADAPTATION")&&!(ce(14)&&de(17,4,!0)||le(14)&&he(17,4,!0)))}(e)&&a&&i&&r&&this.getLocalVideoStats&&["vp8","vp9"].includes(this.store.codec)){const n=s.degradationPreference||(e._hints.includes(ze.CUSTOM_TRACK)?E("CUSTOM_ADAPTATION_DEFAULT_MODE"):"maintain-framerate");!function(e,i,n,s,o,a){if(Qo(e,n),o(i),"balanced"!==s&&"maintain-framerate"!==s&&"maintain-resolution"!==s)return;let r=-1;qo(e,i);const c=window.setInterval((()=>{const c=zo.get(e);if(!E("ENABLE_AG_ADAPTATION")||!c)return Qo(e,n),void o(i);const d=a();if(d.sendPackets>0&&d.OutgoingAvailableBandwidth>0){if(-1===r)return void(r=Date.now());if(Date.now()-r<1e3)return;const a=d.sendFrameRate,l=d.OutgoingAvailableBandwidth,[h,u]=Xo(e,a,l,c.adaptationConfig,i,s);u&&(n.qualityLimitationReason=u),h&&c.adaptationConfig.scale!==h.scale&&(t.debug("[".concat(e,"] applyAdaptation: ").concat(n.qualityLimitationReason,"\n           sendFps ").concat(a,", bwe ").concat(l,", switch from ").concat(c.adaptationConfig.scale," to ").concat(h.scale," ")),c.adaptationConfig=Xt(Xt({},c.adaptationConfig),h),o(h))}}),E("CHECK_LOCAL_STATS_INTERVAL")),d=Xt({},i);zo.set(e,{timer:c,adaptationConfig:d,originConfig:i,adaptationFunc:o}),t.debug("[".concat(e,"] start adaptation, originConfig: ").concat(JSON.stringify(i),", degradationPreference: ").concat(s))}(this.id+a.mid,r,this,n,(e=>{i&&this.updateAdaptation(i,e)}),this.getLocalVideoStats.bind(this))}if(e._encoderConfig){const{bitrateMax:t,frameRate:i,scaleResolutionDownBy:n}=e._encoderConfig;t&&(o.maxBitrate=1e3*t),(e._hints.includes(ze.LOW_STREAM)||e.isUseScaleResolutionDownBy)&&(i&&(o.maxFramerate=pn(i)),n&&n>=1&&(o.scaleResolutionDownBy=n))}const{maxFramerate:c}=E("ENCODER_CONFIG_LIMIT");if(c&&"number"==typeof c&&(o.maxFramerate=o.maxFramerate?Math.min(o.maxFramerate,c):c),E("DSCP_TYPE")&&$()){const e=E("DSCP_TYPE");["very-low","low","medium","high"].includes(e)&&(o.networkPriority=e)}const d=i.getParameters(),l=null===(n=d.encodings)||void 0===n?void 0:n[0];f()&&!l&&(s.encodings=[o]),l&&Object.assign(l,o),Object.assign(d,s),t.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(d.encodings))),await i.setParameters(d),await async function(e,i,n){try{var s;if(!Xe().supportSetRtpSenderParameters)return;if(!function(e){return"vp9"===e}(e)||!E("ENABLE_SVC"))return;const o={},a={},r=i.getParameters(),c=null===(s=r.encodings)||void 0===s?void 0:s[0];a.scalabilityMode=An(n),c&&Object.assign(c,a),Object.assign(r,o),await i.setParameters(r),t.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode success: ".concat(JSON.stringify(r.encodings)))}catch(e){t.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode failed",e)}}(this.store.codec,i,E("SVC_MODE"))}async updateAdaptation(e,i){var n;if(!e)return t.debug("[updateAdaptation] no rtpSender found");if(!Xe().supportSetRtpSenderParameters)return t.debug("[updateAdaptation] Browser not support set rtp-sender parameters");const s={},{bitrateMax:o,frameRate:a,scaleResolutionDownBy:r}=i;o&&(s.maxBitrate=1e3*o),a&&(s.maxFramerate=pn(a)),r&&r>=1&&["vp8","vp9"].includes(this.store.codec)&&(s.scaleResolutionDownBy=r);const c=e.getParameters(),d=null===(n=c.encodings)||void 0===n?void 0:n[0];d&&Object.assign(d,s),Object.assign(c,{});try{await e.setParameters(c),t.debug("[updateAdaptation] updateRtpSenderEncodings: ".concat(JSON.stringify(c.encodings)))}catch(i){!("transport"in e)||e.transport&&"connected"===e.transport.state?"connected"!==this.peerConnectionState?t.debug("[updateAdaptation] peerConnection not connected}"):t.debug("[updateAdaptation] updateRtpSenderEncodings failed",i):t.debug("[updateAdaptation] rtpSender transport not connected}")}}async applySendEncodings(e,i){try{if(!Xe().supportSetRtpSenderParameters)return;if(e.length!==i.length)return;for(let t=0;t<e.length;t++){const n=e[t],s=i[t];s instanceof Je&&!this.isVP8Simulcast(s)&&await this.updateRtpSenderEncodings(s,n.sender)}}catch(e){t.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,t,i){const n=gn.parse(e);return t.forEach(((e,t)=>{const s=i[t],o=n.mediaDescriptions.find((e=>e.attributes.mid===s));o&&(Dn(o,e),Un(o,e,this.store.codec))})),gn.print(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,i)=>{var n;null===(n=this.onFirstVideoDecoded)||void 0===n||n.call(this,e,t,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedLocalCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var t;null===(t=this.onFirstVideoDecodedTimeout)||void 0===t||t.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,t){if(e.length===t.length)for(let a=0;a<e.length;a++){var i,n,s,o;const r=e[a],c=t[a];if(c instanceof Je&&!c._hints.includes(ze.LOW_STREAM)&&null!==(i=c._encoderConfig)&&void 0!==i&&i.bitrateMax&&(null===(n=c._encoderConfig)||void 0===n?void 0:n.bitrateMax)>200&&null!==(s=c._scalabilityMode)&&void 0!==s&&s.numSpatialLayers&&(null===(o=c._scalabilityMode)||void 0===o?void 0:o.numSpatialLayers)>1&&"vp8"===this.store.codec){const e={},t={high:1e3*(c._encoderConfig.bitrateMax-50),medium:5e4};e.encodings=[{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:t.high}];const i=r.sender.getParameters();await r.sender.setParameters(Object.assign(i,e))}}}async applySimulcastEncodings(e,t){if(!f()&&e.length===t.length)for(let i=0;i<e.length;i++){const n=t[i];if(n instanceof Je&&this.isVP8Simulcast(n)){const t=e[i],s={},o={high:1e3*(n._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:o.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:o.medium,scaleResolutionDownBy:4}];const a=t.sender.getParameters();await t.sender.setParameters(Object.assign(a,s))}}}isVP8Simulcast(e){var t,i,n,s;return!!(e instanceof Je&&E("SIMULCAST")&&"vp8"===this.store.codec&&!e._hints.includes(ze.LOW_STREAM)&&null!==(t=e._encoderConfig)&&void 0!==t&&t.bitrateMax&&(null===(i=e._encoderConfig)||void 0===i?void 0:i.bitrateMax)>200&&null!==(n=e._scalabilityMode)&&void 0!==n&&n.numSpatialLayers&&(null===(s=e._scalabilityMode)||void 0===s?void 0:s.numSpatialLayers)>1)}logSDPExchange(e,i,n,s){if(E("SDP_LOGGING"))return t.upload("[".concat(this.store.clientId,"] exchanging ").concat(n," ").concat(i," SDP during P2PConnection.").concat(s,"\n"),e),"offer"===i?e=>{this.logSDPExchange(e,"answer","local"===n?"remote":"local",s)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;const t=this.remoteSDP.getSSRC(e);return t&&0!==t.length?t[0].ssrcId:void 0}setConfiguration(t){if(Xe().supportPCSetConfiguration){const i=e.resolvePCConfiguration(t);this.peerConnection.setConfiguration(i)}}},jt(Zo.prototype,"updateRemoteRTPCapabilities",[ea],Object.getOwnPropertyDescriptor(Zo.prototype,"updateRemoteRTPCapabilities"),Zo.prototype),jt(Zo.prototype,"connect",[ea],Object.getOwnPropertyDescriptor(Zo.prototype,"connect"),Zo.prototype),jt(Zo.prototype,"updateRemoteConnect",[ea],Object.getOwnPropertyDescriptor(Zo.prototype,"updateRemoteConnect"),Zo.prototype),jt(Zo.prototype,"createDataChannels",[ea],Object.getOwnPropertyDescriptor(Zo.prototype,"createDataChannels"),Zo.prototype),jt(Zo.prototype,"receive",[ea],Object.getOwnPropertyDescriptor(Zo.prototype,"receive"),Zo.prototype),jt(Zo.prototype,"batchReceive",[ea],Object.getOwnPropertyDescriptor(Zo.prototype,"batchReceive"),Zo.prototype),jt(Zo.prototype,"stopReceiving",[ea],Object.getOwnPropertyDescriptor(Zo.prototype,"stopReceiving"),Zo.prototype),jt(Zo.prototype,"muteRemote",[ea],Object.getOwnPropertyDescriptor(Zo.prototype,"muteRemote"),Zo.prototype),jt(Zo.prototype,"unmuteRemote",[ea],Object.getOwnPropertyDescriptor(Zo.prototype,"unmuteRemote"),Zo.prototype),jt(Zo.prototype,"muteLocal",[ea],Object.getOwnPropertyDescriptor(Zo.prototype,"muteLocal"),Zo.prototype),jt(Zo.prototype,"unmuteLocal",[ea],Object.getOwnPropertyDescriptor(Zo.prototype,"unmuteLocal"),Zo.prototype),jt(Zo.prototype,"close",[ea],Object.getOwnPropertyDescriptor(Zo.prototype,"close"),Zo.prototype),jt(Zo.prototype,"updateEncoderConfig",[ea],Object.getOwnPropertyDescriptor(Zo.prototype,"updateEncoderConfig"),Zo.prototype),jt(Zo.prototype,"updateSendParameters",[ea],Object.getOwnPropertyDescriptor(Zo.prototype,"updateSendParameters"),Zo.prototype),jt(Zo.prototype,"replaceTrack",[ea],Object.getOwnPropertyDescriptor(Zo.prototype,"replaceTrack"),Zo.prototype),jt(Zo.prototype,"updateAdaptation",[ea],Object.getOwnPropertyDescriptor(Zo.prototype,"updateAdaptation"),Zo.prototype),jt(Zo.prototype,"getRemoteSSRC",[ea],Object.getOwnPropertyDescriptor(Zo.prototype,"getRemoteSSRC"),Zo.prototype),Zo);function ea(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("From P2PConnection.".concat(t));try{for(var s=arguments.length,o=new Array(s),a=0;a<s;a++)o[a]=arguments[a];return await n.apply(this,o)}finally{i()}},i}var ta;let ia=(jt((ta=class extends _{get state(){return this._state}set state(e){const t=this._state;this._state=e,this.emit(Vi.StateChange,t,this._state)}constructor(e,i){super(),this.isPlanB=void 0,this.store=void 0,this.statsUploader=void 0,this.connection=void 0,this.localTrackMap=new Map,this.remoteUserMap=new Map,this.localDataChannels=[],this.remoteDataChannelMap=new Map,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.statsCollector=void 0,this.shouldForwardP2PCreation=void 0,this.iceFailedCount=0,this.dtlsFailedCount=0,this.mutex=new C("P2PChannel-mutex"),this._state=Ui.Disconnected,this._pcStatsUploadType=E("NEW_ICE_RESTART")?ki.FIRST_CONNECTION:ki.OLD_FIRST_CONNECTION,this._isInRestartIce=!1,this._isStartRestartIce=!1,this._restartStates=["disconnected","failed"],this._restartTimer=void 0,this._isFirstConnected=!0,this.handleMuteLocalTrack=async(e,t,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==Ui.Connected)return void i(new l(h.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));const s=this.filterTobeMutedTracks(e);if(0===s.length)return void t();const o=s.find((e=>"videoLowTrack"===e[0]));if(o){o[1].track._originMediaStreamTrack.stop()}await this.connection.muteLocal(s.map((e=>{let[,{id:t}]=e;return t})));const a=this.createMuteMessage(s);await ee(this,Vi.RequestMuteLocal,a),t()}catch(e){i(e)}finally{n()}},this.handleUnmuteLocalTrack=async(e,t,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==Ui.Connected)return void i(new l(h.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));const s=this.filterTobeUnmutedTracks(e);if(0===s.length)return void t();const o=s.find((e=>"videoLowTrack"===e[0]));if(o){const t=o[1];if(t.track._originMediaStreamTrack.stop(),!E("DISABLE_DUAL_STREAM_USE_ENCODING")&&Xe().supportDualStreamEncoding){const i=e._mediaStreamTrack.clone();t.track._mediaStreamTrack=i,t.track._originMediaStreamTrack=i}else{const i=Qs(e,D(this,Vi.RequestLowStreamParameter));t.track._mediaStreamTrack=i,t.track._originMediaStreamTrack=i}await new Promise(((e,i)=>{this.handleReplaceTrack(t.track,e,i,!0)}))}await this.connection.unmuteLocal(s.map((e=>{let[,{id:t}]=e;return t})));const a=this.createUnmuteMessage(s);await ee(this,Vi.RequestUnmuteLocal,a),t()}catch(e){i(e)}finally{n()}},this.handleUpdateVideoEncoder=async(e,t,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleSetVideoEncoder");try{const i=this.localTrackMap.get(Mi.LocalVideoTrack);if(!this.connection||!i||i.track!==e||this.state!==Ui.Connected)return void t();const{id:s,track:o}=i;await this.connection.updateSendParameters(s,o),await this.connection.updateEncoderConfig(s,o),this.emit(Vi.UpdateVideoEncoder,o),t()}catch(e){i(e)}finally{n()}},this.handleUpdateVideoSendParameters=async(e,t,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleUpdateVideoSendParameters");try{const i=this.localTrackMap.get(Mi.LocalVideoTrack);if(!this.connection||!i||i.track!==e||this.state!==Ui.Connected)return void t();const{id:s,track:o}=i;await this.connection.updateSendParameters(s,o),t()}catch(e){i(e)}finally{n()}},this.handleReplaceMixingTrack=async(e,i,n,s)=>{if(!this.connection||this.state!==Ui.Connected)return void i();const o=Co([e]);let a;t.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(o.getTrackId(),"]")),"boolean"==typeof s&&s||(a=await this.mutex.lock("From P2PChannel.handleReplaceMixingTrack"));try{await this.replaceTrack(e,o),i()}catch(e){n(e)}finally{var r;null===(r=a)||void 0===r||r()}},this.handleReplaceTrack=async(e,i,n,s)=>{let o;t.debug("[".concat(this.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(e.getTrackId(),"]")),"boolean"==typeof s&&s||(o=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var a;const t=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(!this.connection||!t||this.state!==Ui.Connected)return void i();if(await(null===(a=this.connection)||void 0===a?void 0:a.replaceTrack(e,t[1].id)),this.isPlanB){const i=t[1];i.id=e._mediaStreamTrack.id,this.localTrackMap.set(t[0],i)}if(t[0]===Mi.LocalVideoTrack&&!E("DISABLE_DUAL_STREAM_USE_ENCODING")&&Xe().supportDualStreamEncoding){const t=this.localTrackMap.get(Mi.LocalVideoLowTrack);if(t){const i=e._mediaStreamTrack.clone();t.track._originMediaStreamTrack.stop(),t.track._mediaStreamTrack=i,t.track._originMediaStreamTrack=i,await new Promise(((e,i)=>{this.handleReplaceTrack(t.track,e,i,!0)}))}}i()}catch(e){n(e)}finally{var r;null===(r=o)||void 0===r||r()}},this.handleGetRTCStats=e=>{e(this.statsCollector.getRTCStats())},this.handleGetLocalVideoStats=e=>{e(this.statsCollector.getLocalVideoTrackStats())},this.handleGetLocalAudioStats=e=>{e(this.statsCollector.getLocalAudioTrackStats())},this.handleGetRemoteVideoStats=e=>this.statsCollector.getRemoteVideoTrackStats(e.uid)[e.uid],this.handleGetRemoteAudioStats=e=>this.statsCollector.getRemoteAudioTrackStats(e.uid)[e.uid],this.store=e,this.statsCollector=i,this.statsCollector.addP2PChannel(this),this.statsUploader=new _o(this.store),this.bindStatsUploaderEvents(),this.isPlanB=!Xe().supportUnifiedPlan||E("CHROME_FORCE_PLAN_B")&&$(),this.shouldForwardP2PCreation=E("FORWARD_P2P_CREATION")&&Xe().supportPCSetConfiguration&&ue(),this.shouldForwardP2PCreation&&(this.connection=this.isPlanB?new xo({},this.store):new $o({},this.store),this.bindConnectionEvents(this.connection))}async startP2PConnection(e){var i;this.state=Ui.New;const n=this.shouldForwardP2PCreation&&"closed"===(null===(i=this.connection)||void 0===i?void 0:i.peerConnectionState);if(this.shouldForwardP2PCreation&&!n||(n&&this.connection&&(t.warning("[".concat(this.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),this.connection.close(),this.unbindConnectionEvents(this.connection)),this.connection=this.isPlanB?new xo(e,this.store):new $o(e,this.store),this.bindConnectionEvents(this.connection)),!this.connection)throw new l(h.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this._pcStatsUploadType=E("NEW_ICE_RESTART")?ki.FIRST_CONNECTION:ki.OLD_FIRST_CONNECTION,this._isFirstConnected=!0,this._isInRestartIce=!1,this._isStartRestartIce=!1,this.connection.setConfiguration(e),this.connection.establishPromise}async connect(e){if(!this.connection)throw new l(h.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");E("ENABLE_PREALLOC_PC")&&this.state===Ui.Connected?await this.connection.updateRemoteConnect(e):(this.store.peerConnectionStart(),await this.connection.connect(e),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=Ui.Connected)}updateRemoteRTPCapabilities(e){const n=Array.from(this.localTrackMap.entries()).filter((e=>{let[t]=e;return[Mi.LocalVideoLowTrack,Mi.LocalVideoTrack].includes(t)})),s=n.map((e=>{let[,{id:t}]=e;return t})),o=n.map((e=>{let[t]=e;return t}));if(this.connection instanceof $o){if(i.updateRemoteRTPCapabilities(this.store.sessionId,{trackTypes:JSON.stringify(o),localCodecs:JSON.stringify(this.connection.localCodecs),remoteCodecs:JSON.stringify(e)}),!e.includes(this.store.codec)){const i=["vp9","vp8","h264"].find((t=>e.includes(t)));i&&(this.store.codec=i,t.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId," updateRemoteRTPCapabilities] default codec is not available, hence the fallback to ").concat(i,".")))}this.connection.updateRemoteRTPCapabilities(s,e)}}async getEstablishParams(){if(this.connection instanceof $o&&"closed"!==this.connection.peerConnectionState&&[Ui.New,Ui.Connected].includes(this.state))return this.connection.establishPromise}async publishDataChannel(e){if(!this.connection||this.state!==Ui.Connected){if(this.state===Ui.Disconnected)throw new l(h.UNEXPECTED_ERROR,"PeerConnection already disconnected.");return e.forEach((e=>{this.pendingLocalDataChannels.includes(e)||this.pendingLocalDataChannels.push(e)})),[]}const t=this.filterTobePublishedDataChannels(e);return 0===t.length?[]:(t.forEach((e=>{const t=Date.now();this.store.publish(e.id.toString(),"datachannel",t)})),await this.connection.createDataChannels(this.store.uid,t),t.forEach((e=>{this.localDataChannels.push(e);const t=Date.now();this.store.publish(e.id+"","datachannel",void 0,t)})),e.map((e=>({streamId:e.id,ordered:e.ordered,maxRetransmits:e.maxRetransmits,metadata:e.metadata,channelId:e._originDataChannelId}))))}publish(e,t,i){var n=this;return zt((function*(){const s=yield Yt(n.mutex.lock("From P2PChannel.publish"));try{if(!n.connection||n.state!==Ui.Connected){if(n.state===Ui.Disconnected)throw new l(h.UNEXPECTED_ERROR,"PeerConnection already disconnected.");n.throwIfTrackTypeNotMatch(e);const t=e.filter((e=>-1===n.pendingLocalTracks.indexOf(e)));return void(n.pendingLocalTracks=n.pendingLocalTracks.concat(t))}n.store.pubId=n.store.pubId+1,Ds.markPublishStart(n.store.clientId,n.store.pubId);const o=n.filterTobePublishedTracks(e,t,i);if(0===o.length)return void(yield Yt(n.tryToUnmuteAudio(e)));yield*Wt(Ht(n.doPublish(n.connection,o)))}finally{s()}}))()}doPublish(e,t){var i=this;return zt((function*(){t.forEach((e=>{let{track:t,type:n}=e;const s=Date.now();i.store.publish(t.getTrackId(),n===Mi.LocalAudioTrack?"audio":"video",s)})),i.bindLocalTrackEvents(t);const n=t.map((e=>{let{track:t}=e;return t})),s=yield Yt(e.send(t.map((e=>{let{track:t}=e;return t})),i.store.codec,i.store.audioCodec)),o=(yield Yt(s.next())).value,a=i.createGatewayPublishMessage(t,o);let r;try{r=yield a}catch(e){throw s.throw(e),(null==e?void 0:e.code)===h.WS_ABORT&&t.forEach((e=>{let{track:t}=e;-1===i.pendingLocalTracks.indexOf(t)&&i.pendingLocalTracks.push(t)})),i.unbindLocalTrackEvents(t),e}const c=i.mapPubResToRemoteConfig(a,r),d=(yield Yt(s.next(c))).value,l=E("ENABLE_VIDEO_SEI");n.forEach((async e=>{const t=e.getRTCRtpTransceiver();t&&l&&(e.trackMediaType===Pi.VIDEO?await Tt(t.sender,e):e.trackMediaType===Pi.AUDIO&&await Rt(t.sender))})),t.forEach((e=>{let{type:t}=e;i.statsCollector.addLocalStats(t)})),i.assignLocalTracks(t,d),i.statsUploader.startUploadOutboundStats(),t.forEach((e=>{let{track:t,type:n}=e;const s=Date.now();i.store.publish(t.getTrackId(),n===Mi.LocalAudioTrack?"audio":"video",void 0,s)}))}))()}async updateVideoStreamParameter(e,i){const n=this.localTrackMap.get(i);if(!n)return;if(!(n.track instanceof Je))return t.warn("[updateVideoStreamParameter]: track is not an instance of LocalVideoTrack");if(!(this.connection instanceof $o||this.connection instanceof xo))return t.warn("[updateVideoStreamParameter]: connection is not P2PConnection or P2PConnectionPlanB");const{track:s}=n,o=function(e,t){const i={};return e.height&&e.width&&(i.scaleResolutionDownBy=fn(e,t)),i.maxFramerate=e.framerate?pn(e.framerate):void 0,i.maxBitrate=e.bitrate?1e3*e.bitrate:void 0,i}(e,s);if(s._encoderConfig||(s._encoderConfig={}),i!==Mi.LocalVideoLowTrack||!E("DISABLE_DUAL_STREAM_USE_ENCODING")&&Xe().supportDualStreamEncoding)null!=o.scaleResolutionDownBy&&(s._encoderConfig.scaleResolutionDownBy=o.scaleResolutionDownBy);else{const i=s._originMediaStreamTrack;if(!i.canvas)return t.warn("[".concat(s.getTrackId(),"] no canvas on track"));!function(e,t){const i=e.canvas;t.width&&(i.width=pn(t.width)),t.height&&(i.height=pn(t.height)),t.framerate&&(i.stopCapture&&i.stopCapture(),i.stopCapture=$e((()=>{!i.startCapture&&i.stopCapture&&i.stopCapture(),i.startCapture&&i.startCapture()}),pn(t.framerate)))}(i,e)}null!=o.maxBitrate&&(s._encoderConfig.bitrateMax=o.maxBitrate/1e3),null!=o.maxFramerate&&(s._encoderConfig.frameRate&&"object"==typeof s._encoderConfig.frameRate?s._encoderConfig.frameRate.max=o.maxFramerate:s._encoderConfig.frameRate={max:o.maxFramerate}),t.debug("[".concat(s.getTrackId(),"] LowStreamEncoderConfig: , ").concat(JSON.stringify(s._encoderConfig))),await this.connection.updateRtpSenderEncodings(s)}publishLowStream(e){var t=this;return zt((function*(){if(!t.connection||t.state!==Ui.Connected)return;const i=yield Yt(t.mutex.lock("Locking from P2PChannel.publishLowStream"));try{const s=t.localTrackMap.get(Mi.LocalVideoTrack);if(!s)throw new l(h.UNEXPECTED_ERROR,"Could not find high stream");if(t.localTrackMap.has(Mi.LocalVideoLowTrack))throw new l(h.UNEXPECTED_ERROR,"[".concat(t.store.clientId,"] Can't publish low stream when stream already publish"));const o=[{track:t.getLowVideoTrack(s.track,e),type:Mi.LocalVideoLowTrack}];if(yield*Wt(Ht(t.doPublish(t.connection,o))),s.track.muted||!s.track.enabled){var n;const e=null===(n=t.localTrackMap.get(Mi.LocalVideoLowTrack))||void 0===n?void 0:n.id;void 0!==e&&(yield Yt(t.connection.muteLocal([e])))}}finally{i()}}))()}async republish(){this.pendingLocalTracks.length>0&&(t.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await v(this,Vi.RequestRePublish,this.pendingLocalTracks),this.emit(Vi.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[]),this.pendingLocalDataChannels.length>0&&(t.debug("Emit P2PChannelEvents.RequestRePublishDataChannel to republish datachannels."),await v(this,Vi.RequestRePublishDataChannel,this.pendingLocalDataChannels),this.pendingLocalDataChannels=[])}async reSubscribe(e){for(let e=this.pendingRemoteTracks.length-1;e>=0;e--){const{user:t,kind:i}=this.pendingRemoteTracks[e];(i!==Pi.AUDIO||t._audio_added_&&t._audioSSRC)&&(i!==Pi.VIDEO||t._video_added_&&t._videoSSRC)||this.pendingRemoteTracks.splice(e,1)}if(e)await v(this,Vi.RequestReSubscribe,this.pendingRemoteTracks);else for(const{user:e,kind:t}of this.pendingRemoteTracks)await this.subscribe(e,t,t===Pi.VIDEO?e._videoSSRC:e._audioSSRC);this.pendingRemoteTracks.forEach((e=>{let{user:t}=e;this.emit(Vi.MediaReconnectEnd,t.uid)})),this.pendingRemoteTracks=[]}async unpublish(e){if(!this.connection||this.state!==Ui.Connected)return void e.forEach((e=>{const t=this.pendingLocalTracks.indexOf(e);-1!==t&&this.pendingLocalTracks.splice(t,1)}));const t=this.filterTobeUnpublishedTracks(e);if(0===t.length)return;const i=t.find((e=>"videoLowTrack"===e[0]));if(i){i[1].track.close()}return this.doUnpublish(this.connection,t)}async unpublishDataChannel(e){if(!this.connection||this.state!==Ui.Connected)return void e.forEach((e=>{const t=this.pendingLocalDataChannels.indexOf(e);-1!==t&&this.pendingLocalDataChannels.splice(t,1)}));const t=this.filterTobeUnpublishedDataChannels(e);return 0!==t.length?(t.forEach((e=>{const t=this.localDataChannels.indexOf(e);-1!==t&&this.localDataChannels.splice(t,1)})),0===this.localDataChannels.length&&await this.connection.stopDataChannels(this.store.uid),t.map((e=>e.id))):void 0}async unpublishLowStream(){if(!this.connection||this.state!==Ui.Connected)return;const e=this.localTrackMap.get(Mi.LocalVideoLowTrack);if(!e)return;e.track.close();const t=[[Mi.LocalVideoLowTrack,e]];return this.doUnpublish(this.connection,t)}async doUnpublish(e,t){const i=this.createGatewayUnpublishMessage(t);return await e.stopSending(t.map((e=>{let[,{id:t}]=e;return t}))),this.withdrawLocalTracks(t),this.unbindLocalTrackEvents(t.map((e=>{let[t,{track:i}]=e;return{type:t,track:i}}))),t.forEach((e=>{let[t]=e;this.statsCollector.removeLocalStats(t)})),0===this.localTrackMap.size&&this.statsUploader.stopUploadOutboundStats(),i}async subscribeDataChannel(e,t){if(!this.connection||this.state!==Ui.Connected)throw new l(h.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");const i=t.filter((t=>{var i;return!(null!==(i=this.remoteDataChannelMap.get(e))&&void 0!==i&&i.get(t.id))}));if(0!==i.length)return await this.connection.createDataChannels(e.uid,i),i.forEach((t=>{var i;this.remoteDataChannelMap.has(e)?null===(i=this.remoteDataChannelMap.get(e))||void 0===i||i.set(t.id,t):this.remoteDataChannelMap.set(e,new Map([[t.id,t]]));const n=this.pendingRemoteDataChannels.findIndex((i=>{let{user:n,id:s}=i;return n.uid===e.uid&&s===t.id}));-1!==n&&this.pendingRemoteDataChannels.splice(n,1)})),i.map((e=>e.id))}async subscribe(e,i,n,s,o){var a;if(!this.connection||this.state!==Ui.Connected)throw new l(h.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if(null!==(a=this.remoteUserMap.get(e))&&void 0!==a&&a.has(i))return;let r,c,d;const u=this.connection.getPreMedia(n);if(u)t.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] preSSRCMap has ssrcId: ").concat(n,", no need to send sub to gateway.")),d=u.transceiver,r=u.track,c=u.id;else if(o){const t=o.find((e=>{let{stream_type:t}=e;return t===i}));if(!t)throw new l(h.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(i," for user: ").concat(e.uid," because subscribe answer from gateway does not contain stream_type: ").concat(i,"."));const n=await this.connection.receive(i,t.ssrcs,String(e._uintid),t.attributes);this.connection instanceof $o&&(d=n.transceiver),r=n.track,c=n.id}else{const t=await this.connection.receive(i,[{ssrcId:n,rtx:s}],String(e._uintid),void 0);this.connection instanceof $o&&(d=t.transceiver),r=t.track,c=t.id}i===Pi.AUDIO?(e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(r):(e._audioTrack=new ot(r,e.uid,e._uintid,this.store),t.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),d&&e._audioTrack._updateRtpTransceiver(d),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(r):(e._videoTrack=new at(r,e.uid,e._uintid,this.store),t.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId()))),d&&e._videoTrack._updateRtpTransceiver(d),this.bindRemoteTrackEvents(e,e._videoTrack)),E("ENABLE_VIDEO_SEI")&&d&&(i==Pi.VIDEO?await ft(d.receiver,{onSei:t=>{var i;null===(i=e._videoTrack)||void 0===i||i._onSei(t)}}):i==Pi.AUDIO&&await Ct(d.receiver));const p=this.remoteUserMap.get(e);p?p.set(i,c):this.remoteUserMap.set(e,new Map([[i,c]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadInboundStats();const _=this.pendingRemoteTracks.findIndex((t=>{let{user:n,kind:s}=t;return n.uid===e.uid&&i===s}));-1!==_&&(this.pendingRemoteTracks.splice(_,1),this.emit(Vi.MediaReconnectEnd,e.uid))}async massSubscribe(e){return this.massSubscribeNoLock(e)}async massSubscribeNoLock(e){if(!this.connection||this.state!==Ui.Connected)throw new l(h.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");e=e.filter((e=>{var t;let{user:i,mediaType:n}=e;return!(null!==(t=this.remoteUserMap.get(i))&&void 0!==t&&t.has(n))}));const i=[],n=new Map;e.forEach((e=>{if(!this.connection)return;const t=this.connection.getPreMedia(e.ssrcId);t?n.set(e.ssrcId,t):i.push(e)}));const s=await this.connection.batchReceive(i.map((e=>{let{user:t,mediaType:i,ssrcId:n,rtxSsrcId:s}=e;return{kind:i,ssrcMsg:[{ssrcId:n,rtx:s}],mslabel:String(t._uintid)}})));i.forEach(((e,t)=>{n.set(e.ssrcId,s[t])})),e.forEach((e=>{let{user:i,mediaType:s,ssrcId:o}=e;const a=n.get(o);if(!a)return void t.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] cannot find ").concat(i.uid," subscribe data,").concat(s,", ").concat(o));const{track:r,id:c,transceiver:d}=a;s===Pi.AUDIO?(i._audioTrack?i._audioTrack._updateOriginMediaStreamTrack(r):(i._audioTrack=new ot(r,i.uid,i._uintid,this.store),t.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(i._audioTrack.getTrackId()))),d&&i._audioTrack._updateRtpTransceiver(d),this.bindRemoteTrackEvents(i,i._audioTrack)):(i._videoTrack?i._videoTrack._updateOriginMediaStreamTrack(r):(i._videoTrack=new at(r,i.uid,i._uintid,this.store),t.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(i._videoTrack.getTrackId()))),d&&i._videoTrack._updateRtpTransceiver(d),this.bindRemoteTrackEvents(i,i._videoTrack));const l=this.remoteUserMap.get(i);l?l.set(s,c):this.remoteUserMap.set(i,new Map([[s,c]])),this.statsCollector.addRemoteStats(i.uid),this.statsUploader.startUploadInboundStats();const h=this.pendingRemoteTracks.findIndex((e=>{let{user:t,kind:n}=e;return t.uid===i.uid&&s===n}));-1!==h&&(this.pendingRemoteTracks.splice(h,1),this.emit(Vi.MediaReconnectEnd,i.uid))}))}async unsubscribe(e,t,i){const n=this.pendingRemoteTracks.filter((i=>{let{user:n,kind:s}=i;return void 0!==t?n.uid===e.uid&&t===s:n.uid===e.uid}));if(n.forEach((e=>{const t=this.pendingRemoteTracks.indexOf(e);this.pendingRemoteTracks.splice(t,1)})),this.connection&&this.state===Ui.Connected||i||n.forEach((t=>{let{kind:i}=t;var n;if(i===Pi.AUDIO)null===(n=e._audioTrack)||void 0===n||n._destroy(),e._audioTrack=void 0;else if(i===Pi.VIDEO){var s;null===(s=e._videoTrack)||void 0===s||s._destroy(),e._videoTrack=void 0}})),!this.connection||this.state!==Ui.Connected)return;const s=this.filterTobeUnSubscribedTracks(e,t);if(0===s.length)return;await this.connection.stopReceiving(s.map((e=>{let[,{id:t}]=e;return t})));const o=this.createUnsubscribeMessage(s);return this.withdrawRemoteTracks(s),0===this.remoteUserMap.size&&this.statsUploader.stopUploadInboundStats(),s.forEach((e=>{let[t,{kind:n}]=e;var s,o;n===Pi.VIDEO&&t._videoSSRC&&(null===(s=this.connection)||void 0===s||s.setStatsRemoteVideoIsReady(t._videoSSRC,!1));if(n===Pi.VIDEO)this.unbindRemoteTrackEvents(t._videoTrack),i||(null===(o=t._videoTrack)||void 0===o||o._destroy(),t._videoTrack=void 0);else if(n===Pi.AUDIO){var a;if(this.unbindRemoteTrackEvents(t._audioTrack),!i)null===(a=t._audioTrack)||void 0===a||a._destroy(),t._audioTrack=void 0}})),o}async unsubscribeDataChannel(e,t){if(t.forEach((e=>{const t=this.pendingRemoteDataChannels.findIndex((t=>t.id===e.id));-1!==t&&this.pendingRemoteDataChannels.splice(t,1)})),!this.connection)return;const i=this.filterTobeUnSubscribedDataChannels(e,t);if(0===i.length)return;t.forEach((e=>{e._close()}));const n=this.remoteDataChannelMap.get(e);return i.forEach((e=>{n&&n.delete(e.id)})),n&&0===n.size&&(this.remoteDataChannelMap.delete(e),await this.connection.stopDataChannels(e.uid)),i.map((e=>e.id))}async massUnsubscribe(e){return this.massUnsubscribeNoLock(e)}async massUnsubscribeNoLock(e){let t=[];for(const{user:i,mediaType:n}of e){const e=this.pendingRemoteTracks.filter((e=>{let{user:t,kind:s}=e;return void 0!==n?t.uid===i.uid&&n===s:t.uid===i.uid}));e.forEach((e=>{const t=this.pendingRemoteTracks.indexOf(e);this.pendingRemoteTracks.splice(t,1)})),t=t.concat(e)}if(!this.connection||this.state!==Ui.Connected)return void t.forEach((e=>{let{user:t,kind:i}=e;var n;if(i===Pi.AUDIO)null===(n=t._audioTrack)||void 0===n||n._destroy(),t._audioTrack=void 0;else if(i===Pi.VIDEO){var s;null===(s=t._videoTrack)||void 0===s||s._destroy(),t._videoTrack=void 0}}));const i=e.reduce(((e,t)=>{let{user:i,mediaType:n}=t;const s=this.filterTobeUnSubscribedTracks(i,n);return e.concat(s)}),[]);if(0===i.length)return;await this.connection.stopReceiving(i.map((e=>{let[,{id:t}]=e;return t})));const n=this.createUnsubscribeAllMessage(i);return this.withdrawRemoteTracks(i),0===this.remoteUserMap.size&&this.statsUploader.stopUploadInboundStats(),i.forEach((e=>{let[t,{kind:i}]=e;var n,s;i===Pi.VIDEO&&t._videoSSRC&&(null===(n=this.connection)||void 0===n||n.setStatsRemoteVideoIsReady(t._videoSSRC,!1));if(i===Pi.VIDEO)this.unbindRemoteTrackEvents(t._videoTrack),null===(s=t._videoTrack)||void 0===s||s._destroy(),t._videoTrack=void 0;else if(i===Pi.AUDIO){var o;this.unbindRemoteTrackEvents(t._audioTrack),null===(o=t._audioTrack)||void 0===o||o._destroy(),t._audioTrack=void 0}})),n}isPreSubScribe(e){if(!this.connection||this.state!==Ui.Connected)return!1;return!!this.connection.getPreMedia(e)}async muteRemote(e,i){if(!this.connection)return;const n=this.remoteUserMap.get(e);if(!n)return void t.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(e.uid,"."));if(!n.get(i))return void t.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(e.uid," media type ").concat(i,"."));const s=i===Pi.VIDEO?e._videoSSRC:e._audioSSRC;void 0!==s&&this.connection.setStatsRemoteVideoIsReady(s,!1)}async unmuteRemote(e,t){return this.unmuteRemoteNoLock(e,t)}async unmuteRemoteNoLock(e,i){if(!this.connection)return;const n=this.remoteUserMap.get(e);if(!n)return void t.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(e.uid,"."));n.get(i)||t.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(i,"."))}getAllTracks(e){const t=this.localTrackMap.get(Mi.LocalAudioTrack);if((null==t?void 0:t.track)instanceof Ze){const i=t.track;return Array.from(this.localTrackMap.entries()).filter((e=>{let[t]=e;return t!==Mi.LocalAudioTrack})).filter((t=>{let[i]=t;return!(e&&i===Mi.LocalVideoLowTrack)})).map((e=>{let[,{track:t}]=e;return t})).concat(i.trackList)}return Array.from(this.localTrackMap.entries()).filter((t=>{let[i]=t;return!(e&&i===Mi.LocalVideoLowTrack)})).map((e=>{let[,{track:t}]=e;return t}))}getAllDataChannels(){return this.localDataChannels}reportPublishEvent(e,t,n,s,o){if(e){const n=this.localTrackMap.get(Mi.LocalAudioTrack),a=s?this.localTrackMap.get(Mi.LocalVideoLowTrack):this.localTrackMap.get(Mi.LocalVideoTrack);i.publish(this.store.sessionId,{eventElapse:Ds.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:null==n?void 0:n.track.getTrackLabel(),videoName:null==a?void 0:a.track.getTrackLabel(),screenshare:-1!==(null==a?void 0:a.track._hints.indexOf(ze.SCREEN_TRACK)),audio:!!n,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:o})}else{var a;n||(n=[]);const r=n.find((e=>e instanceof qe)),c=s?null===(a=this.localTrackMap.get(Mi.LocalVideoTrack))||void 0===a?void 0:a.track:n.find((e=>e instanceof Je));i.publish(this.store.sessionId,{eventElapse:Ds.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:null==r?void 0:r.getTrackLabel(),videoName:null==c?void 0:c.getTrackLabel(),screenshare:-1!==(null==c?void 0:c._hints.indexOf(ze.SCREEN_TRACK)),audio:!!r,video:!!c,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:o})}}reportSubscribeEvent(e,t,n,s){const o=s===Pi.VIDEO?n._videoSSRC:n._audioSSRC;o&&i.subscribe(this.store.sessionId,{succ:e,ec:t,video:s===Pi.VIDEO,audio:s===Pi.AUDIO,peerid:n.uid,subscribeRequestid:o,p2pid:this.store.p2pId,eventElapse:Ds.measureFromSubscribeStart(this.store.clientId,o),preSsrc:this.isPreSubScribe(o)})}reset(){t.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new C("P2PChannel-mutex"),this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=this.isPlanB?new xo({},this.store):new $o({},this.store),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const e=this.localTrackMap.get(Mi.LocalAudioTrack);if((null==e?void 0:e.track)instanceof Ze){if(e.track.trackList.length>0){const t=e.track;e.track.trackList.forEach((e=>{t.removeAudioTrack(e)}))}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.localDataChannels=[],this.remoteDataChannelMap.clear(),this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.state=Ui.Disconnected}getStats(){var e;return null===(e=this.connection)||void 0===e?void 0:e.getStats()}getRemoteVideoIsReady(e){var t;return(null===(t=this.connection)||void 0===t?void 0:t.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){const e=this.localTrackMap.get(Mi.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){const e=this.localTrackMap.get(Mi.LocalVideoTrack);if(e)return{width:e.track.videoWidth||0,height:e.track.videoHeight||0}}getEncoderConfig(e){const t=this.localTrackMap.get(e);return t&&t.track instanceof Je||t&&t.track instanceof qe?t.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,t){if(!e)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(e);return!!i&&(!t||i.has(t))}async hasRemoteMediaWithLock(e,t){if(!e)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(e);return!!i&&(!t||i.has(t))}getRemoteMedia(e){const t=Array.from(this.remoteUserMap.keys()).find((t=>t.uid===e));return t?{audioTrack:t.audioTrack,audioSSRC:t._audioSSRC,videoTrack:t.videoTrack,videoSSRC:t._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map((e=>{let[t]=e;return{uid:t.uid,level:t.audioTrack?100*t.audioTrack._source.getAccurateVolumeLevel():0}}));const t=this.localTrackMap.get(Mi.LocalAudioTrack);return t&&e.push({level:100*t.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=e.sort(((e,t)=>e.level-t.level)),e}async disconnectForReconnect(){this.connection&&(t.debug("[".concat(this.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),this.state=Ui.Reconnecting,E("KEEP_LAST_FRAME")&&0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t]=e;var i;t._videoTrack&&t._videoTrack._player&&(null===(i=t._videoTrack._player.getVideoElement())||void 0===i||i.pause(),t._videoTrack._player.isKeepLastFrame=!0,t._videoTrack._originMediaStreamTrack.stop())})),this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=this.isPlanB?new xo({},this.store):new $o({},this.store),this.bindConnectionEvents(this.connection)),0!==this.localTrackMap.size&&(Array.from(this.localTrackMap.entries()).forEach((e=>{let[t,{track:i}]=e;switch(t){case Mi.LocalVideoTrack:i._hints.includes(ze.LOW_STREAM)?i.close():this.pendingLocalTracks.push(i);break;case Mi.LocalAudioTrack:i instanceof Ze?this.pendingLocalTracks=this.pendingLocalTracks.concat(i.trackList):this.pendingLocalTracks.push(i);case Mi.LocalVideoLowTrack:}})),this.emit(Vi.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,i]=e;Array.from(i.keys()).forEach((e=>{this.setPendingRemoteMedia(t,e)})),this.emit(Vi.MediaReconnectStart,t.uid)})),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),0!==this.localDataChannels.length&&(this.localDataChannels.forEach((e=>{this.pendingLocalDataChannels.push(e)})),this.localDataChannels.length=0),0!==this.remoteDataChannelMap.size&&(Array.from(this.remoteDataChannelMap.entries()).forEach((e=>{let[t,i]=e;Array.from(i.keys()).forEach((e=>{this.setPendingRemoteDataChannel(t,e)}))})),this.remoteDataChannelMap.clear()),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),t.debug("[".concat(this.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")))}hasPendingRemoteDataChannel(e,t){for(const i of this.pendingRemoteDataChannels){const{user:n,id:s}=i;if((e instanceof Eo?e.uid:e)===n.uid&&s===t)return!0}return!1}setPendingRemoteDataChannel(e,t){this.hasPendingRemoteDataChannel(e,t)||this.pendingRemoteDataChannels.push({user:e,id:t})}hasPendingRemoteMedia(e,t){for(const i of this.pendingRemoteTracks){const{user:n,kind:s}=i;if((e instanceof Eo?e.uid:e)===n.uid&&t===s)return!0}return!1}setPendingRemoteMedia(e,t){this.hasPendingRemoteMedia(e,t)||this.pendingRemoteTracks.push({user:e,kind:t})}restartICE(e){var t=this;return zt((function*(){if(!t.connection||t.state!==Ui.Connected)return;const i=yield Yt(t.mutex.lock("From P2PChannel.restartICE"));let n;try{n=yield Yt(t.connection.restartICE(e));const s=yield Yt(n.next());if(s.done)return;const o=s.value,a=yield o;switch(t.reportPCDisconnectedOrFailed(e),e){case Li.TCP:t._pcStatsUploadType=ki.TCP_RESTART;break;case Li.RELAY:t._pcStatsUploadType=ki.RELAY_RESTART;break;default:t._pcStatsUploadType=ki.OLD_RESTART}t._isInRestartIce=!0,n.next(a)}catch(e){var s;null===(s=n)||void 0===s||s.throw(e)}finally{i()}}))()}getUplinkNetworkQuality(){if(!this.connection)return 0;const e=this.connection.getStats(),t=this.localTrackMap.get(Mi.LocalVideoTrack),i=this.localTrackMap.get(Mi.LocalAudioTrack),n=e.videoSend.find((e=>e.ssrc===(null==t?void 0:t.ssrcs[0].ssrcId))),s=e.audioSend.find((e=>e.ssrc===(null==i?void 0:i.ssrcs[0].ssrcId)));if(!n||!s)return 1;const o=y(this,Vi.NeedSignalRTT),a=n?n.rttMs:void 0,r=s?s.rttMs:void 0,c=a&&r?(a+r)/2:a||r,d=(c&&o?(c+o)/2:c||o)||0,l=100*e.sendPacketLossRate*.7/50+.3*d/1500,h=l<.17?1:l<.36?2:l<.59?3:l<.1?4:5,u=null==t?void 0:t.track;if(u&&u._encoderConfig&&-1===u._hints.indexOf(ze.SCREEN_TRACK)){const t=u._encoderConfig.bitrateMax,i=e.bitrate.actualEncoded;if(t&&i){const e=(1e3*t-i)/(1e3*t);return xt[e<.15?0:e<.3?1:e<.45?2:e<.6?3:4][h]}}return h}getDownlinkNetworkQuality(){if(!this.connection)return 0;const e=this.connection.getStats();let t=0;return Array.from(this.remoteUserMap.entries()).forEach((i=>{let[n]=i;const s=n._audioSSRC,o=n._videoSSRC,a=e.audioRecv.find((e=>e.ssrc===s)),r=e.videoRecv.find((e=>e.ssrc===o));if(!a&&!r)return void(t+=1);const c=y(this,Vi.NeedSignalRTT),d=e.rtt,l=(d&&c?(d+c)/2:d||c)||0,h=a?a.jitterMs:void 0,u=e.recvPacketLossRate;let p=.7*u*100/50+.3*l/1500;h&&(p=.6*u*100/50+.2*l/1500+.2*h/400);t+=p<.1?1:p<.17?2:p<.36?3:p<.59?4:5})),this.remoteUserMap.size>0?Math.round(t/this.remoteUserMap.size):t}async muteLocalTrack(e){return new Promise(((t,i)=>{this.handleMuteLocalTrack(e,t,i)}))}async replaceTrack(e,i){var n;if(t.debug("[".concat(this.store.clientId,"] P2PChannel replaceTrack from [").concat(e.getTrackId(),"] to [").concat(i.getTrackId(),"]")),!this.connection||this.state!==Ui.Connected)return;const s=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(!s)return;const o=s[0];if(e!==i&&(this.unbindLocalTrackEvents([{track:e,type:o}]),this.bindLocalTrackEvents([{track:i,type:o}]),s[1].track=i),await(null===(n=this.connection)||void 0===n?void 0:n.replaceTrack(i,s[1].id)),this.isPlanB){const e=s[1];e.id=i._mediaStreamTrack.id,this.localTrackMap.set(o,e)}if(o===Mi.LocalVideoTrack&&!E("DISABLE_DUAL_STREAM_USE_ENCODING")&&Xe().supportDualStreamEncoding){const t=this.localTrackMap.get(Mi.LocalVideoLowTrack);if(t){const i=e._mediaStreamTrack.clone();t.track._originMediaStreamTrack.stop(),t.track._mediaStreamTrack=i,t.track._originMediaStreamTrack=i,await new Promise(((e,i)=>{this.handleReplaceTrack(t.track,e,i,!0)}))}}}filterTobePublishedTracks(e,i,n){const s=[],o=this.getAllTracks();e=e.filter((e=>-1===o.indexOf(e))),e=te(e);let a,r=!1;const c=this.localTrackMap.get(Mi.LocalAudioTrack);for(const o of e){if(o instanceof Je&&(this.localTrackMap.has(Mi.LocalVideoTrack)||r?new l(h.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(s.push({track:o,type:Mi.LocalVideoTrack}),r=!0),i)){const e=this.getLowVideoTrack(o,n);s.push({track:e,type:Mi.LocalVideoLowTrack})}if(o instanceof qe)if(c){const e=c.track;if(e instanceof Ze)fo([o]),e.addAudioTrack(o),this.bindLocalAudioTrackEvents(o,!0);else{const i=Co([e,o]);t.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(i.getTrackId(),"]")),this.replaceTrack(e,i)}}else if(a instanceof Ze)fo([o]),a.addAudioTrack(o);else if(a||!o._useAudioElement&&Xe().webAudioMediaStreamDest&&!o._bypassWebAudio){a=Co(a?[o,a]:[o])}else a=o}return a&&(t.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will send audioTrack [").concat(a.getTrackId(),"]")),s.push({track:a,type:Mi.LocalAudioTrack})),s}filterTobeUnpublishedTracks(e){const t=[],i=this.getAllTracks();e=e.filter((e=>-1!==i.indexOf(e))),e=te(e);for(const i of e){if(i instanceof qe){const e=this.localTrackMap.get(Mi.LocalAudioTrack);if(!e)continue;e.track instanceof Ze?(e.track.removeAudioTrack(i),this.unbindLocalAudioTrackEvents(i),0===e.track.trackList.length&&(t.push([Mi.LocalAudioTrack,e]),e.track.close())):t.push([Mi.LocalAudioTrack,e])}if(i instanceof Je){const e=this.localTrackMap.get(Mi.LocalVideoTrack);if(!e)continue;t.push([Mi.LocalVideoTrack,e]);const i=this.localTrackMap.get(Mi.LocalVideoLowTrack);i&&t.push([Mi.LocalVideoLowTrack,i])}}return t}filterTobePublishedDataChannels(e){return e=(e=te(e)).filter((e=>-1===this.localDataChannels.findIndex((t=>t.id===e.id))))}filterTobeUnpublishedDataChannels(e){return e=(e=(e=te(e)).filter((e=>-1!==this.localDataChannels.indexOf(e)))).filter((e=>e._originDataChannel))}bindLocalTrackEvents(e){e.forEach((e=>{let{track:t,type:i}=e;switch(i){case Mi.LocalVideoTrack:t.addListener(rt.GET_STATS,this.handleGetLocalVideoStats),t.addListener(rt.GET_RTC_STATS,this.handleGetRTCStats),t.addListener(rt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(rt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(rt.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.addListener(rt.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),t.addListener(rt.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.addListener(rt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(rt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case Mi.LocalAudioTrack:this.bindLocalAudioTrackEvents(t);case Mi.LocalVideoLowTrack:}}))}bindLocalAudioTrackEvents(e,t){e instanceof Ze?e.trackList.forEach((e=>{e.addListener(rt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(rt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(rt.GET_STATS,this.handleGetLocalAudioStats),e.addListener(rt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(rt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.addListener(rt.GET_STATS,this.handleGetLocalAudioStats),e.addListener(rt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(rt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(rt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(rt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),t||(e.addListener(rt.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.addListener(rt.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack)))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map((e=>{let[t,{track:i}]=e;return{track:i,type:t}}))),e.forEach((e=>{let{track:t,type:i}=e;switch(i){case Mi.LocalVideoTrack:t.off(rt.GET_STATS,this.handleGetLocalVideoStats),t.off(rt.GET_RTC_STATS,this.handleGetRTCStats),t.off(rt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(rt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(rt.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.off(rt.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),t.off(rt.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(rt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(rt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case Mi.LocalAudioTrack:this.unbindLocalAudioTrackEvents(t);case Mi.LocalVideoLowTrack:}}))}unbindLocalAudioTrackEvents(e){e instanceof Ze?e.trackList.forEach((e=>{e.off(rt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(rt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(rt.GET_STATS,this.handleGetLocalAudioStats),e.off(rt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(rt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.off(rt.GET_STATS,this.handleGetLocalAudioStats),e.off(rt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(rt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(rt.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(rt.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack),e.off(rt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(rt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,t){t instanceof at&&t.addListener(rt.GET_STATS,(t=>{t(this.handleGetRemoteVideoStats(e))})),t instanceof ot&&t.addListener(rt.GET_STATS,(t=>{t(this.handleGetRemoteAudioStats(e))}))}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(rt.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,i]=e;i.has(Pi.AUDIO)&&this.unbindRemoteTrackEvents(t._audioTrack),i.has(Pi.VIDEO)&&this.unbindRemoteTrackEvents(t._videoTrack)}))}createGatewayPublishMessage(e,t){return e.map(((e,i)=>{let n,s,{track:o,type:a}=e;switch(a){case Mi.LocalAudioTrack:n=Ri.Audio,s={dtx:o instanceof st&&o._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case Mi.LocalVideoTrack:n=o._hints.includes(ze.SCREEN_TRACK)?Ri.Screen:Ri.High,s=Xt(Xt({},_n(o)),{},{codec:this.store.codec,svc_mode:An()});break;case Mi.LocalVideoLowTrack:n=Ri.Low,s=Xt(Xt({},_n(o)),{},{codec:this.store.codec,svc_mode:An()})}return{stream_type:n,attributes:s,ssrcs:t[i]}}))}createGatewayUnpublishMessage(e){return e.map((e=>{let t,[i,{track:n,ssrcs:s,id:o}]=e;switch(i){case Mi.LocalVideoTrack:t=n._hints.includes(ze.SCREEN_TRACK)?Ri.Screen:Ri.High;break;case Mi.LocalAudioTrack:t=Ri.Audio;break;case Mi.LocalVideoLowTrack:t=Ri.Low}return{stream_type:t,ssrcs:s,mid:o}}))}assignLocalTracks(e,t){e.forEach(((e,i)=>{let{track:n,type:s}=e;this.localTrackMap.set(s,{track:n,id:t[i].id,ssrcs:t[i].localSSRC})}))}withdrawLocalTracks(e){e.forEach((e=>{let[t]=e;this.localTrackMap.delete(t)}))}bindConnectionEvents(e){e.onConnectionStateChange=async i=>{if(t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(i,")")),this.emit(Vi.PeerConnectionStateChange,i),"connected"!==i||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),"connected"===i&&(this._restartTimer&&(clearTimeout(this._restartTimer),this._restartTimer=void 0),(this._isFirstConnected||this._isInRestartIce)&&this.reportPCStats(Date.now(),!0,this._pcStatsUploadType),this._isInRestartIce=!1,this._isFirstConnected=!1,this._isStartRestartIce=!1),E("NEW_ICE_RESTART")){if(this._restartStates.includes(i)){if(this._isStartRestartIce)return;this._isStartRestartIce=!0;const i=i=>{if("disconnected"===e.iceConnectionState||"checking"===e.iceConnectionState||"failed"===e.iceConnectionState){t.debug("[".concat(this.store.clientId,"] [P2PChannel] start use restartICE, type is ").concat(i));"CONNECTED"===y(this,Vi.QueryClientConnectionState)&&this.emit(Vi.RequestRestartICE,i)}},n=()=>{"disconnected"!==e.iceConnectionState&&"checking"!==e.iceConnectionState&&"failed"!==e.iceConnectionState||(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),t.debug("[".concat(this.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout((()=>this.emit(Vi.P2PLost)),0),this.iceFailedCount+=1,this.requestReconnect())},s=E("ICE_RESTART_INTERVAL");return void(this._restartTimer=window.setTimeout((()=>{if(E("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&Xe().supportPCSetConfiguration)i(Li.RELAY),this._restartTimer=window.setTimeout(n,s);else if(f())i(Li.UDP),this._restartTimer=window.setTimeout(n,4e3);else{if(i(Li.TCP),Xe().supportPCSetConfiguration)return void(this._restartTimer=window.setTimeout((()=>{i(Li.RELAY),this._restartTimer=window.setTimeout(n,s)}),s));this._restartTimer=window.setTimeout(n,s)}}),800))}}else{if("disconnected"===i&&"disconnected"===e.iceConnectionState)return setTimeout((()=>{if("disconnected"===e.iceConnectionState&&E("ICE_RESTART")){"CONNECTED"===y(this,Vi.QueryClientConnectionState)&&this.emit(Vi.RequestRestartICE)}}),800),void setTimeout((()=>{"disconnected"===e.peerConnectionState&&(t.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isInRestartIce=!1,setTimeout((()=>this.emit(Vi.P2PLost)),0),this.iceFailedCount+=1,this.requestReconnect())}),4e3);"failed"===i&&(t.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection state failed, force reconnect")),this.reportPCDisconnectedOrFailed(),setTimeout((()=>this.emit(Vi.P2PLost)),0),this.iceFailedCount+=1,await this.requestReconnect())}},e.onICEConnectionStateChange=e=>{"connected"!==e||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),i.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:q.TRACER}).onSuccess(),this.emit(Vi.IceConnectionStateChange,e)},e.onICETransportStateChange=e=>{t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},e.onDTLSTransportStateChange=e=>{t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},e.onDTLSTransportError=e=>{t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},e.onFirstAudioDecoded=e=>{const t=Array.from(this.remoteUserMap.keys()).find((t=>t._audioSSRC===e));var o;t&&(this.store.subscribe(t.uid,"audio",void 0,void 0,void 0,Date.now()),null===(o=t.audioTrack)||void 0===o||o.emit(ct.FIRST_FRAME_DECODED),i.firstRemoteFrame(this.store.sessionId,n.FIRST_AUDIO_DECODE,s.FIRST_AUDIO_DECODE,{peer:t._uintid,subscribeElapse:Ds.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=e=>{const t=Array.from(this.remoteUserMap.keys()).find((t=>t._audioSSRC===e));t&&i.firstRemoteFrame(this.store.sessionId,n.FIRST_AUDIO_RECEIVED,s.FIRST_AUDIO_RECEIVED,{peer:t._uintid,subscribeElapse:Ds.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(e,t,i)=>{this.reportVideoFirstFrameDecoded(e,t,i)},e.onFirstVideoReceived=e=>{const t=Array.from(this.remoteUserMap.keys()).find((t=>t._videoSSRC===e));t&&i.firstRemoteFrame(this.store.sessionId,n.FIRST_VIDEO_RECEIVED,s.FIRST_VIDEO_RECEIVED,{peer:t._uintid,subscribeElapse:Ds.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},e.onSelectedLocalCandidateChanged=(e,i)=>{const n="relay"===e.candidateType,s="relay"===i.candidateType;"unknown"!==i.candidateType&&n===s||this.emit(Vi.ConnectionTypeChange,n),t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(Cn(i))," -> ").concat(JSON.stringify(Cn(e)),")"))},e.onSelectedRemoteCandidateChanged=(e,i)=>{t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(Cn(i))," -> ").concat(JSON.stringify(Cn(e)),")"))},e.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)},e.getLocalVideoStats=()=>{const e=this.statsCollector.getLocalVideoTrackStats(),t=this.statsCollector.getRTCStats();return Xt(Xt({},e),t)}}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0,e.getLocalVideoStats=void 0}filterTobeMutedTracks(e){const t=[];if(-1===this.getAllTracks().indexOf(e))return t;const i=this.localTrackMap.get(Mi.LocalAudioTrack);if(e instanceof qe&&(null==i?void 0:i.track)instanceof Ze)return i.track.isActive||t.push([Mi.LocalAudioTrack,i]),t;const n=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(n&&(t.push(n),n[0]===Mi.LocalVideoTrack)){const e=this.localTrackMap.get(Mi.LocalVideoLowTrack);e&&t.push([Mi.LocalVideoLowTrack,e])}return t}filterTobeUnmutedTracks(e){const t=[],i=this.localTrackMap.get(Mi.LocalAudioTrack);if(e instanceof qe&&(null==i?void 0:i.track)instanceof Ze)return i.track.isActive&&t.push([Mi.LocalAudioTrack,i]),t;const n=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(n)if(n[0]===Mi.LocalVideoTrack){t.push(n);const e=this.localTrackMap.get(Mi.LocalVideoLowTrack);e&&t.push([Mi.LocalVideoLowTrack,e])}else t.push(n);return t}createMuteMessage(e){return e.map((e=>{let t,[i,{track:n,ssrcs:s,id:o}]=e;switch(i){case Mi.LocalAudioTrack:t=Ri.Audio;break;case Mi.LocalVideoTrack:t=n._hints.includes(ze.SCREEN_TRACK)?Ri.Screen:Ri.High;break;case Mi.LocalVideoLowTrack:t=Ri.Low}return{stream_type:t,ssrcs:s,mid:o}}))}createUnmuteMessage(e){return e.map((e=>{let t,[i,{track:n,ssrcs:s,id:o}]=e;switch(i){case Mi.LocalAudioTrack:t=Ri.Audio;break;case Mi.LocalVideoTrack:t=n._hints.includes(ze.SCREEN_TRACK)?Ri.Screen:Ri.High;break;case Mi.LocalVideoLowTrack:t=Ri.Low}return{stream_type:t,ssrcs:s,mid:o}}))}filterTobeUnSubscribedTracks(e,t){const i=[],n=this.remoteUserMap.get(e);if(!n)return i;if(t){const s=n.get(t);if(!s)return i;i.push([e,{kind:t,id:s}])}else Array.from(n.entries()).forEach((t=>{let[n,s]=t;i.push([e,{kind:n,id:s}])}));return i}filterTobeUnSubscribedDataChannels(e,t){const i=[];return t.forEach((t=>{var n;null!==(n=this.remoteDataChannelMap.get(e))&&void 0!==n&&n.has(t.id)&&i.push(t)})),i}createUnsubscribeMessage(e){const t=[];return e.forEach((e=>{let[i,{kind:n,id:s}]=e;switch(n){case Pi.VIDEO:return void(i._videoSSRC&&t.push({stream_type:Pi.VIDEO,ssrcId:i._videoSSRC}));case Pi.AUDIO:return void(i._audioSSRC&&t.push({stream_type:Pi.AUDIO,ssrcId:i._audioSSRC}))}})),t}createUnsubscribeAllMessage(e){const t=new Map;return e.forEach((e=>{let[i,{kind:n}]=e;if(t.has(i)){let e=t.get(i);n===Pi.VIDEO?e|=Ai.Video:e|=Ai.Audio,t.set(i,e)}else n===Pi.VIDEO?t.set(i,Ai.Video):t.set(i,Ai.Audio)})),{users:Array.from(t.entries()).map((e=>{let[t,i]=e;return{stream_id:t.uid,stream_type:i}}))}}withdrawRemoteTracks(e){e.forEach((e=>{let[t,{kind:i}]=e;const n=this.remoteUserMap.get(t);n&&(n.delete(i),0===Array.from(n.entries()).length&&this.remoteUserMap.delete(t))}))}async updateBitrateLimit(e){const t=this.localTrackMap.get(Mi.LocalVideoTrack),i=this.localTrackMap.get(Mi.LocalVideoLowTrack);t&&await t.track.setBitrateLimit(e.uplink),i&&e.low_stream_uplink&&await i.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0})}isP2PDisconnected(){if(this.connection){return"connected"!==this.connection.peerConnectionState}return!0}mapPubResToRemoteConfig(e,t){return e.map(((e,i)=>{var n;let{stream_type:s}=e;return null===(n=t.find((e=>{let{stream_type:t}=e;return s===t})))||void 0===n?void 0:n.attributes}))}async tryToUnmuteAudio(e){for(let i=0;i<e.length;i++)if(e[i]instanceof qe){var t;const n=this.filterTobeUnmutedTracks(e[i]);if(0===n.length)continue;await(null===(t=this.connection)||void 0===t?void 0:t.unmuteLocal(n.map((e=>{let[,{id:t}]=e;return t}))));const s=this.createUnmuteMessage(n);return void await ee(this,Vi.RequestUnmuteLocal,s)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var t;return!(null===(t=this.connection)||void 0===t||!t.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,t)=>this.emit(Vi.RequestUpload,e,t),this.statsUploader.requestUploadStats=e=>this.emit(Vi.RequestUploadStats,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await A(g(this.dtlsFailedCount,X)),this.emit(Vi.RequestReconnect)}async reconnectP2P(){const e=Array.from(this.localTrackMap.entries()),t=this.createGatewayUnpublishMessage(e);Array.from(this.remoteUserMap.entries()),t.length>0&&await v(this,Vi.RequestUnpublishForReconnectPC,t),this.disconnectForReconnect(),this.emit(Vi.RequestReconnectPC)}canPublishLowStream(){return this.localTrackMap.has(Mi.LocalVideoTrack)||this.pendingLocalTracks.some((e=>e instanceof Je))}throwIfTrackTypeNotMatch(e){if(e.filter((e=>e instanceof Je)).length>1)throw new l(h.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter((e=>e instanceof qe)).length>1&&(e.some((e=>e instanceof qe&&e._bypassWebAudio))||!Xe().webAudioMediaStreamDest))throw new l(h.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const t of e){if(t instanceof Je&&this.pendingLocalTracks.some((e=>e instanceof Je)))throw new l(h.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t instanceof qe&&this.pendingLocalTracks.some((e=>e instanceof qe))&&(!Xe().webAudioMediaStreamDest||t._bypassWebAudio||this.pendingLocalTracks.some((e=>e instanceof qe&&e._bypassWebAudio))))throw new l(h.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,t){const i=!E("DISABLE_DUAL_STREAM_USE_ENCODING")&&Xe().supportDualStreamEncoding,n=Xt(Xt({},{width:160,height:120,framerate:15,bitrate:50}),t);let s;s=i?e._mediaStreamTrack.clone():Qs(e,n);const o=O(8,"track-low-"),a=new Je(s,Xt(Xt({},i&&{scaleResolutionDownBy:fn(n,e)}),{},{frameRate:n.framerate,bitrateMax:n.bitrate,bitrateMin:n.bitrate}),void 0,void 0,o);return a.on(dt.TRANSCEIVER_UPDATED,(t=>{e._updateRtpTransceiver(t,lt.LOW_STREAM)})),a._hints.push(ze.LOW_STREAM),e.on("sei-to-send",(e=>{a.emit("sei-to-send",e)})),e.addListener(rt.NEED_CLOSE,(()=>{a.close()})),a}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}async reportPCStats(e,t,n){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(this.connection&&this.connection instanceof $o){var o,a,r,c;const d=this.store.keyMetrics.descriptionStart||0,{iceConnectionState:l,dtlsTransportState:h,peerConnectionState:u}=this.connection,{local:p,remote:_}=await this.connection.getSelectedCandidatePair();i.pcStats(this.store.sessionId,{startTime:d,eventElapse:e-d||0,iceconnectionsate:l,dtlsstate:h,connectionstate:u,intSucc:t?1:2,error:s,selectedLocalCandidateProtocol:null!==(o=null==p?void 0:p.protocol)&&void 0!==o?o:"",selectedLocalCandidateType:null!==(a=p.candidateType)&&void 0!==a?a:"",selectedLocalCandidateAddress:"".concat(p.address,":").concat(p.port),selectedRemoteCandidateProtocol:null!==(r=_.protocol)&&void 0!==r?r:"",selectedRemoteCandidateType:null!==(c=_.candidateType)&&void 0!==c?c:"",selectedRemoteCandidateAddress:"".concat(_.address,":").concat(_.port),restartCnt:n,preallocation:this.connection.isPreallocation})}}reportVideoFirstFrameDecoded(e,t,o,a){const r=Array.from(this.remoteUserMap.keys()).find((t=>t._videoSSRC===e));if(r){a||this.store.subscribe(r.uid,"video",void 0,void 0,void 0,void 0,Date.now());const c=this.store.keyMetrics,d=c.subscribe.find((e=>e.userId===r.uid&&"video"===e.type));i.firstRemoteVideoDecode(this.store.sessionId,n.FIRST_VIDEO_DECODE,s.FIRST_VIDEO_DECODE,{peer:r._uintid,videowidth:t,videoheight:o,subscribeElapse:Ds.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:c.requestAPEnd||0,apStart:c.requestAPStart||0,joinGwEnd:c.joinGatewayEnd||0,joinGwStart:c.joinGatewayStart||0,pcEnd:c.peerConnectionEnd||0,pcStart:c.peerConnectionStart||0,subscriberEnd:(null==d?void 0:d.subscribeEnd)||0,subscriberStart:(null==d?void 0:d.subscribeStart)||0,videoAddNotify:(null==d?void 0:d.streamAdded)||0,state:a?1:0,firstFrame:(null==d?void 0:d.firstFrame)||0})}}async remoteMediaSsrcChanged(e,t,i){if(!this.connection)return!1;const n=this.remoteUserMap.get(e);if(!n)return!1;const s=n.get(t);if(!s)return!1;const o=await this.connection.getRemoteSSRC(s);return void 0!==o&&o!==i}unbindRtpTransceiver(){0!==this.localTrackMap.size&&Array.from(this.localTrackMap.entries()).forEach((e=>{let[t,{track:i}]=e;t===Mi.LocalVideoLowTrack?i._updateRtpTransceiver(void 0,lt.LOW_STREAM):i._updateRtpTransceiver(void 0)}))}reportPCDisconnectedOrFailed(e){this.connection&&this.connection instanceof $o&&("disconnected"!==this.connection.iceConnectionState&&"checking"!==this.connection.iceConnectionState&&"failed"!==this.connection.iceConnectionState||(this._isFirstConnected?(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isFirstConnected=!1):this._pcStatsUploadType===ki.TCP_RESTART&&e===Li.RELAY?this.reportPCStats(Date.now(),!1,this._pcStatsUploadType):this.reportPCStats(Date.now(),!1,ki.DISCONNECTED_OR_FAILED)))}}).prototype,"startP2PConnection",[na],Object.getOwnPropertyDescriptor(ta.prototype,"startP2PConnection"),ta.prototype),jt(ta.prototype,"connect",[na],Object.getOwnPropertyDescriptor(ta.prototype,"connect"),ta.prototype),jt(ta.prototype,"updateRemoteRTPCapabilities",[na],Object.getOwnPropertyDescriptor(ta.prototype,"updateRemoteRTPCapabilities"),ta.prototype),jt(ta.prototype,"publishDataChannel",[na],Object.getOwnPropertyDescriptor(ta.prototype,"publishDataChannel"),ta.prototype),jt(ta.prototype,"unpublish",[na],Object.getOwnPropertyDescriptor(ta.prototype,"unpublish"),ta.prototype),jt(ta.prototype,"unpublishDataChannel",[na],Object.getOwnPropertyDescriptor(ta.prototype,"unpublishDataChannel"),ta.prototype),jt(ta.prototype,"unpublishLowStream",[na],Object.getOwnPropertyDescriptor(ta.prototype,"unpublishLowStream"),ta.prototype),jt(ta.prototype,"subscribeDataChannel",[na],Object.getOwnPropertyDescriptor(ta.prototype,"subscribeDataChannel"),ta.prototype),jt(ta.prototype,"subscribe",[na],Object.getOwnPropertyDescriptor(ta.prototype,"subscribe"),ta.prototype),jt(ta.prototype,"massSubscribe",[na],Object.getOwnPropertyDescriptor(ta.prototype,"massSubscribe"),ta.prototype),jt(ta.prototype,"unsubscribe",[na],Object.getOwnPropertyDescriptor(ta.prototype,"unsubscribe"),ta.prototype),jt(ta.prototype,"unsubscribeDataChannel",[na],Object.getOwnPropertyDescriptor(ta.prototype,"unsubscribeDataChannel"),ta.prototype),jt(ta.prototype,"massUnsubscribe",[na],Object.getOwnPropertyDescriptor(ta.prototype,"massUnsubscribe"),ta.prototype),jt(ta.prototype,"muteRemote",[na],Object.getOwnPropertyDescriptor(ta.prototype,"muteRemote"),ta.prototype),jt(ta.prototype,"unmuteRemote",[na],Object.getOwnPropertyDescriptor(ta.prototype,"unmuteRemote"),ta.prototype),jt(ta.prototype,"hasRemoteMediaWithLock",[na],Object.getOwnPropertyDescriptor(ta.prototype,"hasRemoteMediaWithLock"),ta.prototype),jt(ta.prototype,"disconnectForReconnect",[na],Object.getOwnPropertyDescriptor(ta.prototype,"disconnectForReconnect"),ta.prototype),jt(ta.prototype,"updateBitrateLimit",[na],Object.getOwnPropertyDescriptor(ta.prototype,"updateBitrateLimit"),ta.prototype),jt(ta.prototype,"remoteMediaSsrcChanged",[na],Object.getOwnPropertyDescriptor(ta.prototype,"remoteMediaSsrcChanged"),ta.prototype),ta);function na(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("From P2PChannel.".concat(t));try{for(var s=arguments.length,o=new Array(s),a=0;a<s;a++)o[a]=arguments[a];return await n.apply(this,o)}finally{i()}},i}const sa={};function oa(e){const t=sa[e];if(!t)throw new l(h.INVALID_OPERATION,"".concat(e," not found, please use AgoraRTC.use(").concat(e,"Service) to load it first"));return t}function aa(e,t){return oa("DataStream").create(e,t)}const ra=Date.now(),ca=20,da=new Map,la=new Map;async function ha(e){const t=da.get(e),i=Array.isArray(t)&&t[t.length-1],n=la.get(e);if(!i)return void(n.isSyncing=!1);const s={uid:i.uid,payload:i.payload};0===n.firstRecvTs&&(n.firstRecvTs=i.recvTs,n.firstSendTs=i.sendTs);const o=i.sendTs-n.firstSendTs,a=o-(Date.now()-n.firstRecvTs);a>0&&(n.firstRecvTs=Date.now()-o);let r=i.mediaDelay+a;r<=0?(t.pop(),ua(i.context,s),r=0):r=Math.min(r,ca),setTimeout((()=>t.length&&ha(e)),r)}function ua(e,t){e.safeEmit(pe.STREAM_MESSAGE,t.uid,t.payload),e.onStreamMessage&&e.onStreamMessage(t)}function pa(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2?arguments[2]:void 0;if(!e.syncWithAudio)return ua(i,{uid:e.uid,payload:e.payload});const n="".concat(i.id,"-").concat(e.uid),s=da.get(n)||[],o=s.findIndex((t=>e.sendTs>=t.sendTs)),a=Xt(Xt({},e),{},{context:i,mediaDelay:t,recvTs:Date.now()});-1===o?s.push(a):s.splice(o,0,a),da.set(n,s);let r=!1;var c;la.has(n)?r=!(null===(c=la.get(n))||void 0===c||!c.isSyncing):la.set(n,{isSyncing:r,firstRecvTs:0,firstSendTs:0});r||ha(n)}const _a=U().name;async function Ea(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const s=i.reportApiInvoke(null,{tag:q.TRACER,name:Y.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[n]});if(!(e instanceof Je||e instanceof at)){const e=new ui(h.INVALID_TRACK,"the parameter is not a video track");return s.onError(e),e.throw()}n&&n<1e3&&(n=1e3);const o=e instanceof Je?e.getTrackLabel():"remote_track",a=e.getMediaStreamTrack(!0),r=document.createElement("video");r.style.width="1px",r.style.height="1px",r.setAttribute("muted",""),r.muted=!0,r.setAttribute("playsinline",""),r.controls=!1,(ne()||_e())&&(r.style.opacity="0.01",r.style.position="fixed",r.style.left="0",r.style.top="0",document.body.appendChild(r)),r.srcObject=new MediaStream([a]),r.play();const c=document.createElement("canvas");c.width=160,c.height=120;let d=0,l=0;try{const e=Date.now();d=await function(e,i,n,s){let o,a=0,r=null;return new Promise(((c,d)=>{function l(){a>s&&o&&(o(),c(a));const i=n.getContext("2d");if(!i){const e=new ui(h.UNEXPECTED_ERROR,"can not get canvas 2d context.");return t.error(e.toString()),void d(e)}i.drawImage(e,0,0,160,120);const l=i.getImageData(0,0,n.width,n.height),u=Math.floor(l.data.length/3);if(r){for(let e=0;e<u;e+=3)if(l.data[e]!==r[e])return a+=1,void(r=l.data);r=l.data}else r=l.data}setTimeout((()=>{o&&(o(),c(a))}),i),o=$e((()=>{l()}),30)}))}(r,n,c,4),l=Date.now()-e}catch(e){throw s.onError(e),e}_a===V.SAFARI&&(r.pause(),r.remove()),r.srcObject=null;const u=d>4,p={duration:l,changedPicNum:d,deviceLabel:o,result:u};return t.info("[track-".concat(e.getTrackId(),"] check video track active completed. ").concat(JSON.stringify(p))),s.onSuccess(p),u}async function ma(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const s=i.reportApiInvoke(null,{tag:q.TRACER,name:Y.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[n]});if(!(e instanceof qe||e instanceof ot)){const e=new ui(h.INVALID_TRACK,"the parameter is not a audio track");return s.onError(e),e.throw()}n&&n<1e3&&(n=1e3);const o=e instanceof qe?e.getTrackLabel():"remote_track",a=e.getVolumeLevel();let r=a,c=a;const d=Date.now();return new Promise((i=>{const a=setInterval((()=>{const l=e.getVolumeLevel();r=l>r?l:r,c=l<c?l:c;const h=r-c>1e-4,u=Date.now()-d;if(h||u>n){clearInterval(a);const n=h,c={duration:u,deviceLabel:o,maxVolumeLevel:r,result:n};t.info("[track-".concat(e.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(c))),s.onSuccess(c),i(n)}}),200)}))}const Sa="websdk_ng_cache_parameter",fa=E("MAX_PRELOAD_ASYNC_LENGTH"),Ca=1e4,Ta=new Map,Ra=[];let Ia=null,ga=0,Aa=0;const va=new Map,ya=function(e,t){const i=[];let n=0;const s=async()=>{const e=i.shift();e&&await e(),i.length>0&&n<t?s():n--};return async function(){for(var o=arguments.length,a=new Array(o),r=0;r<o;r++)a[r]=arguments[r];return new Promise((async(o,r)=>{i.push((async()=>{try{const t=await e(...a);o(t)}catch(e){r(e)}})),n<t&&(n++,s())}))}}(Na,fa),wa=Dt.CancelToken.source();async function ba(e,t,i,n){return Na(e,t,i,n)}async function Na(e,n,s,o,a,r){try{if(!E("ENABLE_PRELOAD"))return;if(!Xe().supportWebCrypto)return void Ee((()=>{t.warn("Your browser does not support preloading, this feature  be run in a secure environment")}),"preload_webcrypto_not_supported");if(!s&&null!==s)throw new l(h.INVALID_PARAMS,"Invalid token: ".concat(s,". If you don not use token, set it to null"));s&&p(s,"token",1,2047),p(e,"appid",1,2047),pi(n),o&&_i(o);const i=me();t.debug("preload channel ".concat(n,", uid is ").concat(o));const c={appId:e,cname:n,token:s||e,uid:"string"!=typeof o?o:null,sid:i,proxyServer:a};let d,u;"string"==typeof o?(c.stringUid=o,[u,d]=await Promise.all([gs(o,{sid:i,appId:e},wa.token),vs(Xt(Xt({},c),{},{token:s||e,uid:0}),wa.token)]),c.uid=u.uid,d.gatewayInfo.uid=c.uid,d.gatewayInfo.res.uid=c.uid):(r&&(c.stringUid=r),d=await vs(c,wa.token));const _={sid:i,appId:e,cname:n,token:s||e,uid:c.stringUid||o,intUid:c.uid||d.gatewayInfo.uid,stringUid:c.stringUid,ts:Date.now(),sua:u,ap:d};await async function(e){let i;try{e.uid&&Da({appId:e.appId,cname:e.cname,token:e.token,uid:e.uid,stringUid:e.stringUid});const t=Va(e),n=await async function(e,t){try{const i=await window.crypto.subtle.importKey("raw",fe(t),"AES-GCM",!1,["encrypt"]),n=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:new Uint8Array(1)},i,k(window.btoa(JSON.stringify(e))));return L(new Uint8Array(n))}catch(e){return}}(e,e.token||e.appId);if(!n)return;i=Ma(Sa);const s=i?JSON.parse(i):[];s.push({[t]:n}),s.length>E("AP_CACHE_NUM")&&s.shift(),Ua(Sa,JSON.stringify(s))}catch(e){t.warn("Error caching server parameters:",e.message),Ua(Sa,"")}}(_),ga++}catch(e){throw Aa++,function(e){Ia||(Ia=window.setTimeout((()=>{let t="";va.forEach(((e,i)=>{t+="".concat(i,": ").concat(e," ;")})),i.reportApiInvoke(null,{name:Y.PRELOAD,options:{success:ga,failed:Aa,err:t}}).onError(e),ga=0,Aa=0,va.clear(),Ia=null}),Ca));const t=va.get(e.code)||0;va.set(e.code,t+1)}(e),e}}async function Oa(e){try{const t=Da(e);if(!t||"disabled"!==e.cloudProxyServer)return;const i=await async function(e,t){try{const i=await window.crypto.subtle.importKey("raw",fe(t),"AES-GCM",!1,["decrypt"]),n=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(1)},i,k(e));return JSON.parse(window.atob(L(new Uint8Array(n))))}catch(e){return}}(t,e.token||e.appId);if(!i)return;if(!function(e,t){const i=e.cname===t.cname&&e.appId===t.appId&&e.token===t.token;if(!i)return!1;return t.stringUid?e.stringUid===t.stringUid:"number"==typeof t.uid?e.uid===t.uid:e.uid==t.uid}(i,e))return;if(i&&Date.now()-i.ts<E("AP_CACHE_LIFETIME"))return i}catch(e){t.warn("Error get preloadInfo",e.message)}}function Da(e){let i;try{if(i=Ma(Sa),!i)return;const t=JSON.parse(i),n=Va(e),s=function(e,t){for(let i=e.length-1;i>=0;i--)if(t(e[i]))return i;return-1}(t,(e=>n in e));if(-1===s)return;const o=t.splice(s,1)[0];return Ua(Sa,JSON.stringify(t)),o[n]}catch(e){t.warn("Error delete preload info: ".concat(i),e.message),Ua(Sa,"")}}function Pa(e){if(e){let t=Ta.get(e);t&&(window.clearTimeout(t),t=null,Ta.delete(e)),Ra.includes(e)||"disabled"!==e.cloudProxyServer||Ra.push(e)}if(Ta.size<E("AP_CACHE_NUM")&&Ra.length>0){const e=Ra.shift();Ta.set(e,window.setTimeout((async()=>{const{appId:i,cname:n,token:s,stringUid:o,uid:a,proxyServer:r}=e;try{await ya(i,n,s,a,r,o),Ta.has(e)&&Pa(e)}catch(i){t.warn("update preload failed",i.message),La(e)}}),E("AP_UPDATE_INTERVAL")))}}function La(e){const t=Ra.indexOf(e);-1!==t&&Ra.splice(t,1);let i=Ta.get(e);i&&(window.clearTimeout(i),i=null,Ta.delete(e),Pa())}function ka(e,t){const n=e.sua,s=e.ap;t&&n&&i.reqUserAccount(e.sid,{lts:n.requestTime,elapse:n.elapse,success:!0,serverAddr:n.url,stringUid:t,uid:e.intUid,errorCode:null,extend:n.req}),i.reportResourceTiming(e.ap.url,e.sid),i.joinWebProxyAP(e.sid,{lts:s.requestTime,elapse:s.elapse,sucess:1,apServerAddr:s.url,turnServerAddrList:s.proxyInfo.addresses.map((e=>e.ip)).join(","),eventType:"disabled",unilbsServerIds:[ln.CHOOSE_SERVER,ln.CLOUD_PROXY_FALLBACK].toString()}),i.joinChooseServer(e.sid,{lts:s.requestTime,elapse:s.elapse,succ:!0,csAddr:s.url,opid:s.opid,serverList:s.gatewayInfo.gatewayAddrs.map((e=>e.address)),ec:null,cid:s.gatewayInfo.cid.toString(),uid:s.gatewayInfo.uid.toString(),csIp:s.gatewayInfo.csIp,unilbsServerIds:[ln.CHOOSE_SERVER].toString(),isHttp3:s.isHttp3})}function Ma(e){return window.atob(window.localStorage.getItem(e)||"")}function Ua(e,t){window.localStorage.setItem(e,window.btoa(t))}function Va(e){let t="".concat(e.appId,"_").concat(e.cname);return"string"==typeof e.uid&&(t+="_s_".concat(e.uid)),"number"==typeof e.uid&&(t+="_".concat(e.uid)),e.token&&(t+="_".concat(e.token)),Se(t)}const xa={},Fa={};function Ba(e,t){let i,n,s;return t?(s=0<=(e>>>=0)&&e<256)&&(n=Fa[e],n)?n:(i=Ga(e,0,!0),s&&(Fa[e]=i),i):(s=-128<=(e|=0)&&e<128)&&(n=xa[e],n)?n:(i=Ga(e,e<0?-1:0,!1),s&&(xa[e]=i),i)}function Ga(e,t,i){return{low:0|e,high:0|t,unsigned:!!i}}var ja,Wa,Ha,Ka,Ya,qa,Ja,Xa,za,Qa,Za,$a,er,tr,ir,nr,sr,or,ar,rr,cr,dr,lr,hr,ur,pr,_r,Er,mr,Sr,fr,Cr,Tr,Rr,Ir,gr,Ar,vr,yr,wr,br;Ba(0,!0),Ba(0),C.setLogger(t);let Nr=(ja=o(),Wa=o({argsMap:(e,t)=>{if(!Array.isArray(t)){if(!(t instanceof It))return[t];t=[t]}return t.map((e=>e?Object(e).toString():"null"))}}),Ha=o({argsMap:(e,t)=>(t||(t=[]),Array.isArray(t)||t.trackMediaType!==gt.DATA?(Array.isArray(t)||(t=[t]),t.map((e=>e.getTrackId()))):[t.getChannelId()])}),Ka=o({argsMap:(e,t,i,n)=>["object"==typeof t?t.uid:t,i,n]}),Ya=o({argsMap:(e,t,i)=>[t,i]}),qa=o({argsMap:(e,t)=>t.map((e=>{let{user:t,mediaType:i}=e;return[null==t?void 0:t.uid,i]}))}),Ja=o({argsMap:(e,t,i,n)=>["object"==typeof t?t.uid:t,i,n]}),Xa=o({argsMap:(e,t)=>t.map((e=>{let{user:t,mediaType:i}=e;return{uid:null==t?void 0:t.uid,mediaType:i}}))}),za=o(),Qa=o(),Za=o(),$a=o(),er=o(),tr=o(),ir=o(),nr=o(),sr=o(),or=o(),ar=o(),rr=o(),cr=o(),dr=o(),lr=o({argsMap:(e,t)=>[t]}),hr=o(),ur=o(),pr=o(),_r=o(),Er=o(),mr=o(),Sr=o(),fr=o(),Cr=o({argsMap:(e,t)=>(Array.isArray(t)||(t=[t]),[JSON.stringify(t)])}),Tr=o(),Rr=o(),Ir=o(),gr=o(),Ar=o(),vr=o(),yr=o({reportResult:!0}),wr=o(),jt((br=class extends _{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get localDataChannels(){return this._p2pChannel.getAllDataChannels()}get mode(){return this._config.mode}get role(){var e;return(null===(e=this._config)||void 0===e?void 0:e.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(e){let o;if(super(),this.store=void 0,this._uid=void 0,this._channelName=void 0,this._uintUid=void 0,this._users=[],this._config=void 0,this._clientId=void 0,this._appId=void 0,this._sessionId=null,this._key=void 0,this._rtmConfig={},this._joinInfo=void 0,this._gateway=void 0,this._statsCollector=void 0,this._configDistribute=void 0,this._leaveMutex=new C("client-leave"),this._publishMutex=new C("client-publish"),this._renewTokenMutex=new C("client-renewtoken"),this._subscribeMutex=new C("client-subscribe"),this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._encryptDataStream=!1,this._encryptDataStreamKey=null,this._encryptDataStreamIv=null,this._proxyServer=void 0,this._turnServer={servers:[],mode:"auto"},this._cloudProxyServerMode="disabled",this._isDualStreamEnabled=!1,this._defaultStreamFallbackType=void 0,this._lowStreamParameter=void 0,this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._axiosCancelSource=Dt.CancelToken.source(),this._audioVolumeIndicationInterval=void 0,this._networkQualityInterval=void 0,this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0,this._liveTranscodeStreamingClient=void 0,this._liveRawStreamingClient=void 0,this._channelMediaRelayClient=void 0,this._networkQualitySensitivity="normal",this._p2pChannel=void 0,this._useLocalAccessPoint=!1,this._setLocalAPVersion=void 0,this._joinAndNotLeaveYet=!1,this._numberOfJoinCount=0,this._remoteDefaultVideoStreamType=void 0,this._inspect=void 0,this._moderation=void 0,this._license=void 0,this._pendingPublishedUsers=[],this.ntpAlignErrorCount=0,this.remoteInboundOffset=0,this._handleLocalTrackEnable=(e,t,i)=>{this.publish(e,!1).then(t).catch(i)},this._handleLocalTrackDisable=(e,t,i)=>{this.unpublish(e).then(t).catch(i)},this._handleUserOnline=e=>{if(E("BLOCK_LOCAL_CLIENT")&&Bt(e.uid,this.channelName))return void t.debug("[".concat(e.uid,"] will be ignored in local"));this.isStringUID&&"string"!=typeof e.uid&&t.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));const i=this._users.find((t=>t.uid===e.uid));if(i)i._trust_in_room_=!0,i._is_pre_created&&(i._is_pre_created=!1,this.safeEmit(pe.USER_JOINED,i));else{const i=new Eo(e.uid,e.uint_id||e.uid);this._users.push(i),t.debug("[".concat(this._clientId,"] user online"),e.uid),this.safeEmit(pe.USER_JOINED,i)}},this._handleUserOffline=e=>{if(E("BLOCK_LOCAL_CLIENT")&&Bt(e.uid,this.channelName))return;const i=this._users.find((t=>t.uid===e.uid));i&&(this._handleRemoveStream(e),this._handleRemoveDataChannels(e),i._audio_pre_subscribed||i._video_pre_subscribed?i._is_pre_created=!0:Te(this._users,i),this._remoteStreamTypeCacheMap.delete(i.uid),this._streamFallbackTypeCacheMap.delete(i.uid),t.debug("[".concat(this._clientId,"] user offline"),e.uid,"reason:",e.reason),this.safeEmit(pe.USER_LEAVED,i,e.reason))},this._handleAddAudioOrVideoStream=(e,o,a,r,c,d,l)=>{if(E("BLOCK_LOCAL_CLIENT")&&Bt(o,this.channelName))return;const h=this._users.find((e=>e.uid===o));if(!h)return void t.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));t.debug("[".concat(this._clientId,"] stream added with uid ").concat(o,", type ").concat(e)),this.store.subscribe(h.uid,e,void 0,void 0,void 0,Date.now());const u="audio"===e?h.hasAudio:h.hasVideo;h._uintid||(h._uintid=c||o),"audio"===e?h._trust_audio_stream_added_state_=!0:h._trust_video_stream_added_state_=!0,"audio"===e?(h._audio_added_=!0,void 0!==a&&(h._audioSSRC=a),void 0!==r&&(h._cname=r),d&&(h._audioOrtc=d)):(h._video_added_=!0,void 0!==a&&(h._videoSSRC=a),void 0!==r&&(h._cname=r),void 0!==l&&(h._rtxSsrcId=l),d&&(h._videoOrtc=d)),("audio"===e?h.hasAudio:h.hasVideo)&&!u&&(t.info("[".concat(this._clientId,"] remote user ").concat(h.uid," published ").concat(e)),this.safeEmit(pe.USER_PUBLISHED,h,e)),"video"===e?i.onGatewayStream(this._sessionId,n.ON_ADD_VIDEO_STREAM,s.ON_ADD_VIDEO_STREAM,{peer:c||o,ssrc:h._videoSSRC}):i.onGatewayStream(this._sessionId,n.ON_ADD_AUDIO_STREAM,s.ON_ADD_AUDIO_STREAM,{peer:c||o,ssrc:h._audioSSRC}),this._p2pChannel.remoteMediaSsrcChanged(h,e,a).then((i=>{if(i&&(t.debug("[".concat(this._clientId,"] resubscribe ").concat(e," for user ").concat(h.uid," after rejoin because SSRC id changed.")),this._p2pChannel instanceof ia))return this._p2pChannel.unsubscribe(h,e,!0).then((()=>this._subscribe(h,e,!0).catch((e=>{t.error("[".concat(this._clientId,"] resubscribe error"),e.toString())}))))})),this._p2pChannel.hasPendingRemoteMedia(h,e)&&(t.debug("[".concat(this._clientId,"] resubscribe ").concat(e," for user ").concat(h.uid," after reconnect.")),this._subscribe(h,e,!0).catch((e=>{t.error("[".concat(this._clientId,"] resubscribe error"),e.toString())})))},this._handleRemoveStream=e=>{if(E("BLOCK_LOCAL_CLIENT")&&Bt(e.uid,this.channelName))return;const o=this._users.find((t=>t.uid===e.uid));if(!o)return void t.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));t.debug("[".concat(this._clientId,"] stream removed with uid ").concat(e.uid));let a=()=>{};o.hasAudio&&o.hasVideo?a=()=>{t.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished audio track")),this.safeEmit(pe.USER_UNPUBLISHED,o,"audio"),t.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished video track")),this.safeEmit(pe.USER_UNPUBLISHED,o,"video")}:o.hasVideo?a=()=>{t.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished video track")),this.safeEmit(pe.USER_UNPUBLISHED,o,"video")}:o.hasAudio&&(a=()=>{t.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished audio track")),this.safeEmit(pe.USER_UNPUBLISHED,o,"audio")}),o._video_pre_subscribed||o._audio_pre_subscribed||(o._trust_audio_stream_added_state_=!0,o._trust_video_stream_added_state_=!0,o._audio_added_=!1,o._video_added_=!1,this._p2pChannel instanceof ia&&this._p2pChannel.unsubscribe(o).then((e=>{if(e)return this._gateway.unsubscribe(e,o.uid)})),o._audioSSRC=void 0,o._videoSSRC=void 0,o._audioOrtc=void 0,o._videoOrtc=void 0,o._rtxSsrcId=void 0),i.onGatewayStream(this._sessionId,n.ON_REMOVE_STREAM,s.ON_REMOVE_STREAM,{peer:e.uint_id||e.uid}),a()},this._handleSetStreamLocalEnable=(e,i,n)=>{if(E("BLOCK_LOCAL_CLIENT")&&Bt(i,this.channelName))return;const s=this._users.find((e=>e.uid===i));if(!s)return void t.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));t.debug("[".concat(this._clientId,"] local ").concat(e," ").concat(n?"enabled":"disabled"," with uid ").concat(i));const o="audio"===e?s.hasAudio:s.hasVideo;if("audio"===e){s._trust_audio_enabled_state_=!0;const e=s._audio_enabled_;if(s._audio_enabled_=n,s._audio_enabled_===e)return;{const e=s._audio_enabled_?"enable-local-audio":"disable-local-audio";t.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(i,", msg: ").concat(e)),this.safeEmit(pe.USER_INFO_UPDATED,i,e)}}else{s._trust_video_enabled_state_=!0;const e=s._video_enabled_;if(s._video_enabled_=n,s._video_enabled_===e)return;{const e=s._video_enabled_?"enable-local-video":"disable-local-video";t.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(i,", msg: ").concat(e)),this.safeEmit(pe.USER_INFO_UPDATED,i,e)}}const a="audio"===e?s.hasAudio:s.hasVideo;return o!==a?!o&&a?(t.info("[".concat(this._clientId,"] remote user ").concat(i," published ").concat(e)),void this.safeEmit(pe.USER_PUBLISHED,s,e)):("video"===e&&s._videoTrack&&s._videoTrack._destroy(),"audio"===e&&s._audioTrack,this._p2pChannel.muteRemote(s,e),t.info("[".concat(this._clientId,"] remote user ").concat(i," unpublished ").concat(e)),void this.safeEmit(pe.USER_UNPUBLISHED,s,e)):void 0},this._handleMuteStream=(e,i,n)=>{if(E("BLOCK_LOCAL_CLIENT")&&Bt(e,this.channelName))return;t.debug("[".concat(this._clientId,"] receive mute message"),e,i,n);const s=this._users.find((t=>t.uid===e));if(!s)return void t.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(e));const o="audio"===i?s.hasAudio:s.hasVideo;if("audio"===i){s._trust_audio_mute_state_=!0;const i=s._audio_muted_;if(s._audio_muted_=n,s._audio_muted_===i)return;{const i=s._audio_muted_?"mute-audio":"unmute-audio";t.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(e,", msg: ").concat(i)),this.safeEmit(pe.USER_INFO_UPDATED,e,i)}}else{s._trust_video_mute_state_=!0;const i=s._video_muted_;if(s._video_muted_=n,s._video_muted_===i)return;{const i=s._video_muted_?"mute-video":"unmute-video";t.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(e,", msg: ").concat(i)),this.safeEmit(pe.USER_INFO_UPDATED,e,i)}}const a="audio"===i?s.hasAudio:s.hasVideo;if(o!==a){if(!o&&a){return("audio"===i?s._audioSSRC:s._videoSSRC)?(t.info("[".concat(this._clientId,"] remote user ").concat(e," published ").concat(i)),void this.safeEmit(pe.USER_PUBLISHED,s,i)):void t.warning("[".concat(this._clientId,"] remote user ").concat(e," receive ").concat(i," unmute message  before add stream message, ").concat(i," SSRC doesn't exist yet."))}"video"===i&&s._videoTrack&&!s._video_pre_subscribed&&s._videoTrack._destroy(),"audio"===i&&s._audioTrack,this._p2pChannel.muteRemote(s,i),t.info("[".concat(this._clientId,"] remote user ").concat(e," unpublished ").concat(i)),this.safeEmit(pe.USER_UNPUBLISHED,s,i)}},this._handleP2PLost=async e=>{t.debug("[".concat(this._clientId,"] receive p2p lost"),e),parseInt(e.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():t.warning("[".concat(this._clientId,"] P2PLost stream not found"),e)},this._handleTokenWillExpire=()=>{t.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(pe.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)},this._handleBeforeUnload=e=>{"beforeunload"===e.type&&void 0!==e.returnValue&&""!==e.returnValue||(this.leave(),t.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))},this._handleUpdateNetworkQuality=()=>{if("normal"===this._networkQualitySensitivity)return;if(navigator&&void 0!==navigator.onLine&&!navigator.onLine)return void this.safeEmit(pe.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});const e={downlinkNetworkQuality:0,uplinkNetworkQuality:0};e.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),e.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(pe.NETWORK_QUALITY,e)},this._handleP2PAddAudioOrVideoStream=(e,i,n,s)=>{const o=this._users.find((e=>e.uid===i));if(!o)return void t.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));t.debug("[".concat(this._clientId,"] stream added with uid ").concat(i,", type ").concat(e)),this.store.subscribe(o.uid,e,void 0,void 0,void 0,Date.now());const a="audio"===e?o.hasAudio:o.hasVideo;"audio"===e?o._trust_audio_stream_added_state_=!0:o._trust_video_stream_added_state_=!0,"audio"===e?(o._audio_added_=!0,void 0!==n&&(o._audioSSRC=n),void 0!==s&&(o._audioMid=s)):(o._video_added_=!0,void 0!==n&&(o._videoSSRC=n),void 0!==s&&(o._videoMid=s)),("audio"===e?o.hasAudio:o.hasVideo)&&!a&&(t.info("[".concat(this._clientId,"] remote user ").concat(o.uid," published ").concat(e)),this.safeEmit(pe.USER_PUBLISHED,o,e)),this._p2pChannel.hasPendingRemoteMedia(o,e)&&(t.debug("[".concat(this._clientId,"] resubscribe ").concat(e," for user ").concat(o.uid," after reconnect.")),this._subscribe(o,e,!0).catch((e=>{t.error("[".concat(this._clientId,"] resubscribe error"),e.toString())})))},this._config=e,this._clientId=O(5,"client-"),this.store=new Re(e.codec,e.audioCodec,e.mode,this._clientId),this.store.clientCreated(),e.proxyServer&&this.setProxyServer(e.proxyServer,!0),e.turnServer&&this.setTurnServer(e.turnServer,!0),t.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(j," build: ").concat(Ie,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),e.clientRoleOptions)try{ge(e.clientRoleOptions),o=Object.assign({},e.clientRoleOptions)}catch(e){t.warning("[".concat(this._clientId,"] ").concat(e.toString()))}this._statsCollector=new ko(this.store),this._statsCollector.onStatsException=(e,i,n)=>{t.debug("[".concat(this._clientId,"] receive exception msg, code: ").concat(e,", msg: ").concat(i,", uid: ").concat(n)),this.safeEmit(pe.EXCEPTION,{code:e,msg:i,uid:n})},this._statsCollector.onUploadPublishDuration=(e,t,n,s)=>{const o=this._users.find((t=>t.uid===e));o&&i.peerPublishStatus(this._sessionId,{subscribeElapse:s,audioPublishDuration:t,videoPublishDuration:n,peer:o._uintid})},this.store.useP2P="p2p"===e.mode,this._gateway=new Xn(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:e.websocketRetryConfig||X,httpRetryConfig:e.httpRetryConfig||X,forceWaitGatewayResponse:void 0===e.forceWaitGatewayResponse||e.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:e.role,clientRoleOptions:o}),this._configDistribute=new bs,this.store.useP2P?(this._p2pChannel=new Po(this.store,this._statsCollector),this._handleP2PEvents()):this._p2pChannel=new ia(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}async joinMeta(e,t,i,n,s){let o=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],a=arguments.length>6&&void 0!==arguments[6]&&arguments[6];W("JOIN_GATEWAY_USE_443PORT_ONLY",o),W("JOIN_GATEWAY_USE_DUAL_DOMAIN",a);const r=this._gateway.signal.websocket;return r instanceof cn&&(r.use443PortOnly=o,r.tryDoubleDomain=a),Ae("client.join",E("JOIN_MAX_CONCURRENCY"),this.join.bind(this),e,t,i,n,s)}async join(e,n,s,o,a){const r=++this._numberOfJoinCount;this.store.joinStart(),o&&(this.store.uid=o);const c=ve(),d=ye()?window.isSecureContext:"Browser Not Support";if(!ye()&&!c||!window.isSecureContext){const e="The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser";t.warning(e)}"DISCONNECTED"===this.connectionState&&(this.store.avoidJoinStart=Math.round(Date.now()),t.debug("[".concat(this._clientId,"] set avoidJoinStart to ").concat(this.store.avoidJoinStart))),i.setAppId(e);try{if(!s&&null!==s)throw new ui(h.INVALID_PARAMS,"Invalid token: ".concat(s,". If you don not use token, set it to null"));s&&p(s,"token",1,2047),p(e,"appid",1,2047),pi(n),o&&_i(o),a&&p(a,"optionalInfo",1,2047)}catch(t){throw i.reportApiInvoke(me(),{name:Y.JOIN,options:[e,n,s,o],states:{isHttps:c,isSecureContext:d},tag:q.TRACER}).onError(t),t}if(this._leaveMutex.isLocked){t.debug("[".concat(this._clientId,"] join: waiting leave operation"));(await this._leaveMutex.lock())(),t.debug("[".concat(this._clientId,"] join: continue"))}if(this._joinAndNotLeaveYet=!0,"DISCONNECTED"!==this.connectionState){const t=new ui(h.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw i.reportApiInvoke(me(),{name:Y.JOIN,options:[e,n,s,o],states:{isHttps:c,isSecureContext:d},tag:q.TRACER}).onError(t),t}this._gateway.state="CONNECTING";const l=await Oa({appId:e,cname:n,uid:o,stringUid:"string"==typeof o?o:void 0,token:s||e,cloudProxyServer:this._cloudProxyServerMode});if(!this._joinAndNotLeaveYet)throw new ui(h.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));const u=(null==l?void 0:l.sid)||me();t.info("[".concat(this._clientId,"] start join channel ").concat(n,", join number: ").concat(r)),this._sessionId||(this._sessionId=u,this.store.sessionId=this._sessionId);const _=i.reportApiInvoke(u,{name:Y.JOIN,options:[e,n,s,o],states:{isHttps:c,isSecureContext:d},tag:q.TRACER}),m=Xt(Xt({},this._rtmConfig),{},{clientId:this._clientId,appId:e,sid:this._sessionId,cname:n,uid:"string"!=typeof o?o:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:s||e,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:a,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint,preload:!!l},void 0!==this._remoteDefaultVideoStreamType&&{defaultVideoStream:this._remoteDefaultVideoStreamType});if(this._useLocalAccessPoint&&(m.setLocalAPVersion=this._setLocalAPVersion),"string"==typeof o&&(m.stringUid=o,this._uintUid?(m.uid=this._uintUid,this._uintUid=void 0):m.uid=0),"none"!==this._encryptionMode&&this._encryptionSecret){if(m.aesmode=this._encryptionMode,m.aespassword=await we(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new ui(h.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(m.aessalt=this._encryptionSalt)}if(this._encryptDataStream&&("aes-128-gcm2"===this._encryptionMode||"aes-256-gcm2"===this._encryptionMode))if(this._encryptionSalt&&this._encryptionSecret)if(window.crypto.subtle){const e=new TextEncoder,t=E("USE_PURE_ENCRYPTION_MASTER_KEY")?e.encode(m.appId+this._encryptionSecret+this._encryptionSecret):e.encode(m.appId+m.cname+this._encryptionSecret);this._encryptDataStreamIv=await be(this._encryptionMode,t,k(this._encryptionSalt)),this._encryptDataStreamKey=await Ne(this._encryptionMode,t,k(this._encryptionSalt))}else d?t.warning("[".concat(this._clientId,"] encrypt datastream must be running in a secure context, fallback to plain data stream")):t.warning("[".concat(this._clientId,"] current browser do not support WebCrypto ,fallback to plain data stream")),this._encryptDataStream=!1;else this._encryptDataStream=!1,t.debug("[".concat(this._clientId,"] no salt / secret, cannot support encrypt data stream, fallback to plain data stream"));this._startSession(this._sessionId,{channel:n,appId:e,stringUid:m.stringUid});const S=this._sessionId;setTimeout((()=>{"CONNECTING"===this.connectionState&&S===this._sessionId&&i.joinChannelTimeout(this._sessionId,5)}),5e3);try{let o;const a=m.cloudProxyServer;if(["proxy3","proxy4","proxy5"].includes(a)){const e=E("PROXY_SERVER_TYPE3");Array.isArray(e)?m.proxyServer=e[0]:m.proxyServer=e}if(i.setProxyServer(m.proxyServer),t.setProxyServer(m.proxyServer),this.store.requestAPStart(),l){if(t.debug("[".concat(this._clientId,"] get serverInfo Success from Preload Cache ").concat(m.stringUid?", ".concat(m.stringUid," => ").concat(l.intUid):""," ")),m.stringUid&&!m.uid&&(m.uid=l.intUid),o={gatewayInfo:l.ap.gatewayInfo},E("JOIN_WITH_FALLBACK_MEDIA_PROXY")&&"auto"===m.turnServer.mode)if(0===l.ap.proxyInfo.addresses.length)t.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers");else{const e=(await Sn(l.ap.proxyInfo,l.ap.gatewayInfo.uid)).map((e=>({turnServerURL:e.address,tcpport:e.tcpport||Vt.tcpport,udpport:e.udpport||Vt.udpport,username:e.username||Vt.username,password:e.password||Vt.password,forceturn:!1,security:!0})));m.turnServer={mode:"manual",servers:e}}ka(l,m.stringUid)}else{if(m.stringUid&&!m.uid){let e;[e,o]=await Promise.all([Is(m.stringUid,m,this._axiosCancelSource.token,this._config.httpRetryConfig||X,this.store),Rs(m,this._axiosCancelSource.token,this._config.httpRetryConfig||X,!0,this.store)]),t.debug("[".concat(this._clientId,"] getUserAccount Success ").concat(m.stringUid," => ").concat(e)),m.uid=e,o.gatewayInfo.uid=e,o.gatewayInfo.res.uid=e}else o=await Rs(m,this._axiosCancelSource.token,this._config.httpRetryConfig||X,!0,this.store);if(!this._joinAndNotLeaveYet)throw new ui(h.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"))}this.store.requestAPEnd(),setTimeout((()=>{this._configDistribute.startGetConfigDistribute(m,this._axiosCancelSource.token),this._configDistribute.on(Ni.UPDATE_BITRATE_LIMIT,(e=>{this._p2pChannel.updateBitrateLimit(e)}))}),0),this._key=s||e;const r=o.gatewayInfo,c=m.uid?m.uid:r.uid;this._joinInfo=Xt(Xt({},m),{},{cid:r.cid,uid:c,vid:r.vid,apResponse:r.res,apGatewayAddress:r.apGatewayAddress,uni_lbs_ip:r.uni_lbs_ip,gatewayAddrs:r.gatewayAddrs}),this.store.intUid=c;const d=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new ui(h.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));_.onSuccess(d),this._appId=e,this._channelName=m.cname,this._uid=d,this.store.uid=d,setTimeout((()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),window.addEventListener(ne()?"beforeunload":"pagehide",this._handleBeforeUnload),this._statsCollector.startUpdateStats()}),0);const u=m.stringUid?"string uid: ".concat(m.stringUid,",uid: ").concat(m.uid):"uid: ".concat(this._uid);return t.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(n,",").concat(u)),setTimeout((()=>{t.startUpload()}),5e3),this.store.joinEnd(),f=this,Ft.includes(f)||Ft.push(f),"disabled"===this._cloudProxyServerMode&&Xe().supportWebCrypto&&E("ENABLE_PRELOAD")&&Pa(this._joinInfo),d}catch(e){const i=Array.isArray(e)?e[0]:e;throw i&&i.code===h.OPERATION_ABORTED?t.warning("[".concat(this._clientId,"] join number: ").concat(r,", Joining channel failed, rollback"),i):t.error("[".concat(this._clientId,"] join number: ").concat(r,", Joining channel failed, rollback"),i),i.code!==h.OPERATION_ABORTED&&this._numberOfJoinCount===r&&(this._gateway.state="DISCONNECTED",this._reset()),_.onError(i),i}var f}_joinGateway(){if(!this._joinInfo||!this._key)throw new ui(h.INVALID_OPERATION);return this._gateway.join(this._joinInfo,this._key,!("disabled"!==this._joinInfo.cloudProxyServer||this._joinInfo.proxyServer||!E("JOIN_WITH_FALLBACK_SIGNAL_PROXY")))}async leave(){t.info("[".concat(this._clientId,"] Leaving channel")),window.removeEventListener(ne()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),function(e){const t=Ft.indexOf(e);-1!==t&&Ft.splice(t,1)}(this),this._statsCollector.stopUpdateStats();const e=await this._leaveMutex.lock();if("DISCONNECTED"===this.connectionState)return t.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void e();await this._gateway.leave("CONNECTED"!==this.connectionState),t.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),e()}async publish(e){let i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!Array.isArray(e)){if(!(e instanceof It))return this._publishDataChannel(e);e=[e]}if(0===e.length)throw new ui(h.INVALID_PARAMS,"param list is empty");const n=e;if("audience"===this._gateway.role)throw new ui(h.INVALID_OPERATION,"audience can not publish stream");for(const e of n){if(!(e instanceof It))throw new ui(h.INVALID_PARAMS,"parameter is not local track");if(!e._enabled&&i)throw new ui(h.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(e.getTrackId()))}t.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(n.map((e=>"".concat(e.getTrackId()," ")))));const s=await this._publishMutex.lock();await this._configDistribute.awaitConfigDistributeComplete(),i&&n.forEach((e=>{const t=this._configDistribute.getBitrateLimit();e instanceof Je&&t&&e.setBitrateLimit(t.uplink)}));try{await this._publishHighStream(n),t.info("[".concat(this._clientId,"] Publish success, id ").concat(n.map((e=>"".concat(e.getTrackId()," ")))))}catch(e){throw t.error("[".concat(this._clientId,"] publish error"),e.toString()),e}finally{s()}}async _publishDataChannel(e){Ce(e.id,"id",0,65535,!0),Oe(e.ordered,"ordered"),p(e.metadata,"metadata",0,512),t.info("[".concat(this._clientId,"] Publishing datachannels, id ").concat(e.id));const i=await this._publishMutex.lock();try{if(-1!==this._p2pChannel.getAllDataChannels().findIndex((t=>t.id===e.id)))throw new ui(h.INVALID_PARAMS,"Invalid id: ".concat(e.id,". If you want to republish the datachannel, unpublish first"));if(!this._joinInfo||void 0===this._uid)throw new ui(h.INVALID_OPERATION,"Can't publish datachannel, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new ui(h.INVALID_OPERATION,"can not publish datachannel in ".concat(this.connectionState," state"));if("auto"===this._turnServer.mode&&E("FORCE_TURN")&&!E("TURN_ENABLE_TCP")&&!E("TURN_ENABLE_UDP"))throw new ui(h.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");const n=function(e){return aa(e,!1)}(e),s=await this._p2pChannel.publishDataChannel([n]);if(s.length>0){if("number"!=typeof n._originDataChannelId)throw t.error("[".concat(this._clientId,"] can not publish with mediaType datachannel, cannot get RTCDatachannel id")),new ui(h.CREATE_DATACHANNEL_ERROR);try{await Promise.all(s.map((e=>this._uid&&this._gateway.publishDataChannel(this._uid,e,!0)))),await n._waitTillOpen()}catch(e){if(e.code!==h.DISCONNECT_P2P)throw e}}return t.info("[".concat(this._clientId,"] Publish dataChannels success, id ").concat(n.id)),n}catch(e){throw t.error("[".concat(this._clientId,"] publish datachannels error"),e.toString()),e}finally{i()}}async unpublish(e){if(!this._joinInfo||void 0===this._uid)throw new ui(h.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");let i=[];if(e)if(Array.isArray(e))i=e;else{if(!(e instanceof It))return this._unpublishDataChannel([e]);i=[e]}else this.store.useP2P||await this._unpublishDataChannel(),i=this._p2pChannel.getAllTracks(!0);t.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(i.map((e=>"".concat(e.getTrackId()," ")))," "));const n=await this._publishMutex.lock();try{if(this._p2pChannel instanceof Po){const e=await this._p2pChannel.unpublish(i);e&&await this._gateway.sendExtensionMessage(Hi.UNPUBLISH,{unpubMsg:e},!0)}else{const e=await this._p2pChannel.unpublish(i);e&&await this._gateway.unpublish(e,this._uid),t.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(i.map((e=>"".concat(e.getTrackId())))))}}catch(e){throw t.error("[".concat(this._clientId,"] unpublish error"),e.toString()),e}finally{n&&n()}}async _unpublishDataChannel(e){void 0!==e&&0!==e.length||(e=this._p2pChannel.getAllDataChannels()),t.info("[".concat(this._clientId,"] Unpublish datachannels, datachannels ").concat(e.map((e=>"".concat(e.id," ")))," "));const i=await this._publishMutex.lock();try{const n=await this._p2pChannel.unpublishDataChannel(e);n&&await this._gateway.unpublishDataChannel(n),t.info("[".concat(this._clientId,"] Unpublish dataChannel success,dataChannel ").concat(e.map((e=>"".concat(e.id)))))}catch(e){throw t.error("[".concat(this._clientId,"] unpublish dataChannel error"),e.toString()),e}finally{i&&i()}}async subscribe(e,t,i){if(!(e instanceof Eo)){const t=this.remoteUsers.find((t=>t.uid===e));if(!t)throw new ui(h.INVALID_REMOTE_USER,"user is not in the channel");e=t}return"datachannel"===t?this._subscribeDataChannel(e,i):this._subscribe(e,t)}async presubscribe(e,i){if(De(i,"mediaType",["audio","video"]),this._p2pChannel instanceof Po)throw new ui(h.INVALID_OPERATION,"can't presub at p2p mode");if(!this._joinInfo)throw new ui(h.INVALID_OPERATION,"can't presub when not join");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new ui(h.INVALID_OPERATION,"can't presub in ".concat(this.connectionState," state"));const n=i===Pi.AUDIO,s=i===Pi.VIDEO,o=await this._subscribeMutex.lock();try{const{ssrcId:a,ortc:r,rtxSsrcId:c,cname:d,uint_id:l}=await this._gateway.presubscribe(e,i,!0);if(null==a)throw new ui(h.UNEXPECTED_RESPONSE,"no ssrc id");let u=this._users.find((t=>t.uid===e));u||(u=new Eo(e,l||e),u._is_pre_created=!0,this._users.push(u)),d&&(u._cname=d),u._uintid||(u._uintid=l||e),n&&(u._audioSSRC=a,u._audio_pre_subscribed=!0,r&&(u._audioOrtc=r)),s&&(u._videoSSRC=a,u._video_pre_subscribed=!0,r&&(u._videoOrtc=r),null!=c&&(u._rtxSsrcId=c)),t.info("[".concat(this._clientId,"] presub succeed ssrc: ").concat(a)),await this._p2pChannel.subscribe(u,i,a,c,r);const p=n?u._audioTrack:u._videoTrack;if(!p)throw new ui(h.UNEXPECTED_ERROR,"can not find remote track in user");return n&&(u._trust_audio_stream_added_state_=!0,u._audio_added_=!0),s&&(u._trust_video_stream_added_state_=!0,u._video_added_=!0),p}catch(i){throw t.error("[".concat(this._clientId,"] presub user ").concat(e," error"),i),i}finally{o()}}async _subscribeDataChannel(e,i){var n;if(Ce(i,"channelId",0,65535,!0),!this._joinInfo)throw new ui(h.INVALID_OPERATION,"Can't subscribe datachannel, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new ui(h.INVALID_OPERATION,"Can't subscribe datachannel in ".concat(this.connectionState," state"));if(!this._users.find((t=>t===e)))throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),new ui(h.INVALID_REMOTE_USER,"user is not in the channel");if(!e.hasAudio&&!e.hasVideo&&0===e._dataChannels.length)throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),new ui(h.INVALID_REMOTE_USER,"user is not published");const s=null===(n=e._dataChannels)||void 0===n?void 0:n.find((e=>e.id===i));if(!s)throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType datachannel, remote datachannel is not published")),new ui(h.REMOTE_USER_IS_NOT_PUBLISHED);const o=await this._subscribeMutex.lock();t.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: datachannel"));try{const i=await this._p2pChannel.subscribeDataChannel(e,[s]);if(i&&i.includes(s.id))try{var a;if("number"!=typeof s._originDataChannelId)throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType datachannel, cannot get RTCDatachannel")),new ui(h.CREATE_DATACHANNEL_ERROR);const i={id:s.id,datachannelId:s._originDataChannelId,ordered:s.ordered,maxRetransmits:s.maxRetransmits,metadata:null!==(a=s.metadata)&&void 0!==a?a:""};await this._gateway.subscribeDataChannel(e.uid,i,!0),await s._waitTillOpen()}catch(t){if((null==t?void 0:t.code)!==h.WS_ABORT)throw await this._p2pChannel.unsubscribeDataChannel(e,[s]),t;await this._p2pChannel.unsubscribeDataChannel(e,[s]),this._p2pChannel.setPendingRemoteDataChannel(e,s.id)}return t.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: datachannel")),s}finally{o()}}async _p2pSubscribe(e,i,n){if(De(i,"mediaType",["audio","video"]),!this._joinInfo)throw new ui(h.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new ui(h.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find((t=>t===e))){const i=new ui(h.INVALID_REMOTE_USER,"user is not in the channel");throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),i}if(!e.hasAudio&&!e.hasVideo){const i=new ui(h.INVALID_REMOTE_USER,"user is not published");throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),i}if(!n&&("audio"===i&&!e.hasAudio||"video"===i&&!e.hasVideo)){const n=new ui(h.REMOTE_USER_IS_NOT_PUBLISHED);throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(i,", remote track is not published")),n}const s=await this._subscribeMutex.lock();t.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(i));try{if(await this._p2pChannel.hasRemoteMediaWithLock(e,i))await this._p2pChannel.unmuteRemote(e,i);else try{const t="audio"===i?e._audioSSRC:e._videoSSRC,n="audio"===i?e._audioMid:e._videoMid;this.store.subscribe(e.uid,i,Date.now()),this._p2pChannel instanceof Po&&await this._p2pChannel.subscribe(e,i,t,n)}catch(e){throw e}t.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(i)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch((e=>{t.warning("[".concat(this._clientId,"] auto set fallback failed"),e)}));const n="audio"===i?e._audioTrack:e._videoTrack;if(!n)throw new ui(h.UNEXPECTED_ERROR,"can not find remote track in user object");return n}catch(i){throw t.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),i),i}finally{s()}}async _subscribe(e,i,n){if(this._p2pChannel instanceof Po)return this._p2pSubscribe(e,i);if(De(i,"mediaType",["audio","video"]),!this._joinInfo)throw new ui(h.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new ui(h.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find((t=>t===e))){const i=new ui(h.INVALID_REMOTE_USER,"user is not in the channel");throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),i}if(!e.hasAudio&&!e.hasVideo){const i=new ui(h.INVALID_REMOTE_USER,"user is not published");throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),i}if(!(n||("audio"!==i||e.hasAudio&&void 0!==e._audioSSRC)&&("video"!==i||e.hasVideo&&void 0!==e._videoSSRC))){const n=new ui(h.REMOTE_USER_IS_NOT_PUBLISHED);throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(i,", remote track is not published")),n}let s="audio"===i?e._audioSSRC:e._videoSSRC,o="audio"===i?e._audioOrtc:e._videoOrtc,a="video"===i?e._rtxSsrcId:void 0,r={stream_type:"audio"===i?Pi.AUDIO:Pi.VIDEO,ssrcId:s};const c=await this._subscribeMutex.lock();t.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(i));try{if(await this._p2pChannel.hasRemoteMediaWithLock(e,i))await this._p2pChannel.unmuteRemote(e,i);else try{const t="audio"===i?e._audioSSRC:e._videoSSRC;void 0!==t&&t!==s&&(s=t,o="audio"===i?e._audioOrtc:e._videoOrtc,a="video"===i?e._rtxSsrcId:void 0,r={stream_type:"audio"===i?Pi.AUDIO:Pi.VIDEO,ssrcId:s}),Ds.markSubscribeStart(this.store.clientId,s),this.store.subscribe(e.uid,i,Date.now()),await this._p2pChannel.subscribe(e,i,s,a,o);try{this._p2pChannel.isPreSubScribe(s)||await this._gateway.subscribe(e.uid,r,!0)}catch(t){if((null==t?void 0:t.code)!==h.WS_ABORT)throw await this._p2pChannel.unsubscribe(e,i),t;await this._p2pChannel.unsubscribe(e,i,!0),this._p2pChannel.setPendingRemoteMedia(e,i)}this.store.subscribe(e.uid,i,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,e,i)}catch(t){throw this._p2pChannel.reportSubscribeEvent(!1,null==t?void 0:t.code,e,i),t}t.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(i)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch((e=>{t.warning("[".concat(this._clientId,"] auto set fallback failed"),e)}));const n="audio"===i?e._audioTrack:e._videoTrack;if(!n)throw new ui(h.UNEXPECTED_ERROR,"can not find remote track in user object");return n}catch(i){throw t.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),i),i}finally{c()}}async massSubscribe(e){if(Pe(e,"subscribeList"),!this._joinInfo)throw new ui(h.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new ui(h.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));const n=Date.now(),s=new Map,o=await this._subscribeMutex.lock();t.info("[".concat(this._clientId,"]start massSubscribe user ").concat(e.map((e=>{let{user:t,mediaType:i}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(i)})).join("; ")));const a=(e=[...e]).map((e=>{let{user:t,mediaType:i}=e;return{user:t,mediaType:i}})),r=await this._p2pChannel.globalLock();try{for(let i=e.length-1;i>=0;i--){const n=e[i],{user:o,mediaType:r}=n;if(De(r,"mediaType",["audio","video"]),!o){const e=new ui(h.INVALID_PARAMS,"user property does not exist in subscribeList item");throw t.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),e}if(!this._users.find((e=>e===o))){const n=new ui(h.INVALID_REMOTE_USER,"user is not in the channel");t.error("[".concat(this._clientId,"] can not massSubscribe ").concat(o.uid,", this user is not in the channel")),a[i].error=n,e.splice(i,1);continue}if("audio"===r&&(!o.hasAudio||void 0===o._audioSSRC)||"video"===r&&(!o.hasVideo||void 0===o._videoSSRC)){const n=new ui(h.REMOTE_USER_IS_NOT_PUBLISHED);t.error("[".concat(this._clientId,"] can not subscribe ").concat(o.uid," with mediaType ").concat(r,", remote user is not published")),a[i].error=n,e.splice(i,1);continue}const c=Ai.Video|Ai.LwoVideo,d=s.get(o);if(d){if("video"===r?d&c:d&Ai.Audio){e.splice(i,1),t.warning("[".concat(this._clientId,"] repeat massSubscribe user:").concat(o.uid,", mediaType:").concat(r," twice"));continue}s.set(o,d|("video"===r?c:Ai.Audio))}else s.set(o,"video"===r?c:Ai.Audio)}for(let t=e.length-1;t>=0;t--){const i=e[t],{user:n,mediaType:o}=i,a=Ai.Video|Ai.LwoVideo;if(this._p2pChannel.hasRemoteMedia(n,o)){await this._p2pChannel.unmuteRemoteNoLock(n,o);const i=s.get(n);s.set(n,"video"===o?i^a:i^Ai.Audio),e.splice(t,1)}}this.store.massSubscribe(e.map((e=>({userId:e.user.uid,type:e.mediaType}))),n);let c=Array.from(s.entries()).reduce(((e,t)=>{let[i,n]=t;if(0===n)return e;const s={stream_id:i.uid,stream_type:n};return n&Ai.Audio&&(s.audio_ssrc=i._audioSSRC),n&Ai.Video&&(s.video_ssrc=i._videoSSRC),e.push(s),e}),[]);try{e.length>0&&await this._p2pChannel.massSubscribeNoLock(e.map((e=>{let{user:t,mediaType:i}=e;return{user:t,mediaType:i,ssrcId:i===Pi.VIDEO?t._videoSSRC:t._audioSSRC,rtxSsrcId:i===Pi.VIDEO?t._rtxSsrcId:void 0}})));const s=new Map;if(c=c.filter((e=>e.video_ssrc&&!this._p2pChannel.isPreSubScribe(e.video_ssrc)||e.audio_ssrc&&!this._p2pChannel.isPreSubScribe(e.audio_ssrc)||!e.video_ssrc&&!e.audio_ssrc)),c.length>0){const e=await this._gateway.subscribeAll(c,!0);((null==e?void 0:e.users)||[]).forEach((e=>{let{stream_id:t,video_error_code:i,audio_error_code:n,error_code:o}=e;(i||n||o)&&s.set(t,{video_error_code:i,audio_error_code:n,error_code:o})}))}if(Array.from(s.entries()).length>0){const e=[];Array.from(s.entries()).forEach((t=>{let[i,n]=t;const s=this.remoteUsers.find((e=>e.uid===i));if(s){let t;n.error_code||n.video_error_code&&n.audio_error_code?t=void 0:n.video_error_code?t=Pi.VIDEO:n.audio_error_code&&(t=Pi.AUDIO),e.push({user:s,mediaType:t})}})),e.length>0&&await this._p2pChannel.massUnsubscribeNoLock(e)}for(const e of a){const i=s.get(e.user.uid);if(i){const n=i.error_code||"audio"===e.mediaType&&i.audio_error_code||"video"===e.mediaType&&i.video_error_code;if(n){const i=Qi(n);t.error("user:".concat(e.user.uid," mediaType:").concat(e.mediaType," has massSubscribe error ").concat(i.desc)),e.error=new ui(h.SUBSCRIBE_FAILED,"code ".concat(n,": ").concat(i.desc))}}e.error||("video"===e.mediaType?e.track=e.user.videoTrack:e.track=e.user.audioTrack)}return this.store.massSubscribe(a.filter((e=>!e.error)).map((e=>({userId:e.user.uid,type:e.mediaType}))),void 0,Date.now()),a.forEach((e=>{var t;i.subscribe(this.store.sessionId,{succ:!!e.error,ec:(null===(t=e.error)||void 0===t?void 0:t.code)||null,video:e.mediaType===Pi.VIDEO,audio:e.mediaType===Pi.AUDIO,peerid:e.user.uid,subscribeRequestid:e.mediaType===Pi.VIDEO?e.user._videoSSRC:e.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-n),preSsrc:this._p2pChannel.isPreSubScribe(e.user._videoSSRC)},!0)})),t.info("[".concat(this._clientId,"] massSubscribe success ").concat(e.map((e=>{let{user:t,mediaType:i}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(i)})).join("; "))),a}catch(t){throw await this._p2pChannel.massUnsubscribeNoLock(e),t}}finally{r(),o()}}async unsubscribe(e,i,n){if(!(e instanceof Eo)){const t=this.remoteUsers.find((t=>t.uid===e));if(!t)throw new ui(h.INVALID_REMOTE_USER,"user is not in the channel");e=t}if(i||this.store.useP2P){if("datachannel"===i)return this._unsubscribeDataChannel(e,n)}else await this._unsubscribeDataChannel(e,n);if(i&&De(i,"mediaType",["audio","video"]),!this._joinInfo)throw new ui(h.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");if(!this._users.find((t=>t===e))){const i=new ui(h.INVALID_REMOTE_USER,"user is not in the channel");throw t.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),i}t.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: ").concat(i));const s=await this._subscribeMutex.lock();try{if(this._p2pChannel instanceof Po)await this._p2pChannel.unsubscribe(e,i);else{const n=await this._p2pChannel.unsubscribe(e,i);n&&await this._gateway.unsubscribe(n,e.uid),i&&"audio"!==i||(e._audio_pre_subscribed=!1),i&&"video"!==i||(e._video_pre_subscribed=!1),e._is_pre_created&&Te(this._users,e),t.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(e.uid,", mediaType: ").concat(i))}}catch(i){if(i.code===h.DISCONNECT_P2P)return void t.warning("disconnecting p2p, abort unsubscribe request.");throw t.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),i.toString()),i}finally{s()}}async _unsubscribeDataChannel(e,i){if(i&&Ce(i,"id",0,65535,!0),!this._joinInfo)throw new ui(h.INVALID_OPERATION,"Can't unsubscribe datachannel, haven't joined yet!");if(!this._users.find((t=>t===e))){const i=new ui(h.INVALID_REMOTE_USER,"user is not in the channel");throw t.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),i}let n;if("number"==typeof i){const t=e._dataChannels.find((e=>e.id===i));t&&(n=[t])}else n=e._dataChannels;if(void 0===n){const n=new ui(h.REMOTE_USER_IS_NOT_PUBLISHED);throw t.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid," with channelId ").concat(i,", remote datachannel is not published")),n}t.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: datachannel, ids: ").concat(n.map((e=>e.id))));try{const i=await this._p2pChannel.unsubscribeDataChannel(e,n);i&&await this._gateway.unsubscribeDataChannel(i,e.uid),t.info("[".concat(this._clientId,"] unsubscribe datachannel success uid: ").concat(e.uid,", mediaType: datachannel, ids: ").concat(i))}catch(i){if(i.code===h.DISCONNECT_P2P)return void t.warning("disconnecting p2p, abort unsubscribe request.");throw t.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),i.toString()),i}}async massUnsubscribe(e){if(Pe(e,"unsubscribeList"),!this._joinInfo)throw new ui(h.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");t.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(e.map((e=>{let{user:t,mediaType:i}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(i,";")})).join())),e=[...e];const i=new Map;for(let n=e.length-1;n>=0;n--){const{user:s,mediaType:o}=e[n];if(!s){const e=new ui(h.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw t.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),e}De(o,"mediaType",["video","audio",void 0]);if(!this._users.find((e=>e===s))){t.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(s.uid,", user is not in the channel")),e.splice(n,1);continue}const a=Ai.Video|Ai.LwoVideo;if(i.has(s)){const r=i.get(s);let c;switch(o){case"video":c=r&a;break;case"audio":c=r&Ai.Audio;break;default:c=r&(Ai.Audio|a)}if(c){t.warning("[".concat(this._clientId,"] repeat massUnsubscribe user:").concat(s.uid,",mediaType:").concat(o," twice.")),e.splice(n,1);continue}o?"audio"===o?i.set(s,r|Ai.Audio):"video"===o&&i.set(s,r|a):i.set(s,r|Ai.Audio|a)}else o?"audio"===o?i.set(s,Ai.Audio):"video"===o&&i.set(s,a):i.set(s,Ai.Audio|a)}try{const i=await this._p2pChannel.massUnsubscribe(e);i&&await this._gateway.massUnsubscribe(i),t.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(e.map((e=>{let{user:t,mediaType:i}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(i,";")})).join()))}catch(e){if(e.code===h.DISCONNECT_P2P)return void t.warning("[".concat(this._clientId,"] disconnecting p2p, abort unsubscribe request."));throw t.error("[".concat(this._clientId,"] massUnsubscribe error"),e.toString()),e}}async setLowStreamParameter(e){At(e),(!e.width&&e.height||e.width&&!e.height)&&t.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),t.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(e));const i=this._configDistribute.getLowStreamConfigDistribute();if(i&&i.bitrate&&e.bitrate&&i.bitrate<e.bitrate&&(e.bitrate=i.bitrate),this._lowStreamParameter=e,this._isDualStreamEnabled)return this._p2pChannel.updateVideoStreamParameter(e,Mi.LocalVideoLowTrack)}async enableDualStream(){if(!Xe().supportDualStream)throw i.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new ui(h.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new ui(h.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream()}catch(e){throw i.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),e}this._isDualStreamEnabled=!0,i.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),t.info("[".concat(this._clientId,"] enable dual stream"))}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)throw new ui(h.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this._p2pChannel.getLocalMedia(Mi.LocalVideoLowTrack))try{const e=await this._p2pChannel.unpublishLowStream();e&&await this._gateway.unpublish(e,this._joinInfo.stringUid||this._joinInfo.uid)}catch(e){throw i.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),e}this._isDualStreamEnabled=!1,i.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),t.info("[".concat(this._clientId,"] disable dual stream"))}}async setClientRole(e,i){if(Le(e),i&&ge(i),"rtc"===this.mode||"p2p"===this.mode)throw t.warning("[".concat(this._clientId,"]").concat(this.mode," mode can not use setClientRole")),new ui(h.INVALID_OPERATION,"".concat(this.mode," mode can not use setClientRole"));if(i&&i.level&&"host"===e)throw new ui(h.INVALID_OPERATION,"host mode can not set audience latency level");if("audience"===e&&this._p2pChannel.hasLocalMedia())throw new ui(h.INVALID_OPERATION,"can not set client role to audience when publishing stream");await this._gateway.setClientRole(e,i),this._config.role=e,t.info("[".concat(this._clientId,"] set client role to ").concat(e,", level: ").concat(i&&i.level))}getRemoteInboundOffset(){var e;const t=null===(e=this._p2pChannel.getStats())||void 0===e?void 0:e.audioSend[0];if(!t||!t.timestamp)return 0;const i=t.timestamp-Date.now();return Math.abs(i)>1e3+t.rttMs+100?this.ntpAlignErrorCount+=1:this.ntpAlignErrorCount=0,this.ntpAlignErrorCount>=3?i:0}getNtpWallTimeInMs(){return"visible"===document.visibilityState&&(this.remoteInboundOffset=this.getRemoteInboundOffset()),this.remoteInboundOffset+Date.now()+this._gateway.ntpOffset}setProxyServer(e,n){if(p(e,"proxyServer"),!n){if("DISCONNECTED"!==this.connectionState)throw new ui(h.INVALID_OPERATION,"Set proxy server before join channel");if("disabled"!==this._cloudProxyServerMode||this._useLocalAccessPoint)throw new ui(h.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=e,i.setProxyServer(this._proxyServer),t.setProxyServer(this._proxyServer),t.info("[".concat(this._clientId,"] Set proxy server ").concat(n?"by initialize call":""," success."))}setTurnServer(e,i){if(Array.isArray(e)||(e=[e]),!i){if("DISCONNECTED"!==this.connectionState)throw new ui(h.INVALID_OPERATION,"Set turn server before join channel");if("disabled"!==this._cloudProxyServerMode||this._useLocalAccessPoint)throw new ui(h.INVALID_OPERATION,"You have already set the proxy")}if(Z(e))return this._turnServer={servers:e,mode:"original-manual"},void t.info("[".concat(this._clientId,"] Set original turnserver ").concat(i?"by initialize call":""," success: ").concat(e.map((e=>e.urls)).join(","),"."));e.forEach((e=>ke(e))),this._turnServer={servers:e,mode:"manual"},t.info("[".concat(this._clientId,"] Set turnserver ").concat(i?"by initialize call":""," success."))}setLicense(e){if("DISCONNECTED"!==this.connectionState){throw new ui(h.INVALID_OPERATION,"you should set license before join channel")}if(p(e,"license",32,32),!/^[A-Za-z\d]+$/.test(e))throw new ui(h.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=e,t.info("[".concat(this._clientId,"] set license success"),e)}startProxyServer(e){if("DISCONNECTED"!==this.connectionState)throw new ui(h.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||"manual"===this._turnServer.mode||this._useLocalAccessPoint)throw new ui(h.INVALID_OPERATION,"You have already set the proxy");const i=[3,4,5];let n;switch(void 0===e&&(e=3),e){case 1:case 2:throw new ui(h.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:n="proxy3";break;case 4:n="proxy4";break;case 5:n="proxy5";break;default:throw new ui(h.INVALID_PARAMS,"proxy server mode must be ".concat(i.join("|")))}this._cloudProxyServerMode=n,this.store.cloudProxyServerMode=n,t.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if("DISCONNECTED"!==this.connectionState)throw new ui(h.INVALID_OPERATION,"Stop proxy server after leave channel");i.setProxyServer(),t.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",t.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(e){if(!e.accessPoints)throw new ui(h.INVALID_PARAMS,"accessPoints is required.");Pe(e.accessPoints.serverList,"accessPoints.serverList"),p(e.accessPoints.domain,"accessPoints.domain");const i=(e,t)=>{Ce(e,t,0,65535,!0)};let n=443;if(e.accessPoints.port&&(i(e.accessPoints.port,"accessPoints.port"),n=e.accessPoints.port),this._proxyServer||"disabled"!==this._cloudProxyServerMode)throw new ui(h.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");E("CLOSE_AFB_FOR_LOCAL_AP")&&(W("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),W("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));const s=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,o=e.accessPoints.domain,a=e.accessPoints.serverList.map((e=>s.test(e)?"".concat(e.replace(/\./g,"-"),".").concat(o):e)),r=a.map((e=>"".concat(e,":").concat(n)));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,W("WEBCS_DOMAIN",r),W("WEBCS_DOMAIN_BACKUP_LIST",r),W("GATEWAY_DOMAINS",[o]),e.report&&e.report.hostname&&Array.isArray(e.report.hostname)&&e.report.hostname.length?(Pe(e.report.hostname,"report.hostname"),W("EVENT_REPORT_DOMAIN",e.report.hostname[0]),W("EVENT_REPORT_BACKUP_DOMAIN",e.report.hostname[1]||e.report.hostname[0])):(W("EVENT_REPORT_DOMAIN",a[0]),W("EVENT_REPORT_BACKUP_DOMAIN",a[1]||a[0]));let c=6443;e.report&&e.report.port&&(i(e.report.port,"report.port"),c=e.report.port),W("STATS_COLLECTOR_PORT",c),e.report?W("ENABLE_EVENT_REPORT",!0):W("ENABLE_EVENT_REPORT",!1);let d="";e.log&&e.log.hostname&&Array.isArray(e.log.hostname)&&e.log.hostname.length?(Pe(e.log.hostname,"log.hostname"),d=e.log.hostname[0]):d=a[0];let l=6444;e.log&&e.log.port&&(i(e.log.port,"log.port"),l=e.log.port),W("LOG_UPLOAD_SERVER","".concat(d,":").concat(l));let u=[];e.cds&&e.cds.hostname&&Array.isArray(e.cds.hostname)&&e.cds.hostname.length?(Pe(e.cds.hostname,"cds.hostname"),u=e.cds.hostname):u=a;let _=443;e.cds&&e.cds.port&&(i(e.cds.port,"cds.port"),_=e.cds.port),W("CDS_AP",u.map((e=>"".concat(e,":").concat(_)))),e.cds?W("ENABLE_CONFIG_DISTRIBUTE",!0):W("ENABLE_CONFIG_DISTRIBUTE",!1),t.info("set local access point v2 success")}setLocalAccessPoints(e,i){if(Pe(e,"serverList"),p(i,"domain"),this._proxyServer||"disabled"!==this._cloudProxyServerMode)throw new ui(h.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");const n=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;e=e.map((e=>n.test(e)?"".concat(e.replace(/\./g,"-"),".").concat(i):e)),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,W("WEBCS_DOMAIN",e),W("WEBCS_DOMAIN_BACKUP_LIST",e),W("GATEWAY_DOMAINS",[i]),W("EVENT_REPORT_DOMAIN",e[0]),W("EVENT_REPORT_BACKUP_DOMAIN",e[1]||e[0]),W("LOG_UPLOAD_SERVER","".concat(e[0],":6444")),t.info("[".concat(this._clientId,"] set local access point success"))}async setRemoteDefaultVideoStreamType(e){if(De(e,"streamType",[0,1]),this._remoteDefaultVideoStreamType=e,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(e),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(e){throw t.error("[".concat(this._clientId,"] set default remote video stream type error"),e.toString()),e}else t.debug("[".concat(this._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(e))}async setRemoteVideoStreamType(e,i){De(i,"streamType",[0,1]);try{await this._gateway.setRemoteVideoStreamType(e,i),setTimeout((()=>{const t=this._users.find((t=>t.uid===e));t&&t.videoTrack&&t.videoTrack.updateMediaStreamTrackResolution()}),2e3)}catch(e){throw t.error("[".concat(this._clientId,"] set remote video stream type error"),e.toString()),e}t.info("[".concat(this._clientId,"] set remote ").concat(e," video stream type to ").concat(i)),this._remoteStreamTypeCacheMap.set(e,i)}async setStreamFallbackOption(e,i){De(i,"fallbackType",[0,1,2]);try{await this._gateway.setStreamFallbackOption(e,i)}catch(e){throw t.error("[".concat(this._clientId,"] set stream fallback option"),e.toString()),e}t.info("[".concat(this._clientId,"] set remote ").concat(e," stream fallback type to ").concat(i)),this._streamFallbackTypeCacheMap.set(e,i)}setEncryptionConfig(e,i,n,s){Me(e),p(i,"secret");const o=["aes-128-gcm2","aes-256-gcm2"];if(o.includes(e)){if(!n||!(n instanceof Uint8Array&&32===n.length))throw new ui(h.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(n)throw new ui(h.INVALID_PARAMS,"current encrypt mode does not need salt");if(s){if(Oe(s,"encryptDataStream"),!o.includes(e))throw new ui(h.INVALID_PARAMS,"current encrypt mode does not support data stream");this._encryptDataStream=!0}new RegExp("^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'\"|{}\\[\\]])(?=.{8,})").test(i)||t.warning("The secret is not strong:\n      The secret must contain at least 1 lowercase alphabetical character,\n      The secret must contain at least 1 uppercase alphabetical character,\n      The secret must contain at least 1 numeric character,\n      The secret must contain at least one special character,\n      The secret must be eight characters or longer.\n      "),this._encryptionMode=e,this._encryptionSecret=i,n&&(this._encryptionSalt=L(n))}async renewToken(e){if(p(e,"token",1,2047),!this._key||!this._joinInfo)throw new ui(h.INVALID_OPERATION,"renewToken should not be called before user join");const i=this._key;this._key=e,this._joinInfo&&(this._joinInfo.token=e);const n=await this._renewTokenMutex.lock();try{if(E("USE_NEW_TOKEN")){t.debug("[".concat(this._clientId,"] start renew token with ticket from unilbs"));const i=await ws(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||X);t.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:e,ticket:i})}else t.debug("[".concat(this._clientId,"] start renew token without ticket")),await this._gateway.renewToken({token:e});t.debug("[".concat(this._clientId,"] renewToken success"))}catch(e){throw this._key=i,this._joinInfo.token=i,t.error("[".concat(this._clientId,"] renewToken failed"),e.toString()),e}finally{n()}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?t.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval((()=>{const e=this._p2pChannel.getAudioLevels();this.safeEmit(pe.VOLUME_INDICATOR,e)}),E("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){const e=this._statsCollector.getRTCStats(),t=this._gateway.getInChannelInfo();return e.Duration=Math.round(t.duration/1e3),e}async startLiveStreaming(e,t){if(!t){if("h264"!==this.codec)throw new ui(h.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new ui(h.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(e)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(e))throw new ui(h.LIVE_STREAMING_TASK_CONFLICT);const i=t?Ei.TRANSCODE:Ei.RAW;return this._createLiveStreamingClient(i).startLiveStreamingTask(e,i)}setLiveTranscoding(e){return this._createLiveStreamingClient(Ei.TRANSCODE).setTranscodingConfig(e)}async stopLiveStreaming(e){const t=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter((t=>t&&t.hasUrl(e)));if(!t.length)throw new ui(h.INVALID_PARAMS,"can not find live streaming url to stop");await Promise.all(t.map((t=>t&&t.stopLiveStreamingTask(e))))}async startChannelMediaRelay(e){Uo(e);const t=this._createChannelMediaRelayClient();await t.startChannelMediaRelay(e)}async updateChannelMediaRelay(e){Uo(e);const t=this._createChannelMediaRelayClient();await t.updateChannelMediaRelay(e)}async stopChannelMediaRelay(){const e=this._createChannelMediaRelayClient();await e.stopChannelMediaRelay(),this._statsCollector.onStatsChanged&&(this._statsCollector.onStatsChanged=void 0)}async sendStreamMessage(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!this._joinInfo)throw new ui(h.INVALID_OPERATION,"can not send data stream, not joined");if(("string"==typeof e||e instanceof Uint8Array)&&(e={payload:e}),"string"==typeof e.payload){const t=new TextEncoder;e.payload=t.encode(e.payload)}let i=!1;this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&["aes-128-gcm2","aes-256-gcm2"].includes(this._encryptionMode)&&(i=!0,e.payload=await Ue(this._encryptDataStreamIv,this._encryptDataStreamKey,e.payload));if(new Blob([e.payload]).size>1024)throw new ui(h.INVALID_PARAMS,i?"encrypted stream message out of range.":"stream message out of range.");return this._gateway.signal.request(ri.DATA_STREAM,{payload:L(e.payload),syncWithAudio:e.syncWithAudio,sendTs:Date.now()-ra},!t)}sendMetadata(e){if(!this._joinInfo)throw new ui(h.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([e]).size>1024)throw new ui(h.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(ri.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:L(e)})}async sendCustomReportMessage(e){if(Array.isArray(e)||(e=[e]),e.forEach(a),!this._joinInfo)throw new ui(h.INVALID_OPERATION,"can not send custom report, not joined");await i.sendCustomReportMessage(this._joinInfo.sid,e)}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){return this._statsCollector.getRemoteNetworkQualityStats()}async pickSVCLayer(e,i){De(i.spatialLayer,"spatialLayer",[0,1,2,3]),De(i.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(e,i)}catch(e){throw t.error("[".concat(this._clientId,"] pick SVC layer failed"),e.toString()),e}}async setRTMConfig(e){const{apRTM:i=!1,rtmFlag:n}=e;if(Oe(i,"apRTM"),Ce(n,"rtmFlag",0),this._rtmConfig.apRTM=i,this._rtmConfig.rtmFlag=n,t.debug("[".concat(this._clientId,"] setRTMconfig ").concat(JSON.stringify(e)," in ").concat(this.connectionState," state")),("CONNECTED"===this.connectionState||"RECONNECTING"===this.connectionState)&&this._joinInfo)return this._joinInfo.apRTM=i,this._joinInfo.rtmFlag=n,this._gateway.setRTM2Flag(n)}_reset(){if(t.debug("[".concat(this._clientId,"] reset client")),this._axiosCancelSource.cancel(),this._axiosCancelSource=Dt.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo&&La(this._joinInfo),this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId=null,this.store.sessionId=null,this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._encryptDataStreamKey=null,this._encryptDataStreamIv=null,this._pendingPublishedUsers=[],this._users.forEach((e=>{e._audioTrack&&e._audioTrack._destroy(),e._videoTrack&&e._videoTrack._destroy(),e._dataChannels&&(e._dataChannels.forEach((e=>e._close())),e._dataChannels.length=0)})),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),"fallback"===this._cloudProxyServerMode&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new C("client-publish"),this._subscribeMutex=new C("client-subscribe"),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch(e){}if(this._moderation)try{this.setImageModeration(!1)}catch(e){}}_startSession(e,n){var s;const o=e||me();e?t.debug("[".concat(this._clientId,"] new Session ").concat(o)):t.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(o));const a=e?"":this._sessionId||"";this._sessionId=o,this.store.sessionId=o;const r={lts:(new Date).getTime(),mode:this.mode,buildFormat:3,stringUid:(null==n?void 0:n.stringUid)||(null===(s=this._joinInfo)||void 0===s?void 0:s.stringUid),channelProfile:"live"===this.mode?1:0,channelMode:0,isABTestSuccess:Number(this._configDistribute.isSuccess),lsid:a,clientRole:"audience"===this.role?2:1};i.sessionInit(this._sessionId,Xt({cname:n.channel,appid:n.appId},r)),this._joinInfo&&(this._joinInfo.sid=o),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=o)}async _publishHighStream(e){if(!this._joinInfo||void 0===this._uid)throw new ui(h.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new ui(h.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if("auto"===this._turnServer.mode&&E("FORCE_TURN")&&!E("TURN_ENABLE_TCP")&&!E("TURN_ENABLE_UDP"))throw new ui(h.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");t.debug("[".concat(this._clientId,"] publish high stream"));try{const t=await this._p2pChannel.publish(e,this._isDualStreamEnabled,this._lowStreamParameter);if(this._p2pChannel instanceof Po){const e=(await t.next()).value;if(e){try{await this._gateway.sendExtensionMessage(Hi.PUBLISH,e,!0)}catch(e){throw t.throw(e),e}await t.next()}this._p2pChannel.reportPublishEvent(!0,null)}else{const n=(await t.next()).value;if(n){var i;let e;try{e=await this._gateway.publish(this._uid,n,!0)}catch(e){if(e.code!==h.DISCONNECT_P2P)throw t.throw(e),e}await t.next((null===(i=e)||void 0===i?void 0:i.ortc)||[])}this._p2pChannel.reportPublishEvent(!0,null);for(const t of e)t instanceof Je&&t._encoderConfig&&this._gateway.setVideoProfile(t._encoderConfig),!t.muted&&t.enabled||await this._p2pChannel.muteLocalTrack(t)}}catch(t){if(this._p2pChannel.reportPublishEvent(!1,null==t?void 0:t.code,e),(null==t?void 0:t.code)===h.WS_ABORT)return;throw t}}async _publishLowStream(){if(!this._joinInfo||void 0===this._uid)throw new ui(h.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new ui(h.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));t.debug("[".concat(this._clientId,"] publish low stream"));const e=this._configDistribute.getLowStreamConfigDistribute();e&&e.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&e.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=e.bitrate));try{const e=await this._p2pChannel.publishLowStream(this._lowStreamParameter),t=(await e.next()).value;if(t){var i;let n;try{n=await this._gateway.publish(this._uid,t,!0)}catch(t){if(t.code!==h.DISCONNECT_P2P)throw e.throw(t),t}e.next((null===(i=n)||void 0===i?void 0:i.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(e){if(this._p2pChannel.reportPublishEvent(!1,null==e?void 0:e.code,void 0,!0),(null==e?void 0:e.code)===h.WS_ABORT)return;throw e}}_createLiveStreamingClient(e){const t=()=>{if(!this._joinInfo||!this._appId){return new ui(h.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw()}const e=(t={joinInfo:this._joinInfo,appId:this._appId,websocketRetryConfig:this._config.websocketRetryConfig,httpRetryConfig:this._config.httpRetryConfig},oa("LiveStreaming").create(t));var t;return e.onLiveStreamError=(e,t)=>{i.reportApiInvoke(this._sessionId,{name:Y.ON_LIVE_STREAM_ERROR,options:[e,t],tag:q.TRACER}).onSuccess(),this.safeEmit(pe.LIVE_STREAMING_ERROR,e,t)},e.onLiveStreamWarning=(e,t)=>{i.reportApiInvoke(this._sessionId,{name:Y.ON_LIVE_STREAM_WARNING,options:[e,t],tag:q.TRACER}).onSuccess(),this.safeEmit(pe.LIVE_STREAMING_WARNING,e,t)},e.on(mi.REQUEST_WORKER_MANAGER_LIST,((e,t,i)=>{if(!this._joinInfo)return i(new ui(h.INVALID_OPERATION,"can not find join info to get worker manager"));(async function(e,t,i,n){const s=E("UAP_AP").slice(0,E("AJAX_REQUEST_CONCURRENT")).map((e=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(e+"/api/v1?action=uap"):"https://".concat(e,"/api/v1?action=uap")));return await ds(s,e,t,i,n)})(e,this._joinInfo,this._axiosCancelSource.token,X).then(t).catch(i)})),e};return e===Ei.RAW?(this._liveRawStreamingClient=this._liveRawStreamingClient||t(),this._liveRawStreamingClient):(this._liveTranscodeStreamingClient=this._liveTranscodeStreamingClient||t(),this._liveTranscodeStreamingClient)}_createChannelMediaRelayClient(){if(!this._joinInfo){return new ui(h.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw()}if(!this._channelMediaRelayClient){const{sendResolutionWidth:t,sendResolutionHeight:i}=this.getLocalVideoStats(),n=(e={joinInfo:this._joinInfo,clientId:this._clientId,websocketRetryConfig:this._config.websocketRetryConfig,httpRetryConfig:this._config.httpRetryConfig,resolution:{width:t,height:i}},oa("ChannelMediaRelay").create(e));n.on("state",(e=>{e===Ci.RELAY_STATE_FAILURE&&n&&n.dispose(),this.safeEmit(pe.CHANNEL_MEDIA_RELAY_STATE,e)})),n.on("event",(e=>{this.safeEmit(pe.CHANNEL_MEDIA_RELAY_EVENT,e)})),this._channelMediaRelayClient=n,this._statsCollector.onStatsChanged=(e,t)=>{var i;"resolution"===e&&(null===(i=this._channelMediaRelayClient)||void 0===i||i.setVideoProfile(t))}}var e;return this._channelMediaRelayClient}_handleUpdateDataChannel(e,i){const{added:n,deleted:s}=e;if(i){const e=[];this._users.forEach((t=>{t._dataChannels.forEach((i=>{n.every((e=>e.uid!==t._uintid||e.stream_id!==i.id))&&e.push({uid:t._uintid,stream_id:i.id,ordered:i.ordered,max_retrans_times:i.maxRetransmits,metadata:i.metadata})}))})),e.length>0&&this._handleUpdateDataChannel({added:[],deleted:e})}Array.isArray(n)&&n.length>0&&n.forEach((e=>{const{uid:n,stream_id:s,ordered:o,max_retrans_times:a,metadata:r}=e,c=this._users.find((e=>e._uintid===n));if(!c)return void t.error("[".concat(this._clientId,"] can not find target user!(on_add_data_channel)"));t.debug("[".concat(this._clientId,"] data_channel added with uid ").concat(n)),c._uintid||(c._uintid=n);if(!(-1!==c._dataChannels.findIndex((t=>t.id===e.stream_id)))){const e={id:s,ordered:!!o,maxRetransmits:a,metadata:r},n=function(e){return aa(e,!0)}(e);c._dataChannels.push(n),t.info("[".concat(this._clientId,"] remote user ").concat(c.uid," published datachannel")),i||this.safeEmit(pe.USER_PUBLISHED,c,"datachannel",e)}this._p2pChannel.hasPendingRemoteDataChannel(c,e.stream_id)&&(t.debug("[".concat(this._clientId,"] resubscribe datachannel for user ").concat(c.uid," after reconnect.")),this._subscribeDataChannel(c,e.stream_id).catch((e=>{t.error("[".concat(this._clientId,"] resubscribe datachannel error"),e.toString())})))})),i&&(this.safeEmit(pe.PUBLISHED_USER_LIST,this._pendingPublishedUsers),this._pendingPublishedUsers=[]),Array.isArray(s)&&s.length>0&&s.forEach((e=>{const{uid:i,stream_id:n}=e,s=this._users.find((e=>e._uintid===i));if(!s)return void t.error("[".concat(this._clientId,"] can not find target user!(on_delete_data_channel)"));const o=s._dataChannels.find((t=>t.id===e.stream_id));o&&(t.debug("[".concat(this._clientId,"] data_stream delete with uid ").concat(i)),this._p2pChannel.unsubscribeDataChannel(s,[o]).then((e=>{if(s._dataChannels=s._dataChannels.filter((e=>e!==o)),e)return this._gateway.unsubscribeDataChannel(e,s.uid)})),t.info("[".concat(this._clientId,"] remote user ").concat(i," unpublished datachannel ,id:").concat(o.id)),this.safeEmit(pe.USER_UNPUBLISHED,s,"datachannel",o._config))}))}_handleRemoveDataChannels(e){const i=this._users.find((t=>t.uid===e.uid));if(i){if(void 0!==i._dataChannels&&i._dataChannels.length>0){t.debug("[".concat(this._clientId,"] datachannel removed with uid ").concat(e.uid));const n=()=>{t.info("[".concat(this._clientId,"] remote user ").concat(i.uid," unpublished datachannel")),i._dataChannels.forEach((e=>{this.safeEmit(pe.USER_UNPUBLISHED,i,"datachannel",e._config)}))};this._p2pChannel.unsubscribeDataChannel(i,i._dataChannels).then((e=>{if(e)return this._gateway.unsubscribeDataChannel(e,i.uid)})),n()}}else t.warning("[".concat(this._clientId,"] can not find target user!(on_remove_datachannel)"))}_handleGatewayEvents(){this._gateway.on(Ii.DISCONNECT_P2P,(async()=>{await this._p2pChannel.disconnectForReconnect()})),this._gateway.on(Ii.CONNECTION_STATE_CHANGE,((e,n,s)=>{var o;if(s===b.FALLBACK)return;const a=()=>{this.safeEmit(pe.CONNECTION_STATE_CHANGE,e,n,s)};if(i.reportApiInvoke(this._sessionId||(null===(o=this._gateway.joinInfo)||void 0===o?void 0:o.sid)||null,{name:Y.CONNECTION_STATE_CHANGE,options:[e,n,s],tag:q.TRACER}).onSuccess(JSON.stringify({cur:e,prev:n,reason:s})),t.info("[".concat(this._clientId,"] connection state change: ").concat(n," -> ").concat(e)),"DISCONNECTED"===e)return this._reset(),void a();if("RECONNECTING"===e)this._users.forEach((e=>{e._trust_in_room_=!1,e._trust_audio_enabled_state_=!1,e._trust_video_enabled_state_=!1,e._trust_audio_mute_state_=!1,e._trust_video_mute_state_=!1,e._trust_audio_stream_added_state_=!1,e._trust_video_stream_added_state_=!1,e._is_pre_created||(e._audio_pre_subscribed||(e._audioSSRC=void 0,e._audioOrtc=void 0),e._video_pre_subscribed||(e._videoSSRC=void 0,e._videoOrtc=void 0,e._rtxSsrcId=void 0),e._cname=void 0)})),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if("CONNECTED"===e){var r;this._streamFallbackTypeCacheMap.forEach(((e,i)=>{this._gateway.setStreamFallbackOption(i,e).catch((e=>{t.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),e)}))})),this._remoteStreamTypeCacheMap.forEach(((e,i)=>{this._gateway.setRemoteVideoStreamType(i,e).catch((e=>{t.warning("[".concat(this._clientId,"] auto set remote stream type failed"),e)}))})),void 0!==this._remoteDefaultVideoStreamType&&void 0===(null===(r=this._joinInfo)||void 0===r?void 0:r.defaultVideoStream)&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then((()=>{t.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))})).catch((e=>{t.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(e))})),this.store.useP2P||(this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout((()=>{if("CONNECTED"!==this.connectionState)return;this._userOfflineTimeout=void 0;this._users.filter((e=>!e._trust_in_room_)).forEach((e=>{t.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(e.uid)),this._handleUserOffline({uid:e.uid})}))}),3e3),this._streamRemovedTimeout=window.setTimeout((()=>{"CONNECTED"===this.connectionState&&(this._streamRemovedTimeout=void 0,this._users.forEach((e=>{e._trust_audio_mute_state_||(t.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(e.uid)),this._handleMuteStream(e.uid,Pi.AUDIO,!1)),e._trust_video_mute_state_||(t.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(e.uid)),this._handleMuteStream(e.uid,Pi.VIDEO,!1)),e._trust_audio_enabled_state_||(t.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(e.uid)),this._handleSetStreamLocalEnable("audio",e.uid,!0)),e._trust_video_enabled_state_||(t.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(e.uid)),this._handleSetStreamLocalEnable("video",e.uid,!0)),e._trust_video_stream_added_state_||(t.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(e.uid)),this._handleResetAddStream(e,"video")),e._trust_audio_stream_added_state_||(t.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(e.uid)),this._handleResetAddStream(e,"audio")),e._video_added_||e._audio_added_||(t.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(e.uid)),this._handleRemoveStream({uid:e.uid,uint_id:e._uintid}))})))}),1e3))}a()})),this._gateway.on(Ii.REQUEST_NEW_GATEWAY_LIST,(async(e,t)=>{if(!this._joinInfo)return t(new ui(h.UNEXPECTED_ERROR,"can not recover, no join info"));try{let t;const i=await Oa(Xt(Xt({},this._joinInfo),{},{uid:this._joinInfo.uid,stringUid:void 0}));i?(t=i.ap,ka(i),this._joinInfo.preload=!0):(t=await Ts(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||X,this.store),this._joinInfo.preload=!1),this._joinInfo&&(this._joinInfo.apResponse=t.gatewayInfo.res,this._joinInfo.gatewayAddrs=t.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=t.gatewayInfo.uni_lbs_ip);const n=[];t.gatewayInfo.gatewayAddrs.forEach((e=>{let{address:t}=e;const[i,s]=t.split(":");this._joinInfo&&this._joinInfo.proxyServer?n.push({proxy:this._joinInfo.proxyServer,host:i,port:s}):n.push({host:i,port:s})})),e(n)}catch(e){t(e)}})),this._gateway.on(Ii.NETWORK_QUALITY,(e=>{"normal"===this._networkQualitySensitivity&&this.safeEmit(pe.NETWORK_QUALITY,e)})),this._gateway.on(Ii.STREAM_TYPE_CHANGE,((e,t)=>{this.safeEmit(pe.STREAM_TYPE_CHANGED,e,t);i.reportApiInvoke(this._sessionId,{name:Y.STREAM_TYPE_CHANGE,options:[e,t],tag:q.TRACER}).onSuccess(JSON.stringify({uid:e,streamType:t}))})),this._gateway.on(Ii.IS_P2P_DISCONNECTED,(e=>{this._p2pChannel.isP2PDisconnected()?e(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?e(!1):e(!0)})),this._gateway.on(Ii.REQUEST_P2P_CONNECTION_PARAMS,(async(e,t,i)=>{try{let i=await this._p2pChannel.getEstablishParams();E("ENABLE_PREALLOC_PC")&&i||(i=await this._p2pChannel.startP2PConnection(e)),t(i)}catch(e){i(e)}})),this._gateway.on(Ii.JOIN_RESPONSE,((e,t)=>{if(this.store.useP2P)return;const i=bn(e.ortc,t,e.attributes.userAttributes.preSubSsrcs);this._p2pChannel.connect(i)})),this._gateway.on(Ii.PRE_CONNECT_PC,(async e=>{const{candidates:t,fingerprint:i}=e;if(this._joinInfo&&t.length>0&&!this._p2pChannel.isPlanB){var n;await this._p2pChannel.startP2PConnection({turnServer:this._joinInfo.turnServer});const{cert:e,cid:s}=this._joinInfo.apResponse;await this._p2pChannel.connect({iceParameters:{iceUfrag:"".concat(s,"_").concat(e),icePwd:"".concat(s,"_").concat(e)},dtlsParameters:{fingerprints:[{hashFunction:"sha-256",fingerprint:null!==(n=E("FINGERPRINT"))&&void 0!==n?n:i}]},candidates:t,rtpCapabilities:{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},setup:"active",cname:"o/i14u9pJrxRKAsu",preallocation:!0})}}))}_handleGatewaySignalEvents(){this._gateway.signal.on(di.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(di.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(di.ON_ADD_AUDIO_STREAM,(e=>this._handleAddAudioOrVideoStream("audio",e.uid,e.ssrcId,e.cname,e.uint_id,e.ortc))),this._gateway.signal.on(di.ON_ADD_VIDEO_STREAM,(e=>this._handleAddAudioOrVideoStream("video",e.uid,e.ssrcId,e.cname,e.uint_id,e.ortc,e.rtxSsrcId))),this._gateway.signal.on(di.ON_REMOTE_DATASTREAM_UPDATE,(e=>{this._handleUpdateDataChannel(e)})),this._gateway.signal.on(di.ON_REMOTE_FULL_DATASTREAM_INFO,(e=>{this._handleUpdateDataChannel({added:e.datastreams||[],deleted:[]},!0)})),this._gateway.signal.on(di.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(di.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(di.MUTE_AUDIO,(e=>this._handleMuteStream(e.uid,Pi.AUDIO,!0))),this._gateway.signal.on(di.UNMUTE_AUDIO,(e=>this._handleMuteStream(e.uid,Pi.AUDIO,!1))),this._gateway.signal.on(di.MUTE_VIDEO,(e=>this._handleMuteStream(e.uid,Pi.VIDEO,!0))),this._gateway.signal.on(di.UNMUTE_VIDEO,(e=>this._handleMuteStream(e.uid,Pi.VIDEO,!1))),this._gateway.signal.on(di.RECEIVE_METADATA,(e=>{const t=k(e.metadata);this.safeEmit(pe.RECEIVE_METADATA,e.uid,t)})),this._gateway.signal.on(di.ON_DATA_STREAM,(async e=>{if(!e)return;let t=k(e.payload);if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&["aes-128-gcm2","aes-256-gcm2"].includes(this._encryptionMode)){if(e.payload.length<Ve)throw new ui(h.UNEXPECTED_RESPONSE,"payload length ".concat(e.payload.length," is less than header length ").concat(Ve));t=await xe(this._encryptDataStreamIv,this._encryptDataStreamKey,t)}let i=0;if(e.ordered||e.syncWithAudio){const t=this._p2pChannel.getStats(),n=this.remoteUsers.find((t=>t.uid===e.uid)),s=null==t?void 0:t.audioRecv.find((e=>e.ssrc===(null==n?void 0:n._audioSSRC)));i=null==s?void 0:s.jitterBufferMs}null==i&&(i=0),pa(Xt(Xt({},e),{},{payload:t}),i,{id:this._clientId,onStreamMessage:"function"==typeof this.onStreamMessage?this.onStreamMessage.bind(this):void 0,safeEmit:this.safeEmit.bind(this)})})),this._gateway.signal.on(di.ON_CRYPT_ERROR,(()=>{Ee((()=>{t.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(pe.CRYPT_ERROR)}),this._sessionId)})),this._gateway.signal.on(di.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(di.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{t.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0,b.TOKEN_EXPIRE),this.safeEmit(pe.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()})),this._gateway.signal.on(di.ON_STREAM_FALLBACK_UPDATE,(e=>{t.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(e.stream_id,", attr: ").concat(e.stream_type)),this.safeEmit(pe.STREAM_FALLBACK,e.stream_id,1===e.stream_type?"fallback":"recover")})),this._gateway.signal.on(di.ON_PUBLISH_STREAM,(e=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:e.proxy})),t.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(e))))})),this._gateway.signal.on(di.ENABLE_LOCAL_VIDEO,(e=>{this._handleSetStreamLocalEnable("video",e.uid,!0)})),this._gateway.signal.on(di.DISABLE_LOCAL_VIDEO,(e=>{this._handleSetStreamLocalEnable("video",e.uid,!1)})),this._gateway.signal.on(ai.REQUEST_TIMEOUT,((e,t)=>{if(this._joinInfo)switch(e){case ri.PUBLISH:{if(!t)return;const e=t.ortc;if(e){var n,s;const o=e.some((e=>{let{stream_type:t}=e;return t===Ri.Audio})),a=e.some((e=>{let{stream_type:t}=e;return t!==Ri.Audio})),r=e.some((e=>{let{stream_type:t}=e;return t===Ri.Screen||t===Ri.ScreenLow}));"offer"===t.state&&i.publish(this._joinInfo.sid,{eventElapse:Ds.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:h.TIMEOUT,audio:o,video:a,p2pid:t.p2p_id,publishRequestid:this.store.pubId,screenshare:r,audioName:o?null===(n=e.find((e=>{let{stream_type:t}=e;return t===Ri.Audio})))||void 0===n||null===(n=n.ssrcs[0])||void 0===n?void 0:n.ssrcId.toString():void 0,videoName:a?null===(s=e.find((e=>{let{stream_type:t}=e;return t!==Ri.Audio})))||void 0===s||null===(s=s.ssrcs[0])||void 0===s?void 0:s.ssrcId.toString():void 0})}break}case ri.SUBSCRIBE:t&&i.subscribe(this._joinInfo.sid,{succ:!1,ec:h.TIMEOUT,audio:t.stream_type===Pi.AUDIO,video:t.stream_type===Pi.VIDEO,peerid:t.stream_id,subscribeRequestid:t.ssrcId,p2pid:this.store.p2pId,eventElapse:Ds.measureFromSubscribeStart(this.store.clientId,t.ssrcId),preSsrc:this._p2pChannel.isPreSubScribe(t.ssrcId)})}})),this._gateway.signal.on(di.ON_P2P_OK,(e=>{this.uid,this._uid})),this._gateway.signal.on(di.ON_PUBLISHED_USER_LIST,(e=>{if(null==e||!e.users)return;E("BLOCK_LOCAL_CLIENT")&&(e.users=e.users.filter((e=>!Bt(e.string_id||e.stream_id,this.channelName))));const i=[],n=[];for(const s of e.users){let e=this._users.find((e=>e._uintid===s.stream_id));e?e._trust_in_room_=!0:(e=new Eo(s.string_id||s.stream_id,s.stream_id),this._users.push(e),0===this.getListeners(pe.PUBLISHED_USER_LIST).length&&(t.debug("[".concat(this._clientId,"] user online"),s.stream_id),this.safeEmit(pe.USER_JOINED,e)));const o=Ai.Audio&s.stream_type,a=(Ai.Video|Ai.LwoVideo)&s.stream_type,r=0!=(65280&s.stream_type),c=o&&e.hasAudio,d=a&&e.hasVideo;a&&(e._trust_video_stream_added_state_=!0,e._video_added_=!0,e._videoSSRC=s.video_ssrc,e._rtxSsrcId=s.video_rtx),o&&(e._trust_audio_stream_added_state_=!0,e._audio_added_=!0,e._audioSSRC=s.audio_ssrc),o&&!c&&0===this.getListeners(pe.PUBLISHED_USER_LIST).length&&(t.info("[".concat(this._clientId,"] remote user ").concat(e.uid," published audio")),this.safeEmit(pe.USER_PUBLISHED,e,"audio")),a&&!d&&0===this.getListeners(pe.PUBLISHED_USER_LIST).length&&(t.info("[".concat(this._clientId,"] remote user ").concat(e.uid," published video")),this.safeEmit(pe.USER_PUBLISHED,e,"video")),(o&&!c||a&&!d||r)&&i.push(e),a&&this._p2pChannel.hasPendingRemoteMedia(e,"video")&&n.push({user:e,mediaType:"video"}),o&&this._p2pChannel.hasPendingRemoteMedia(e,"audio")&&n.push({user:e,mediaType:"audio"})}n.length>0&&(t.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(n.map((e=>"user: ".concat(e.user.uid,", mediaType: ").concat(e.mediaType))).join("; ")," ")),this.massSubscribe(n).catch((e=>{t.error("[".concat(this._clientId,"] mass resubscribe error"),e.toString())}))),this.getListeners(pe.PUBLISHED_USER_LIST).length>0?E("ENABLE_DATASTREAM_2")?this._pendingPublishedUsers=i:(t.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(i.map((e=>e.uid)).join(", "))),this.safeEmit(pe.PUBLISHED_USER_LIST,i)):t.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(i.map((e=>e.uid)).join(", ")))})),this._gateway.signal.on(di.ON_RTP_CAPABILITY_CHANGE,(e=>{const{video_codec:t}=e;this._p2pChannel instanceof ia&&this._p2pChannel.updateRemoteRTPCapabilities(t.map((e=>e.toLowerCase())).filter((e=>Object.keys(ie).includes(e))))}))}_handleP2PEvents(){this._gateway.signal.on(di.ON_USER_OFFLINE,(()=>{this._p2pChannel.disconnectForReconnect()})),this._gateway.signal.on(Hi.PUBLISH,((e,t,i)=>{const{uid:n}=e;e.forEach((e=>{const{kind:s,ssrcs:o,mid:a,isMuted:r}=e;this._handleP2PAddAudioOrVideoStream(s,n,o[0].ssrcId,a);const c=this._users.find((e=>e.uid===n));return c&&this._p2pChannel instanceof Po?this._p2pChannel.mockSubscribe(c,s,o[0].ssrcId,a).then((()=>{t()})).catch(i):t(),this._handleMuteStream(n,s,!!r)}))})),this._gateway.signal.on(Hi.CALL,(async(e,t,i)=>{if(this._p2pChannel instanceof Po)try{var n;t(await this._p2pChannel.startP2P({turnServer:null===(n=this._joinInfo)||void 0===n?void 0:n.turnServer},e))}catch(e){i(e)}})),this._gateway.signal.on(ai.P2P_CONNECTION,(async e=>{this._p2pChannel instanceof Po&&await this._p2pChannel.p2pConnect(e)})),this._gateway.signal.on(Hi.UNPUBLISH,(async(e,i,n)=>{if(this._p2pChannel instanceof Po){const{unpubMsg:s,uid:o}=e,a=this._users.find((e=>e.uid===o));if(!a)return t.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(o)),void i();try{s.forEach((async e=>{let{stream_type:t}=e;const i=t===Ri.Audio?Pi.AUDIO:Pi.VIDEO;await this._p2pChannel.unsubscribe(a,i),this._handleMuteStream(o,i,!0)})),i()}catch(e){n(e)}}})),this._gateway.signal.on(Hi.CONTROL,(async(e,t)=>{const{action:i}=e;switch(i){case Yi.MUTE_LOCAL_VIDEO:this._handleMuteStream(t,Pi.VIDEO,!0);break;case Yi.MUTE_LOCAL_AUDIO:this._handleMuteStream(t,Pi.AUDIO,!0);break;case Yi.UNMUTE_LOCAL_VIDEO:this._handleP2PAddAudioOrVideoStream("video",t),this._handleMuteStream(t,Pi.VIDEO,!1);break;case Yi.UNMUTE_LOCAL_AUDIO:this._handleP2PAddAudioOrVideoStream("audio",t),this._handleMuteStream(t,Pi.AUDIO,!1)}})),this._gateway.signal.on(Hi.RESTART_ICE,(async(e,t,i)=>{if(this._p2pChannel instanceof Po)try{const{direction:i,iceParameter:n}=e;if(i!==li.SEND_ONLY||n){t(await this._p2pChannel.restartICE(i,n))}else this._p2pChannel.handleDisconnect(i),t()}catch(e){i(e)}})),this._gateway.signal.on(Hi.CANDIDATE,(e=>{if(this._p2pChannel instanceof Po){const{candidate:t,direction:i}=e;this._p2pChannel.addRemoteCandidate(t,i)}})),this._p2pChannel.on(Vi.RequestP2PRestartICE,(async(e,t,i)=>{try{const{direction:i}=e;t(await this._gateway.sendExtensionMessage(Hi.RESTART_ICE,e,i===li.SEND_ONLY))}catch(e){i(e)}})),this._p2pChannel.on(Vi.LocalCandidate,(e=>{this._gateway.sendExtensionMessage(Hi.CANDIDATE,JSON.stringify(e),!0)})),this._p2pChannel.on(Vi.RequestP2PMuteLocal,(async(e,t,i)=>{try{await this._gateway.sendExtensionMessage(Hi.CONTROL,e,!0),t()}catch(e){i(e)}})),this._p2pChannel.on(Vi.RequestP2PUnmuteRemote,(async(e,t,i)=>{if(this._joinInfo)try{await this._gateway.unmuteRemote(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(e){e.code===h.DISCONNECT_P2P?t():i(e)}else t()})),this._p2pChannel.on(Vi.RequestP2PMuteRemote,(async(e,t,i)=>{if(this._joinInfo)try{await this._gateway.muteRemote(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(e){e.code===h.DISCONNECT_P2P?t():i(e)}else t()})),this._p2pChannel.on(Vi.StateChange,((e,t)=>{t===Ui.Connected&&this._p2pChannel.republish()}))}_handleP2PChannelEvents(){this._p2pChannel.on(Vi.RequestMuteLocal,(async(e,t,i)=>{if(this._joinInfo)try{await this._gateway.muteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(e){e.code===h.DISCONNECT_P2P?t():i(e)}else t()})),this._p2pChannel.on(Vi.RequestUnmuteLocal,(async(e,t,i)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(e){e.code===h.DISCONNECT_P2P?t():i(e)}else t()})),this._p2pChannel.on(Vi.RequestRePublish,((e,t,i)=>{this.publish(e,!1).then(t).catch(i)})),this._p2pChannel.on(Vi.RequestRePublishDataChannel,((e,t,i)=>{Promise.all(e.map((async e=>{const t=await this._p2pChannel.publishDataChannel([e]);try{t.forEach((e=>{this._uid&&this._gateway.publishDataChannel(this._uid,e,!0)}))}catch(e){if(e.code!==h.DISCONNECT_P2P)throw e}}))).then(t).catch(i)})),this._p2pChannel.on(Vi.RequestReSubscribe,(async(e,t,i)=>{try{for(const{user:t,kind:i}of e)i===Pi.VIDEO?await this.subscribe(t,"video"):await this.subscribe(t,"audio");t()}catch(e){i(e)}})),this._p2pChannel.on(Vi.RequestUpload,((e,t)=>{this._gateway.upload(e,t)})),this._p2pChannel.on(Vi.RequestUploadStats,(e=>{this._gateway.uploadWRTCStats(e)})),this._p2pChannel.on(Vi.MediaReconnectStart,(e=>{this.safeEmit(pe.MEDIA_RECONNECT_START,e)})),this._p2pChannel.on(Vi.MediaReconnectEnd,(e=>{this.safeEmit(pe.MEDIA_RECONNECT_END,e)})),this._p2pChannel.on(Vi.NeedSignalRTT,(e=>{e(this._gateway.getSignalRTT())})),this._p2pChannel.on(Vi.RequestRestartICE,(async e=>{if(this._p2pChannel instanceof Po)return;const t=await this._p2pChannel.restartICE(e),i=await t.next();if(i.done)return;const n=i.value;let s;try{s=await this._gateway.restartICE({iceParameters:n})}catch(e){return void t.throw(e)}const{iceParameters:o}=function(e){const t=e.iceParameters;return{iceParameters:{iceUfrag:t.iceUfrag,icePwd:t.icePwd}}}(s);await t.next({remoteIceParameters:o})})),this._p2pChannel.on(Vi.RequestReconnect,(async()=>{this._gateway.reconnect()})),this._p2pChannel.on(Vi.RequestReconnectPC,(async()=>{var e;const{iceParameters:t,dtlsParameters:i,rtpCapabilities:n}=await this._p2pChannel.startP2PConnection({turnServer:null===(e=this._joinInfo)||void 0===e?void 0:e.turnServer}),{gatewayEstablishParams:s,gatewayAddress:o}=await this._gateway.reconnectPC({iceParameters:t,dtlsParameters:i,rtpCapabilities:n}),a=bn(s,o);await this._p2pChannel.connect(a),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe()})),this._p2pChannel.on(Vi.RequestUnpublishForReconnectPC,(async(e,t,i)=>{this._joinInfo&&void 0!==this._uid?(await this._gateway.unpublish(e,this._uid),t()):i()})),this._p2pChannel.on(Vi.P2PLost,(()=>{this.safeEmit(pe.P2P_LOST,this.store.uid)})),this._p2pChannel.on(Vi.UpdateVideoEncoder,(e=>{e._encoderConfig&&this._gateway.setVideoProfile(e._encoderConfig)})),this._p2pChannel.on(Vi.ConnectionTypeChange,(e=>{this.safeEmit(pe.IS_USING_CLOUD_PROXY,e)})),this._p2pChannel.on(Vi.RequestLowStreamParameter,(e=>{e(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})})),this._p2pChannel.on(Vi.QueryClientConnectionState,(e=>{e(this.connectionState)}))}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(e){if(!this._joinInfo||"CONNECTED"!==this.connectionState)throw new ui(h.INVALID_OPERATION,"[".concat(this._clientId,"] can not create content inspect, please join channel first"));if(this._inspect)throw new ui(h.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));try{const i=(t={config:e},oa("ContentInspect").create(t));this._inspect=i,this.handleVideoInspectEvents(i);const{appId:n,cname:s,sid:o,token:a,uid:r,cid:c,vid:d}=this._joinInfo;await i.init({appId:n,areaCode:"",cname:s,sid:o,token:a,uid:r,cid:c,vid:d?Number(d):0},X)}catch(e){throw Array.isArray(e)?e[0]:e}var t}handleVideoInspectEvents(e){e.on(Fi.CONNECTION_STATE_CHANGE,((t,i)=>{if(this.safeEmit(pe.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,t,i),i===xi.CONNECTED){if("CONNECTED"!==this.connectionState)return void this.safeEmit(pe.CONTENT_INSPECT_ERROR,new ui(h.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));e.inspectImage()}})),e.on(Fi.INSPECT_RESULT,((e,i)=>{var n;if((null==i?void 0:i.code)===h.INVALID_OPERATION&&"DISCONNECTED"===this.connectionState)return t.debug("Stop inspect content because that has left channel"),null==this||null===(n=this._inspect)||void 0===n||n.close(),void(this._inspect=void 0);this.safeEmit(pe.CONTENT_INSPECT_RESULT,e,i)})),e.on(Fi.CLIENT_LOCAL_VIDEO_TRACK,(e=>{e(this.localTracks.filter((e=>"video"===e.trackMediaType))[0])}))}async disableContentInspect(){if(!this._inspect)throw new ui(h.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(e){throw Array.isArray(e)?e[0]:e}}async setImageModeration(e,t){if(Oe(e,"enabled"),e){if(!t)throw new ui(h.INVALID_PARAMS,"config is required");if(function(e){if(Ce(e.interval,"interval",1e3,1/0),e&&e.extraInfo&&e.extraInfo.length>1024)throw new ui(h.INVALID_PARAMS,"config.extraInfo length cannot exceed 1024 bytes");if(e&&e.vendor&&e.vendor.length>1024)throw new ui(h.INVALID_PARAMS,"config.vendor length cannot exceed 1024 bytes")}(t),!this._joinInfo)throw new ui(h.INVALID_OPERATION,"can not create image moderation, please join channel first");try{if(this._moderation)this._moderation.updateConfig(t);else{const e=(i={config:t},oa("ImageModeration").create(i));this._moderation=e,this.handleImageModerationEvents(e);const{appId:n,cname:s,sid:o,token:a,uid:r,cid:c,vid:d}=this._joinInfo;await e.init({appId:n,areaCode:"",cname:s,sid:o,token:a,uid:r,cid:c,vid:d?Number(d):0},X)}}catch(e){throw Array.isArray(e)?e[0]:e}}else{var i;if(!this._moderation)throw new ui(h.INVALID_OPERATION,"[".concat(this._clientId,"] image moderation not started"));try{this._moderation.close(),this._moderation.removeAllListeners(),this._moderation=void 0}catch(e){throw Array.isArray(e)?e[0]:e}}}handleImageModerationEvents(e){e.on(Wi.CONNECTION_STATE_CHANGE,((t,i)=>{if(this.safeEmit(pe.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,t,i),t===ji.CONNECTED){if("CONNECTED"!==this.connectionState)throw this.setImageModeration(!1),new ui(h.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");e.inspectImage()}})),e.on(Wi.CLIENT_LOCAL_VIDEO_TRACK,(e=>{e(this.localTracks.filter((e=>"video"===e.trackMediaType))[0])}))}setP2PTransport(e){if(Fe(e),"p2p"!==this.mode)throw new ui(h.INVALID_OPERATION,"only p2p mode can set p2pTransport");this.store.p2pTransport=e,t.info("[".concat(this._clientId,"] set client p2pTransport to ").concat(e))}getJoinChannelServiceRecords(){return t.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(e){Oe(e,"enabled"),W("ENABLE_PUBLISH_AUDIO_FILTER",e),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(e)}_handleResetAddStream(e,t){switch(t){case"audio":e._audio_added_=!1,e._trust_audio_stream_added_state_=!0;break;case"video":e._video_added_=!1,e._trust_video_stream_added_state_=!0}}}).prototype,"leave",[ja],Object.getOwnPropertyDescriptor(br.prototype,"leave"),br.prototype),jt(br.prototype,"publish",[Wa],Object.getOwnPropertyDescriptor(br.prototype,"publish"),br.prototype),jt(br.prototype,"unpublish",[Ha],Object.getOwnPropertyDescriptor(br.prototype,"unpublish"),br.prototype),jt(br.prototype,"subscribe",[Ka],Object.getOwnPropertyDescriptor(br.prototype,"subscribe"),br.prototype),jt(br.prototype,"presubscribe",[Ya],Object.getOwnPropertyDescriptor(br.prototype,"presubscribe"),br.prototype),jt(br.prototype,"massSubscribe",[qa],Object.getOwnPropertyDescriptor(br.prototype,"massSubscribe"),br.prototype),jt(br.prototype,"unsubscribe",[Ja],Object.getOwnPropertyDescriptor(br.prototype,"unsubscribe"),br.prototype),jt(br.prototype,"massUnsubscribe",[Xa],Object.getOwnPropertyDescriptor(br.prototype,"massUnsubscribe"),br.prototype),jt(br.prototype,"setLowStreamParameter",[za],Object.getOwnPropertyDescriptor(br.prototype,"setLowStreamParameter"),br.prototype),jt(br.prototype,"enableDualStream",[Qa],Object.getOwnPropertyDescriptor(br.prototype,"enableDualStream"),br.prototype),jt(br.prototype,"disableDualStream",[Za],Object.getOwnPropertyDescriptor(br.prototype,"disableDualStream"),br.prototype),jt(br.prototype,"setClientRole",[$a],Object.getOwnPropertyDescriptor(br.prototype,"setClientRole"),br.prototype),jt(br.prototype,"setProxyServer",[er],Object.getOwnPropertyDescriptor(br.prototype,"setProxyServer"),br.prototype),jt(br.prototype,"setTurnServer",[tr],Object.getOwnPropertyDescriptor(br.prototype,"setTurnServer"),br.prototype),jt(br.prototype,"setLicense",[ir],Object.getOwnPropertyDescriptor(br.prototype,"setLicense"),br.prototype),jt(br.prototype,"startProxyServer",[nr],Object.getOwnPropertyDescriptor(br.prototype,"startProxyServer"),br.prototype),jt(br.prototype,"stopProxyServer",[sr],Object.getOwnPropertyDescriptor(br.prototype,"stopProxyServer"),br.prototype),jt(br.prototype,"setLocalAccessPointsV2",[or],Object.getOwnPropertyDescriptor(br.prototype,"setLocalAccessPointsV2"),br.prototype),jt(br.prototype,"setLocalAccessPoints",[ar],Object.getOwnPropertyDescriptor(br.prototype,"setLocalAccessPoints"),br.prototype),jt(br.prototype,"setRemoteDefaultVideoStreamType",[rr],Object.getOwnPropertyDescriptor(br.prototype,"setRemoteDefaultVideoStreamType"),br.prototype),jt(br.prototype,"setRemoteVideoStreamType",[cr],Object.getOwnPropertyDescriptor(br.prototype,"setRemoteVideoStreamType"),br.prototype),jt(br.prototype,"setStreamFallbackOption",[dr],Object.getOwnPropertyDescriptor(br.prototype,"setStreamFallbackOption"),br.prototype),jt(br.prototype,"setEncryptionConfig",[lr],Object.getOwnPropertyDescriptor(br.prototype,"setEncryptionConfig"),br.prototype),jt(br.prototype,"renewToken",[hr],Object.getOwnPropertyDescriptor(br.prototype,"renewToken"),br.prototype),jt(br.prototype,"enableAudioVolumeIndicator",[ur],Object.getOwnPropertyDescriptor(br.prototype,"enableAudioVolumeIndicator"),br.prototype),jt(br.prototype,"startLiveStreaming",[pr],Object.getOwnPropertyDescriptor(br.prototype,"startLiveStreaming"),br.prototype),jt(br.prototype,"setLiveTranscoding",[_r],Object.getOwnPropertyDescriptor(br.prototype,"setLiveTranscoding"),br.prototype),jt(br.prototype,"stopLiveStreaming",[Er],Object.getOwnPropertyDescriptor(br.prototype,"stopLiveStreaming"),br.prototype),jt(br.prototype,"startChannelMediaRelay",[mr],Object.getOwnPropertyDescriptor(br.prototype,"startChannelMediaRelay"),br.prototype),jt(br.prototype,"updateChannelMediaRelay",[Sr],Object.getOwnPropertyDescriptor(br.prototype,"updateChannelMediaRelay"),br.prototype),jt(br.prototype,"stopChannelMediaRelay",[fr],Object.getOwnPropertyDescriptor(br.prototype,"stopChannelMediaRelay"),br.prototype),jt(br.prototype,"sendCustomReportMessage",[Cr],Object.getOwnPropertyDescriptor(br.prototype,"sendCustomReportMessage"),br.prototype),jt(br.prototype,"pickSVCLayer",[Tr],Object.getOwnPropertyDescriptor(br.prototype,"pickSVCLayer"),br.prototype),jt(br.prototype,"setRTMConfig",[Rr],Object.getOwnPropertyDescriptor(br.prototype,"setRTMConfig"),br.prototype),jt(br.prototype,"enableContentInspect",[Ir],Object.getOwnPropertyDescriptor(br.prototype,"enableContentInspect"),br.prototype),jt(br.prototype,"disableContentInspect",[gr],Object.getOwnPropertyDescriptor(br.prototype,"disableContentInspect"),br.prototype),jt(br.prototype,"setImageModeration",[Ar],Object.getOwnPropertyDescriptor(br.prototype,"setImageModeration"),br.prototype),jt(br.prototype,"setP2PTransport",[vr],Object.getOwnPropertyDescriptor(br.prototype,"setP2PTransport"),br.prototype),jt(br.prototype,"getJoinChannelServiceRecords",[yr],Object.getOwnPropertyDescriptor(br.prototype,"getJoinChannelServiceRecords"),br.prototype),jt(br.prototype,"setPublishAudioFilterEnabled",[wr],Object.getOwnPropertyDescriptor(br.prototype,"setPublishAudioFilterEnabled"),br.prototype),br);function Or(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"};const n=i.reportApiInvoke(null,{name:Y.CREATE_CLIENT,options:[e],tag:q.TRACER});try{Be(e)}catch(e){throw n.onError(e),e}return(de(16,0,!0)||he(16,0,!0))&&("vp9"===e.codec&&(e.codec="vp8",t.debug("browser not support vp9, force use vp8")),W("UNSUPPORTED_VIDEO_CODEC",["vp9"])),void 0===e.audioCodec&&(e.audioCodec="opus"),n.onSuccess(),new Nr(Xt(Xt({forceWaitGatewayResponse:!0},e),{},{role:["rtc","p2p"].includes(e.mode)?"host":e.role||"audience"}))}async function Dr(){let e={audio:[],video:[]};try{let t=new RTCPeerConnection;const i=await async function(e){let t;return Xe().supportUnifiedPlan?(e.addTransceiver("video",{direction:"recvonly"}),e.addTransceiver("audio",{direction:"recvonly"}),t=(await e.createOffer()).sdp):t=(await e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0})).sdp,t}(t);if(!i)return e;t.close(),t=null,e=function(e){const t={video:[],audio:[]};return e.match(/ VP8/i)&&t.video.push("VP8"),e.match(/ VP9/i)&&t.video.push("VP9"),e.match(/ AV1/i)&&t.video.push("AV1"),e.match(/ H264/i)&&t.video.push("H264"),e.match(/ H265/i)&&t.video.push("H265"),e.match(/ opus/i)&&t.audio.push("OPUS"),e.match(/ PCMU/i)&&t.audio.push("PCMU"),e.match(/ PCMA/i)&&t.audio.push("PCMA"),e.match(/ G722/i)&&t.audio.push("G722"),t}(i)}catch(e){throw new ui(h.CREATE_OFFER_FAILED,e.toString&&e.toString()).print()}return e}function Pr(){const e=i.reportApiInvoke(null,{name:Y.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:q.TRACER});let n=!1;try{const e=window.RTCPeerConnection,t=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,i=window.WebSocket;n=!!(e&&t&&i),n&&ue()&&G(75)&&(new e).close()}catch(e){return t.error("check system requirement failed: ",e),!1}let s=!1;const o=U();o.name===V.CHROME&&Number(o.version)>=58&&(!Ge()||je())&&(s=!0),(o.name===V.FIREFOX&&Number(o.version)>=56||o.name===V.OPERA&&Number(o.version)>=45||o.name===V.SAFARI&&Number(o.version)>=11||"WebKit"===o.name&&(se()||We())&&o.osVersion&&Number(o.osVersion.split(".")[0])>=11||He()||Ke())&&(s=!0),t.debug("checkSystemRequirements, api:",n,"browser",s);const a=n&&s;return e.onSuccess(a),a}class Lr{constructor(e,t){this.id=0,this.element=void 0,this.peerPair=void 0,this.context=void 0,this.audioPlayerElement=void 0,this.audioTrack=void 0,Lr.count+=1,this.id=Lr.count,this.element=e,this.context=t}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=e=>{const t=document.createElement("audio");t.srcObject=new MediaStream([e.track]),t.play(),this.audioPlayerElement=t}}async switchSdp(){if(!this.peerPair)return;const e=async(e,t)=>{const i="offer"===t?await e.createOffer():await e.createAnswer();return await e.setLocalDescription(i),"complete"===e.iceGatheringState?e.localDescription:new Promise((t=>{e.onicegatheringstatechange=()=>{"complete"===e.iceGatheringState&&t(e.localDescription)}}))},t=async(e,t)=>await e.setRemoteDescription(t);try{const i=await e(this.peerPair[0],"offer");await t(this.peerPair[1],i);const n=await e(this.peerPair[1],"answer");await t(this.peerPair[0],n)}catch(e){throw new ui(h.LOCAL_AEC_ERROR,e.toString()).print()}}async getTracksFromMediaElement(e){if(this.audioTrack)return this.audioTrack;let t;try{e instanceof HTMLVideoElement&&(e.captureStream?e.captureStream():e.mozCaptureStream()),t=this.context.createMediaStreamDestination();this.context.createMediaElementSource(e).connect(t)}catch(e){throw new ui(h.LOCAL_AEC_ERROR,e.toString()).print()}if(!t){throw new ui(h.LOCAL_AEC_ERROR,"no dest node when local aec").print()}const i=t.stream.getAudioTracks()[0];return this.audioTrack=i,i}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();const e=this.element,t=await this.getTracksFromMediaElement(e);this.peerPair&&this.peerPair[0].addTrack(t),await this.switchSdp()}close(){t.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach((e=>{e.close()})),this.peerPair=void 0,this.audioPlayerElement=void 0}}var kr,Mr;Lr.count=0;const Ur=window.AudioContext||window.webkitAudioContext;const Vr=new(kr=o({report:i}),jt((Mr=class{constructor(){this.units=[],this.context=void 0}processExternalMediaAEC(e){if(!this._doesEnvironmentNeedAEC())return t.debug("the system does not need to process local aec"),-1;this.context||(this.context=new Ur);let i=this.units.find((t=>t&&t.getElement()===e));return i||(i=new Lr(e,this.context),this.units.push(i)),i.startEchoCancellation(),t.debug("start processing local audio echo cancellation, id is",i.id),i.id}_doesEnvironmentNeedAEC(){return U().name!==V.SAFARI}}).prototype,"processExternalMediaAEC",[kr],Object.getOwnPropertyDescriptor(Mr.prototype,"processExternalMediaAEC"),Mr.prototype),Mr);const xr=window||document;function Fr(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!xr)return;const i=Zr._cspEventHandlerPointer;if(i&&t)return void console.error(i,t);const n=e=>{if(!(e&&e.blockedURI&&(Zr.onSecurityPolicyViolation||Zr.getListeners(Gi.SECURITY_POLICY_VIOLATION).length>0)))return;const t=e.blockedURI;E("CSP_DETECTED_HOSTNAME_LIST").some((e=>t.includes(e)))&&(Zr.onSecurityPolicyViolation&&"function"==typeof Zr.onSecurityPolicyViolation&&Zr.onSecurityPolicyViolation(e),Zr.getListeners(Gi.SECURITY_POLICY_VIOLATION).length>0&&Zr.safeEmit(Gi.SECURITY_POLICY_VIOLATION,e))};i&&xr.removeEventListener("securitypolicyviolation",i),(t||e&&"function"==typeof e||Zr.getListeners(Gi.SECURITY_POLICY_VIOLATION).length>0)&&xr.addEventListener("securitypolicyviolation",n),Zr._cspEventHandlerPointer=n}function Br(e){return yt.enumerateDevices(!0,!0,e)}function Gr(e){return yt.getRecordingDevices(e)}function jr(e){return yt.getCamerasDevices(e)}function Wr(e){return yt.getSpeakers(e)}function Hr(){return new Mo}function Kr(e){if(t.debug("setAppType: ".concat(e)),!(Number.isInteger(e)&&e>=0))throw t.debug("Invalid appType"),new ui(h.INVALID_PARAMS,"invalid app type",e);W("APP_TYPE",Math.floor(e))}function Yr(e){t.setLogLevel(e)}function qr(){E("USE_NEW_LOG")?W("UPLOAD_LOG",!0):t.enableLogUpload()}function Jr(){E("USE_NEW_LOG")?W("UPLOAD_LOG",!1):t.disableLogUpload()}function Xr(e){Vr.processExternalMediaAEC(e)}function zr(e){e.forEach((e=>{const n=e;n.__registered__=!0,n.logger.hookLog=t.extLog,n.reporter.hookApiInvoke=i.extApiInvoke,n.parameters&&Object.keys(n.parameters).forEach((e=>{n.parameters[e]=E(e)}))}))}function Qr(){nt.autoResumeAfterInterruption(!0)}W("PROCESS_ID",Ye()),function(){let e;try{e=window.localStorage.getItem("websdk_ng_global_parameter")}catch(e){return void t.error("Error loading sdk config",e.message)}if(e)try{const i=JSON.parse(window.atob(e)),n=Date.now();t.debug("Loading global parameters from cache",i),Object.keys(i).forEach((e=>{if(Object.prototype.hasOwnProperty.call(c,e)){const{value:t,expires:s}=i[e];if(s&&s<=n)return;d[e]=t,c[e]=t}}))}catch(i){t.error("Error loading mutableParamsCache: ".concat(e),i.message)}}(),Array.isArray(d.AREAS)&&d.AREAS.length>0&&rs(d.AREAS,!0);const Zr=function(e){const t=new _,i=e,n={getListeners:t.getListeners.bind(t),on:(e,i)=>(function(e,t){e===Gi.SECURITY_POLICY_VIOLATION&&Fr(t,!0)}(e,i),t.on.bind(t)(e,i)),addListener:t.addListener.bind(t),once:t.once.bind(t),off:t.off.bind(t),removeAllListeners:t.removeAllListeners.bind(t),emit:t.emit.bind(t),safeEmit:t.safeEmit.bind(t)};return Xt(Xt({},i),n)}({});function $r(e){vt.onAudioAutoplayFailed=e}function ec(e){vt.onAutoplayFailed=e}function tc(e){Zr.onSecurityPolicyViolation=e}function ic(e){Zr.onCameraChanged=e}function nc(e){Zr.onMicrophoneChanged=e}function sc(e){Zr.onAudioContextStateChanged=e}Object.defineProperties(Zr,{onAudioAutoplayFailed:{get:()=>vt.onAudioAutoplayFailed,set:$r},onAutoplayFailed:{get:()=>vt.onAutoplayFailed,set:ec},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>Zr._onSecurityPolicyViolation,set(e){Zr._onSecurityPolicyViolation=e,Fr(e)}},__CLIENT_LIST__:{get:()=>E("SHOW_GLOBAL_CLIENT_LIST")?Ft:[]}}),Zr.use=e=>(function(e){(!(arguments.length>1&&void 0!==arguments[1])||arguments[1])&&t.debug("install service ".concat(e.name)),sa[e.name]=e}(e),Zr),yt.on(wt.CAMERA_DEVICE_CHANGED,(e=>{t.info("camera device changed",JSON.stringify(e)),Zr.onCameraChanged&&Zr.onCameraChanged(e),Zr.safeEmit(Gi.CAMERA_CHANGED,e)})),yt.on(wt.RECORDING_DEVICE_CHANGED,(e=>{t.info("microphone device changed",JSON.stringify(e)),Zr.onMicrophoneChanged&&Zr.onMicrophoneChanged(e),Zr.safeEmit(Gi.MICROPHONE_CHANGED,e)})),yt.on(wt.PLAYOUT_DEVICE_CHANGED,(e=>{t.debug("playout device changed",JSON.stringify(e)),Zr.onPlaybackDeviceChanged&&Zr.onPlaybackDeviceChanged(e),Zr.safeEmit(Gi.PLAYBACK_DEVICE_CHANGED,e)})),nt.onAutoplayFailed=()=>{t.info("detect audio element autoplay failed"),vt.onAudioAutoplayFailed&&vt.onAudioAutoplayFailed()},bt.on("autoplay-failed",(()=>{t.info("detect webaudio autoplay failed"),vt.onAudioAutoplayFailed&&vt.onAudioAutoplayFailed(),Zr.safeEmit(Gi.AUTOPLAY_FAILED)})),bt.on(Nt.STATE_CHANGE,((e,i)=>{t.info("audio context state changed: ".concat(i," => ").concat(e)),Zr.onAudioContextStateChanged&&Zr.onAudioContextStateChanged(e,i),Zr.safeEmit(Gi.AUDIO_CONTEXT_STATE_CHANGED,e,i)})),window&&(window.__ARTC__={ESM_BUNDLER:true,ESM:false,UMD:false,DEV:false,AgoraRTC:Zr,__TRACK_LIST__:Ot}),R.on(I.NETWORK_STATE_CHANGE,((e,i)=>{t.info("[network-indicator] network state changed, ".concat(i," => ").concat(e))}));const oc=(e,i,n)=>{t.debug("setParameter key:".concat(e,", value:").concat(JSON.stringify(i))),W(e,i,n)};export{vi as AREAS,Zr as AgoraRTC,Ti as ChannelMediaRelayError,fi as ChannelMediaRelayEvent,Ci as ChannelMediaRelayState,Mt as DEV,Lt as ESM,Pt as ESM_BUNDLER,kt as UMD,Ft as __CLIENT_LIST__,ma as checkAudioTrackIsActive,Pr as checkSystemRequirements,Ea as checkVideoTrackIsActive,Hr as createChannelMediaRelayConfiguration,Or as createClient,Jr as disableLogUpload,qr as enableLogUpload,jr as getCameras,Br as getDevices,Gr as getMicrophones,Wr as getPlaybackDevices,Dr as getSupportedCodec,$r as onAudioAutoplayFailed,sc as onAudioContextStateChanged,ec as onAutoplayFailed,ic as onCameraChanged,nc as onMicrophoneChanged,tc as onSecurityPolicyViolation,ba as preload,Xr as processExternalMediaAEC,zr as registerExtensions,Qr as resumeAudioContext,Kr as setAppType,rs as setArea,Yr as setLogLevel,oc as setParameter};
