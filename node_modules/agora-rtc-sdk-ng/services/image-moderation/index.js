/**
 * AgoraWebSDK_N-v4.22.0-0-g8569241d-dirty Copyright AgoraInc.
 */

import{AgoraRTCError as e,IS_GLOBAL_VERSION as t,MUTABLE_PARAMS as n,EventEmitter as o,PromiseMutex as E,NETWORK_STATE as i,networkIndicator as _,NETWORK_INDICATOR_EVENTS as s,createDefer as r,getParameter as c,AgoraRTCErrorCode as a,getRetryWaitTime as R,wait as N,emitAsPromise as I,emitAsInvokerNoResponse as A,getUTF8StringByteLength as O,getMultiUnilbsFormDataByteLength as T,retryable as C,checkValidNumber as h,getRandomString as S,DEFAULT_RETRY_CONFIG as L,AgoraAPIName as d,AgoraAPITag as l}from"@agora-js/shared";import{logger as u,AgoraRTCEventReport as D,report as m}from"@agora-js/report";import{frameData2CryptoBuffer as w}from"@agora-js/media";import g from"axios";import"formdata-polyfill";function f(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var o=n.call(e,t||"default");if("object"!=typeof o)return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function V(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function p(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?V(Object(n),!0).forEach((function(t){f(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):V(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class b extends e{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",arguments.length>2?arguments[2]:void 0),this.name="AgoraRTCException"}print(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"error";return super.print(e,u)}throw(){super.throw(u)}}let U=function(e){return e[e.ACCESS_POINT=101]="ACCESS_POINT",e[e.UNILBS=201]="UNILBS",e[e.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR",e}({}),M=function(e){return e[e.IIIEGAL_APPID=1]="IIIEGAL_APPID",e[e.IIIEGAL_UID=2]="IIIEGAL_UID",e[e.INTERNAL_ERROR=3]="INTERNAL_ERROR",e}({}),v=function(e){return e[e.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",e[e.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",e[e.INTERNAL_ERROR=8]="INTERNAL_ERROR",e[e.NO_AUTHORIZED=9]="NO_AUTHORIZED",e[e.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",e[e.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",e[e.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",e[e.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",e[e.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",e[e.USER_OVERLOAD=16]="USER_OVERLOAD",e[e.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",e[e.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND",e}({}),P=function(e){return e[e.NO_FLAG_SET=100]="NO_FLAG_SET",e[e.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",e[e.INVALID_FALG_SET=102]="INVALID_FALG_SET",e[e.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",e[e.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",e[e.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",e[e.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",e[e.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",e[e.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",e[e.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",e[e.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",e[e.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",e[e.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",e[e.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",e[e.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",e[e.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",e[e.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",e[e.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",e[e.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV",e}({}),y=function(e){return e[e.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",e[e.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",e[e.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",e[e.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",e[e.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",e[e.K_TICKET_INVALID=7]="K_TICKET_INVALID",e[e.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",e[e.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",e[e.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",e[e.K_UID_BANNED=14]="K_UID_BANNED",e[e.K_IP_BANNED=15]="K_IP_BANNED",e[e.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",e[e.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",e[e.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",e[e.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",e[e.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",e[e.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",e[e.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",e[e.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",e[e.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",e[e.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",e[e.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",e[e.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",e[e.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",e[e.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",e[e.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",e[e.ERR_INVALID_UID=117]="ERR_INVALID_UID",e[e.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",e[e.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",e[e.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",e[e.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",e[e.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",e[e.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",e[e.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",e[e.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",e[e.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",e[e.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",e[e.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",e[e.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",e[e.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",e[e.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",e[e.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",e[e.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",e[e.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",e[e.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",e[e.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",e[e.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",e[e.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",e[e.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",e[e.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",e[e.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",e[e.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",e[e.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",e[e.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",e[e.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",e[e.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",e[e.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",e[e.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",e[e.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",e[e.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",e[e.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",e[e.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",e[e.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",e[e.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY",e}({}),k=function(e){return e.CONNECTED="websocket:connected",e.RECONNECTING="websocket:reconnecting",e.WILL_RECONNECT="websocket:will_reconnect",e.CLOSED="websocket:closed",e.FAILED="websocket:failed",e.ON_MESSAGE="websocket:on_message",e.REQUEST_NEW_URLS="websocket:request_new_urls",e.RECONNECT_WAITTING_FINISH="websocket:reconnect_waitting_finish",e.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire",e}({});const B=function(){const e="us".concat("erna","me"),t="pa".concat("sswo","rd"),n=["t","s","t"];n.splice(1,0,"e");const o=n.join(""),E=[];for(let e=0;e<6;e++)E.push("1");const i=E.join(""),_={};return _[e]=o,_[t]=i,Object.assign(_,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=B,t||(n.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],n.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],n.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],n.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],n.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],n.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],n.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",n.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",n.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",n.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",n.AREAS=["NORTH_AMERICA","OVERSEA"]);D.__CLIENT_LIST__=[];let G=function(e){return e.CHINA="CHINA",e.ASIA="ASIA",e.NORTH_AMERICA="NORTH_AMERICA",e.EUROPE="EUROPE",e.JAPAN="JAPAN",e.INDIA="INDIA",e.KOREA="KOREA",e.HKMC="HKMC",e.US="US",e.OCEANIA="OCEANIA",e.SOUTH_AMERICA="SOUTH_AMERICA",e.AFRICA="AFRICA",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="EXTENSIONS",e}({});G.AFRICA,G.ASIA,G.CHINA,G.EUROPE,G.GLOBAL,G.INDIA,G.JAPAN,G.NORTH_AMERICA,G.OCEANIA,G.OVERSEA,G.SOUTH_AMERICA;let K=function(e){return e.CHINA="CN",e.ASIA="AS",e.NORTH_AMERICA="NA",e.EUROPE="EU",e.JAPAN="JP",e.INDIA="IN",e.KOREA="KR",e.HKMC="HK",e.US="US",e.OCEANIA="OC",e.SOUTH_AMERICA="SA",e.AFRICA="AF",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="GLOBAL",e}({});K.ASIA,K.NORTH_AMERICA,K.EUROPE,K.JAPAN,K.INDIA,K.KOREA,K.HKMC,K.US,K.OVERSEA,K.GLOBAL,K.OCEANIA,K.SOUTH_AMERICA,K.AFRICA,t&&K.CHINA;let W=function(e){return e.CONNECTED="transmitter:connected",e.RECONNECTING="transmitter:reconnecting",e.WILL_RECONNECT="transmitter:will_reconnect",e.CLOSED="transmitter:closed",e.FAILED="transmitter:failed",e.ON_MESSAGE="transmitter:on_message",e.REQUEST_NEW_URLS="transmitter:request_new_urls",e.RECONNECT_WAITTING_FINISH="transmitter:reconnect_waitting_finish",e.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",e.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",e.FAILBACK="transmitter:failback",e.PRE_CONNECT_PC="transmitter:pre_connect_pc",e}({}),H=function(e){return e.CONNECTING="CONNECTING",e.RECONNECTING="RECONNECTING",e.CONNECTED="CONNECTED",e.CLOSED="CLOSED",e}({}),Y=function(e){return e.CONNECTION_STATE_CHANGE="connection-state-change",e.STATE_CHANGE="state-change",e.INSPECT_RESULT="inspect-result",e.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",e.REQUEST_NEW_WORKER_URL="request-new-worker-url",e}({}),F=function(e){return e[e.CONNECT_AP=0]="CONNECT_AP",e[e.AP_CONNECTED=1]="AP_CONNECTED",e[e.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",e[e.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",e[e.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",e[e.CONNECT_WORKER=5]="CONNECT_WORKER",e[e.WORKER_CONNECTED=6]="WORKER_CONNECTED",e[e.CLOSED=7]="CLOSED",e}({});class x extends o{get url(){return this.websocket&&this.websocket.url||null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){["tryNext","recover"].includes(e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,"reconnecting"===this._state?this.emit(k.RECONNECTING,this.reconnectReason):"connected"===this._state?this.emit(k.CONNECTED):"closed"===this._state?this.emit(k.CLOSED):"failed"===this._state&&this.emit(k.FAILED))}resetReconnectCount(e){u.debug("websocket reset reconnect count, reason: "+e),this.reconnectCount=0}constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],c=arguments.length>5?arguments[5]:void 0;super(),this.connectionID=0,this.currentURLIndex=0,this.urls=[],this._reconnectMode="tryNext",this.reconnectReason=void 0,this._initMutex=new E("websocket"),this.name=void 0,this._state="closed",this.reconnectInterrupter=void 0,this.websocket=void 0,this.retryConfig=void 0,this.reconnectCount=0,this.forceCloseTimeout=5e3,this.onlineReconnectListener=void 0,this.useCompress=void 0,this.tryDoubleDomain=!1,this.use443PortOnly=!1,this.wsInflateLength=0,this.wsDeflateLength=0,this.closeEstablishingWs=()=>{},this.store=void 0,this.joinGatewayRecordIndex=void 0,this.store=c,this.name=e,this.retryConfig=p({},t),this.useCompress=n,this.tryDoubleDomain=o,this.use443PortOnly=r;const{timeout:a,timeoutFactor:R}=t,N=Math.max(300,Math.floor(3*a/5)),I=Math.max(1.2,Math.floor(8*R)/10);i.ONLINE&&(this.retryConfig.timeout=N,this.retryConfig.timeoutFactor=I),_.on(s.NETWORK_STATE_CHANGE,((e,t)=>{e!==t&&(this.resetReconnectCount("network state change: ".concat(t," -> ").concat(e)),e===i.ONLINE?(this.retryConfig.timeout=N,this.retryConfig.timeoutFactor=I):(this.retryConfig.timeout=a,this.retryConfig.timeoutFactor=R))}))}getConnection(){return this.websocket||void 0}async init(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const o=await this._initMutex.lock();this.forceCloseTimeout=n,this.urls=t,this.state="connecting";try{const t=r(),n=this.urls[this.currentURLIndex];c("ENABLE_PREALLOC_PC")&&this.emit(W.PRE_CONNECT_PC),this.createWebSocketConnection(n).then(t.resolve).catch(t.reject),this.once(k.CLOSED,(()=>{t.reject(new e(a.WS_DISCONNECT))})),this.once(k.CONNECTED,t.resolve),await t.promise}catch(e){}finally{o()}}close(e,t){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;const e=this.websocket;t?setTimeout((()=>e.close()),500):e.close(),this.websocket=void 0}this.state=e?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(e,t){if(!this.websocket)return void u.warning("[".concat(this.name,"] can not reconnect, no websocket"));void 0!==e&&(this.reconnectMode=e),u.debug("[".concat(this.name,"] reconnect is triggered initiative")),"number"==typeof this.joinGatewayRecordIndex&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(t)]},this.joinGatewayRecordIndex);const n=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),n&&n.bind(this.websocket)({code:9999,reason:t})}sendMessage(t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new e(a.WS_ABORT,"websocket is not ready");try{n||(t=JSON.stringify(t)),this.websocket.send(t)}catch(t){throw new e(a.WS_ERR,"send websocket message error"+t.toString())}}setWsInflateData(e){this.wsDeflateLength=this.wsDeflateLength+e.originLength,this.wsInflateLength=this.wsInflateLength+e.compressedLength}getWsInflateData(){const e=this.wsInflateLength,t=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:e,wsDeflateLength:t}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(t){var n;const o=r();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;const E=e=>{var t;null===(t=this.store)||void 0===t||t.signalChannelOpen(),u.debug("[".concat(this.name,"] websocket opened:"),e),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),o.resolve()},i=async t=>{var n;if(u.debug("[".concat(this.name,"] websocket close ").concat(null===(n=this.websocket)||void 0===n?void 0:n.url,", code: ").concat(t.code,", reason: ").concat(t.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)o.reject(new e(a.WS_DISCONNECT,"websocket close: ".concat(t.code))),this.close();else{"connected"===this.state&&(this.reconnectReason=t.reason,this.state="reconnecting");const n=A(this,k.WILL_RECONNECT,this.reconnectMode,t.reason)||this.reconnectMode,E=await this.reconnectWithAction(n);if("closed"===this.state)return void u.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!E)return o.reject(new e(a.WS_DISCONNECT,"websocket reconnect failed: ".concat(t.code))),this.close(!0);o.resolve()}},_=e=>{this.emit(k.ON_MESSAGE,e)},s=e=>{u.warn("[".concat(this.connectionID,"] ws open error ").concat(e))};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),c("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(t=c("GATEWAY_WSS_ADDRESS")),u.debug("[".concat(this.name,"] start connect, url:"),t);const R=null===(n=this.store)||void 0===n?void 0:n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var N;const e=await this.chooseBestWebsocketConnection(t);this.websocket=e,E&&E(this.websocket.url),this.websocket.onclose=i,this.websocket.onmessage=_,this.websocket.onerror=s,null===(N=this.store)||void 0===N||N.recordJoinChannelService({endTs:Date.now(),status:"success"},R),this.joinGatewayRecordIndex=R}catch(t){const n="closed"===this.state,E=t instanceof e,_=E&&t.code===a.WS_ABORT,s=E&&t.code===a.WS_ERR,r=E?t.message:t&&(t.reason||t.toString());u.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(r)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:_?"aborted":"error",errors:[t]},R),n||s?(o.reject(n?new e(a.WS_DISCONNECT,"websocket is closed: ".concat(r)):new e(a.WS_ERR,"init websocket failed: ".concat(r))),s&&u.error("[".concat(this.name,"] init websocket failed: ").concat(r))):i&&i(t)}return o.promise}async reconnectWithAction(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount)return!1;if(0===this.urls.length)return!1;if("closed"===this.state)return!1;u.warning("[choose-best-ws] action: =>",e),this.onlineReconnectListener||_.isOnline||!_.onlineWaiter||(this.onlineReconnectListener=_.onlineWaiter.then((()=>{this.onlineReconnectListener=void 0})));let n=!0;if(this.reconnectInterrupter=()=>n=!1,t){const t=R(this.reconnectCount,this.retryConfig);u.debug("[".concat(this.name,"] wait ").concat(t,"ms to reconnect websocket, mode: ").concat(e)),await Promise.race([N(t),this.onlineReconnectListener||new Promise((()=>{}))])}if("closed"===this._state||!n)return!1;this.reconnectCount+=1;const o=async(e,t)=>{this.emit(k.RECONNECT_CREATE_CONNECTION,t),await this.createWebSocketConnection(e)};try{if("retry"===e)this.emit(k.RECONNECT_WAITTING_FINISH,e),await o(this.urls[this.currentURLIndex],e);else if("tryNext"===e){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);u.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),this.emit(k.RECONNECT_WAITTING_FINISH,e),await o(this.urls[this.currentURLIndex],e)}else"recover"===e&&(u.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.emit(k.RECONNECT_WAITTING_FINISH,e),this.urls=await I(this,k.REQUEST_NEW_URLS),this.currentURLIndex=0,await o(this.urls[this.currentURLIndex],e))}catch(n){var E;u.error("[".concat(this.name,"] reconnect failed ").concat(n&&n.toString()));const o=null==n||null===(E=n.data)||void 0===E?void 0:E.desc;return Array.isArray(o)&&o.includes("dynamic key expired")?(this.emit(k.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):this.reconnectWithAction(e,t)}return!0}}class J extends x{constructor(e,t){super(e,t,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(t,n){return new Promise(((o,E)=>{let i=!1;const _=[];this.closeEstablishingWs=()=>{u.debug("[choose-best-ws] close establishing websockets"),_.forEach((e=>{e.onclose=null,e.onopen=null,e.onmessage=null,e.close()})),E(new e(a.WS_ABORT,"choose best websocket aborted"))};const s=c("GATEWAY_DOMAINS");let r;const R=t.indexOf("?h="),I=s.find((e=>-1!==R?t.includes(e,R):t.includes(e)));u.debug("[choose-best-ws] currentDomain: ",I,", domains: ",s);let A=!this.tryDoubleDomain||!I;if(!A&&I){var O;const e=Date.now();try{s.forEach((e=>{const n=-1===R?t.replace(I,e):t.substr(0,R)+t.substr(R).replace(I,e),o=new WebSocket(n);o.binaryType="arraybuffer",_.push(o),u.debug("[choose-best-ws] ws is connecting:",o.url)}))}catch(e){for(u.debug("[choose-best-ws] ws create failed, fallback to single url"),_.forEach((e=>e.close()));_.length;)_.pop();A=!0}null===(O=this.store)||void 0===O||O.recordJoinChannelService({urls:_.map((e=>e.url)),service:"gateway"},n),_.forEach((t=>{t.onopen=()=>{if(i)return;const n=Date.now()-e;u.debug("[choose-best-ws] ws open cost ".concat(n,"ms")),_.filter((e=>e!==t)).forEach((e=>{u.debug("[choose-best-ws]close backup websocket: ".concat(e.url)),e.close()})),i=!0,o(t)},t.onclose=e=>{if(r=e,i)return;_.find((e=>!(e.readyState===WebSocket.CLOSED||e.readyState===WebSocket.CLOSING)))||(u.debug("[choose-best-ws] all websocket is closed"),i=!0,E(r))},t.onmessage=e=>{u.debug("[choose-best-ws]".concat(t.url," onmessage: ").concat(e.data))}})),N(this.forceCloseTimeout).then((()=>{_.forEach((e=>{e.readyState!==WebSocket.OPEN&&e.close()}))}))}if(A){var T;let i;u.debug("[choose-best-ws] use single url: ",t),null===(T=this.store)||void 0===T||T.recordJoinChannelService({urls:[t],service:"gateway"},n);try{i=new WebSocket(t),_.push(i),i.binaryType="arraybuffer"}catch(t){const n=new e(a.WS_ERR,"init websocket failed! Error: ".concat(t.toString()));return u.error("[".concat(this.name,"]").concat(n)),void E(n)}i.onopen=()=>{o(i)},i.onclose=e=>{E(e)},i.onmessage=e=>{u.debug("[choose-best-ws]".concat(i.url," onmessage: ").concat(e.data))},N(this.forceCloseTimeout).then((()=>{i&&i.readyState!==WebSocket.OPEN&&i.close()}))}})).then((e=>(this.closeEstablishingWs=void 0,e))).catch((e=>{throw this.closeEstablishingWs=void 0,e}))}}function q(e){let t=function(){const e=Z.pop();return e?(e.offset=e.limit=0,e):{bytes:new Uint8Array(64),offset:0,limit:0}}();return function(e,t){let n=e.appId;void 0!==n&&(re(t,10),Ee(t,n));let o=e.cid;void 0!==o&&(re(t,16),re(t,o));let E=e.cname;void 0!==E&&(re(t,26),Ee(t,E));let i=e.deviceId;void 0!==i&&(re(t,34),Ee(t,i));let _=e.elapse;void 0!==_&&(re(t,40),ae(t,_));let s=e.fileSize;void 0!==s&&(re(t,48),ae(t,Q(s)));let r=e.height;void 0!==r&&(re(t,56),ae(t,Q(r)));let c=e.jpg;void 0!==c&&(re(t,66),re(t,c.length),ne(t,c));let a=e.networkType;void 0!==a&&(re(t,72),ae(t,Q(a)));let R=e.osType;void 0!==R&&(re(t,80),ae(t,Q(R)));let N=e.requestId;void 0!==N&&(re(t,90),Ee(t,N));let I=e.sdkVersion;void 0!==I&&(re(t,98),Ee(t,I));let A=e.sequence;void 0!==A&&(re(t,104),ae(t,Q(A)));let O=e.sid;void 0!==O&&(re(t,114),Ee(t,O));let T=e.timestamp;void 0!==T&&(re(t,120),ae(t,T));let C=e.uid;void 0!==C&&(re(t,128),re(t,C));let h=e.vid;void 0!==h&&(re(t,136),re(t,h));let S=e.width;void 0!==S&&(re(t,144),ae(t,Q(S)));let L=e.service;void 0!==L&&(re(t,152),re(t,L));let d=e.callbackData;void 0!==d&&(re(t,162),re(t,d.length),ne(t,d));let l=e.ticket;void 0!==l&&(re(t,170),Ee(t,l));let u=e.vendorConfigs;void 0!==u&&(re(t,178),Ee(t,u))}(e,t),function(e){let t=e.bytes,n=e.limit;return t.length===n?t:t.subarray(0,n)}(t)}function j(e){return function(e){let t={};e:for(;!$(e);){let n=se(e);switch(n>>>3){case 0:break e;case 1:t.code=se(e);break;case 2:t.msg=oe(e,se(e));break;case 3:t.requestId=oe(e,se(e));break;case 4:t.timestamp=ce(e,!1);break;default:X(e,7&n)}}return t}({bytes:t=e,offset:0,limit:t.length});var t}function X(e,t){switch(t){case 0:for(;128&ie(e););break;case 2:z(e,se(e));break;case 5:z(e,4);break;case 1:z(e,8);break;default:throw new Error("Unimplemented type: "+t)}}function Q(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}let Z=[];function z(e,t){if(e.offset+t>e.limit)throw new Error("Skip past limit");e.offset+=t}function $(e){return e.offset>=e.limit}function ee(e,t){let n=e.bytes,o=e.offset,E=e.limit,i=o+t;if(i>n.length){let t=new Uint8Array(2*i);t.set(n),e.bytes=t}return e.offset=i,i>E&&(e.limit=i),o}function te(e,t){let n=e.offset;if(n+t>e.limit)throw new Error("Read past limit");return e.offset+=t,n}function ne(e,t){let n=ee(e,t.length);e.bytes.set(t,n)}function oe(e,t){let n=te(e,t),o=String.fromCharCode,E=e.bytes,i="ï¿½",_="";for(let e=0;e<t;e++){let s,r,c,a,R=E[e+n];0==(128&R)?_+=o(R):192==(224&R)?e+1>=t?_+=i:(s=E[e+n+1],128!=(192&s)?_+=i:(a=(31&R)<<6|63&s,a<128?_+=i:(_+=o(a),e++))):224==(240&R)?e+2>=t?_+=i:(s=E[e+n+1],r=E[e+n+2],32896!=(49344&(s|r<<8))?_+=i:(a=(15&R)<<12|(63&s)<<6|63&r,a<2048||a>=55296&&a<=57343?_+=i:(_+=o(a),e+=2))):240==(248&R)?e+3>=t?_+=i:(s=E[e+n+1],r=E[e+n+2],c=E[e+n+3],8421504!=(12632256&(s|r<<8|c<<16))?_+=i:(a=(7&R)<<18|(63&s)<<12|(63&r)<<6|63&c,a<65536||a>1114111?_+=i:(a-=65536,_+=o(55296+(a>>10),56320+(1023&a)),e+=3))):_+=i}return _}function Ee(e,t){let n=t.length,o=0;for(let e=0;e<n;e++){let E=t.charCodeAt(e);E>=55296&&E<=56319&&e+1<n&&(E=(E<<10)+t.charCodeAt(++e)-56613888),o+=E<128?1:E<2048?2:E<65536?3:4}re(e,o);let E=ee(e,o),i=e.bytes;for(let e=0;e<n;e++){let o=t.charCodeAt(e);o>=55296&&o<=56319&&e+1<n&&(o=(o<<10)+t.charCodeAt(++e)-56613888),o<128?i[E++]=o:(o<2048?i[E++]=o>>6&31|192:(o<65536?i[E++]=o>>12&15|224:(i[E++]=o>>18&7|240,i[E++]=o>>12&63|128),i[E++]=o>>6&63|128),i[E++]=63&o|128)}}function ie(e){return e.bytes[te(e,1)]}function _e(e,t){let n=ee(e,1);e.bytes[n]=t}function se(e){let t,n=0,o=0;do{t=ie(e),n<32&&(o|=(127&t)<<n),n+=7}while(128&t);return o}function re(e,t){for(t>>>=0;t>=128;)_e(e,127&t|128),t>>>=7;_e(e,t)}function ce(e,t){let n,o=0,E=0,i=0;return n=ie(e),o=127&n,128&n&&(n=ie(e),o|=(127&n)<<7,128&n&&(n=ie(e),o|=(127&n)<<14,128&n&&(n=ie(e),o|=(127&n)<<21,128&n&&(n=ie(e),E=127&n,128&n&&(n=ie(e),E|=(127&n)<<7,128&n&&(n=ie(e),E|=(127&n)<<14,128&n&&(n=ie(e),E|=(127&n)<<21,128&n&&(n=ie(e),i=127&n,128&n&&(n=ie(e),i|=(127&n)<<7))))))))),{low:o|E<<28,high:E>>>4|i<<24,unsigned:t}}function ae(e,t){let n=t.low>>>0,o=(t.low>>>28|t.high<<4)>>>0,E=t.high>>>24,i=0===E?0===o?n<16384?n<128?1:2:n<1<<21?3:4:o<16384?o<128?5:6:o<1<<21?7:8:E<128?9:10,_=ee(e,i),s=e.bytes;switch(i){case 10:s[_+9]=E>>>7&1;case 9:s[_+8]=9!==i?128|E:127&E;case 8:s[_+7]=8!==i?o>>>21|128:o>>>21&127;case 7:s[_+6]=7!==i?o>>>14|128:o>>>14&127;case 6:s[_+5]=6!==i?o>>>7|128:o>>>7&127;case 5:s[_+4]=5!==i?128|o:127&o;case 4:s[_+3]=4!==i?n>>>21|128:n>>>21&127;case 3:s[_+2]=3!==i?n>>>14|128:n>>>14&127;case 2:s[_+1]=2!==i?n>>>7|128:n>>>7&127;case 1:s[_]=1!==i?128|n:127&n}}const Re={},Ne={},Ie=4294967296,Ae=Ie*Ie,Oe=Ae/2,Te=de(0,!0),Ce=de(0),he=le(0,-2147483648,!1),Se=le(-1,2147483647,!1),Le=le(-1,-1,!0);function de(e,t){let n,o,E;return t?(E=0<=(e>>>=0)&&e<256)&&(o=Ne[e],o)?o:(n=le(e,0,!0),E&&(Ne[e]=n),n):(E=-128<=(e|=0)&&e<128)&&(o=Re[e],o)?o:(n=le(e,e<0?-1:0,!1),E&&(Re[e]=n),n)}function le(e,t,n){return{low:0|e,high:0|t,unsigned:!!n}}function ue(e,t){if(isNaN(e))return t?Te:Ce;if(t){if(e<0)return Te;if(e>=Ae)return Le}else{if(e<=-Oe)return he;if(e+1>=Oe)return Se}return e<0?t?Te:Ce:le(e%Ie|0,e/Ie|0,t)}let De=0,me=0;U.ACCESS_POINT,P.NO_FLAG_SET,P.FLAG_SET_BUT_EMPTY,P.INVALID_FALG_SET,P.FLAG_SET_BUT_NO_RE,P.INVALID_SERVICE_ID,P.NO_SERVICE_AVAILABLE,P.NO_SERVICE_AVAILABLE_P2P,P.NO_SERVICE_AVAILABLE_VOICE,P.NO_SERVICE_AVAILABLE_WEBRTC,P.NO_SERVICE_AVAILABLE_CDS,P.NO_SERVICE_AVAILABLE_CDN,P.NO_SERVICE_AVAILABLE_TDS,P.NO_SERVICE_AVAILABLE_REPORT,P.NO_SERVICE_AVAILABLE_APP_CENTER,P.NO_SERVICE_AVAILABLE_ENV0,P.NO_SERVICE_AVAILABLE_VOET,P.NO_SERVICE_AVAILABLE_STRING_UID,P.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS,U.UNILBS,v.INVALID_VENDOR_KEY,v.INVALID_CHANNEL_NAME,v.INTERNAL_ERROR,v.NO_AUTHORIZED,v.DYNAMIC_KEY_TIMEOUT,v.NO_ACTIVE_STATUS,v.DYNAMIC_KEY_EXPIRED,v.STATIC_USE_DYNAMIC_KEY,v.DYNAMIC_USE_STATIC_KEY,v.USER_OVERLOAD,v.FORBIDDEN_REGION,v.CANNOT_MEET_AREA_DEMAND,U.STRING_UID_ALLOCATOR,M.IIIEGAL_APPID,M.IIIEGAL_UID,M.INTERNAL_ERROR,y.K_TIMESTAMP_EXPIRED,y.K_CHANNEL_PERMISSION_INVALID,y.K_CERTIFICATE_INVALID,y.K_CHANNEL_NAME_EMPTY,y.K_CHANNEL_NOT_FOUND,y.K_TICKET_INVALID,y.K_CHANNEL_CONFLICTED,y.K_SERVICE_NOT_READY,y.K_SERVICE_TOO_HEAVY,y.K_UID_BANNED,y.K_IP_BANNED,y.K_AUTO_REBALANCE,y.ERR_INVALID_VENDOR_KEY,y.ERR_INVALID_CHANNEL_NAME,y.WARN_NO_AVAILABLE_CHANNEL,y.WARN_LOOKUP_CHANNEL_TIMEOUT,y.WARN_LOOKUP_CHANNEL_REJECTED,y.WARN_OPEN_CHANNEL_TIMEOUT,y.WARN_OPEN_CHANNEL_REJECTED,y.WARN_REQUEST_DEFERRED,y.ERR_DYNAMIC_KEY_TIMEOUT,y.ERR_NO_AUTHORIZED,y.ERR_VOM_SERVICE_UNAVAILABLE,y.ERR_NO_CHANNEL_AVAILABLE_CODE,y.ERR_MASTER_VOCS_UNAVAILABLE,y.ERR_INTERNAL_ERROR,y.ERR_NO_ACTIVE_STATUS,y.ERR_INVALID_UID,y.ERR_DYNAMIC_KEY_EXPIRED,y.ERR_STATIC_USE_DYANMIC_KE,y.ERR_DYNAMIC_USE_STATIC_KE,y.ERR_NO_VOCS_AVAILABLE,y.ERR_NO_VOS_AVAILABLE,y.ERR_JOIN_CHANNEL_TIMEOUT,y.ERR_JOIN_BY_MULTI_IP,y.ERR_NOT_JOINED,y.ERR_REPEAT_JOIN_REQUEST,y.ERR_REPEAT_JOIN_CHANNEL,y.ERR_INVALID_STRINGUID,y.ERR_TOO_MANY_USERS,y.ERR_SET_CLIENT_ROLE_TIMEOUT,y.ERR_SET_CLIENT_ROLE_NO_PERMISSION,y.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE,y.ERR_PUBLISH_REQUEST_INVALID,y.ERR_SUBSCRIBE_REQUEST_INVALID,y.ERR_NOT_SUPPORTED_MESSAGE,y.ERR_ILLEAGAL_PLUGIN,y.ILLEGAL_CLIENT_ROLE_LEVEL,y.ERR_REJOIN_TOKEN_INVALID,y.ERR_REJOIN_USER_NOT_JOINED,y.ERR_INVALID_OPTIONAL_INFO,y.ERR_TEST_RECOVER,y.ERR_TEST_TRYNEXT,y.ERR_TEST_RETRY,y.ILLEGAL_AES_PASSWORD,y.ERR_TOO_MANY_BROADCASTERS,y.ERR_TOO_MANY_SUBSCRIBERS,y.ERR_LICENSE_ILLEGAL,y.ERR_LICENSE_MISSING,y.ERR_LICENSE_EXPIRED,y.ERR_LICENSE_MINUTES_EXCEEDED,y.ERR_LICENSE_PERIOD_INVALID,y.ERR_LICENSE_MULTIPLE_SDK_SERVICE;const we={GLOBAL:{ASIA:[G.CHINA,G.JAPAN,G.INDIA,G.KOREA,G.HKMC],EUROPE:[],NORTH_AMERICA:[G.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}};Object.keys(we[G.GLOBAL]),G.CHINA,G.NORTH_AMERICA,G.EUROPE,G.ASIA,G.JAPAN,G.INDIA,G.OCEANIA,G.SOUTH_AMERICA,G.AFRICA,G.KOREA,G.HKMC,G.US;let ge=0;function fe(e,t,n,o){let{appId:E,areaCode:i,cname:_,sid:s,token:r,uid:R}=t;ge++;const N="moderation_plugin",I={service_name:N,json_body:JSON.stringify({appId:E,areaCode:i,cname:_,command:"allocateEdge",requestId:ge,seq:ge,sid:s,appToken:r,ts:Date.now(),uid:R+""})};let A,h,S=e[0];return C((async()=>{A=Date.now();const e=await function(e,t,n,o){return new Promise(((E,i)=>{t.timeout=t.timeout||c("HTTP_CONNECT_TIMEOUT"),t.responseType=t.responseType||"json",t.data&&!n?(t.data=JSON.stringify(t.data),De+=O(t.data)):n&&(t.data.size?De+=t.data.size:t.data instanceof FormData?De+=T(t.data):De+=O(JSON.stringify(t.data))),t.headers=t.headers||{},t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.method="POST",t.url=e,g.request(t).then((e=>{"string"==typeof e.data?me+=O(e.data):e.data instanceof ArrayBuffer||e.data instanceof Uint8Array?me+=e.data.byteLength:me+=O(JSON.stringify(e.data)),o&&E({data:e.data,headers:e.headers}),E(e.data)})).catch((e=>{g.isCancel(e)?i(new b(a.OPERATION_ABORTED,"cancel token canceled")):"ECONNABORTED"===e.code?i(new b(a.NETWORK_TIMEOUT,e.message)):e.response?i(new b(a.NETWORK_RESPONSE_ERROR,e.response.status)):i(new b(a.NETWORK_ERROR,e.message))}))}))}(S,{data:I,cancelToken:n,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(h=Date.now()-A,0!==e.code){const t=new b(a.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+e.code,{retry:!0,responseTime:h});throw u.error(t.toString()),t}const t=JSON.parse(e.json_body);if(200!==t.code){const e=new b(a.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(t.code,", reason: ").concat(t.reason),{code:t.code,responseTime:h});throw u.error(e.toString()),e}if(!t.servers||!Array.isArray(t.servers)||0===t.servers.length){const e=new b(a.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:t.code,responseTime:h});throw u.error(e.toString()),e}if(!t.servers.some((e=>!!e.wss))){const e=new b(a.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:t.code,responseTime:h});throw u.error(e.toString()),e}const o=c("IMAGE_MODERATION_WORKER_HOST");return{addressList:t.servers.map((e=>{let{address:t,wss:n}=e;if(t&&n)return"wss://".concat(t.replace(/\./g,"-"),".").concat(o,":").concat(n,"/moderation")})).filter((e=>!!e)),workerToken:t.workerToken,vid:t.vid,ticket:t.appTicket,responseTime:h}}),((t,n)=>(m.apworkerEvent(s,{success:!0,sc:200,serviceName:N,responseDetail:JSON.stringify(t.addressList),firstSuccess:0===n,responseTime:h,serverIp:e[n%e.length]}),!1)),((t,n)=>(m.apworkerEvent(s,{success:!1,sc:t.data&&t.data.code||200,serviceName:N,responseTime:h,serverIp:e[n%e.length]}),!!(t.code!==a.OPERATION_ABORTED&&t.code!==a.UNEXPECTED_RESPONSE||t.data&&t.data.retry)&&(S=e[(n+1)%e.length],!0))),o)}class Ve extends o{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;const t=this._connectionState;this._connectionState=e,this.emit(Y.CONNECTION_STATE_CHANGE,e,t)}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout((()=>{this.quality=this._quality/this._qualityRatio}),6e4))}constructor(e){var t;super(),this.name="AgoraRTCImageModeration",this._connectionState=H.CONNECTING,this._sequence=0,this._moderationStartTime=void 0,this._workerConnection=void 0,this._workerMessageLengthLimit=void 0,this._qualityRatio=void 0,this._connectInfo=void 0,this._cancelTokenSource=g.CancelToken.source(),this._retryConfig=void 0,this._moderationInterval=void 0,this._moderationTimer=null,this._moderationMode=1,this._quality=1,this._qualityTimer=null,this._ticket=void 0,this._moderationIntervalMinimum=void 0,this._uploadFailedNum=0,this._uploadNum=0,this._uploadTimer=null,this._extraInfo=void 0,this._vendor="",this._encoder=new TextEncoder,this._moderationId=void 0,this.inspectImage=()=>{if(this.connectionState!==H.CONNECTED)throw new b(a.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval((()=>{this.connectionState===H.CONNECTED?this.requestToInspectImage():u.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState)}),this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage()},this._moderationId=S(5,"image-moderation-"),this._workerMessageLengthLimit=c("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=c("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=null!==(t=e.interval)&&void 0!==t?t:1e3,e.extraInfo&&(this._extraInfo=this._encoder.encode(e.extraInfo)),e.vendor&&(this._vendor=e.vendor),this._qualityRatio=c("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new J("worker-"+this._moderationId,L),this.on(Y.STATE_CHANGE,((e,t)=>{u.debug("[".concat(this._moderationId,"] Moderation operation :").concat(F[e]," ").concat(t||""))})),this.handleWorkerEvents()}async init(e,t){this.emit(Y.STATE_CHANGE,F.CONNECT_AP),this._connectInfo=e;const n=this._cancelTokenSource.token;return this._retryConfig=t,new Promise(((o,E)=>{this.on(Y.CONNECTION_STATE_CHANGE,((e,t)=>{e===H.CONNECTED&&o()})),this.requestAP(e,n,t).then((e=>{this.connectWorker(e)})).catch((e=>{E(e)}))}))}updateConfig(e){var t;this._moderationInterval=null!==(t=e.interval)&&void 0!==t?t:1e3,e.extraInfo&&(this._extraInfo=this._encoder.encode(e.extraInfo)),e.vendor&&(this._vendor=e.vendor),u.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(e))),this.connectionState===H.CONNECTED&&this.inspectImage()}async requestAP(e,t,n){const o=c("WEBCS_DOMAIN").map((e=>"https://".concat(e,"/api/v1"))),E=await fe(o,e,t,n);this.emit(Y.STATE_CHANGE,F.AP_CONNECTED);const{addressList:i,ticket:_}=E;return this._ticket=_,i}async connectWorker(e){this.emit(Y.STATE_CHANGE,F.CONNECT_WORKER),await this._workerConnection.init(e,1e4)}handleWorkerEvents(){this._workerConnection.on(k.CONNECTED,(async()=>{this.emit(Y.STATE_CHANGE,F.WORKER_CONNECTED,this._workerConnection.url),this.connectionState=H.CONNECTED})),this._workerConnection.on(k.CLOSED,(()=>{this.connectionState=H.CLOSED})),this._workerConnection.on(k.FAILED,(()=>{this.connectionState=H.CLOSED})),this._workerConnection.on(k.RECONNECTING,(()=>{this.connectionState=this.connectionState===H.CONNECTED?H.RECONNECTING:H.CONNECTING})),this._workerConnection.on(k.ON_MESSAGE,(async e=>{if(e.data instanceof ArrayBuffer){const t=j(new Uint8Array(e.data));c("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&u.debug("[".concat(this._moderationId,"] Response message for worker of image moderation "),JSON.stringify(t)),this._uploadNum++,void 0===t.code||0===t.code||(this._uploadFailedNum++,u.error("[".concat(this._moderationId,"] Error response from worke, code is ").concat(t.code,", msg is ").concat(t.msg)),this._uploadTimer||(this._uploadTimer=window.setTimeout((()=>{m.reportApiInvoke(this._connectInfo.sid||null,{name:d.IMAGE_MODERATION_UPLOAD,options:[this._uploadFailedNum,this._uploadNum,t.code],tag:l.TRACER}).onError(new b(a.IMAGE_MODERATION_UPLOAD_FAILED,t.msg)),this._uploadTimer=null}),c("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))))}else u.error("[".concat(this._moderationId,"] Unexpected message type from worker"))})),this._workerConnection.on(k.WILL_RECONNECT,((e,t,n)=>{"recover"===e&&n(e),n("tryNext")})),this._workerConnection.on(k.REQUEST_NEW_URLS,((e,t)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(t)}))}static intToLong(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}async requestToInspectImage(){const e=A(this,Y.CLIENT_LOCAL_VIDEO_TRACK),t={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void(c("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&u.debug("Only the track being played can be inspected"));this._sequence++;const n=await this.generateRequestData(e,t);this._workerConnection.sendMessage(n,!0,!0)}else c("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&u.debug("Only the track being published can be inspected")}async generateRequestData(e,t){let{appId:n,cname:o,cid:E,vid:i,sid:_,uid:s}=t;const r=Date.now(),a=await e.getCurrentFrameImage("image/jpeg",this.quality),R=await w(a,n,o),N=this._sequence+"-"+E+"-"+s+"-"+r+"-"+S(12,""),I={appId:n,cid:E,cname:o,deviceId:"",elapse:Ve.intToLong(Number(r-this._moderationStartTime)),fileSize:a.buffer.byteLength,height:a.height,width:a.width,jpg:R,networkType:6,osType:7,requestId:N,sdkVersion:"4.22.0",sequence:this._sequence,sid:_,timestamp:ue(r),uid:s,vid:i,service:this._moderationMode,ticket:this._ticket,callbackData:this._extraInfo,vendorConfigs:this._vendor};void 0===this._extraInfo&&delete I.callbackData;const A=q(I);if(A.byteLength<this._workerMessageLengthLimit){if(c("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){const e=p({},I);delete e.jpg,u.debug("[".concat(this._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(e))}return A}{const t=this.quality*this._qualityRatio;return this.quality=t,await this.generateRequestData(e,{appId:n,cname:o,cid:E,vid:i,sid:_,uid:s})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=g.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=H.CLOSED,this.emit(Y.STATE_CHANGE,F.CLOSED)}}function pe(e){if(h(e.interval,"interval",1e3,1/0),e&&e.extraInfo&&e.extraInfo.length>1024)throw new b(a.INVALID_PARAMS,"config.extraInfo length cannot exceed 1024 bytes");if(e&&e.vendor&&e.vendor.length>1024)throw new b(a.INVALID_PARAMS,"config.vendor length cannot exceed 1024 bytes")}const be={name:"ImageModeration",create:function(e){let{config:t}=e;return pe(t),new Ve(t)}};export{be as ImageModerationService,pe as checkImageModerationConfig};
