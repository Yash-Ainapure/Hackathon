/**
 * AgoraWebSDK_N-v4.22.0-0-g8569241d-dirty Copyright AgoraInc.
 */

import{EventEmitter as t,setParameter as e,getParameter as s,VERSION as o,retryable as r,checkValidString as n,checkValidNumber as i,wait as a,AgoraRTCErrorCode as c,AgoraRTCError as p,throttleByKey as E,IS_GLOBAL_VERSION as d,BUILD as l,isPageRecording as _,dividePackage as u,networkIndicator as h,NETWORK_STATE as T,DEFAULT_RETRY_CONFIG as R,post as I,postProtobuf as S,AgoraAPITag as g,getMessageEncoding as O,appendBuffer as A}from"@agora-js/shared";import m from"axios";function P(t,e,s){return(e=function(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var s=t[Symbol.toPrimitive];if(void 0!==s){var o=s.call(t,e||"default");if("object"!=typeof o)return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:e+""}(e))in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}function v(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,o)}return s}function f(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?v(Object(s),!0).forEach((function(e){P(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):v(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}const N=new class extends t{constructor(){super(...arguments),P(this,"currentUploadLogID",0)}reportLogUploadError(t){const{errorRange:e}=t;e[e.length-1]&&e[e.length-1]>this.currentUploadLogID&&(this.currentUploadLogID=e[e.length-1],this.emit("REPORT_LOG_UPLOAD",t))}};class D{constructor(t){P(this,"logger",void 0),P(this,"prefixLists",[]),this.logger=t}debug(){for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];this.logger.debug(...this.prefixLists,...e)}info(){for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];this.logger.info(...this.prefixLists,...e)}warning(){for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];this.logger.warning(...this.prefixLists,...e)}error(){for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];this.logger.error(...this.prefixLists,...e)}prefix(t){return this.prefixLists.push(t),this}popPrefix(){return this.prefixLists.pop(),this}}function U(){const t=new Date;return t.toTimeString().split(" ")[0]+":"+t.getMilliseconds()}function L(){const t=new Date,e=/((\d+:){2}\d+)/.exec((new Date).toUTCString());return e?(null==e?void 0:e[0])+":"+t.getUTCMilliseconds():t.toTimeString().split(" ")[0]+":"+t.getMilliseconds()}const b={DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4},y=Date.now(),C=t=>{for(const e in b)if(Object.prototype.hasOwnProperty.call(b,e)&&b[e]===t)return e;return"DEFAULT"};class w{constructor(){P(this,"proxyServerURL",void 0),P(this,"logLevel",b.DEBUG),P(this,"uploadState","collecting"),P(this,"uploadLogWaitingList",[]),P(this,"uploadLogUploadingList",[]),P(this,"uploadErrorCount",0),P(this,"currentLogID",0),P(this,"url",void 0),P(this,"extLog",((t,e)=>{this.appendLogToWaitingList(t,...e)}))}debug(){for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];const o=[b.DEBUG].concat(e);this.log.apply(this,o)}info(){for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];const o=[b.INFO].concat(e);this.log.apply(this,o)}warning(){for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];const o=[b.WARNING].concat(e);this.log.apply(this,o)}warn(){this.warning(...arguments)}error(){for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];const o=[b.ERROR].concat(e);this.log.apply(this,o)}upload(){for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];const o=[b.DEBUG].concat(e);this.uploadLog.apply(this,o)}setLogLevel(t){t=Math.min(Math.max(0,t),4),this.logLevel=t}enableLogUpload(){e("UPLOAD_LOG",!0)}disableLogUpload(){e("UPLOAD_LOG",!1),this.uploadLogUploadingList=[],this.uploadLogWaitingList=[]}setProxyServer(t){this.proxyServerURL=t}prefix(t){return new D(this).prefix(t)}log(){for(var t=arguments.length,e=new Array(t),o=0;o<t;o++)e[o]=arguments[o];if(Date.now()-y<100)return void setTimeout((()=>{this.log(...e)}),Date.now()-y);const r=Math.max(0,Math.min(4,e[0]));if(e[0]=U()+" Agora-SDK [".concat(C(r),"]:"),this.appendLogToWaitingList(r,...e),r<this.logLevel)return;const n=U()+" %cAgora-SDK [".concat(C(r),"]:");let i=[];if(!s("USE_NEW_LOG"))switch(r){case b.DEBUG:i=[n,"color: #64B5F6;"].concat(e.slice(1)),console.log.apply(console,i);break;case b.INFO:i=[n,"color: #1E88E5; font-weight: bold;"].concat(e.slice(1)),console.log.apply(console,i);break;case b.WARNING:i=[n,"color: #FB8C00; font-weight: bold;"].concat(e.slice(1)),console.warn.apply(console,i);break;case b.ERROR:i=[n,"color: #B00020; font-weight: bold;"].concat(e.slice(1)),console.error.apply(console,i)}}uploadLog(){for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];if(Date.now()-y<100)return void setTimeout((()=>{this.uploadLog(...e)}),Date.now()-y);const o=Math.max(0,Math.min(4,e[0]));e[0]=U()+" Agora-SDK [".concat(C(o),"]:"),this.appendLogToWaitingList(o,...e)}appendLogToWaitingList(t){if(!s("UPLOAD_LOG"))return;for(var e=arguments.length,o=new Array(e>1?e-1:0),r=1;r<e;r++)o[r-1]=arguments[r];Array.isArray(o[0])?o[0][0]=L()+" Agora-SDK [".concat(C(t),"]:"):o[0]=L()+" Agora-SDK [".concat(C(t),"]:");let n="";o.forEach((t=>{"object"==typeof t&&(t=JSON.stringify(t)),n+="".concat(t," ")})),this.uploadLogWaitingList.push({payload_str:n,log_level:t,log_item_id:this.currentLogID++}),"uploading"===this.uploadState&&0===this.uploadLogUploadingList.length&&this.uploadLogInterval()}startUpload(){this.uploadState="uploading",0===this.uploadLogUploadingList.length&&this.uploadLogInterval()}async uploadLogs(){const t=this.uploadLogUploadingList,e={sdk_version:o,process_id:s("PROCESS_ID"),payload:JSON.stringify(t)};return r((async()=>{const t=await m.post(this.url||(this.proxyServerURL?"https://".concat(this.proxyServerURL,"/ls/?h=").concat(s("LOG_UPLOAD_SERVER"),"&p=443&d=upload/v1"):"https://".concat(s("LOG_UPLOAD_SERVER"),"/upload/v1")),e,{responseType:"text"});if("OK"!==t.data){const e=new Error("unexpected upload log response");throw e.response=t,e}}),(()=>(this.uploadLogUploadingList=[],!1)),(e=>{const s={status:-1,message:e.message,errorRange:t.map((t=>t.log_item_id))};return e.response?(s.status=e.response.status,s.data=e.response.data,s.headers=e.response.headers):e.request&&(s.status=e.request.status),N.reportLogUploadError(s),!0}),{timeout:s("UPLOAD_LOG_REQUEST_RETRY_INTERVAL"),maxRetryTimeout:s("UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL")})}uploadLogInterval(){0===this.uploadLogUploadingList.length&&0===this.uploadLogWaitingList.length||(0===this.uploadLogUploadingList.length&&(this.uploadLogUploadingList=this.uploadLogWaitingList.splice(0,s("UPLOAD_LOG_LENGTH_EACH_TIME"))),this.uploadLogs().then((()=>{this.uploadErrorCount=0,this.uploadLogWaitingList.length>0&&window.setTimeout((()=>this.uploadLogInterval()),s("UPLOAD_LOG_INTERVAL"))})).catch((t=>{this.uploadErrorCount+=1,this.uploadErrorCount<2?window.setTimeout((()=>this.uploadLogInterval()),s("UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1")):window.setTimeout((()=>this.uploadLogInterval()),s("UPLOAD_LOG_RETRY_INTERVAL_V1"))})))}}const M=new w;let W=function(t){return t.FREE="free",t.UPLOADING="uploading",t}({}),V=function(t){return t[t.MISC=0]="MISC",t[t.INTERNAL_EVENT=1]="INTERNAL_EVENT",t[t.PUBLIC_EVENT=2]="PUBLIC_EVENT",t[t.WEB_EVENT=3]="WEB_EVENT",t[t.INTERNAL_API=4]="INTERNAL_API",t[t.WEB_API=5]="WEB_API",t[t.PUBLIC_API=6]="PUBLIC_API",t}({});function x(t){return n(t.reportId,"params.reportId",0,100,!1),n(t.category,"params.category",0,100,!1),n(t.event,"params.event",0,100,!1),n(t.label,"params.label",0,100,!1),i(t.value,"params.value",Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!1),!0}const k={sid:"",lts:0,success:null,cname:null,uid:null,peer:null,cid:null,elapse:null,extend:null,vid:0};let B=function(t){return t.PUBLISH="publish",t.SUBSCRIBE="subscribe",t.WS_COMPRESSOR_INIT="ws_compressor_init",t.SESSION_INIT="session_init",t.JOIN_CHOOSE_SERVER="join_choose_server",t.REQ_USER_ACCOUNT="req_user_account",t.JOIN_GATEWAY="join_gateway",t.REJOIN_GATEWAY="rejoin_gateway",t.STREAM_SWITCH="stream_switch",t.REQUEST_PROXY_WORKER_MANAGER="request_proxy_worker_manager",t.REQUEST_PROXY_APPCENTER="request_proxy_appcenter",t.FIRST_VIDEO_RECEIVED="first_video_received",t.FIRST_AUDIO_RECEIVED="first_audio_received",t.FIRST_VIDEO_DECODE="first_video_decode",t.FIRST_AUDIO_DECODE="first_audio_decode",t.ON_ADD_AUDIO_STREAM="on_add_audio_stream",t.ON_ADD_VIDEO_STREAM="on_add_video_stream",t.ON_UPDATE_STREAM="on_update_stream",t.ON_REMOVE_STREAM="on_remove_stream",t.USER_ANALYTICS="req_user_analytics",t.PC_STATS="pc_stats",t.UPDATE_REMOTE_RTPCAPABILITIES="update_remote_rtpCapabilities",t}({}),G=function(t){return t.SESSION="io.agora.pb.Wrtc.Session",t.JOIN_CHOOSE_SERVER="io.agora.pb.Wrtc.JoinChooseServer",t.REQ_USER_ACCOUNT="io.agora.pb.Wrtc.ReqUserAccount",t.JOIN_GATEWAY="io.agora.pb.Wrtc.JoinGateway",t.RE_JOIN_GATEWAY="io.agora.pb.Wrtc.ReJoinGateway",t.PUBLISH="io.agora.pb.Wrtc.Publish",t.SUBSCRIBE="io.agora.pb.Wrtc.Subscribe",t.WS_COMPRESSOR_INIT="io.agora.pb.Wrtc.WsCompressorInit",t.STREAM_SWITCH="io.agora.pb.Wrtc.StreamSwitch",t.AUDIO_SENDING_STOPPED="io.agora.pb.Wrtc.AudioSendingStopped",t.VIDEO_SENDING_STOPPED="io.agora.pb.Wrtc.VideoSendingStopped",t.REQUEST_PROXY_APPCENTER="io.agora.pb.Wrtc.RequestProxyAppCenter",t.REQUEST_PROXY_WORKER_MANAGER="io.agora.pb.Wrtc.RequestProxyWorkerManager",t.API_INVOKE="io.agora.pb.Wrtc.ApiInvoke",t.FIRST_VIDEO_RECEIVED="io.agora.pb.Wrtc.FirstVideoReceived",t.FIRST_AUDIO_RECEIVED="io.agora.pb.Wrtc.FirstAudioReceived",t.FIRST_VIDEO_DECODE="io.agora.pb.Wrtc.FirstVideoDecode",t.FIRST_AUDIO_DECODE="io.agora.pb.Wrtc.FirstAudioDecode",t.ON_ADD_AUDIO_STREAM="io.agora.pb.Wrtc.OnAddAudioStream",t.ON_ADD_VIDEO_STREAM="io.agora.pb.Wrtc.OnAddVideoStream",t.ON_UPDATE_STREAM="io.agora.pb.Wrtc.OnUpdateStream",t.ON_REMOVE_STREAM="io.agora.pb.Wrtc.OnRemoveStream",t.JOIN_CHANNEL_TIMEOUT="io.agora.pb.Wrtc.JoinChannelTimeout",t.PEER_PUBLISH_STATUS="io.agora.pb.Wrtc.PeerPublishStatus",t.WORKER_EVENT="io.agora.pb.Wrtc.WorkerEvent",t.AP_WORKER_EVENT="io.agora.pb.Wrtc.APWorkerEvent",t.JOIN_WEB_PROXY_AP="io.agora.pb.Wrtc.JoinWebProxyAP",t.WEBSOCKET_QUIT="io.agora.pb.Wrtc.WebSocketQuit",t.USER_ANALYTICS="io.agora.pb.Wrtc.UserAnalytics",t.AUTOPLAY_FAILED="io.agora.pb.Wrtc.AutoplayFailed",t.PC_STATS="io.agora.pb.Wrtc.PCStats",t.UPDATE_REMOTE_RTPCAPABILITIES="io.agora.pb.Wrtc.UpdateRemoteRTPCapabilities",t}({}),F=function(t){return t[t.WORKER_EVENT=156]="WORKER_EVENT",t[t.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",t}({}),J=function(t){return t[t.SESSION=26]="SESSION",t[t.JOIN_CHOOSE_SERVER=27]="JOIN_CHOOSE_SERVER",t[t.REQ_USER_ACCOUNT=196]="REQ_USER_ACCOUNT",t[t.JOIN_GATEWAY=28]="JOIN_GATEWAY",t[t.PUBLISH=30]="PUBLISH",t[t.SUBSCRIBE=29]="SUBSCRIBE",t[t.WS_COMPRESSOR_INIT=9430]="WS_COMPRESSOR_INIT",t[t.STREAM_SWITCH=32]="STREAM_SWITCH",t[t.AUDIO_SENDING_STOPPED=33]="AUDIO_SENDING_STOPPED",t[t.VIDEO_SENDING_STOPPED=34]="VIDEO_SENDING_STOPPED",t[t.REQUEST_PROXY_APPCENTER=35]="REQUEST_PROXY_APPCENTER",t[t.REQUEST_PROXY_WORKER_MANAGER=36]="REQUEST_PROXY_WORKER_MANAGER",t[t.API_INVOKE=41]="API_INVOKE",t[t.FIRST_VIDEO_RECEIVED=348]="FIRST_VIDEO_RECEIVED",t[t.FIRST_AUDIO_RECEIVED=349]="FIRST_AUDIO_RECEIVED",t[t.FIRST_VIDEO_DECODE=350]="FIRST_VIDEO_DECODE",t[t.FIRST_AUDIO_DECODE=351]="FIRST_AUDIO_DECODE",t[t.ON_ADD_AUDIO_STREAM=352]="ON_ADD_AUDIO_STREAM",t[t.ON_ADD_VIDEO_STREAM=353]="ON_ADD_VIDEO_STREAM",t[t.ON_UPDATE_STREAM=356]="ON_UPDATE_STREAM",t[t.ON_REMOVE_STREAM=355]="ON_REMOVE_STREAM",t[t.JOIN_CHANNEL_TIMEOUT=407]="JOIN_CHANNEL_TIMEOUT",t[t.PEER_PUBLISH_STATUS=408]="PEER_PUBLISH_STATUS",t[t.WORKER_EVENT=156]="WORKER_EVENT",t[t.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",t[t.JOIN_WEB_PROXY_AP=700]="JOIN_WEB_PROXY_AP",t[t.WEBSOCKET_QUIT=671]="WEBSOCKET_QUIT",t[t.USER_ANALYTICS=1e4]="USER_ANALYTICS",t[t.AUTOPLAY_FAILED=9178]="AUTOPLAY_FAILED",t}({});class Y{constructor(){P(this,"baseInfoMap",new Map),P(this,"proxyServer",void 0),P(this,"eventUploadTimer",void 0),P(this,"setSessionIdTimer",void 0),P(this,"url",void 0),P(this,"backupUrl",void 0),P(this,"_appId",void 0),P(this,"keyEventUploadPendingItems",[]),P(this,"normalEventUploadPendingItems",[]),P(this,"apiInvokeUploadPendingItems",[]),P(this,"apiInvokeCount",0),P(this,"ltsList",[]),P(this,"lastSendNormalEventTime",Date.now()),P(this,"customReportCounterTimer",void 0),P(this,"customReportCount",0),P(this,"extApiInvoke",(async t=>{for(const e of t){const t=f(f({},e),{},{sid:null,invokeId:++this.apiInvokeCount,tag:g.TRACER});this.sendApiInvoke(t)}})),this.eventUploadTimer=window.setInterval(this.doSend.bind(this),s("EVENT_REPORT_SEND_INTERVAL")),this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),s("EVENT_REPORT_SEND_INTERVAL"))}getBaseInfoBySessionId(t){return this.baseInfoMap.get(t)}adjustSessionStartTime(t){if(!this.baseInfoMap.has(t)&&!this.baseInfoMap.get(t))return void M.error("adjust session ".concat(t," start time, sid is not exist or info is undefined"));const e=this.baseInfoMap.get(t),s=Date.now(),o=e.startTime;e.startTime=s,M.debug("rewrite session ".concat(t," startTime: ").concat(s," , ").concat(s-o,"ms")),this.baseInfoMap.set(t,e)}setAppId(t){this._appId=t}reportApiInvoke(t,e,o){e.timeout=e.timeout||6e4,e.reportResult=void 0===e.reportResult||e.reportResult;const r=Date.now();this.apiInvokeCount+=1;const n=this.apiInvokeCount,i=()=>({tag:e.tag,invokeId:n,sid:t,name:e.name,apiInvokeTime:r,options:e.options,states:e.states||null}),d=!!s("SHOW_REPORT_INVOKER_LOG");d&&M.info("".concat(e.name," start"),e.options);let l=!1;a(e.timeout).then((()=>{l||(this.sendApiInvoke(f(f({},i()),{},{error:c.API_INVOKE_TIMEOUT,success:!1})),M.debug("".concat(e.name," timeout")))}));const _=new p(c.UNEXPECTED_ERROR,"".concat(e.name,": this api invoke is end"));return{onSuccess:t=>{const s=()=>{if(l)throw _;return l=!0,this.sendApiInvoke(f(f({},i()),{},{success:!0},e.reportResult&&{result:t})),d&&M.info("".concat(e.name," onSuccess")),t};return o?E(s,e.name+"Success",o,(()=>l=!0)):s()},onError:t=>{const s=()=>{if(l)throw t;l=!0,this.sendApiInvoke(f(f({},i()),{},{success:!1,error:t})),d&&M.info("".concat(e.name," onFailure"),t.toString())};return o?E(s,e.name+"Error",o,(()=>l=!0)):s()}}}sessionInit(t,e){if(this.baseInfoMap.has(t))return;const r=Date.now(),n=this.createBaseInfo(t,r);n.cname=e.cname;const i=Object.assign({},{willUploadConsoleLog:s("UPLOAD_LOG"),maxTouchPoints:navigator.maxTouchPoints,areaVersion:d?"global":"oversea",areas:s("AREAS")&&s("AREAS").join(",")},e.extend),{stringUid:a,channelProfile:c,channelMode:p,isABTestSuccess:E,lsid:u,clientRole:h}=e,T=Date.now(),R=f(f({},n),{},{eventType:B.SESSION_INIT,appid:e.appid,browser:navigator.userAgent,buildFormat:e.buildFormat,build:l,lts:T,elapse:T-r,extend:JSON.stringify(i),mode:e.mode,process:s("PROCESS_ID"),appType:s("APP_TYPE"),success:!0,version:o,stringUid:a,channelProfile:c,channelMode:p,isABTestSuccess:E,lsid:u,clientType:_()?42:20,clientRole:h,serviceId:s("PROCESS_ID"),extensionID:s("PLUGIN_INFO").join(",")||""});this.send({type:G.SESSION,data:R},!0)}joinChooseServer(t,e){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,r=Date.now(),n=f(f({},o),{},{eventType:B.JOIN_CHOOSE_SERVER,lts:r,eventElapse:e.elapse||r-e.lts,chooseServerAddr:e.csAddr,errorCode:e.ec,elapse:r-s.startTime,success:e.succ,chooseServerAddrList:JSON.stringify(e.serverList),uid:e.uid?parseInt(e.uid):null,cid:e.cid?parseInt(e.cid):null,chooseServerIp:e.csIp||"",opid:e.opid,unilbsServerIds:e.unilbsServerIds,extend:e.extend||void 0,isHttp3:e.isHttp3});this.send({type:G.JOIN_CHOOSE_SERVER,data:n},!0)}reqUserAccount(t,e){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,r=Date.now(),n=f(f({},o),{},{eventType:B.REQ_USER_ACCOUNT,lts:r,success:e.success,serverAddress:e.serverAddr,stringUid:e.stringUid,uid:e.uid,errorCode:e.errorCode,elapse:e.elapse||r-s.startTime,eventElapse:r-e.lts,extend:JSON.stringify(e.extend)});this.send({type:G.REQ_USER_ACCOUNT,data:n},!0)}joinGateway(t,e){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info;e.vid&&(o.vid=e.vid),o.uid=e.uid,o.cid=e.cid;const r=Date.now(),{firstSuccess:n,avoidJoinStartTime:i}=e,a=r-(n&&i?i:s.startTime),c=f(f({},o),{},{eventType:B.JOIN_GATEWAY,lts:r,gatewayAddr:e.addr,success:e.succ,errorCode:e.ec,errorMsg:e.errorMsg||"",elapse:a,eventElapse:r-e.lts,firstSuccess:n,signalChannel:e.signalChannel,preload:e.preload?1:0});e.succ&&(s.lastJoinSuccessTime=r),this.send({type:G.JOIN_GATEWAY,data:c},!0)}joinChannelTimeout(t,e){const s=this.baseInfoMap.get(t);if(!s)return;const o=Date.now(),r=f(f({},s.info),{},{lts:o,timeout:e,elapse:o-s.startTime});this.send({type:G.JOIN_CHANNEL_TIMEOUT,data:r},!0)}publish(t,e){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,r=Date.now(),n=f(f({},o),{},{eventType:B.PUBLISH,lts:r,eventElapse:e.eventElapse,elapse:r-s.startTime,success:e.succ,errorCode:e.ec,videoName:e.videoName,audioName:e.audioName,screenName:e.screenName,screenshare:e.screenshare,audio:e.audio,video:e.video,p2pid:e.p2pid,publishRequestid:e.publishRequestid});this.send({type:G.PUBLISH,data:n},!0)}subscribe(t,e,s){const o=this.baseInfoMap.get(t);if(!o)return;const r=o.info,n=Date.now(),i=f(f({},r),{},{eventType:B.SUBSCRIBE,lts:n,eventElapse:e.eventElapse,elapse:n-o.startTime,success:e.succ,errorCode:e.ec,video:e.video,audio:e.audio,subscribeRequestid:e.subscribeRequestid,p2pid:e.p2pid,preSsrc:e.preSsrc?1:0},s&&{extend:JSON.stringify({isMassSubscribe:!0})});"string"==typeof e.peerid?i.peerSuid=e.peerid:i.peer=e.peerid,this.send({type:G.SUBSCRIBE,data:i},!0)}wsCompressorInit(t){const e=[...this.baseInfoMap.keys()],s=e.length?e[0]:"UnableToGetSid",o=this.baseInfoMap.get(s);if(!o)return;const r=o.info,n=Date.now(),i=f(f({},r),{},{eventType:B.WS_COMPRESSOR_INIT,lts:n,eventElapse:t.eventElapse,elapse:n-o.startTime,status:t.status?1:2});this.send({type:G.WS_COMPRESSOR_INIT,data:i},!0)}firstRemoteVideoDecode(t,e,s,o){const r=this.baseInfoMap.get(t);if(!r)return;const n=r.info,i=Date.now(),a=f(f(f({},n),o),{},{elapse:i-r.startTime,eventType:e,lts:i,firstDecodeFrame:Math.max((o.firstFrame||i)-r.startTime,0),apEnd:Math.max(o.apEnd-r.startTime,0),apStart:Math.max(o.apStart-r.startTime,0),joinGwEnd:Math.max(o.joinGwEnd-r.startTime,0),joinGwStart:Math.max(o.joinGwStart-r.startTime,0),pcEnd:Math.max(o.pcEnd-r.startTime,0),pcStart:Math.max(o.pcStart-r.startTime,0),subscriberEnd:Math.max(o.subscriberEnd-r.startTime,0),subscriberStart:Math.max(o.subscriberStart-r.startTime,0),videoAddNotify:Math.max(o.videoAddNotify-r.startTime,0)});this.send({type:s,data:a},!0)}firstRemoteFrame(t,e,s,o){const r=this.baseInfoMap.get(t);if(!r)return;const n=r.info,i=Date.now(),a=f(f(f({},n),o),{},{elapse:i-r.startTime,eventType:e,lts:i});this.send({type:s,data:a},!0)}pcStats(t,e){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,r=Date.now(),n=f(f(f({},o),e),{},{vid:void 0===o.vid?0:Number(o.vid),elapse:r-s.startTime,eventType:B.PC_STATS,lts:r,preallocation:e.preallocation?1:0});this.send({type:G.PC_STATS,data:n},!0)}updateRemoteRTPCapabilities(t,e){if(t){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,r=Date.now(),n=f(f(f({},o),e),{},{vid:void 0===o.vid?0:Number(o.vid),eventType:B.UPDATE_REMOTE_RTPCAPABILITIES,lts:r});this.send({type:G.UPDATE_REMOTE_RTPCAPABILITIES,data:n},!0)}}onGatewayStream(t,e,s,o){const r=this.baseInfoMap.get(t);if(!r)return;const n=r.info,i=Date.now(),a=f(f(f({},n),o),{},{eventType:e,lts:i});this.send({type:s,data:a},!0)}streamSwitch(t,e){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,r=Date.now(),n=f(f({},o),{},{eventType:B.STREAM_SWITCH,lts:r,isDual:e.isdual,elapse:r-s.startTime,success:e.succ});this.send({type:G.STREAM_SWITCH,data:n},!0)}requestProxyAppCenter(t,e){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,r=Date.now(),n=f(f({},o),{},{eventType:B.REQUEST_PROXY_APPCENTER,lts:r,eventElapse:r-e.lts,elapse:r-s.startTime,APAddr:e.APAddr,workerManagerList:e.workerManagerList,response:e.response,errorCode:e.ec,success:e.succ});this.send({type:G.REQUEST_PROXY_APPCENTER,data:n},!0)}requestProxyWorkerManager(t,e){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,r=Date.now(),n=f(f({},o),{},{eventType:B.REQUEST_PROXY_WORKER_MANAGER,lts:r,eventElapse:r-e.lts,elapse:r-s.startTime,workerManagerAddr:e.workerManagerAddr,response:e.response,errorCode:e.ec,success:e.succ});this.send({type:G.REQUEST_PROXY_WORKER_MANAGER,data:n},!0)}setProxyServer(t){this.proxyServer=t,t?M.debug("reportProxyServerurl: ".concat(t)):M.debug("disable reportProxyServerurl: ".concat(t))}peerPublishStatus(t,e){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,r=Date.now(),n=f(f({},o),{},{subscribeElapse:e.subscribeElapse,peer:e.peer,peerPublishDuration:Math.max(e.audioPublishDuration,e.videoPublishDuration),audiotag:e.audioPublishDuration>0?1:-1,videotag:e.videoPublishDuration>0?1:-1,lts:r,elapse:r-s.startTime,joinChannelSuccessElapse:r-(s.lastJoinSuccessTime||r),peerPublishDurationVideo:e.videoPublishDuration,peerPublishDurationAudio:e.audioPublishDuration});this.send({type:G.PEER_PUBLISH_STATUS,data:n},!0)}workerEvent(t,e){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,r=Date.now(),n=f(f(f({},o),e),{},{elapse:r-s.startTime,lts:r,productType:"WebRTC"});u(n,"payload",1300).forEach((t=>this.send({type:G.WORKER_EVENT,data:t},!0)))}apworkerEvent(t,e){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,r=Date.now(),n=f(f(f({},o),e),{},{elapse:r-s.startTime,lts:r});this.send({type:G.AP_WORKER_EVENT,data:n},!0)}joinWebProxyAP(t,e){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,r=Date.now(),n=f(f(f({},o),e),{},{elapse:r-s.startTime,lts:r,extend:e.extend||void 0});this.send({type:G.JOIN_WEB_PROXY_AP,data:n},!0)}WebSocketQuit(t,e){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,r=Date.now(),n=f(f(f({},o),e),{},{elapse:r-s.startTime,lts:r});this.send({type:G.WEBSOCKET_QUIT,data:n},!0)}async sendCustomReportMessage(t,e){if(this.customReportCount+=e.length,this.customReportCount>s("CUSTOM_REPORT_LIMIT"))throw new p(c.CUSTOM_REPORT_FREQUENCY_TOO_HIGH);this.customReportCounterTimer||(this.customReportCounterTimer=window.setInterval((()=>{this.customReportCount=0}),5e3));const o=Date.now(),r=e.map((e=>({type:G.USER_ANALYTICS,data:f(f({sid:t},e),{},{lts:o})})));try{s("NEW_REPORT_SERVER")?await this.postDataToStatsCollector2(r):await this.postDataToStatsCollector(r)}catch(t){throw M.error("send custom report message failed",t.toString()),new p(c.CUSTOM_REPORT_SEND_FAILED,t.message)}}sendApiInvoke(t){const e=s("NOT_REPORT_EVENT");if(t.tag&&e.includes&&e.includes(t.tag))return!1;if(null===t.sid)return this.apiInvokeUploadPendingItems.push(t),!1;const o=this.baseInfoMap.get(t.sid);if(!o)return this.apiInvokeUploadPendingItems.push(t),!1;const{cname:r,uid:n,cid:i}=o.info;let a;if(t.lts=t.lts||Date.now(),t.error)if(t.error instanceof p){const{code:e,message:s}=t.error;a=e||(s||t.error.toString())}else a=t.error.toString();const c={invokeId:t.invokeId,sid:t.sid,cname:r,cid:i,uid:n,lts:t.lts,success:t.success,elapse:t.lts-o.startTime,execElapse:t.lts-t.apiInvokeTime,apiName:t.name,options:t.options?JSON.stringify(t.options):void 0,execStates:t.states?JSON.stringify(t.states):void 0,execResult:t.result?JSON.stringify(t.result):void 0,errorCode:t.error?a:void 0,errorMsg:t.error?JSON.stringify(t.error):void 0};return this.send({type:G.API_INVOKE,data:c},!1),!0}appendSessionId(){Y.__CLIENT_LIST__.forEach((t=>{if(t._sessionId){const e=this.apiInvokeUploadPendingItems.length;for(let s=0;s<e;s++){const e=this.apiInvokeUploadPendingItems.shift();e&&(e.sid=t._sessionId,this.sendApiInvoke(Object.assign({},e)))}}}))}send(t,e){if(e)return this.keyEventUploadPendingItems.push(t),void this.sendItems(this.keyEventUploadPendingItems,!0);this.normalEventUploadPendingItems.push(t),this.normalEventUploadPendingItems.length>s("NORMAL_EVENT_QUEUE_CAPACITY")&&this.normalEventUploadPendingItems.splice(0,1),this.normalEventUploadPendingItems.length>=10&&this.sendItems(this.normalEventUploadPendingItems,!1)}doSend(){this.keyEventUploadPendingItems.length>0&&this.sendItems(this.keyEventUploadPendingItems,!0),this.normalEventUploadPendingItems.length>0&&Date.now()-this.lastSendNormalEventTime>=5e3&&this.sendItems(this.normalEventUploadPendingItems,!1)}sendItems(t,e){const o=[],r=[];for(;t.length;){const e=t.shift();o.length<20?o.push(e):r.push(e)}t.push(...r);for(const t of[...o])-1!==this.ltsList.indexOf(t.data.lts)?(t.data.lts=this.ltsList[this.ltsList.length-1]+1,this.ltsList.push(t.data.lts)):(this.ltsList.push(t.data.lts),this.ltsList.sort(((t,e)=>t-e)));e||(this.lastSendNormalEventTime=Date.now());return s("ENABLE_EVENT_REPORT")?(o.length&&(s("NEW_REPORT_SERVER")?this.postDataToStatsCollector2(o):this.postDataToStatsCollector(o)).catch((t=>o=>{s("EVENT_REPORT_RETRY")&&(e?this.keyEventUploadPendingItems=this.keyEventUploadPendingItems.concat(t):(this.normalEventUploadPendingItems=this.normalEventUploadPendingItems.concat(t),this.normalEventUploadPendingItems.length>s("NORMAL_EVENT_QUEUE_CAPACITY")&&(this.normalEventUploadPendingItems.splice(0,this.normalEventUploadPendingItems.length-s("NORMAL_EVENT_QUEUE_CAPACITY")),M.warning("report: drop normal events"))))})(o)),t):t}async postDataToStatsCollector2(t){h.networkState===T.OFFLINE&&await Promise.race([h.onlineWaiter,a(2*R.maxRetryTimeout)]);const e=t=>{let e=new Uint8Array;return t.forEach((t=>{const s=O(JSON.stringify(t.data)),o=new ArrayBuffer(5),r=(t=>{let e=0;return Object.entries(G).forEach((s=>{let[o,r]=s;r===t.type&&(e=J[o])})),e})(t),n=new DataView(o);n.setUint16(0,s.byteLength,!0),n.setUint8(2,255&r),n.setUint8(3,r>>>8&255),n.setUint8(4,r>>>16&255),e=A(e,new Uint8Array(o)),e=A(e,s)})),e},o="event";let r=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(s("NEW_REPORT_SERVER_DOMAINS")[0],"&p=443&d=").concat(o):"https://".concat(s("NEW_REPORT_SERVER_DOMAINS")[0],"/").concat(o);for(let n=0;n<2;n+=1){1===n&&(r=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(s("NEW_REPORT_SERVER_DOMAINS")[1],"&p=443&d=").concat(o):"https://".concat(s("NEW_REPORT_SERVER_DOMAINS")[1],"/").concat(o));try{await I(r,{timeout:1e4,data:e(t),headers:f(f({biz:"webrtc",sendts:Math.round(Date.now()/1e3),debug:"false"},this._appId&&{appid:this._appId}),{},{"Content-Type":"application/octet-stream"})},!0)}catch(t){if(1===n)throw t;continue}return}}async postDataToStatsCollector(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const o={msgType:"EventMessages",sentTs:Math.round(Date.now()/1e3),payloads:t.map((t=>JSON.stringify(t))),vid:(t=>{const e=t&&t.data.sid&&this.baseInfoMap.get(t.data.sid);return e&&e.info.vid&&+e.info.vid||0})(t[0])};h.networkState===T.OFFLINE&&await Promise.race([h.onlineWaiter,a(2*R.maxRetryTimeout)]);const r=e?"/events/proto-raws":"/events/messages";let n=this.url||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(s("EVENT_REPORT_DOMAIN"),"&p=").concat(s("STATS_COLLECTOR_PORT"),"&d=").concat(r):"https://".concat(s("EVENT_REPORT_DOMAIN"),":").concat(s("STATS_COLLECTOR_PORT")).concat(r));for(let t=0;t<2;t+=1){1===t&&(n=this.backupUrl||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(s("EVENT_REPORT_BACKUP_DOMAIN"),"&p=").concat(s("STATS_COLLECTOR_PORT"),"&d=").concat(r):"https://".concat(s("EVENT_REPORT_BACKUP_DOMAIN"),":").concat(s("STATS_COLLECTOR_PORT")).concat(r)));try{e?await S(n,{timeout:1e4,data:o}):await I(n,{timeout:1e4,data:o})}catch(e){if(1===t)throw e;continue}return}}createBaseInfo(t,e){const s=Object.assign({},k);return s.sid=t,this.baseInfoMap.set(t,{info:s,startTime:e}),s}reportResourceTiming(t,e){const s=performance.getEntriesByName(t),o=s[s.length-1];o&&this.reportApiInvoke(e,{name:"Client.resourceTiming",options:o,tag:g.TRACER}).onSuccess()}}function j(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(e,s,o){const r=o.value;if("function"==typeof r){const n=t.className||e.__className__||("AgoraRTCClient"===e.constructor.name?"Client":e.constructor.name);o.value=function(){for(var e=arguments.length,o=new Array(e),i=0;i<e;i++)o[i]=arguments[i];let a=o;if(t.argsMap)try{a=t.argsMap(this,...o)}catch(t){M.warning(t),a=[]}try{JSON.stringify(a)}catch(t){M.warning("arguments for method ".concat(n,".").concat(String(s)," not serializable for apiInvoke.")),a=[]}const c=(t.report||K).reportApiInvoke(this._sessionId||null,{name:"".concat(n,".").concat(String(s)),options:a,tag:g.TRACER,reportResult:t.reportResult},t.throttleTime);try{const e=r.apply(this,o);return e instanceof Promise?e.then((e=>(c.onSuccess(t.reportResult&&e),e))).catch((t=>{throw c.onError(t),t})):(c.onSuccess(t.reportResult&&e),e)}catch(t){throw c.onError(t),t}}}return o}}P(Y,"__CLIENT_LIST__",[]);const K=new Y;N.on("REPORT_LOG_UPLOAD",(t=>{t.networkState=h.networkState,K.reportApiInvoke(null,{name:"logUploadError",options:t,tag:g.TRACER}).onSuccess("logUploadError")}));export{F as AgoraEventUploadId,w as AgoraLogger,B as AgoraRTCEvent,Y as AgoraRTCEventReport,G as AgoraRTCEventUploadType,k as EVENT_BASE_TEMPLATE,J as EventNameToID,V as LOG_TYPE,W as LOG_UPLOAD_STATE,j as apiInvoke,x as isEventCustomReportParams,N as logReportBus,M as logger,K as report};
