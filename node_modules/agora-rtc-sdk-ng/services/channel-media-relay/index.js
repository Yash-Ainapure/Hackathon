/**
 * AgoraWebSDK_N-v4.22.0-0-g8569241d-dirty Copyright AgoraInc.
 */

import{IS_GLOBAL_VERSION as e,MUTABLE_PARAMS as t,AgoraRTCError as s,getParameter as E,getUTF8StringByteLength as n,getMultiUnilbsFormDataByteLength as o,AgoraRTCErrorCode as _,VERSION as i,retryable as r,EventEmitter as a,PromiseMutex as c,NETWORK_STATE as R,networkIndicator as A,NETWORK_INDICATOR_EVENTS as I,createDefer as N,getRetryWaitTime as S,wait as h,emitAsPromise as C,emitAsInvokerNoResponse as T,generateSessionID as O,DEFAULT_RETRY_CONFIG as L}from"@agora-js/shared";import{AgoraRTCEventReport as d,logger as l}from"@agora-js/report";import u from"axios";import"formdata-polyfill";const D=function(){const e="us".concat("erna","me"),t="pa".concat("sswo","rd"),s=["t","s","t"];s.splice(1,0,"e");const E=s.join(""),n=[];for(let e=0;e<6;e++)n.push("1");const o=n.join(""),_={};return _[e]=E,_[t]=o,Object.assign(_,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=D,e||(t.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],t.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],t.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],t.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],t.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],t.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],t.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",t.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",t.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",t.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",t.AREAS=["NORTH_AMERICA","OVERSEA"]);function w(e,t,s){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var E=s.call(e,t||"default");if("object"!=typeof E)return E;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}function g(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var E=Object.getOwnPropertySymbols(e);t&&(E=E.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,E)}return s}d.__CLIENT_LIST__=[];class P extends s{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",arguments.length>2?arguments[2]:void 0),this.name="AgoraRTCException"}print(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"error";return super.print(e,l)}throw(){super.throw(l)}}let V=0,U=0;let f=function(e){return e[e.ACCESS_POINT=101]="ACCESS_POINT",e[e.UNILBS=201]="UNILBS",e[e.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR",e}({}),m=function(e){return e[e.IIIEGAL_APPID=1]="IIIEGAL_APPID",e[e.IIIEGAL_UID=2]="IIIEGAL_UID",e[e.INTERNAL_ERROR=3]="INTERNAL_ERROR",e}({}),p=function(e){return e[e.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",e[e.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",e[e.INTERNAL_ERROR=8]="INTERNAL_ERROR",e[e.NO_AUTHORIZED=9]="NO_AUTHORIZED",e[e.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",e[e.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",e[e.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",e[e.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",e[e.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",e[e.USER_OVERLOAD=16]="USER_OVERLOAD",e[e.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",e[e.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND",e}({}),M=function(e){return e[e.NO_FLAG_SET=100]="NO_FLAG_SET",e[e.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",e[e.INVALID_FALG_SET=102]="INVALID_FALG_SET",e[e.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",e[e.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",e[e.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",e[e.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",e[e.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",e[e.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",e[e.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",e[e.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",e[e.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",e[e.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",e[e.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",e[e.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",e[e.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",e[e.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",e[e.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",e[e.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV",e}({}),b=function(e){return e[e.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",e[e.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",e[e.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",e[e.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",e[e.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",e[e.K_TICKET_INVALID=7]="K_TICKET_INVALID",e[e.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",e[e.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",e[e.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",e[e.K_UID_BANNED=14]="K_UID_BANNED",e[e.K_IP_BANNED=15]="K_IP_BANNED",e[e.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",e[e.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",e[e.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",e[e.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",e[e.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",e[e.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",e[e.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",e[e.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",e[e.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",e[e.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",e[e.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",e[e.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",e[e.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",e[e.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",e[e.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",e[e.ERR_INVALID_UID=117]="ERR_INVALID_UID",e[e.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",e[e.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",e[e.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",e[e.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",e[e.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",e[e.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",e[e.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",e[e.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",e[e.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",e[e.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",e[e.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",e[e.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",e[e.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",e[e.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",e[e.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",e[e.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",e[e.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",e[e.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",e[e.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",e[e.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",e[e.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",e[e.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",e[e.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",e[e.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",e[e.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",e[e.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",e[e.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",e[e.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",e[e.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",e[e.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",e[e.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",e[e.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",e[e.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",e[e.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",e[e.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",e[e.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",e[e.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY",e}({});f.ACCESS_POINT,M.NO_FLAG_SET,M.FLAG_SET_BUT_EMPTY,M.INVALID_FALG_SET,M.FLAG_SET_BUT_NO_RE,M.INVALID_SERVICE_ID,M.NO_SERVICE_AVAILABLE,M.NO_SERVICE_AVAILABLE_P2P,M.NO_SERVICE_AVAILABLE_VOICE,M.NO_SERVICE_AVAILABLE_WEBRTC,M.NO_SERVICE_AVAILABLE_CDS,M.NO_SERVICE_AVAILABLE_CDN,M.NO_SERVICE_AVAILABLE_TDS,M.NO_SERVICE_AVAILABLE_REPORT,M.NO_SERVICE_AVAILABLE_APP_CENTER,M.NO_SERVICE_AVAILABLE_ENV0,M.NO_SERVICE_AVAILABLE_VOET,M.NO_SERVICE_AVAILABLE_STRING_UID,M.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS,f.UNILBS,p.INVALID_VENDOR_KEY,p.INVALID_CHANNEL_NAME,p.INTERNAL_ERROR,p.NO_AUTHORIZED,p.DYNAMIC_KEY_TIMEOUT,p.NO_ACTIVE_STATUS,p.DYNAMIC_KEY_EXPIRED,p.STATIC_USE_DYNAMIC_KEY,p.DYNAMIC_USE_STATIC_KEY,p.USER_OVERLOAD,p.FORBIDDEN_REGION,p.CANNOT_MEET_AREA_DEMAND,f.STRING_UID_ALLOCATOR,m.IIIEGAL_APPID,m.IIIEGAL_UID,m.INTERNAL_ERROR,b.K_TIMESTAMP_EXPIRED,b.K_CHANNEL_PERMISSION_INVALID,b.K_CERTIFICATE_INVALID,b.K_CHANNEL_NAME_EMPTY,b.K_CHANNEL_NOT_FOUND,b.K_TICKET_INVALID,b.K_CHANNEL_CONFLICTED,b.K_SERVICE_NOT_READY,b.K_SERVICE_TOO_HEAVY,b.K_UID_BANNED,b.K_IP_BANNED,b.K_AUTO_REBALANCE,b.ERR_INVALID_VENDOR_KEY,b.ERR_INVALID_CHANNEL_NAME,b.WARN_NO_AVAILABLE_CHANNEL,b.WARN_LOOKUP_CHANNEL_TIMEOUT,b.WARN_LOOKUP_CHANNEL_REJECTED,b.WARN_OPEN_CHANNEL_TIMEOUT,b.WARN_OPEN_CHANNEL_REJECTED,b.WARN_REQUEST_DEFERRED,b.ERR_DYNAMIC_KEY_TIMEOUT,b.ERR_NO_AUTHORIZED,b.ERR_VOM_SERVICE_UNAVAILABLE,b.ERR_NO_CHANNEL_AVAILABLE_CODE,b.ERR_MASTER_VOCS_UNAVAILABLE,b.ERR_INTERNAL_ERROR,b.ERR_NO_ACTIVE_STATUS,b.ERR_INVALID_UID,b.ERR_DYNAMIC_KEY_EXPIRED,b.ERR_STATIC_USE_DYANMIC_KE,b.ERR_DYNAMIC_USE_STATIC_KE,b.ERR_NO_VOCS_AVAILABLE,b.ERR_NO_VOS_AVAILABLE,b.ERR_JOIN_CHANNEL_TIMEOUT,b.ERR_JOIN_BY_MULTI_IP,b.ERR_NOT_JOINED,b.ERR_REPEAT_JOIN_REQUEST,b.ERR_REPEAT_JOIN_CHANNEL,b.ERR_INVALID_STRINGUID,b.ERR_TOO_MANY_USERS,b.ERR_SET_CLIENT_ROLE_TIMEOUT,b.ERR_SET_CLIENT_ROLE_NO_PERMISSION,b.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE,b.ERR_PUBLISH_REQUEST_INVALID,b.ERR_SUBSCRIBE_REQUEST_INVALID,b.ERR_NOT_SUPPORTED_MESSAGE,b.ERR_ILLEAGAL_PLUGIN,b.ILLEGAL_CLIENT_ROLE_LEVEL,b.ERR_REJOIN_TOKEN_INVALID,b.ERR_REJOIN_USER_NOT_JOINED,b.ERR_INVALID_OPTIONAL_INFO,b.ERR_TEST_RECOVER,b.ERR_TEST_TRYNEXT,b.ERR_TEST_RETRY,b.ILLEGAL_AES_PASSWORD,b.ERR_TOO_MANY_BROADCASTERS,b.ERR_TOO_MANY_SUBSCRIBERS,b.ERR_LICENSE_ILLEGAL,b.ERR_LICENSE_MISSING,b.ERR_LICENSE_EXPIRED,b.ERR_LICENSE_MINUTES_EXCEEDED,b.ERR_LICENSE_PERIOD_INVALID,b.ERR_LICENSE_MULTIPLE_SDK_SERVICE;let v=function(e){return e.CHINA="CHINA",e.ASIA="ASIA",e.NORTH_AMERICA="NORTH_AMERICA",e.EUROPE="EUROPE",e.JAPAN="JAPAN",e.INDIA="INDIA",e.KOREA="KOREA",e.HKMC="HKMC",e.US="US",e.OCEANIA="OCEANIA",e.SOUTH_AMERICA="SOUTH_AMERICA",e.AFRICA="AFRICA",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="EXTENSIONS",e}({});v.AFRICA,v.ASIA,v.CHINA,v.EUROPE,v.GLOBAL,v.INDIA,v.JAPAN,v.NORTH_AMERICA,v.OCEANIA,v.OVERSEA,v.SOUTH_AMERICA;let B=function(e){return e.CHINA="CN",e.ASIA="AS",e.NORTH_AMERICA="NA",e.EUROPE="EU",e.JAPAN="JP",e.INDIA="IN",e.KOREA="KR",e.HKMC="HK",e.US="US",e.OCEANIA="OC",e.SOUTH_AMERICA="SA",e.AFRICA="AF",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="GLOBAL",e}({});B.ASIA,B.NORTH_AMERICA,B.EUROPE,B.JAPAN,B.INDIA,B.KOREA,B.HKMC,B.US,B.OVERSEA,B.GLOBAL,B.OCEANIA,B.SOUTH_AMERICA,B.AFRICA,e&&B.CHINA;const y={GLOBAL:{ASIA:[v.CHINA,v.JAPAN,v.INDIA,v.KOREA,v.HKMC],EUROPE:[],NORTH_AMERICA:[v.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}};Object.keys(y[v.GLOBAL]),v.CHINA,v.NORTH_AMERICA,v.EUROPE,v.ASIA,v.JAPAN,v.INDIA,v.OCEANIA,v.SOUTH_AMERICA,v.AFRICA,v.KOREA,v.HKMC,v.US;let K=1;function k(e,t,s,a){const c={command:"convergeAllocateEdge",sid:t.sid,appId:t.appId,token:t.token,ts:Date.now(),version:i,cname:t.cname,uid:t.uid.toString(),requestId:K,seq:K};K+=1;const R={service_name:"tele_channel",json_body:JSON.stringify(c)};return r((async()=>{const t=await function(e,t,s,i){return new Promise(((r,a)=>{t.timeout=t.timeout||E("HTTP_CONNECT_TIMEOUT"),t.responseType=t.responseType||"json",t.data&&!s?(t.data=JSON.stringify(t.data),V+=n(t.data)):s&&(t.data.size?V+=t.data.size:t.data instanceof FormData?V+=o(t.data):V+=n(JSON.stringify(t.data))),t.headers=t.headers||{},t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.method="POST",t.url=e,u.request(t).then((e=>{"string"==typeof e.data?U+=n(e.data):e.data instanceof ArrayBuffer||e.data instanceof Uint8Array?U+=e.data.byteLength:U+=n(JSON.stringify(e.data)),i&&r({data:e.data,headers:e.headers}),r(e.data)})).catch((e=>{u.isCancel(e)?a(new P(_.OPERATION_ABORTED,"cancel token canceled")):"ECONNABORTED"===e.code?a(new P(_.NETWORK_TIMEOUT,e.message)):e.response?a(new P(_.NETWORK_RESPONSE_ERROR,e.response.status)):a(new P(_.NETWORK_ERROR,e.message))}))}))}(e,{data:R,cancelToken:s,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(0!==t.code){const e=new P(_.UNEXPECTED_RESPONSE,"cross channel ap error, code"+t.code,{retry:!0});throw l.error(e.toString()),e}const i=JSON.parse(t.json_body);if(200!==i.code){const e=new P(_.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(i.code,", reason: ").concat(i.reason));throw l.error(e.toString()),e}if(!i.servers||0===i.servers.length){const e=new P(_.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw l.error(e.toString()),e}return{vid:i.vid,workerToken:i.workerToken,addressList:(E("CHANNEL_MEDIA_RELAY_SERVERS")||i.servers).map((e=>"wss://".concat(e.address.replace(/\./g,"-"),".").concat(E("WORKER_DOMAIN"),":").concat(e.wss)))}}),void 0,(e=>!!(e.code!==_.OPERATION_ABORTED&&e.code!==_.UNEXPECTED_RESPONSE||e.data&&e.data.retry)),a)}async function H(e,t,s){const n=E("UAP_AP").slice(0,E("AJAX_REQUEST_CONCURRENT")).map((t=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v1?action=uap"):"https://".concat(t,"/api/v1?action=uap"))).map((E=>k(E,e,t,s)));try{const e=await(o=n,Promise.all(o.map((e=>e.then((e=>{throw e}),(e=>e))))).then((e=>{throw e}),(e=>e)));return n.forEach((e=>e.cancel())),e}catch(e){throw e[0]}var o}let Y=function(e){return e.CONNECTED="websocket:connected",e.RECONNECTING="websocket:reconnecting",e.WILL_RECONNECT="websocket:will_reconnect",e.CLOSED="websocket:closed",e.FAILED="websocket:failed",e.ON_MESSAGE="websocket:on_message",e.REQUEST_NEW_URLS="websocket:request_new_urls",e.RECONNECT_WAITTING_FINISH="websocket:reconnect_waitting_finish",e.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire",e}({}),W=function(e){return e[e.SetSdkProfile=0]="SetSdkProfile",e[e.SetSourceChannel=1]="SetSourceChannel",e[e.SetSourceUserId=2]="SetSourceUserId",e[e.SetDestChannel=3]="SetDestChannel",e[e.StartPacketTransfer=4]="StartPacketTransfer",e[e.StopPacketTransfer=5]="StopPacketTransfer",e[e.UpdateDestChannel=6]="UpdateDestChannel",e[e.Reconnect=7]="Reconnect",e[e.SetVideoProfile=8]="SetVideoProfile",e}({}),G=function(e){return e.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",e.NETWORK_CONNECTED="NETWORK_CONNECTED",e.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",e.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",e.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",e.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",e.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",e.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",e.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",e.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE",e}({}),F=function(e){return e.RELAY_STATE_IDLE="RELAY_STATE_IDLE",e.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",e.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",e.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE",e}({}),J=function(e){return e.RELAY_OK="RELAY_OK",e.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",e.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",e.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED",e}({}),j=function(e){return e.CONNECTED="transmitter:connected",e.RECONNECTING="transmitter:reconnecting",e.WILL_RECONNECT="transmitter:will_reconnect",e.CLOSED="transmitter:closed",e.FAILED="transmitter:failed",e.ON_MESSAGE="transmitter:on_message",e.REQUEST_NEW_URLS="transmitter:request_new_urls",e.RECONNECT_WAITTING_FINISH="transmitter:reconnect_waitting_finish",e.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",e.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",e.FAILBACK="transmitter:failback",e.PRE_CONNECT_PC="transmitter:pre_connect_pc",e}({});class q extends a{get url(){return this.websocket&&this.websocket.url||null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){["tryNext","recover"].includes(e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,"reconnecting"===this._state?this.emit(Y.RECONNECTING,this.reconnectReason):"connected"===this._state?this.emit(Y.CONNECTED):"closed"===this._state?this.emit(Y.CLOSED):"failed"===this._state&&this.emit(Y.FAILED))}resetReconnectCount(e){l.debug("websocket reset reconnect count, reason: "+e),this.reconnectCount=0}constructor(e,t){let s=arguments.length>2&&void 0!==arguments[2]&&arguments[2],E=arguments.length>3&&void 0!==arguments[3]&&arguments[3],n=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5?arguments[5]:void 0;super(),this.connectionID=0,this.currentURLIndex=0,this.urls=[],this._reconnectMode="tryNext",this.reconnectReason=void 0,this._initMutex=new c("websocket"),this.name=void 0,this._state="closed",this.reconnectInterrupter=void 0,this.websocket=void 0,this.retryConfig=void 0,this.reconnectCount=0,this.forceCloseTimeout=5e3,this.onlineReconnectListener=void 0,this.useCompress=void 0,this.tryDoubleDomain=!1,this.use443PortOnly=!1,this.wsInflateLength=0,this.wsDeflateLength=0,this.closeEstablishingWs=()=>{},this.store=void 0,this.joinGatewayRecordIndex=void 0,this.store=o,this.name=e,this.retryConfig=function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?g(Object(s),!0).forEach((function(t){w(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):g(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({},t),this.useCompress=s,this.tryDoubleDomain=E,this.use443PortOnly=n;const{timeout:_,timeoutFactor:i}=t,r=Math.max(300,Math.floor(3*_/5)),a=Math.max(1.2,Math.floor(8*i)/10);R.ONLINE&&(this.retryConfig.timeout=r,this.retryConfig.timeoutFactor=a),A.on(I.NETWORK_STATE_CHANGE,((e,t)=>{e!==t&&(this.resetReconnectCount("network state change: ".concat(t," -> ").concat(e)),e===R.ONLINE?(this.retryConfig.timeout=r,this.retryConfig.timeoutFactor=a):(this.retryConfig.timeout=_,this.retryConfig.timeoutFactor=i))}))}getConnection(){return this.websocket||void 0}async init(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const n=await this._initMutex.lock();this.forceCloseTimeout=t,this.urls=e,this.state="connecting";try{const e=N(),t=this.urls[this.currentURLIndex];E("ENABLE_PREALLOC_PC")&&this.emit(j.PRE_CONNECT_PC),this.createWebSocketConnection(t).then(e.resolve).catch(e.reject),this.once(Y.CLOSED,(()=>{e.reject(new s(_.WS_DISCONNECT))})),this.once(Y.CONNECTED,e.resolve),await e.promise}catch(e){}finally{n()}}close(e,t){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;const e=this.websocket;t?setTimeout((()=>e.close()),500):e.close(),this.websocket=void 0}this.state=e?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(e,t){if(!this.websocket)return void l.warning("[".concat(this.name,"] can not reconnect, no websocket"));void 0!==e&&(this.reconnectMode=e),l.debug("[".concat(this.name,"] reconnect is triggered initiative")),"number"==typeof this.joinGatewayRecordIndex&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(t)]},this.joinGatewayRecordIndex);const s=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),s&&s.bind(this.websocket)({code:9999,reason:t})}sendMessage(e){let t=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new s(_.WS_ABORT,"websocket is not ready");try{t||(e=JSON.stringify(e)),this.websocket.send(e)}catch(e){throw new s(_.WS_ERR,"send websocket message error"+e.toString())}}setWsInflateData(e){this.wsDeflateLength=this.wsDeflateLength+e.originLength,this.wsInflateLength=this.wsInflateLength+e.compressedLength}getWsInflateData(){const e=this.wsInflateLength,t=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:e,wsDeflateLength:t}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(e){var t;const n=N();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;const o=e=>{var t;null===(t=this.store)||void 0===t||t.signalChannelOpen(),l.debug("[".concat(this.name,"] websocket opened:"),e),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),n.resolve()},i=async e=>{var t;if(l.debug("[".concat(this.name,"] websocket close ").concat(null===(t=this.websocket)||void 0===t?void 0:t.url,", code: ").concat(e.code,", reason: ").concat(e.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)n.reject(new s(_.WS_DISCONNECT,"websocket close: ".concat(e.code))),this.close();else{"connected"===this.state&&(this.reconnectReason=e.reason,this.state="reconnecting");const t=T(this,Y.WILL_RECONNECT,this.reconnectMode,e.reason)||this.reconnectMode,E=await this.reconnectWithAction(t);if("closed"===this.state)return void l.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!E)return n.reject(new s(_.WS_DISCONNECT,"websocket reconnect failed: ".concat(e.code))),this.close(!0);n.resolve()}},r=e=>{this.emit(Y.ON_MESSAGE,e)},a=e=>{l.warn("[".concat(this.connectionID,"] ws open error ").concat(e))};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),E("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(e=E("GATEWAY_WSS_ADDRESS")),l.debug("[".concat(this.name,"] start connect, url:"),e);const c=null===(t=this.store)||void 0===t?void 0:t.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var R;const t=await this.chooseBestWebsocketConnection(e);this.websocket=t,o&&o(this.websocket.url),this.websocket.onclose=i,this.websocket.onmessage=r,this.websocket.onerror=a,null===(R=this.store)||void 0===R||R.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this.joinGatewayRecordIndex=c}catch(e){const t="closed"===this.state,E=e instanceof s,o=E&&e.code===_.WS_ABORT,r=E&&e.code===_.WS_ERR,a=E?e.message:e&&(e.reason||e.toString());l.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(a)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:o?"aborted":"error",errors:[e]},c),t||r?(n.reject(t?new s(_.WS_DISCONNECT,"websocket is closed: ".concat(a)):new s(_.WS_ERR,"init websocket failed: ".concat(a))),r&&l.error("[".concat(this.name,"] init websocket failed: ").concat(a))):i&&i(e)}return n.promise}async reconnectWithAction(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount)return!1;if(0===this.urls.length)return!1;if("closed"===this.state)return!1;l.warning("[choose-best-ws] action: =>",e),this.onlineReconnectListener||A.isOnline||!A.onlineWaiter||(this.onlineReconnectListener=A.onlineWaiter.then((()=>{this.onlineReconnectListener=void 0})));let s=!0;if(this.reconnectInterrupter=()=>s=!1,t){const t=S(this.reconnectCount,this.retryConfig);l.debug("[".concat(this.name,"] wait ").concat(t,"ms to reconnect websocket, mode: ").concat(e)),await Promise.race([h(t),this.onlineReconnectListener||new Promise((()=>{}))])}if("closed"===this._state||!s)return!1;this.reconnectCount+=1;const E=async(e,t)=>{this.emit(Y.RECONNECT_CREATE_CONNECTION,t),await this.createWebSocketConnection(e)};try{if("retry"===e)this.emit(Y.RECONNECT_WAITTING_FINISH,e),await E(this.urls[this.currentURLIndex],e);else if("tryNext"===e){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);l.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),this.emit(Y.RECONNECT_WAITTING_FINISH,e),await E(this.urls[this.currentURLIndex],e)}else"recover"===e&&(l.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.emit(Y.RECONNECT_WAITTING_FINISH,e),this.urls=await C(this,Y.REQUEST_NEW_URLS),this.currentURLIndex=0,await E(this.urls[this.currentURLIndex],e))}catch(s){var n;l.error("[".concat(this.name,"] reconnect failed ").concat(s&&s.toString()));const E=null==s||null===(n=s.data)||void 0===n?void 0:n.desc;return Array.isArray(E)&&E.includes("dynamic key expired")?(this.emit(Y.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):this.reconnectWithAction(e,t)}return!0}}class x extends q{constructor(e,t){super(e,t,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(e,t){return new Promise(((n,o)=>{let i=!1;const r=[];this.closeEstablishingWs=()=>{l.debug("[choose-best-ws] close establishing websockets"),r.forEach((e=>{e.onclose=null,e.onopen=null,e.onmessage=null,e.close()})),o(new s(_.WS_ABORT,"choose best websocket aborted"))};const a=E("GATEWAY_DOMAINS");let c;const R=e.indexOf("?h="),A=a.find((t=>-1!==R?e.includes(t,R):e.includes(t)));l.debug("[choose-best-ws] currentDomain: ",A,", domains: ",a);let I=!this.tryDoubleDomain||!A;if(!I&&A){var N;const s=Date.now();try{a.forEach((t=>{const s=-1===R?e.replace(A,t):e.substr(0,R)+e.substr(R).replace(A,t),E=new WebSocket(s);E.binaryType="arraybuffer",r.push(E),l.debug("[choose-best-ws] ws is connecting:",E.url)}))}catch(e){for(l.debug("[choose-best-ws] ws create failed, fallback to single url"),r.forEach((e=>e.close()));r.length;)r.pop();I=!0}null===(N=this.store)||void 0===N||N.recordJoinChannelService({urls:r.map((e=>e.url)),service:"gateway"},t),r.forEach((e=>{e.onopen=()=>{if(i)return;const t=Date.now()-s;l.debug("[choose-best-ws] ws open cost ".concat(t,"ms")),r.filter((t=>t!==e)).forEach((e=>{l.debug("[choose-best-ws]close backup websocket: ".concat(e.url)),e.close()})),i=!0,n(e)},e.onclose=e=>{if(c=e,i)return;r.find((e=>!(e.readyState===WebSocket.CLOSED||e.readyState===WebSocket.CLOSING)))||(l.debug("[choose-best-ws] all websocket is closed"),i=!0,o(c))},e.onmessage=t=>{l.debug("[choose-best-ws]".concat(e.url," onmessage: ").concat(t.data))}})),h(this.forceCloseTimeout).then((()=>{r.forEach((e=>{e.readyState!==WebSocket.OPEN&&e.close()}))}))}if(I){var S;let E;l.debug("[choose-best-ws] use single url: ",e),null===(S=this.store)||void 0===S||S.recordJoinChannelService({urls:[e],service:"gateway"},t);try{E=new WebSocket(e),r.push(E),E.binaryType="arraybuffer"}catch(e){const t=new s(_.WS_ERR,"init websocket failed! Error: ".concat(e.toString()));return l.error("[".concat(this.name,"]").concat(t)),void o(t)}E.onopen=()=>{n(E)},E.onclose=e=>{o(e)},E.onmessage=e=>{l.debug("[choose-best-ws]".concat(E.url," onmessage: ").concat(e.data))},h(this.forceCloseTimeout).then((()=>{E&&E.readyState!==WebSocket.OPEN&&E.close()}))}})).then((e=>(this.closeEstablishingWs=void 0,e))).catch((e=>{throw this.closeEstablishingWs=void 0,e}))}}class X extends a{constructor(e,t,s){super(),this.ws=void 0,this.requestId=1,this.heartBeatTimer=void 0,this.joinInfo=void 0,this.clientId=void 0,this.onOpen=()=>{this.emit("open"),this.startHeartBeatCheck()},this.onClose=e=>{this.emit("close"),this.dispose()},this.onMessage=e=>{const t=JSON.parse(e.data);if(!t||"serverResponse"!==t.command||!t.requestId)return t&&"serverStatus"===t.command&&t.serverStatus&&t.serverStatus.command?(this.emit("status",t.serverStatus),void this.emit(t.serverStatus.command,t.serverStatus)):void 0;this.emit("req_".concat(t.requestId),t)},this.joinInfo=e,this.clientId=t,this.ws=new x("cross-channel-".concat(this.clientId),s),this.ws.on(Y.RECONNECTING,(()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")})),this.ws.on(Y.CONNECTED,this.onOpen),this.ws.on(Y.ON_MESSAGE,this.onMessage),this.ws.on(Y.CLOSED,this.onClose)}isConnect(){return"connected"===this.ws.state}sendMessage(e){const t=this.requestId++;return e.requestId=t,e.seq=t,this.ws.sendMessage(e),t}waitStatus(e){return new Promise(((t,s)=>{const E=window.setTimeout((()=>{s(new P(_.TIMEOUT,"wait status timeout, status: ".concat(e)))}),5e3);this.once(e,(n=>{window.clearTimeout(E),n.state&&0!==n.state?s(new P(_.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(e))):t(void 0)})),this.once("dispose",(()=>{window.clearTimeout(E),s(new P(_.WS_ABORT))}))}))}async request(e){if("closed"===this.ws.state)throw new P(_.WS_DISCONNECT);const t=()=>new Promise(((e,t)=>{this.ws.once(Y.CLOSED,(()=>t(new P(_.WS_ABORT)))),this.ws.once(Y.CONNECTED,e)}));"connected"!==this.ws.state&&await t();const s=this.sendMessage(e),E=new Promise(((e,t)=>{const E=()=>{t(new P(_.WS_ABORT))};this.ws.once(Y.RECONNECTING,E),this.ws.once(Y.CLOSED,E),this.once("req_".concat(s),e),h(3e3).then((()=>{this.removeAllListeners("req_".concat(s)),this.ws.off(Y.RECONNECTING,E),this.ws.off(Y.CLOSED,E),t(new P(_.TIMEOUT,"cross channel ws request timeout"))}))})),n=await E;if(!n||200!==n.code)throw new P(_.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(n)));return n}async connect(e){this.ws.removeAllListeners(Y.REQUEST_NEW_URLS),this.ws.on(Y.REQUEST_NEW_URLS,(t=>{t(e)})),await this.ws.init(e)}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(e){const t=this.requestId++;return e.requestId=t,this.ws.sendMessage(e),t}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval((()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})}),3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class Q extends a{set state(e){e!==this._state&&(e!==F.RELAY_STATE_FAILURE&&(this.errorCode=J.RELAY_OK),this.emit("state",e,this.errorCode),this._state=e)}get state(){return this._state}constructor(e,t,s,E,n){super(),this.joinInfo=void 0,this.sid=void 0,this.clientId=void 0,this.cancelToken=u.CancelToken.source(),this.workerToken=void 0,this.requestId=0,this.signal=void 0,this.prevChannelMediaConfig=void 0,this.httpRetryConfig=void 0,this._resolution=void 0,this._state=F.RELAY_STATE_IDLE,this.errorCode=J.RELAY_OK,this.onStatus=e=>{l.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(e))),e&&e.command&&("onAudioPacketReceived"===e.command&&this.emit("event",G.PACKET_RECEIVED_AUDIO_FROM_SRC),"onVideoPacketReceived"===e.command&&this.emit("event",G.PACKET_RECEIVED_VIDEO_FROM_SRC),"onSrcTokenPrivilegeDidExpire"===e.command&&(this.errorCode=J.SRC_TOKEN_EXPIRED,this.state=F.RELAY_STATE_FAILURE),"onDestTokenPrivilegeDidExpire"===e.command&&(this.errorCode=J.DEST_TOKEN_EXPIRED,this.state=F.RELAY_STATE_FAILURE))},this.onReconnect=async()=>{l.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",G.NETWORK_DISCONNECTED),this.state=F.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch((e=>{this.state!==F.RELAY_STATE_IDLE&&(l.error("auto restart channel media relay failed",e.toString()),this.errorCode=J.SERVER_CONNECTION_LOST,this.state=F.RELAY_STATE_FAILURE)}))},this.joinInfo=e,this.clientId=t,this.sid=O(),this.signal=new X(this.joinInfo,this.clientId,s),this.httpRetryConfig=E,this._resolution=n}async startChannelMediaRelay(e){if(this.state!==F.RELAY_STATE_IDLE)throw new P(_.INVALID_OPERATION);this.state=F.RELAY_STATE_CONNECTING,await this.connect(),l.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(e)}catch(e){if(e.data&&e.data.serverResponse&&"SetSourceChannel"===e.data.serverResponse.command)throw new P(_.CROSS_CHANNEL_FAILED_JOIN_SRC);if(e.data&&e.data.serverResponse&&"SetDestChannelStatus"===e.serverResponse.command)throw new P(_.CROSS_CHANNEL_FAILED_JOIN_DEST);if(e.data&&e.data.serverResponse&&"StartPacketTransfer"===e.serverResponse.command)throw new P(_.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST);throw e}this.prevChannelMediaConfig=e}async updateChannelMediaRelay(e){if(this.state!==F.RELAY_STATE_RUNNING)throw new P(_.INVALID_OPERATION);await this.sendUpdateMessage(e),this.prevChannelMediaConfig=e}async setVideoProfile(e){if(this._resolution=e,this.state!==F.RELAY_STATE_RUNNING)throw new P(_.INVALID_OPERATION);const t=this.genMessage(W.SetVideoProfile);await this.signal.request(t),l.debug("[".concat(this.clientId,"] startChannelMediaRelay: setVideoProfile success"))}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),l.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=F.RELAY_STATE_IDLE,this.dispose()}dispose(){l.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=u.CancelToken.source(),this.state=F.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}async connect(){const e=await H(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=e.workerToken,await this.signal.connect(e.addressList),this.emit("event",G.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)}async sendStartRelayMessage(e){const t=this.genMessage(W.StopPacketTransfer);await this.signal.request(t),await this.signal.waitStatus("Normal Quit"),l.debug("[".concat(this.clientId,"] startChannelMediaRelay: StopPacketTransfer success"));const s=this.genMessage(W.SetSdkProfile,e);await this.signal.request(s),l.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));const E=this.genMessage(W.SetSourceChannel,e);await this.signal.request(E),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",G.PACKET_JOINED_SRC_CHANNEL),l.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));const n=this.genMessage(W.SetSourceUserId,e);await this.signal.request(n),l.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));const o=this.genMessage(W.SetDestChannel,e);await this.signal.request(o),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",G.PACKET_JOINED_DEST_CHANNEL),l.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));const _=this.genMessage(W.StartPacketTransfer,e);await this.signal.request(_),this.emit("event",G.PACKET_SENT_TO_DEST_CHANNEL),this.state=F.RELAY_STATE_RUNNING,l.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),this.setVideoProfile(this._resolution)}async sendUpdateMessage(e){const t=this.genMessage(W.UpdateDestChannel,e);await this.signal.request(t),this.emit("event",G.PACKET_UPDATE_DEST_CHANNEL),l.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))}async sendStopRelayMessage(){const e=this.genMessage(W.StopPacketTransfer);await this.signal.request(e),l.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))}genMessage(e,t){const s=[],E=[],n=[];this.requestId+=1;const o={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:i,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};"4.22.0"===o.sdkVersion&&(o.sdkVersion="0.0.1");let r=null,a=null;switch(e){case W.SetSdkProfile:return o.clientRequest={command:"SetSdkProfile",type:"multi_channel"},o;case W.SetSourceChannel:if(a=t&&t.getSrcChannelMediaInfo(),!a)throw new P(_.UNEXPECTED_ERROR,"can not find source config");return o.clientRequest={command:"SetSourceChannel",uid:"0",channelName:a.channelName,token:a.token||this.joinInfo.appId},o;case W.SetSourceUserId:if(a=t&&t.getSrcChannelMediaInfo(),!a)throw new P(_.UNEXPECTED_ERROR,"can not find source config");return o.clientRequest={command:"SetSourceUserId",uid:a.uid+""},o;case W.SetDestChannel:if(r=t&&t.getDestChannelMediaInfo(),!r)throw new P(_.UNEXPECTED_ERROR,"can not find dest config");return r.forEach((e=>{s.push(e.channelName),E.push(e.uid+""),n.push(e.token||this.joinInfo.appId)})),o.clientRequest={command:"SetDestChannel",channelName:s,uid:E,token:n},o;case W.StartPacketTransfer:return o.clientRequest={command:"StartPacketTransfer"},o;case W.Reconnect:return o.clientRequest={command:"Reconnect"},o;case W.StopPacketTransfer:return o.clientRequest={command:"StopPacketTransfer"},o;case W.UpdateDestChannel:if(r=t&&t.getDestChannelMediaInfo(),!r)throw new P(_.UNEXPECTED_ERROR,"can not find dest config");return r.forEach((e=>{s.push(e.channelName),E.push(e.uid+""),n.push(e.token||this.joinInfo.appId)})),o.clientRequest={command:"UpdateDestChannel",channelName:s,uid:E,token:n},o;case W.SetVideoProfile:o.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height}}return o}}const Z={name:"ChannelMediaRelay",create:function(e){return new Q(e.joinInfo,e.clientId,e.websocketRetryConfig||L,e.httpRetryConfig||L,e.resolution)}};export{Z as ChannelMediaRelayService};
